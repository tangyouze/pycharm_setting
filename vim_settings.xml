<application>
  <component name="VimSettings">
    <state version="4" enabled="true" />
    <globalmarks />
    <filemarks>
      <file name="$USER_HOME$/Dropbox/code/quantlib/acc_rpc.py" timestamp="1462599450512">
        <mark key="'" line="89" column="29" />
        <mark key="[" line="131" column="70" />
        <mark key="]" line="131" column="69" />
        <mark key="." line="131" column="69" />
        <mark key="^" line="131" column="69" />
      </file>
      <file name="/Python Console" timestamp="1462368447786">
        <mark key="[" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-rpc-xtc/xtc_model.py" timestamp="1462588670353">
        <mark key="'" line="106" column="25" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" timestamp="1462589389142">
        <mark key="'" line="16" column="69" />
        <mark key="[" line="12" column="63" />
        <mark key="]" line="16" column="69" />
        <mark key="." line="16" column="69" />
        <mark key="^" line="16" column="69" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/quantlib/interface.py" timestamp="1462583581509">
        <mark key="[" line="0" column="0" />
        <mark key="]" line="9" column="23" />
      </file>
      <file name="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/strategy_mm.py" timestamp="1462536076286">
        <mark key="'" line="23" column="26" />
        <mark key="[" line="53" column="8" />
        <mark key="]" line="53" column="13" />
        <mark key="^" line="53" column="13" />
        <mark key="." line="53" column="13" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/__init__.py" timestamp="1462339888051">
        <mark key="'" line="24" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/quantlib/tasks/daemon/read_redis_queue_save_influxdb.py" timestamp="1462322667294">
        <mark key="[" line="55" column="0" />
        <mark key="]" line="55" column="0" />
        <mark key="." line="55" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/quantlib/btc/test_okcoin.py" timestamp="1462582601294">
        <mark key="[" line="0" column="0" />
        <mark key="]" line="0" column="0" />
        <mark key="." line="0" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/requirements.txt" timestamp="1462588698724">
        <mark key="[" line="12" column="8" />
        <mark key="]" line="13" column="5" />
        <mark key="^" line="13" column="5" />
        <mark key="." line="13" column="5" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/exps.py" timestamp="1462587839442">
        <mark key="'" line="17" column="31" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" timestamp="1462583387442">
        <mark key="'" line="419" column="0" />
        <mark key="[" line="961" column="37" />
        <mark key="]" line="961" column="37" />
        <mark key="." line="961" column="37" />
        <mark key="^" line="961" column="37" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/setup.py" timestamp="1462588710925">
        <mark key="[" line="12" column="30" />
        <mark key="]" line="13" column="9" />
        <mark key="^" line="13" column="9" />
        <mark key="." line="13" column="9" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/quantlib/Makefile" timestamp="1462535511761">
        <mark key="[" line="5" column="0" />
        <mark key="]" line="5" column="118" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-strategy-cn-mm/Makefile" timestamp="1462670047876">
        <mark key="'" line="2" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/util.py" timestamp="1462624845656">
        <mark key="[" line="634" column="0" />
        <mark key="]" line="634" column="0" />
        <mark key="^" line="649" column="15" />
        <mark key="." line="634" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-strategy-cn-mm/strategy.py" timestamp="1462508862307">
        <mark key="'" line="198" column="17" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-strategy-turtle/Makefile" timestamp="1462533803804">
        <mark key="[" line="5" column="76" />
        <mark key="]" line="5" column="81" />
        <mark key="." line="5" column="81" />
        <mark key="^" line="5" column="81" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" timestamp="1462623890195">
        <mark key="'" line="984" column="16" />
        <mark key="[" line="662" column="20" />
        <mark key="]" line="662" column="44" />
        <mark key="." line="662" column="44" />
        <mark key="^" line="662" column="44" />
      </file>
      <file name="/" timestamp="1462534975399">
        <mark key="[" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" timestamp="1462588646728">
        <mark key="'" line="245" column="19" />
        <mark key="[" line="907" column="55" />
        <mark key="]" line="907" column="78" />
        <mark key="^" line="907" column="78" />
        <mark key="." line="907" column="78" />
      </file>
      <file name="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/config.yaml" timestamp="1462534799483">
        <mark key="'" line="8" column="8" />
        <mark key="[" line="7" column="14" />
        <mark key="]" line="7" column="17" />
        <mark key="." line="7" column="17" />
        <mark key="^" line="7" column="17" />
      </file>
      <file name="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" timestamp="1462681577627">
        <mark key="'" line="1176" column="45" />
        <mark key="[" line="2815" column="7" />
        <mark key="]" line="2816" column="31" />
        <mark key="." line="2816" column="31" />
        <mark key="^" line="2816" column="31" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin_quote.py" timestamp="1462367317953">
        <mark key="[" line="27" column="0" />
        <mark key="]" line="27" column="0" />
        <mark key="." line="27" column="0" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-strategy-turtle/strategy.py" timestamp="1462527112684">
        <mark key="'" line="886" column="8" />
      </file>
      <file name="$USER_HOME$/Dropbox/code/qb-okcoin/okcoin.py" timestamp="1462583468893">
        <mark key="[" line="8" column="0" />
        <mark key="]" line="8" column="0" />
        <mark key="." line="8" column="0" />
      </file>
      <file name="$USER_HOME$/Anaconda3/Lib/site-packages/qbtrade-0.1.0-py3.5.egg/qbtrade/model.py" timestamp="1462600680014">
        <mark key="'" line="1035" column="8" />
        <mark key="[" line="948" column="0" />
        <mark key="]" line="948" column="0" />
        <mark key="." line="948" column="0" />
      </file>
    </filemarks>
    <jumps>
      <jump line="945" column="28" filename="$USER_HOME$/Dropbox/code/quantlib/guangfa.py" />
      <jump line="28" column="13" filename="$USER_HOME$/Dropbox/code/quantlib/guangfa.py" />
      <jump line="5" column="15" filename="$USER_HOME$/Dropbox/code/quantlib/huatai.py" />
      <jump line="902" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="393" column="52" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="5" column="0" filename="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/run.sh" />
      <jump line="59" column="54" filename="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/strategy_mm.py" />
      <jump line="35" column="39" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="389" column="33" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="844" column="28" filename="$USER_HOME$/Dropbox/code/quantlib/guangfa.py" />
      <jump line="479" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/huatai.py" />
      <jump line="682" column="4" filename="$USER_HOME$/Dropbox/code/quantlib/huatai.py" />
      <jump line="886" column="8" filename="$USER_HOME$/Dropbox/code/qb-strategy-turtle/strategy.py" />
      <jump line="2" column="0" filename="$USER_HOME$/Dropbox/code/qb-strategy-cn-mm/Makefile" />
      <jump line="113" column="50" filename="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/strategy_mm.py" />
      <jump line="11" column="28" filename="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/strategy_mm.py" />
      <jump line="8" column="8" filename="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/config.yaml" />
      <jump line="23" column="26" filename="$USER_HOME$/Dropbox/projects.win10/qb-okc-mm/strategy_mm.py" />
      <jump line="372" column="44" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="392" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="183" column="64" filename="$USER_HOME$/Dropbox/code/quantlib/acc_rpc.py" />
      <jump line="382" column="45" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="1820" column="25" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="376" column="33" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="379" column="20" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="1042" column="8" filename="$USER_HOME$/Anaconda3/Lib/site-packages/qbtrade-0.1.0-py3.5.egg/qbtrade/model.py" />
      <jump line="202" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="105" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/btc/test_okcoin.py" />
      <jump line="0" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/btc/test_okcoin.py" />
      <jump line="163" column="30" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="453" column="24" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="419" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/btc/okcoin.py" />
      <jump line="27" column="42" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/xtc_model.py" />
      <jump line="0" column="0" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/xtc_model.py" />
      <jump line="125" column="8" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/xtc_model.py" />
      <jump line="30" column="0" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="0" column="0" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="581" column="13" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="889" column="0" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="7" column="0" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="461" column="30" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="10" column="10" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="979" column="4" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="904" column="32" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="366" column="37" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="503" column="36" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="975" column="4" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="379" column="20" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="41" column="0" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="410" column="56" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="996" column="4" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="27" column="31" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="78" column="43" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/xtc_model.py" />
      <jump line="394" column="46" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="984" column="29" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="646" column="50" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="915" column="12" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="15" column="10" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="18" column="8" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="17" column="31" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/exps.py" />
      <jump line="170" column="40" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="9" column="43" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="171" column="0" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="359" column="68" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="173" column="23" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="176" column="0" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="12" column="32" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="194" column="17" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="245" column="19" filename="$USER_HOME$/Dropbox/code/qbtrade/qbtrade/model.py" />
      <jump line="97" column="32" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="106" column="25" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/xtc_model.py" />
      <jump line="589" column="0" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="6" column="7" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="0" column="0" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="197" column="8" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="31" column="20" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="182" column="20" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="195" column="8" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="16" column="69" filename="$USER_HOME$/Dropbox/code/qbtrade/bin/acc_rpc.py" />
      <jump line="822" column="12" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="438" column="39" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="415" column="91" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="963" column="16" filename="$USER_HOME$/Dropbox/code/qb-rpc-xtc/okcoin.py" />
      <jump line="26" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/acc_rpc.py" />
      <jump line="94" column="16" filename="$USER_HOME$/Dropbox/code/quantlib/acc_rpc.py" />
      <jump line="11" column="0" filename="$USER_HOME$/Dropbox/code/quantlib/acc_rpc.py" />
      <jump line="91" column="29" filename="$USER_HOME$/Dropbox/code/quantlib/acc_rpc.py" />
      <jump line="52" column="33" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="3930" column="10" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="3829" column="0" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="2521" column="8" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="3939" column="4" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="3546" column="4" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="3037" column="15" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="96" column="6" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="2984" column="26" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="0" column="0" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="3948" column="25" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="2645" column="20" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
      <jump line="1176" column="45" filename="$USER_HOME$/Dropbox/github/logentries/le/src/le.py" />
    </jumps>
    <registers>
      <register name="&quot;" type="2">
        <text encoding="base64">IyEvdXNyL2Jpbi9lbnYgcHl0aG9uCiMgY29kaW5nOiB1dGYtOAojIHZpbTogc2V0IHRzPTQgc3c9NCBldDoKCiMKIyBMb2dlbnRyaWVzIEFnZW50IDxodHRwczovL2xvZ2VudHJpZXMuY29tLz4uCiMKCiMKIyBDb25zdGFudHMKIwoKZnJvbSB1dGlscyBpbXBvcnQgKgpmcm9tIF9faW5pdF9fIGltcG9ydCBfX3ZlcnNpb25fXwoKQ09SUCA9ICJsb2dlbnRyaWVzIgoKTk9UX1NFVCA9IE5vbmUKCiMgRGVmYXVsdCB1c2VyIGFuZCBhZ2VudCBrZXlzIG9mIG5vbmUgYXJlIGRlZmluZWQgaW4gY29uZmlndXJhdGlvbgpERUZBVUxUX1VTRVJfS0VZID0gTk9UX1NFVApERUZBVUxUX0FHRU5UX0tFWSA9IE5PVF9TRVQKCiMgQ29uZmlndXJhdGlvbiBmaWxlcwpDT05GSUdfRElSX1NZU1RFTSA9ICcvZXRjL2xlJwpDT05GSUdfRElSX1VTRVIgPSAnLmxlJwpMRV9DT05GSUcgPSAnY29uZmlnJyAjIERlZmF1bHQgY29uZmlndXJhdGlvbiBmaWxlCkNPTkZfU1VGRklYID0gJy5jb25mJyAjIEV4cGVjdGVkIHN1ZmZpeCBvZiBjb25maWd1cmF0aW9uIGZpbGVzCgpMT0NBTF9DT05GSUdfRElSX1VTRVIgPSAnLmxlJwpMT0NBTF9DT05GSUdfRElSX1NZU1RFTSA9ICcvZXRjL2xlJwoKUElEX0ZJTEUgPSAnL3Zhci9ydW4vbG9nZW50cmllcy5waWQnCgpNQUlOX1NFQ1QgPSAnTWFpbicKVVNFUl9LRVlfUEFSQU0gPSAndXNlci1rZXknCkFHRU5UX0tFWV9QQVJBTSA9ICdhZ2VudC1rZXknCkZJTFRFUlNfUEFSQU0gPSAnZmlsdGVycycKRk9STUFUVEVSU19QQVJBTSA9ICdmb3JtYXR0ZXJzJwpGT1JNQVRURVJfUEFSQU0gPSAnZm9ybWF0dGVyJwpFTlRSWV9JREVOVElGSUVSX1BBUkFNID0gJ2VudHJ5X2lkZW50aWZpZXInClNVUFBSRVNTX1NTTF9QQVJBTSA9ICdzdXBwcmVzc19zc2wnClVTRV9DQV9QUk9WSURFRF9QQVJBTSA9ICd1c2VfY2FfcHJvdmlkZWQnCkZPUkNFX0RPTUFJTl9QQVJBTSA9ICdmb3JjZV9kb21haW4nCkRBVEFIVUJfUEFSQU0gPSAnZGF0YWh1YicKU1lTU1RBVF9UT0tFTl9QQVJBTSA9ICdzeXN0ZW0tc3RhdC10b2tlbicKSE9TVE5BTUVfUEFSQU0gPSAnaG9zdG5hbWUnClYxX01FVFJJQ1NfUEFSQU0gPSAndjFfbWV0cmljcycKVE9LRU5fUEFSQU0gPSAndG9rZW4nClBBVEhfUEFSQU0gPSAncGF0aCcKSU5DTFVERV9QQVJBTSA9ICdpbmNsdWRlJwpERVNUSU5BVElPTl9QQVJBTSA9ICdkZXN0aW5hdGlvbicKUFVMTF9TRVJWRVJfU0lERV9DT05GSUdfUEFSQU0gPSAncHVsbC1zZXJ2ZXItc2lkZS1jb25maWcnCktFWV9MRU4gPSAzNgpBQ0NPVU5UX0tFWVNfQVBJID0gJy9hZ2VudC9hY2NvdW50LWtleXMvJwpJRF9MT0dTX0FQSSA9ICcvYWdlbnQvaWQtbG9ncy8nCgpMSU5FX1NFUEFSQVRPUiA9ICdceGUyXHg4MFx4YTgnLmRlY29kZSgndXRmOCcpCgpQUk9YWV9UWVBFX1BBUkFNID0gInByb3h5LXR5cGUiClBST1hZX1VSTF9QQVJBTSA9ICJwcm94eS11cmwiClBST1hZX1BPUlRfUEFSQU0gPSAicHJveHktcG9ydCIKCiMgTWF4aW1hbCBxdWV1ZSBzaXplIGZvciBldmVudHMgc2VudApTRU5EX1FVRVVFX1NJWkUgPSAzMjAwMAoKIyBMb2dlbnRyaWVzIHNlcnZlciBkZXRhaWxzCkxFX1NFUlZFUl9BUEkgPSAnLycKCkxFX0RFRkFVTFRfU1NMX1BPUlQgPSAyMDAwMApMRV9ERUZBVUxUX05PTl9TU0xfUE9SVCA9IDEwMDAwCgojIFN0cnVjdHVyZXMgZW1iZWRkZWQgKGJldGEpCkVNQkVEREVEX1NUUlVDVFVSRVMgPSB7CiAgICAjIEpTT04gd2l0aCBzdXBwb3J0IGZvciBuZXN0ZWQgb2JqZWN0cwogICAgImpzb24iOiAiNDQ0ZTYwN2YtMTRiZC00MDVlLWEyY2UtYzQ4OTJiNWEzYjE1IiwKICAgICMgR2VuZXJhbCBrdnAgcGFyc2VyCiAgICAia3ZwIjogIjM4MGQzZjM2LTFhOGQtNDVhZC05NzJmLTMwMDE3Njg4NzBjYSIsCiAgICAjIEFwYWNoZSBhY2Nlc3MgbG9nCiAgICAiaHR0cCI6ICI4MDNmZTdiYS1iZDJlLTQ0YmQtOGVlNy1mMDJmYTI1M2VmNWYiLAp9CgojICctLW11bHRpbG9nJyBvcHRpb24gcmVsYXRlZAojIE1heCBudW1iZXIgb2YgZmlsZXMgdGhhdCBhcmUgYWxsb3dlZCB0byBiZSBmb2xsb3dlZCBhdCBhbnkgb25lIHRpbWUgCk1BWF9GSUxFU19GT0xMT1dFRCA9IDEwMAojIFByZWZpeCB1c2VkIHRvIGRpc3Rpbmd1aXNoIHBhdGhuYW1lcyBpbiBjb25maWcgb3Igc2VydmVyIHNpZGUKIyBhcyBpbnRlbmRlZCBmb3IgbXV0bGlsb2cgYmVoYXZpb3VyClBSRUZJWF9NVUxUSUxPR19GSUxFTkFNRSA9ICJNdWx0aWxvZzoiCiMgVGltZSBpbnRlcnZhbCB0byByZXRyeSBnbG9iIG9mIG11bHRpbG9nIHBhdGhuYW1lIHRvIGNhdGNoIGFueSAKIyBjaGFuZ2UgaW4gcmVsZXZhbnQgZGlyZWN0b3JpZXMgdGhhdCBtYXkgaGF2ZSBiZWVuIGRlbGV0ZWQgb3IgYWRkZWQKUkVUUllfR0xPQl9JTlRFUlZBTCA9IDAuMjUwICMgaW4gc2Vjb25kcyAKIyBJbnRlcnZhbHMgZm9yIC5qb2luKCkgb24gc2V2ZXJhbCB0aHJlYWRzCkZPTExPV01VTFRJX0pPSU5fSU5URVJWQUwgPSAxLjAgICMgaW4gc2Vjb25kcwpGT0xMT1dFUl9KT0lOX0lOVEVSVkFMID0gMS4wICAgICMgaW4gc2Vjb25kcwpUUkFOU1BPUlRfSk9JTl9JTlRFUlZBTCA9IDEuNSAgICMgaW4gc2Vjb25kcwoKY2xhc3MgRG9tYWluKG9iamVjdCk6CgogICAgIiIiIExvZ2VudHJpZXMgZG9tYWlucy4gIiIiCiAgICAjIEdlbmVyYWwgZG9tYWlucwogICAgTUFJTiA9ICdsb2dlbnRyaWVzLmNvbScKICAgIEFQSSA9ICdhcGkubG9nZW50cmllcy5jb20nCiAgICBEQVRBID0gJ2RhdGEubG9nZW50cmllcy5jb20nCiAgICBQVUxMID0gJ3B1bGwubG9nZW50cmllcy5jb20nCiAgICAjIExvY2FsIGRlYnVnZ2luZwogICAgTUFJTl9MT0NBTCA9ICcxMjcuMC4wLjEnCiAgICBBUElfTE9DQUwgPSAnMTI3LjAuMC4xJwogICAgREFUQV9MT0NBTCA9ICcxMjcuMC4wLjEnCiAgICBMT0NBTCA9ICcxMjcuMC4wLjEnCgoKQ09OVEVOVF9MRU5HVEggPSAnY29udGVudC1sZW5ndGgnCgojIExvZyByb290IGRpcmVjdG9yeQpMT0dfUk9PVCA9ICcvdmFyL2xvZycKCiMgVGltZW91dCBhZnRlciBzZXJ2ZXIgY29ubmVjdGlvbiBmYWlsLiBNaWdodCBiZSBhIHRlbXBvcmFyeSBuZXR3b3JrCiMgZmFpbHVyZS4KU1JWX1JFQ09OX1RJTUVPVVQgPSAxMCAgIyBpbiBzZWNvbmRzClNSVl9SRUNPTl9UT19NSU4gPSAxICAgIyBpbiBzZWNvbmRzClNSVl9SRUNPTl9UT19NQVggPSAxMCAgIyBpbiBzZWNvbmRzCgojIFRpbWVvdXQgYWZ0ZXIgaW52YWxpZCBzZXJ2ZXIgcmVzcG9uc2UuIE1pZ2h0IGJlIGEgdmVyc2lvbiBtaXNobWFzaCBvcgojIHRlbXBvcmFyeSBzZXJ2ZXIvbmV0d29yayBmYWlsdXJlCklOVl9TUlZfUkVTUF9USU1FT1VUID0gMzAgICMgU2Vjb25kcwoKIyBUaW1lIGludGVydmFsIGJldHdlZW4gcmUtdHJ5aW5nIHRvIG9wZW4gbG9nIGZpbGUKUkVPUEVOX1RSWV9JTlRFUlZBTCA9IDEgICMgU2Vjb25kcwoKIyBOdW1iZXIgb2YgbGluZXMgd2hpY2ggY2FuIGJlIHNlbnQgaW4gb25lIGJ1Y2ssIHBpZ2d5YmFja2luZwpNQVhfTElORVNfU0VOVCA9IDEwCgojIFRpbWUgaW4gc2Vjb25kcyBzcGVuZCBiZXR3ZWVuIGxvZyByZS1jaGVja3MKVEFJTF9SRUNIRUNLID0gMC4yICAjIFNlY29uZHMKCiMgTnVtYmVyIG9mIGF0dGVtcHMgdG8gcmVhZCBhIGZpbGUsIHVudGlsIHRoZSBuYW1lIGlzIHJlY2hlY2sKTkFNRV9DSEVDSyA9IDQgICMgVEFJTF9SRUNIRUNLIGN5Y2xlcwoKIyBOdW1iZXIgb2YgcmVhZCBsaW5lIGZhbHNlIGF0dGVtcHMgYmV0d2VlbiBhcmUteW91LWFsaXZlIHBhY2tldHMKSUFBX0lOVEVSVkFMID0gMTAwCklBQV9UT0tFTiA9ICIjIyNMRS1JQUEjIyNcbiIKCiMgTWF4aW1hbCBzaXplIG9mIGEgYmxvY2sgb2YgZXZlbnRzCk1BWF9CTE9DS19TSVpFID0gNjU1MzYgLSA1MTIgIyBTcGFjZSBmb3IgZm9ybWF0dGluZwoKIyBJbnRlcnZhbCBiZXR3ZWVuIGF0dGFtcHRzIHRvIG9wZW4gYSBmaWxlClJFT1BFTl9JTlQgPSAxICAjIFNlY29uZHMKCiMgTGludXggYmxvY2sgZGV2aWNlcwpTWVNfQkxPQ0tfREVWID0gJy9zeXMvYmxvY2svJwojIExpbnV4IENQVSBzdGF0IGZpbGUKQ1BVU1RBVFNfRklMRSA9ICcvcHJvYy9zdGF0JwojIExpbnV4IG1tZW9yeSBzdGF0IGZpbGUKTUVNU1RBVFNfRklMRSA9ICcvcHJvYy9tZW1pbmZvJwojIExpbnV4IG5ldHdvcmsgc3RhdCBmaWxlCk5FVFNUQVRTX0ZJTEUgPSAnL3Byb2MvbmV0L2RldicKCiMgTGlzdCBvZiBhY2NlcHRlZCBuZXR3b3JrIGRldmljZXMKTkVUX0RFVklDRVMgPSBbJyAgZXRoJywgJyB3bGFuJywgJ3ZlbmV0JywgJyB2ZXRoJ10KCkVQT0NIID0gNSAgIyBpbiBzZWNvbmRzCgpRVUVVRV9XQUlUX1RJTUUgPSAxICAjIHRpbWUgaW4gc2Vjb25kcyB0byB3YWl0IGZvciByZWFkaW5nIGZyb20gdGhlIHRyYW5zcG9ydCBxdWV1ZSBpZiBpdCBpcyBlbXB0eQoKCiMgRmlsZSBIYW5kbGVyIFBvc2l0aW9ucwpGSUxFX0JFR0lOID0gMApGSUxFX0NVUlJFTlQgPSAxCkZJTEVfRU5EID0gMgoKIyBDb25maWcgcmVzcG9uc2UgcGFyYW1ldGVycwpDT05GX1JFU1BPTlNFID0gJ3Jlc3BvbnNlJwpDT05GX1JFQVNPTiA9ICdyZWFzb24nCkNPTkZfTE9HUyA9ICdsb2dzJwpDT05GX1NFUlZFUlMgPSAnc2VydmVycycKQ09ORl9PSyA9ICdvaycKCiMgU2VydmVyIHJlcXVlc3RzClJRX1dPUktMT0FEID0gJ3B1c2hfd2wnCgojIFJlbGVhc2UgaW5mb3JtYXRpb24gb24gTFNCIHN5c3RlbXMKTFNCX1JFTEVBU0UgPSAnL2V0Yy9sc2ItcmVsZWFzZScKCgojCiMgVXNhZ2UgaGVscAojCgpQVUxMX1VTQUdFID0gInB1bGwgPHBhdGg+IDx3aGVuPiA8ZmlsdGVyPiA8bGltaXQ+IgpQVVNIX1VTQUdFID0gInB1c2ggPGZpbGU+IDxwYXRoPiA8bG9nLXR5cGU+IgpVU0FHRSA9ICJMb2dlbnRyaWVzIGFnZW50IHZlcnNpb24gIiArIF9fdmVyc2lvbl9fICsgIiIiCnVzYWdlOiBsZSBDT01NQU5EIFtBUkdTXQoKV2hlcmUgY29tbWFuZCBpcyBvbmUgb2Y6CiAgaW5pdCAgICAgIFdyaXRlIGxvY2FsIGNvbmZpZ3VyYXRpb24gZmlsZQogIHJlaW5pdCAgICBBcyBpbml0IGJ1dCBkb2VzIG5vdCByZXNldCB1bmRlZmluZWQgcGFyYW1ldGVycwogIHJlZ2lzdGVyICBSZWdpc3RlciB0aGlzIGhvc3QKICAgIC0tbmFtZT0gIG5hbWUgb2YgdGhlIGhvc3QKICAgIC0taG9zdG5hbWU9ICBob3N0bmFtZSBvZiB0aGUgaG9zdAogIHdob2FtaSAgICBEaXNwbGF5cyBzZXR0aW5ncyBmb3IgdGhpcyBob3N0CiAgbW9uaXRvciAgIE1vbml0b3IgdGhpcyBob3N0CiAgZm9sbG93IDxmaWxlbmFtZT4gIEZvbGxvdyB0aGUgZ2l2ZW4gbG9nCiAgICAtLW5hbWU9ICBuYW1lIG9mIHRoZSBsb2cKICAgIC0tdHlwZT0gIHR5cGUgb2YgdGhlIGxvZwogICAgLS1tdWx0aWxvZyBvcHRpb24gdXNlZCB3aXRoIGRpcmVjdG9yeSB3aWxkY2FyZCAqIChyZXN0cmljdGVkIGJlaGF2aW91cikKICBmb2xsb3dlZCA8ZmlsZW5hbWU+ICBDaGVjayBpZiB0aGUgZmlsZSBpcyBmb2xsb3dlZAogIGNsZWFuICAgICBSZW1vdmVzIGNvbmZpZ3VyYXRpb24gZmlsZQogIGxzICAgICAgICBMaXN0IGludGVybmFsIGZpbGVzeXN0ZW0gYW5kIHNldHRpbmdzOiA8cGF0aD4KICBybSAgICAgICAgUmVtb3ZlIGVudGl0eTogPHBhdGg+CiAgcHVsbCAgICAgIFB1bGwgbG9nIGZpbGU6IDxwYXRoPiA8d2hlbj4gPGZpbHRlcj4gPGxpbWl0PgoKV2hlcmUgcGFyYW1ldGVycyBhcmU6CiAgLS1oZWxwICAgICAgICAgICAgICAgICAgc2hvdyB1c2FnZSBoZWxwIGFuZCBleGl0CiAgLS12ZXJzaW9uICAgICAgICAgICAgICAgZGlzcGxheSB2ZXJzaW9uIG51bWJlciBhbmQgZXhpdAogIC0tY29uZmlnPSAgICAgICAgICAgICAgIGxvYWQgc3BlY2lmaWVkIGNvbmZpZ3VyYXRpb24KICAtLWNvbmZpZy5kPSAgICAgICAgICAgICBsb2FkIGNvbmZpZ3VyYXRpb25zIGZyb20gZGlyZWN0b3J5CiAgLS1hY2NvdW50LWtleT0gICAgICAgICAgc2V0IGFjY291bnQga2V5IGFuZCBleGl0CiAgLS1ob3N0LWtleT0gICAgICAgICAgICAgc2V0IGxvY2FsIGhvc3Qga2V5IGFuZCBleGl0LCBnZW5lcmF0ZSBrZXkgaWYga2V5IGlzIGVtcHR5CiAgLS1uby10aW1lc3RhbXBzICAgICAgICAgbm8gdGltZXN0YW1wcyBpbiBhZ2VudCByZXBvcnRpbmdzCiAgLS1mb3JjZSAgICAgICAgICAgICAgICAgZm9yY2UgZ2l2ZW4gb3BlcmF0aW9uCiAgLS1zdXBwcmVzcy1zc2wgICAgICAgICAgZG8gbm90IHVzZSBTU0wgd2l0aCBBUEkgc2VydmVyCiAgLS15ZXMgICAgICAgICAgICAgICAgICAgYWx3YXlzIHJlc3BvbmQgeWVzCiAgLS1kYXRhaHViICAgICAgICAgICAgICAgc2VuZCBsb2dzIHRvIHRoZSBzcGVjaWZpZWQgZGF0YSBodWIgYWRkcmVzcwogICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBmb3JtYXQgaXMgYWRkcmVzczpwb3J0IHdpdGggcG9ydCBiZWluZyBvcHRpb25hbAogIC0tc3lzdGVtLXN0YXQtdG9rZW49ICAgIHNldCB0aGUgdG9rZW4gZm9yIHN5c3RlbSBzdGF0cyBsb2cgKGJldGEpCiAgLS1wdWxsLXNlcnZlci1zaWRlLWNvbmZpZz1GYWxzZSBkbyBub3QgdXNlIHNlcnZlci1zaWRlIGNvbmZpZyBmb3IgZm9sbG93aW5nIGZpbGVzIAoiIiIKCiMgTXVsdGlsb2cgb3B0aW9uIHVzYWdlCk1VTFRJTE9HX1VTQUdFID0gXAoiIiIKVXNhZ2U6CiAgQWdlbnQgaXMgZXhwZWN0aW5nIGEgcGF0aCBuYW1lIGZvciBhIGZpbGUsIHdoaWNoIHNob3VsZCBiZSBiZXR3ZWVuIHNpbmdsZSBxdW90ZXM6CiAgICAgICAgZXhhbXBsZTogXCcvdmFyL2xvZy9kaXJlY3RvcnluYW1lL2ZpbGUubG9nXCcKICBBICogd2lsZGNhcmQgZm9yIGV4cGFuc2lvbiBvZiBkaXJlY3RvcnkgbmFtZSBjYW4gYmUgdXNlZC4gT25seSB0aGUgb25lICogd2lsZGNhcmQgaXMgYWxsb3dlZC4KICBXaWxkY2FyZCBjYW4gbm90IGJlIHVzZWQgZm9yIGV4cGFuc2lvbiBvZiBmaWxlbmFtZSwgYnV0IGZvciBkaXJlY3RvcnkgbmFtZSBvbmx5LgogIFBsYWNlIHBhdGggbmFtZSB3aXRoIHdpbGRjYXJkIGJldHdlZW4gc2luZ2xlIHF1b3RlczoKICAgICAgICBleGFtcGxlOiBcIi92YXIvbG9nL2RpcmVjdG9yeSovZmlsZS5sb2dcIgoiIiIKCmRlZiBwcmludF91c2FnZSh2ZXJzaW9uX29ubHk9RmFsc2UpOgogICAgaWYgdmVyc2lvbl9vbmx5OgogICAgICAgIHJlcG9ydChfX3ZlcnNpb25fXykKICAgIGVsc2U6CiAgICAgICAgcmVwb3J0KFVTQUdFKQoKICAgIHN5cy5leGl0KEVYSVRfSEVMUCkKCgojCiMgTGlicmFyaWVzCiMKCiMgRG8gbm90IHJlbW92ZSAtIGZpeCBmb3IgUHl0aG9uICM4NDg0CnRyeToKICAgIGltcG9ydCBoYXNobGliCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHBhc3MKCmltcG9ydCBzdHJpbmcKaW1wb3J0IHJlCmltcG9ydCBRdWV1ZQppbXBvcnQgcmFuZG9tCmltcG9ydCBDb25maWdQYXJzZXIKaW1wb3J0IGZpbGVpbnB1dAppbXBvcnQgZ2V0b3B0CmltcG9ydCBnbG9iCmltcG9ydCBsb2dnaW5nCmltcG9ydCBvcwppbXBvcnQgb3MucGF0aAppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHNvY2tldAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3RhdAppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCBzeXMKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHVybGxpYgppbXBvcnQgaHR0cGxpYgppbXBvcnQgZ2V0cGFzcwppbXBvcnQgYXRleGl0CmltcG9ydCBsb2dnaW5nLmhhbmRsZXJzCmZyb20gYmFja3BvcnRzIGltcG9ydCBDZXJ0aWZpY2F0ZUVycm9yLCBtYXRjaF9ob3N0bmFtZQoKaW1wb3J0IGZvcm1hdHMKaW1wb3J0IG1ldHJpY3MKaW1wb3J0IHNvY2tzCgojIE9wdGlvbiB0byBhdm9pZCBpc3N1ZXMgYXJvdW5kIGVuY29kaW5ncwojcmVsb2FkKHN5cykKI3N5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoJ3V0ZjgnKQoKCiMgRXhwbGljaXRlbHkgc2V0IHVtYXNrIHRvIGFsbG93IHVzZXIgcncgKyBncm91cCByZWFkCm9zLnVtYXNrKHN0YXQuU19JV0dSUCB8IHN0YXQuU19JUk9USCB8IHN0YXQuU19JV09USCB8IHN0YXQuU19JWE9USCkKCiMKIyBTdGFydCBsb2dnaW5nCiMKCmxvZyA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKExPR19MRV9BR0VOVCkKaWYgbm90IGxvZzoKICAgIHJlcG9ydCgiQ2Fubm90IG9wZW4gbG9nIG91dHB1dCIpCiAgICBzeXMuZXhpdChFWElUX0VSUikKCmxvZy5zZXRMZXZlbChsb2dnaW5nLklORk8pCgpzdHJlYW1faGFuZGxlciA9IGxvZ2dpbmcuU3RyZWFtSGFuZGxlcigpCnN0cmVhbV9oYW5kbGVyLnNldExldmVsKGxvZ2dpbmcuREVCVUcpCnN0cmVhbV9oYW5kbGVyLnNldEZvcm1hdHRlcihsb2dnaW5nLkZvcm1hdHRlcigiJShtZXNzYWdlKXMiKSkKbG9nLmFkZEhhbmRsZXIoc3RyZWFtX2hhbmRsZXIpCgoKZGVmIGRlYnVnX2ZpbHRlcnMobXNnLCAqYXJncyk6CiAgICBpZiBjb25maWcuZGVidWdfZmlsdGVyczoKICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCBtc2cgJSBhcmdzCgpkZWYgZGVidWdfZm9ybWF0dGVycyhtc2csICphcmdzKToKICAgIGlmIGNvbmZpZy5kZWJ1Z19mb3JtYXR0ZXJzOgogICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsIG1zZyAlIGFyZ3MKCiMKIyBJbXBvcnRzIHRoYXQgbWF5IG5vdCBiZSBhdmFpbGFibGUKIwoKdHJ5OgogICAgaW1wb3J0IGpzb24KCiAgICB0cnk6CiAgICAgICAganNvbl9sb2FkcyA9IGpzb24ubG9hZHMKICAgICAgICBqc29uX2R1bXBzID0ganNvbi5kdW1wcwogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIGpzb25fbG9hZHMgPSBqc29uLnJlYWQKICAgICAgICBqc29uX2R1bXBzID0ganNvbi53cml0ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IHNpbXBsZWpzb24KICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBkaWUoJ05PVEU6IFBsZWFzZSBpbnN0YWxsIFB5dGhvbiAic2ltcGxlanNvbiIgcGFja2FnZSAocHl0aG9uLXNpbXBsZWpzb24pIG9yIGEgbmV3ZXIgUHl0aG9uICgyLjYpLicpCiAgICBqc29uX2xvYWRzID0gc2ltcGxlanNvbi5sb2FkcwogICAganNvbl9kdW1wcyA9IHNpbXBsZWpzb24uZHVtcHMKCmNsYXNzIExlZ2FjeVNzbFdyYXBwZXIob2JqZWN0KToKICAgICIiIldyYXBwZXIgYXJvdW5kIGxlZ2FjeSBTU0wgc3VwcG9ydCBpbiBQeXRob24gMi40LiBXZSBtaW1pYyBjZXJ0YWluCiAgICBzb2NrZXQncyBmdW5jdGlvbnMuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNvY2spOgogICAgICAgIHNlbGYuX3NvY2tldCA9IHNvY2tldC5zc2woc29jaykKCiAgICBkZWYgc2VuZChzZWxmLCBkYXRhKToKICAgICAgICBzZWxmLl9zb2NrZXQud3JpdGUoZGF0YSkKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi5fc29ja2V0LmNsb3NlKCkKCm5vX3NzbCA9IEZhbHNlCkZFQVRfU1NMID0gVHJ1ZQp0cnk6CiAgICBpbXBvcnQgc3NsCgogICAgd3JhcF9zb2NrZXQgPSBzc2wud3JhcF9zb2NrZXQKICAgIENFUlRfUkVRVUlSRUQgPSBzc2wuQ0VSVF9SRVFVSVJFRAoKZXhjZXB0IEltcG9ydEVycm9yOgogICAgbm9fc3NsID0gVHJ1ZQogICAgRkVBVF9TU0wgPSBGYWxzZQoKICAgIHRyeToKICAgICAgICBfID0gaHR0cGxpYi5IVFRQU0Nvbm5lY3Rpb24KICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICBkaWUoJ05PVEU6IFBsZWFzZSBpbnN0YWxsIFB5dGhvbiAic3NsIiBtb2R1bGUuJykKCiAgICBkZWYgd3JhcF9zb2NrZXQoc29jaywgY2FfY2VydHM9Tm9uZSwgY2VydF9yZXFzPU5vbmUpOgogICAgICAgIHJldHVybiBMZWdhY3lTc2xXcmFwcGVyKHNvY2spCgogICAgQ0VSVF9SRVFVSVJFRCA9IDAKCiMKIyBDdXN0b20gcHJvY3RpdGxlCiMKCgojCiMgVXNlci1kZWZpbmVkIGZpbHRlcmluZyBjb2RlCiMKCmRlZiBmaWx0ZXJfZXZlbnRzKGV2ZW50cyk6CiAgICAiIiIKICAgIFVzZXItZGVmaW5lZCBmaWx0ZXJpbmcgY29kZS4gRXZlbnRzIHBhc3NlZCBhcmUgYWJvdXQgdG8gYmUgc2VudCB0bwogICAgbG9nZW50cmllcyBzZXJ2ZXIuIE1ha2UgdGhlIHJlcXVpcmVkIG1vZGlmaWNhdGlvbnMgdG8gdGhlIGV2ZW50cyBzdWNoCiAgICBhcyByZW1vdmluZyB1bndhbnRlZCBvciBzZW5zaXRpdmUgaW5mb3JtYXRpb24uCiAgICAiIiIKICAgICMgQnkgZGVmYXVsdCwgdGhpcyBtZXRob2QgaXMgZW1wdHkKICAgIHJldHVybiBldmVudHMKCgpkZWYgZGVmYXVsdF9maWx0ZXJfZmlsZW5hbWVzKGZpbGVuYW1lKToKICAgICIiIgogICAgQnkgZGVmYXVsdCB3ZSBhbGxvdyB0byBmb2xsb3cgYW55IGZpbGVzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlndXJhdGlvbi4KICAgICIiIgogICAgcmV0dXJuIFRydWUKCmRlZiBmb3JtYXRfZW50cmllcyhkZWZhdWx0X2Zvcm1hdHRlciwgZW50cmllcyk6CiAgICAiIiIKICAgIFVzZXItZGVmaW5lZCBmb3JtYXR0ZXJpbmcgY29kZS4gRXZlbnRzIHBhc3NlZCBhcmUgYWJvdXQgdG8gYmUgc2VudCB0bwogICAgbG9nZW50cmllcyBzZXJ2ZXIuIE1ha2UgdGhlIHJlcXVpcmVkIG1vZGlmaWNhdGlvbnMgdG8gcHJvdmlkZSBjb3JyZWN0IGZvcm1hdC4KICAgICIiIgogICAgIyBCeSBkZWZhdWx0LCB0aGlzIG1ldGhvZCBpcyBlbXB0eQogICAgcmV0dXJuIGRlZmF1bHRfZm9ybWF0dGVyLmZvcm1hdF9saW5lKGVudHJpZXMpCgoKZGVmIGNhbGwoY29tbWFuZCk6CiAgICAiIiIKICAgIENhbGxzIHRoZSBnaXZlbiBjb21tYW5kIGluIE9TIGVudmlyb25tZW50LgogICAgIiIiCiAgICBvdXRwdXQgPSBzdWJwcm9jZXNzLlBvcGVuKAogICAgICAgIGNvbW1hbmQsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHNoZWxsPVRydWUpLnN0ZG91dC5yZWFkKCkKICAgIGlmIGxlbihvdXRwdXQpID09IDA6CiAgICAgICAgcmV0dXJuICcnCiAgICBpZiBvdXRwdXRbLTFdID09ICdcbic6CiAgICAgICAgb3V0cHV0ID0gb3V0cHV0WzotMV0KICAgIHJldHVybiBvdXRwdXQKCgpkZWYgdW5pcShhcnIpOgogICAgIiIiCiAgICBSZXR1cm5zIHRoZSBsaXN0IHdpdGggZHVwbGljYXRlIGVsZW1lbnRzIHJlbW92ZWQuCiAgICAiIiIKICAgIHJldHVybiBsaXN0KHNldChhcnIpKQoKCmRlZiBfbG9ja19waWRfZmlsZV9uYW1lKCk6CiAgICAiIiIKICAgIFJldHVybnMgcGF0aCB0byBhIGZpbGUgZm9yIHByb3RlY3RpbmcgY3JpdGljYWwgc2VjdGlvbgogICAgZm9yIGRhZW1vbml6aW5nIChzZWUgZGFlbW9uaXplKCkgKQogICAgIiIiCiAgICByZXR1cm4gY29uZmlnLnBpZF9maWxlICsgJy5sb2NrJwoKCmRlZiBfbG9ja19waWQoKToKICAgICIiIgogICAgVHJpZXMgdG8gZXhjbHVzaXZlbHkgb3BlbiBmaWxlIGZvciBwcm90ZWN0aW5nIG9mIGNyaXRpY2FsIHNlY3Rpb24KICAgIGZvciBkYWVtb25pemluZy4KICAgICIiIgogICAgZmlsZV9uYW1lID0gX2xvY2tfcGlkX2ZpbGVfbmFtZSgpCiAgICB0cnk6CiAgICAgICAgZmQgPSBvcy5vcGVuKGZpbGVfbmFtZSwgb3MuT19XUk9OTFkgfCBvcy5PX0NSRUFUIHwgb3MuT19FWENMKQogICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGlmIGZkID09IC0xOgogICAgICAgIHJldHVybiBOb25lCiAgICBvcy5jbG9zZShmZCkKICAgIHJldHVybiBUcnVlCgoKZGVmIF91bmxvY2tfcGlkKCk6CiAgICAiIiIKICAgIFJlbGVhc2VzIGZpbGUgZm9yIHByb3RlY3Rpbmcgb2YgY3JpdGljYWwgc2VjdGlvbiBmb3IgZGFlbW9uaXppbmcuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBmaWxlX25hbWUgPSBfbG9ja19waWRfZmlsZV9uYW1lKCkKICAgICAgICBvcy5yZW1vdmUoZmlsZV9uYW1lKQogICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgcGFzcwoKCmRlZiBfdHJ5X2RhZW1vbml6ZSgpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgZGFlbW9uIGZyb20gdGhlIGN1cnJlbnQgcHJvY2Vzcy4KICAgIGh0dHA6Ly93d3cuamVqaWsuY29tL2FydGljbGVzLzIwMDcvMDIvYV9zaW1wbGVfdW5peF9saW51eF9kYWVtb25faW5fcHl0aG9uLwogICAgQWx0ZXJuYXRpdmU6IHB5dGhvbi1kYWVtb24KICAgICIiIgoKICAgIHRyeToKICAgICAgICBwaWRmaWxlID0gZmlsZShjb25maWcucGlkX2ZpbGUsICdyJykKICAgICAgICBwaWQgPSBpbnQocGlkZmlsZS5yZWFkKCkuc3RyaXAoKSkKICAgICAgICBwaWRmaWxlLmNsb3NlKCkKICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgIHBpZCA9IE5vbmUKICAgIGlmIHBpZDoKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoJy9wcm9jJykgb3Igb3MucGF0aC5leGlzdHMoIi9wcm9jLyVkL3N0YXR1cyIgJSBwaWQpOgogICAgICAgICAgICByZXR1cm4gIlBpZGZpbGUgJXMgYWxyZWFkeSBleGlzdC4gRGFlbW9uIGFscmVhZHkgcnVubmluZz8iICUgY29uZmlnLnBpZF9maWxlCgogICAgdHJ5OgogICAgICAgICMgT3BlbiBwaWQgZmlsZQogICAgICAgIGlmIGNvbmZpZy5waWRfZmlsZToKICAgICAgICAgICAgZmlsZShjb25maWcucGlkX2ZpbGUsICd3JykuY2xvc2UoKQoKICAgICAgICBwaWQgPSBvcy5mb3JrKCkKICAgICAgICBpZiBwaWQgPiAwOgogICAgICAgICAgICBzeXMuZXhpdChFWElUX09LKQogICAgICAgIG9zLmNoZGlyKCIvIikKICAgICAgICBvcy5zZXRzaWQoKQogICAgICAgIG9zLnVtYXNrKDApCiAgICAgICAgcGlkID0gb3MuZm9yaygpCiAgICAgICAgaWYgcGlkID4gMDoKICAgICAgICAgICAgc3lzLmV4aXQoRVhJVF9PSykKICAgICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKICAgICAgICBzeXMuc3RkZXJyLmZsdXNoKCkKICAgICAgICBzaSA9IGZpbGUoJy9kZXYvbnVsbCcsICdyJykKICAgICAgICBzbyA9IGZpbGUoJy9kZXYvbnVsbCcsICdhKycpCiAgICAgICAgc2UgPSBmaWxlKCcvZGV2L251bGwnLCAnYSsnLCAwKQogICAgICAgIG9zLmR1cDIoc2kuZmlsZW5vKCksIHN5cy5zdGRpbi5maWxlbm8oKSkKICAgICAgICBvcy5kdXAyKHNvLmZpbGVubygpLCBzeXMuc3Rkb3V0LmZpbGVubygpKQogICAgICAgIG9zLmR1cDIoc2UuZmlsZW5vKCksIHN5cy5zdGRlcnIuZmlsZW5vKCkpCgogICAgICAgICMgV3JpdGUgcGlkIGZpbGUKICAgICAgICBpZiBjb25maWcucGlkX2ZpbGU6CiAgICAgICAgICAgIHBpZCA9IHN0cihvcy5nZXRwaWQoKSkKICAgICAgICAgICAgcGlkZmlsZSA9IGZpbGUoY29uZmlnLnBpZF9maWxlLCAndycpCiAgICAgICAgICAgIGF0ZXhpdC5yZWdpc3RlcihybV9waWRmaWxlKQogICAgICAgICAgICBwaWRmaWxlLndyaXRlKCIlc1xuIiAlIHBpZCkKICAgICAgICAgICAgcGlkZmlsZS5jbG9zZSgpCiAgICBleGNlcHQgT1NFcnJvciwgZToKICAgICAgICBybV9waWRmaWxlKGNvbmZpZykKICAgICAgICByZXR1cm4gIkNhbm5vdCBkYWVtb25pemU6ICVzIiAlIGUuc3RyZXJyb3IKICAgIHJldHVybiBOb25lCgoKZGVmIGRhZW1vbml6ZSgpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgZGFlbW9uIGZyb20gdGhlIGN1cnJlbnQgcHJvY2Vzcy4KCiAgICBJdCB1c2VzIGhlbHBlciBmaWxlIGFzIGEgbG9jayBhbmQgdGhlbiBjaGVja3MgaW5zaWRlIGNyaXRpY2FsIHNlY3Rpb24KICAgIHdoZXRoZXIgcGlkIGZpbGUgY29udGFpbnMgcGlkIG9mIGEgdmFsaWQgcHJvY2Vzcy4KICAgIElmIG5vdCB0aGVuIGl0IGRhZW1vbml6ZXMgaXRzZWxmLCBvdGhlcndpc2UgaXQgZGllcy4KICAgICIiIgogICAgaWYgbm90IF9sb2NrX3BpZCgpOgogICAgICAgIGRpZSgiRGFlbW9uIGFscmVhZHkgcnVubmluZy4gSWYgeW91IGFyZSBzdXJlIGl0IGlzbid0IHBsZWFzZSByZW1vdmUgJXMiICUKICAgICAgICAgICAgX2xvY2tfcGlkX2ZpbGVfbmFtZSgpKQogICAgZXJyID0gX3RyeV9kYWVtb25pemUoKQogICAgX3VubG9ja19waWQoKQogICAgaWYgZXJyOgogICAgICAgIGRpZSgiJXMiICUgZXJyKQoKICAgICMgU2V0dGluZyB0aGUgcHJvY3RpdGxlCiAgICBzZXRfcHJvY190aXRsZSgnbG9nZW50cmllcy1kYWVtb24nKQoKICAgICMgTG9nZ2luZyBmb3IgZGFlbW9uIG1vZGUKICAgIGxvZy5yZW1vdmVIYW5kbGVyKHN0cmVhbV9oYW5kbGVyKQogICAgc2hhbmRsZXIgPSBsb2dnaW5nLlN0cmVhbUhhbmRsZXIoKQogICAgc2hhbmRsZXIuc2V0TGV2ZWwobG9nZ2luZy5ERUJVRykKICAgIHNoYW5kbGVyLnNldEZvcm1hdHRlcihsb2dnaW5nLkZvcm1hdHRlcigiJShhc2N0aW1lKXMgICUobWVzc2FnZSlzIikpCiAgICBsb2cuYWRkSGFuZGxlcihzaGFuZGxlcikKCgpkZWYgcHJpbnRfdG90YWwoZWxlbXMsIG5hbWUpOgogICAgIiIiCiAgICBQcmludHMgdG90YWwgbnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBsaXN0CiAgICAiIiIKICAgIHRvdGFsID0gbGVuKGVsZW1zKQogICAgaWYgdG90YWwgPT0gMDoKICAgICAgICByZXBvcnQoIm5vICVzcyIgJSBuYW1lKQogICAgZWxpZiB0b3RhbCA9PSAxOgogICAgICAgIHJlcG9ydCgiMSAiICsgbmFtZSkKICAgIGVsc2U6CiAgICAgICAgcmVwb3J0KCIlZCAlc3MiICUgKHRvdGFsLCBuYW1lKSkKCgpkZWYgY29sbGVjdF9sb2dfbmFtZXMoc3lzdGVtX2luZm8pOgogICAgIiIiCiAgICBDb2xsZWN0cyBzdGFuZGFyZCBsb2NhbCBsb2dzIGFuZCBpZGVudGlmaWVzIHRoZW0uCiAgICAiIiIKICAgIGxvZ3MgPSBbXQogICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsoTE9HX1JPT1QpOgogICAgICAgIGZvciBuYW1lIGluIGZpbGVzOgogICAgICAgICAgICBpZiBuYW1lWy0zOl0gIT0gJy5neicgYW5kIHJlLm1hdGNoKHInLipcLlxkKyQnLCBuYW1lKSBpcyBOb25lOgogICAgICAgICAgICAgICAgbG9ncy5hcHBlbmQob3MucGF0aC5qb2luKHJvb3QsIG5hbWUpKQoKICAgIGxvZy5kZWJ1ZygiQ29sbGVjdGVkIGxvZ3M6ICVzIiwgbG9ncykKICAgIHRyeToKICAgICAgICBjID0gaHR0cGxpYi5IVFRQU0Nvbm5lY3Rpb24oTEVfU0VSVkVSX0FQSSkKICAgICAgICByZXF1ZXN0ID0gewogICAgICAgICAgICAnbG9ncyc6IGpzb25fZHVtcHMobG9ncyksCiAgICAgICAgICAgICdkaXN0bmFtZSc6IHN5c3RlbV9pbmZvWydkaXN0bmFtZSddLAogICAgICAgICAgICAnZGlzdHZlcic6IHN5c3RlbV9pbmZvWydkaXN0dmVyJ10KICAgICAgICB9CiAgICAgICAgbG9nLmRlYnVnKCJSZXF1ZXN0aW5nICVzIiwgcmVxdWVzdCkKICAgICAgICBjLnJlcXVlc3QoJ3Bvc3QnLCBJRF9MT0dTX0FQSSwgdXJsbGliLnVybGVuY29kZShyZXF1ZXN0KSwge30pCiAgICAgICAgcmVzcG9uc2UgPSBjLmdldHJlc3BvbnNlKCkKICAgICAgICBpZiBub3QgcmVzcG9uc2Ugb3IgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMDoKICAgICAgICAgICAgZGllKCdFcnJvcjogVW5leHBlY3RlZCByZXNwb25zZSBmcm9tIGxvZ2VudHJpZXMgKCVzKS4nICUKICAgICAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cykKICAgICAgICBkYXRhID0ganNvbl9sb2FkcyhyZXNwb25zZS5yZWFkKCkpCiAgICAgICAgbG9nX2RhdGEgPSBkYXRhWydsb2dzJ10KCiAgICAgICAgbG9nLmRlYnVnKCJJZGVudGlmaWVkIGxvZ3M6ICVzIiwgbG9nX2RhdGEpCiAgICBleGNlcHQgc29ja2V0LmVycm9yLCBtc2c6CiAgICAgICAgZGllKCdFcnJvcjogQ2Fubm90IGNvbnRhY3Qgc2VydmVyLCAlcycgJSBtc2cpCiAgICBleGNlcHQgVmFsdWVFcnJvciwgbXNnOgogICAgICAgIGRpZSgnRXJyb3I6IEludmFsaWQgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIChQYXJzaW5nIGVycm9yICVzKScgJSBtc2cpCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgZGllKCdFcnJvcjogSW52YWxpZCByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIsIGxvZyBkYXRhIG5vdCBwcmVzZW50LicpCgogICAgcmV0dXJuIGxvZ19kYXRhCgoKZGVmIGxzYl9yZWxlYXNlKHN5c3RlbV9pbmZvKToKICAgICMgR2VuZXJhbCBMU0Igc3lzdGVtCiAgICBpZiBvcy5wYXRoLmlzZmlsZShMU0JfUkVMRUFTRSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmaWVsZHMgPSBkaWN0KChhLnNwbGl0KCc9JykgZm9yIGEgaW4gcmZpbGUoTFNCX1JFTEVBU0UpLnNwbGl0KCdcbicpIGlmIGxlbihhLnNwbGl0KCc9JykpID09IDIpKQogICAgICAgICAgICBzeXN0ZW1faW5mb1snZGlzdG5hbWUnXSA9IGZpZWxkc1snRElTVFJJQl9JRCddCiAgICAgICAgICAgIHN5c3RlbV9pbmZvWydkaXN0dmVyJ10gPSBmaWVsZHNbJ0RJU1RSSUJfUkVMRUFTRSddCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICAjIEluZm9ybWF0aW9uIG5vdCBmb3VuZAogICAgcmV0dXJuIEZhbHNlCgoKZGVmIHJlbGVhc2VfdGVzdChmaWxlbmFtZSwgZGlzdG5hbWUsIHN5c3RlbV9pbmZvKToKICAgIGlmIG9zLnBhdGguaXNmaWxlKGZpbGVuYW1lKToKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdG5hbWUnXSA9IGRpc3RuYW1lCiAgICAgICAgc3lzdGVtX2luZm9bJ2Rpc3R2ZXInXSA9IHJmaWxlKGZpbGVuYW1lKQogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgc3lzdGVtX2RldGVjdChkZXRhaWxzKToKICAgICIiIgogICAgRGV0ZWN0cyB0aGUgY3VycmVudCBvcGVyYXRpbmcgc3lzdGVtLiBSZXR1cm5lZCBpbmZvcm1hdGlvbiBjb250YWluczoKICAgICAgICBkaXN0bmFtZTogZGlzdHJpYnV0aW9uIG5hbWUKICAgICAgICBkaXN0dmVyOiBkaXN0cmlidXRpb24gdmVyc2lvbgogICAgICAgIGtlcm5lbDoga2VybmVsIHR5cGUKICAgICAgICBzeXN0ZW06IHN5c3RlbSBuYW1lCiAgICAgICAgaG9zdG5hbWU6IGhvc3QgbmFtZQogICAgIiIiCiAgICB1bmFtZSA9IHBsYXRmb3JtLnVuYW1lKCkKICAgIHN5cyA9IHVuYW1lWzBdCiAgICBzeXN0ZW1faW5mbyA9IGRpY3Qoc3lzdGVtPXN5cywgaG9zdG5hbWU9c29ja2V0LmdldGZxZG4oKSwKICAgICAgICAgICAgICAgICAgICAgICBrZXJuZWw9JycsIGRpc3RuYW1lPScnLCBkaXN0dmVyPScnKQoKICAgIGlmIG5vdCBkZXRhaWxzOgogICAgICAgIHJldHVybiBzeXN0ZW1faW5mbwoKICAgIGlmIHN5cyA9PSAiU3VuT1MiOgogICAgICAgIHN5c3RlbV9pbmZvWydkaXN0bmFtZSddID0gY2FsbCgnY2F0IC9ldGMvcHJvZHVjdCB8IHNlZCAtbiAicy9OYW1lOiBcXCguKlxcKS9cXDEvcCInKQogICAgICAgIHN5c3RlbV9pbmZvWydkaXN0dmVyJ10gPSBjYWxsKCdjYXQgL2V0Yy9wcm9kdWN0IHwgc2VkIC1uICJzL0ltYWdlOiBcXCguKlxcKS9cXDEvcCInKQogICAgICAgIHN5c3RlbV9pbmZvWydrZXJuZWwnXSA9IHVuYW1lWzJdCiAgICBlbGlmIHN5cyA9PSAiQUlYIjoKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdHZlciddID0gY2FsbCgib3NsZXZlbCAtciIpCiAgICBlbGlmIHN5cyA9PSAiRGFyd2luIjoKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdG5hbWUnXSA9IGNhbGwoInN3X3ZlcnMgLXByb2R1Y3ROYW1lIikKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdHZlciddID0gY2FsbCgic3dfdmVycyAtcHJvZHVjdFZlcnNpb24iKQogICAgICAgIHN5c3RlbV9pbmZvWydrZXJuZWwnXSA9IHVuYW1lWzJdCgogICAgZWxpZiBzeXMgPT0gIkxpbnV4IjoKICAgICAgICBzeXN0ZW1faW5mb1sna2VybmVsJ10gPSB1bmFtZVsyXQogICAgICAgICMgWFhYIENlbnRPUz8KICAgICAgICByZWxlYXNlcyA9IFsKICAgICAgICAgICAgWycvZXRjL2RlYmlhbl92ZXJzaW9uJywgJ0RlYmlhbiddLAogICAgICAgICAgICBbJy9ldGMvVW5pdGVkTGludXgtcmVsZWFzZScsICdVbml0ZWQgTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2FubnZpeC1yZWxlYXNlJywgJ0FubnZpeCddLAogICAgICAgICAgICBbJy9ldGMvYXJjaC1yZWxlYXNlJywgJ0FyY2ggTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2Fya2xpbnV4LXJlbGVhc2UnLCAnQXJrbGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2F1cm94LXJlbGVhc2UnLCAnQXVyb3ggTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2JsYWNrY2F0LXJlbGVhc2UnLCAnQmxhY2tDYXQnXSwKICAgICAgICAgICAgWycvZXRjL2NvYmFsdC1yZWxlYXNlJywgJ0NvYmFsdCddLAogICAgICAgICAgICBbJy9ldGMvY29uZWN0aXZhLXJlbGVhc2UnLCAnQ29uZWN0aXZhJ10sCiAgICAgICAgICAgIFsnL2V0Yy9mZWRvcmEtcmVsZWFzZScsICdGZWRvcmEgQ29yZSddLAogICAgICAgICAgICBbJy9ldGMvZ2VudG9vLXJlbGVhc2UnLCAnR2VudG9vIExpbnV4J10sCiAgICAgICAgICAgIFsnL2V0Yy9pbW11bml4LXJlbGVhc2UnLCAnSW1tdW5peCddLAogICAgICAgICAgICBbJy9ldGMva25vcHBpeF92ZXJzaW9uJywgJ0tub3BwaXgnXSwKICAgICAgICAgICAgWycvZXRjL2xmcy1yZWxlYXNlJywgJ0xpbnV4LUZyb20tU2NyYXRjaCddLAogICAgICAgICAgICBbJy9ldGMvbGludXhwcGMtcmVsZWFzZScsICdMaW51eC1QUEMnXSwKICAgICAgICAgICAgWycvZXRjL21hbmRyaXZhLXJlbGVhc2UnLCAnTWFuZHJpdmEgTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL21hbmRyYWtlLXJlbGVhc2UnLCAnTWFuZHJha2UgTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL21hbmRha2VsaW51eC1yZWxlYXNlJywgJ01hbmRyYWtlIExpbnV4J10sCiAgICAgICAgICAgIFsnL2V0Yy9ta2xpbnV4LXJlbGVhc2UnLCAnTWtMaW51eCddLAogICAgICAgICAgICBbJy9ldGMvbmxkLXJlbGVhc2UnLCAnTm92ZWxsIExpbnV4IERlc2t0b3AnXSwKICAgICAgICAgICAgWycvZXRjL3BsZC1yZWxlYXNlJywgJ1BMRCBMaW51eCddLAogICAgICAgICAgICBbJy9ldGMvcmVkaGF0LXJlbGVhc2UnLCAnUmVkIEhhdCddLAogICAgICAgICAgICBbJy9ldGMvc2xhY2t3YXJlLXZlcnNpb24nLCAnU2xhY2t3YXJlJ10sCiAgICAgICAgICAgIFsnL2V0Yy9lLXNtaXRoLXJlbGVhc2UnLCAnU01FIFNlcnZlciddLAogICAgICAgICAgICBbJy9ldGMvcmVsZWFzZScsICdTb2xhcmlzIFNQQVJDJ10sCiAgICAgICAgICAgIFsnL2V0Yy9zdW4tcmVsZWFzZScsICdTdW4gSkRTJ10sCiAgICAgICAgICAgIFsnL2V0Yy9TdVNFLXJlbGVhc2UnLCAnU3VTRSddLAogICAgICAgICAgICBbJy9ldGMvc2xlcy1yZWxlYXNlJywgJ1N1U0UgTGludXggRVM5J10sCiAgICAgICAgICAgIFsnL2V0Yy90aW55c29mYS1yZWxlYXNlJywgJ1RpbnkgU29mYSddLAogICAgICAgICAgICBbJy9ldGMvdHVyYm9saW51eC1yZWxlYXNlJywgJ1R1cmJvTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL3VsdHJhcGVuZ3Vpbi1yZWxlYXNlJywgJ1VsdHJhUGVuZ3VpbiddLAogICAgICAgICAgICBbJy9ldGMvdmEtcmVsZWFzZScsICdWQS1MaW51eC9SSC1WQUxFJ10sCiAgICAgICAgICAgIFsnL2V0Yy95ZWxsb3dkb2ctcmVsZWFzZScsICdZZWxsb3cgRG9nJ10sCiAgICAgICAgXQoKICAgICAgICAjIENoZWNrIGZvciBrbm93biBzeXN0ZW0gSURzCiAgICAgICAgZm9yIHJlbGVhc2UgaW4gcmVsZWFzZXM6CiAgICAgICAgICAgIGlmIHJlbGVhc2VfdGVzdChyZWxlYXNlWzBdLCByZWxlYXNlWzFdLCBzeXN0ZW1faW5mbyk6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICMgQ2hlY2sgZm9yIGdlbmVyYWwgTFNCIHN5c3RlbQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKExTQl9SRUxFQVNFKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZmllbGRzID0gZGljdCgoYS5zcGxpdCgnPScpIGZvciBhIGluIHJmaWxlKExTQl9SRUxFQVNFKS5zcGxpdCgnXG4nKSBpZiBsZW4oYS5zcGxpdCgnPScpKSA9PSAyKSkKICAgICAgICAgICAgICAgIHN5c3RlbV9pbmZvWydkaXN0bmFtZSddID0gZmllbGRzWydESVNUUklCX0lEJ10KICAgICAgICAgICAgICAgIHN5c3RlbV9pbmZvWydkaXN0dmVyJ10gPSBmaWVsZHNbJ0RJU1RSSUJfUkVMRUFTRSddCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBwYXNzCiAgICByZXR1cm4gc3lzdGVtX2luZm8KCgojIElkZW50aWZpZWQgcmFuZ2VzCgpTRUMgPSAxMDAwCk1JTiA9IDYwICogU0VDCkhPVVIgPSA2MCAqIE1JTgpEQVkgPSAyNCAqIEhPVVIKTU9OID0gMzEgKiBEQVkKWUVBUiA9IDM2NSAqIERBWQoKCmRlZiBkYXRlX3BhdHRlcm5zKCk6CiAgICAiIiIgR2VuZXJhdGVzIGRhdGUgcGF0dGVybnMgb2YgdGhlIGZvcm0gW2RheTwtPm1vbnRoIHllYXI/XS4KICAgICIiIgogICAgZm9yIHllYXIgaW4gWycgJVknLCAnICV5J106CiAgICAgICAgZm9yIG1vbiBpbiBbJyViJywgJyVCJywgJyVtJ106CiAgICAgICAgICAgIHlpZWxkIFsnJSVkICVzJXMnICUgKG1vbiwgeWVhciksIERBWSwgW11dCiAgICAgICAgICAgIHlpZWxkIFsnJXMgJSVkJXMnICUgKG1vbiwgeWVhciksIERBWSwgW11dCiAgICBmb3IgbW9uIGluIFsnJWInLCAnJUInXTogICMgWWVhciBlbXB0eQogICAgICAgIHlpZWxkIFsnJSVkICVzJyAlIChtb24pLCBEQVksIFtZRUFSXV0KICAgICAgICB5aWVsZCBbJyVzICUlZCcgJSAobW9uKSwgREFZLCBbWUVBUl1dCiAgICB5aWVsZCBbJyUlWSAlJWQgJXMnICUgKG1vbiksIERBWSwgW11dCiAgICB5aWVsZCBbJyUlWSAlcyAlJWQnICUgKG1vbiksIERBWSwgW11dCiAgICB5aWVsZCBbJyVZICVtICVkJywgREFZLCBbXV0KCgpkZWYgdGltZV9wYXR0ZXJucyhjX2NvbHMpOgogICAgIiIiR2VuZXJhdGVzIHRpbWUgcGF0dGVybnMgb2YgdGhlIGZvcm0gW2hvdXI6bWluOnNlYz9dIGluY2x1ZGluZyBlbXB0eQogICAgdGltZS4KICAgICIiIgogICAgaWYgY19jb2xzID49IDI6CiAgICAgICAgeWllbGQgWyclSDolTTolUycsIFNFQywgW11dCiAgICBpZiBjX2NvbHMgPj0gMToKICAgICAgICB5aWVsZCBbJyVIOiVNJywgTUlOLCBbXV0KICAgICAgICB5aWVsZCBbJyVJOiVNJXAnLCBNSU4sIFtdXQogICAgeWllbGQgWyclSSVwJywgSE9VUiwgW11dCgoKZGVmIGRhdGV0aW1lX3BhdHRlcm5zKGNfY29scyk6CiAgICAiIiJHZW5lcmF0ZXMgY29tYmluYXRpb25zIG9mIGRhdGUgYW5kIHRpbWUgcGF0dGVybnMuCiAgICAiIiIKICAgICMgR2VuZXJhdGUgZGF0ZXMgb25seQogICAgZm9yIGRhdGVfcGF0dGVybiBpbiBkYXRlX3BhdHRlcm5zKCk6CiAgICAgICAgeWllbGQgZGF0ZV9wYXR0ZXJuCgogICAgIyBHZW5lcmF0ZSBjb21iaW5hdGlvbnMKICAgIGZvciB0IGluIHRpbWVfcGF0dGVybnMoY19jb2xzKToKICAgICAgICBmb3IgZCBpbiBkYXRlX3BhdHRlcm5zKCk6CiAgICAgICAgICAgIHlpZWxkIFsnJXMgJXMnICUgKGRbMF0sIHRbMF0pLCB0WzFdLCBkWzJdXQogICAgICAgICAgICB5aWVsZCBbJyVzICVzJyAlICh0WzBdLCBkWzBdKSwgdFsxXSwgZFsyXV0KICAgICAgICB5aWVsZCBbdFswXSwgdFsxXSwgW1lFQVIsIE1PTiwgREFZXV0KCgpkZWYgdGltZXN0YW1wX3BhdHRlcm5zKHNhbXBsZSk6CiAgICAiIiJHZW5lcmF0ZXMgYWxsIHRpbWVzdGFtcCBwYXR0ZXJucyB3ZSBjYW4gaGFuZGxlLiBJdCBpcyBjb25zdHJ1Y3RlZCBieQogICAgZ2VuZXJhdGluZyBhbGwgcG9zc2libGUgY29tYmluYXRpb25zIG9mIGRhdGUsIHRpbWUsIGRheSBuYW1lIGFuZCB6b25lLiBUaGUKICAgIHBhdHRlcm4gaXMgW2RheV9uYW1lPyBkYXRlPC0+dGltZSB6b25lP10gcGx1cyBzaW1wbGUgZGF0ZSBhbmQgdGltZS4KICAgICIiIgogICAgIyBBbGwgdGltZXN0YW1wcyB2YXJpYXRpb25zCiAgICBkYXlfbmFtZSA9ICcnCiAgICBpZiBsZW4oc2FtcGxlKSA+IDA6CiAgICAgICAgaWYgc2FtcGxlWzBdIGluIHN0cmluZy5hc2NpaV9sZXR0ZXJzOgogICAgICAgICAgICBkYXlfbmFtZSA9ICclYSAnCiAgICBjX2NvbHMgPSBzYW1wbGUuY291bnQoJzonKQogICAgZm9yIHpvbmUgaW4gWycnLCAnICVaJywgJyAleiddOgogICAgICAgIGZvciBkdCBpbiBkYXRldGltZV9wYXR0ZXJucyhjX2NvbHMpOgogICAgICAgICAgICB5aWVsZCBbJyVzJXMlcycgJSAoZGF5X25hbWUsIGR0WzBdLCB6b25lKSwgZHRbMV0sIGR0WzJdXQoKCmRlZiB0aW1lc3RhbXBfZ3JvdXAodGV4dCk6CiAgICAiIiJSZXR1cm5zIGEgdHVwbGUgW3RpbWVzdGFtcCwgcmFuZ2VdIHdoaWNoIGNvcnJlc3BvbmRzIHRvIHRoZSBkYXRlIGFuZAogICAgdGltZSBnaXZlbi4gRXhpc3RzIG9uIHBhcnNlIGVycm9yLgogICAgIiIiCiAgICB0aW1lcCA9IHJlLnN1YihyJyArJywgJyAnLCByZS5zdWIocidbLSwuL10nLCAnICcsIHRleHQpKS5zdHJpcCgpCiAgICBzdGFydF90dXBsZSA9IE5vbmUKICAgIGZvciBwIGluIHRpbWVzdGFtcF9wYXR0ZXJucyh0aW1lcCk6CiAgICAgICAgcGF0dGVybiwgcmVzb2x1dGlvbiwgZmlsbGluZyA9IHAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3R1cGxlID0gdGltZS5zdHJwdGltZSh0aW1lcCwgcFswXSkKICAgICAgICAgICAgYnJlYWsKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgaWYgbm90IHN0YXJ0X3R1cGxlOgogICAgICAgIGRpZSgiRXJyb3I6IERhdGUgJyVzJyBub3QgcmVjb2duaXplZCIgJSB0ZXh0KQoKICAgIHRvZGF5ID0gZGF0ZXRpbWUuZGF0ZS50b2RheSgpCiAgICAjIENvbXBsZXRlIGZpbGxpbmcKICAgIGlmIFlFQVIgaW4gZmlsbGluZzoKICAgICAgICBzdGFydF90dXBsZS5ybV95ZWFyID0gdG9kYXkueWVhcgogICAgaWYgTU9OIGluIGZpbGxpbmc6CiAgICAgICAgc3RhcnRfdHVwbGUucm1fbW9udGggPSB0b2RheS5tb250aAogICAgaWYgREFZIGluIGZpbGxpbmc6CiAgICAgICAgc3RhcnRfdHVwbGUucm1fZGF5ID0gdG9kYXkuZGF5CiAgICByZXR1cm4gW2ludCh0aW1lLm1rdGltZShzdGFydF90dXBsZSkpICogMTAwMCwgcmVzb2x1dGlvbl0KCgpkZWYgdGltZXN0YW1wX3JhbmdlKHRleHQpOgogICAgIiIiSWRlbnRpZmllcyByYW5nZSBpbiB0aGUgdGV4dCBnaXZlbi4gUmV0dXJucyAtMSBpZiB0aGUgcmFuZ2UgaGFzIG5vdCBiZWVuCiAgICBpZGVudGlmaWVkLiAgIiIiCgogICAgIyBQYXJzZSByYW5nZQogICAgbSA9IHJlLm1hdGNoKHInXihsYXN0KT9ccyooXGQrKT9ccyooc3xzZWN8c2Vjb25kfG18bWlufG1pbnV0ZXxofGhvdXJ8ZHxkYXl8bW9ufG1vbnRofHl8eWVhcilzPyQnLCB0ZXh0LnN0cmlwKCkpCiAgICBpZiBub3QgbToKICAgICAgICByZXR1cm4gLTEKICAgIGNvdW50ID0gbS5ncm91cCgyKSAgIyBDb3VudCBvZiB0aW1lIGZyYW1lcwogICAgdGYgPSBtLmdyb3VwKDMpICAjIFRpbWUgZnJhbWUKICAgICMgR2V0IGNvdW50CiAgICBpZiBjb3VudDoKICAgICAgICBjb3VudCA9IGludChjb3VudCkKICAgIGVsc2U6CiAgICAgICAgY291bnQgPSAxCiAgICAjIEdldCB0aW1lIGZyYW1lCiAgICBmX2dyb3VwcyA9IFsKICAgICAgICBbWydzJywgJ3NlYycsICdzZWNvbmQnXSwgU0VDXSwKICAgICAgICBbWydtJywgJ21pbicsICdtaW51dGUnXSwgTUlOXSwKICAgICAgICBbWydoJywgJ2hvdXInXSwgSE9VUl0sCiAgICAgICAgW1snZCcsICdkYXknXSwgREFZXSwKICAgICAgICBbWydtb24nLCAnbW9udGgnXSwgTU9OXSwKICAgICAgICBbWyd5JywgJ3llYXInXSwgWUVBUl0sCiAgICBdCiAgICBmb3IgdGcgaW4gZl9ncm91cHM6CiAgICAgICAgaWYgdGYgaW4gdGdbMF06CiAgICAgICAgICAgIHJldHVybiBjb3VudCAqIHRnWzFdCiAgICByZXR1cm4gLTEKCgpkZWYgcGFyc2VfdGltZXN0YW1wX3JhbmdlKHRleHQpOgogICAgIiIiUGFyc2VzIHRoZSB0aW1lIHJhbmdlIGdpdmVuIGFuZCByZXR1cm4gc3RhcnQtZW5kIHBhaXIgb2YgdGltZXN0YW1wcy4KCiAgICBSZWNvZ25pemVkIHN0cnVjdHVyZXMgYXJlOgogICAgdHx0b2RheQogICAgeXx5ZXN0ZXJkYXkKICAgIGxhc3Q/IFxcZCogKG18bWlufG1pbnV0ZXxofGhvdXJ8ZHxkYXl8bW9ufG1vbnRofHl8eWVhcikgcz8KICAgIHJhbmdlCiAgICBkYXRldGltZQogICAgZGF0ZXRpbWUgLT4gcmFuZ2UKICAgIGRhdGV0aW1lIC0+IGRhdGV0aW1lCiAgICAiIiIKCiAgICB0ZXh0ID0gdGV4dC5zdHJpcCgpCiAgICAjIE5vIHRpbWUgZnJhbWUKICAgIGlmIHRleHQgPT0gJyc6CiAgICAgICAgcmV0dXJuIFswLCA5MjIzMzcyMDM2ODU0Nzc1ODA3XQoKICAgICMgRGF5IHNwZWMKICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICBpZiB0ZXh0IGluIFsndCcsICd0b2RheSddOgogICAgICAgIHRvZGF5ID0gaW50KHRpbWUubWt0aW1lKGRhdGV0aW1lLmRhdGV0aW1lKG5vdy55ZWFyLCBub3cubW9udGgsIG5vdy5kYXkpLnRpbWV0dXBsZSgpKSkgKiAxMDAwCiAgICAgICAgcmV0dXJuIFt0b2RheSwgdG9kYXkgKyBEQVldCiAgICBpZiB0ZXh0IGluIFsneScsICd5ZXN0ZXJkYXknXToKICAgICAgICB5ZXN0ZXJkYXkgPSBpbnQodGltZS5ta3RpbWUoCiAgICAgICAgICAgIChkYXRldGltZS5kYXRldGltZShub3cueWVhciwgbm93Lm1vbnRoLCBub3cuZGF5KSAtCiAgICAgICAgICAgIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpKS50aW1ldHVwbGUoKSkpICogMTAwMAogICAgICAgIHJldHVybiBbeWVzdGVyZGF5LCB5ZXN0ZXJkYXkgKyBEQVldCgogICAgIyBSYW5nZSBzcGVjCiAgICBwYXJ0cyA9IHRleHQuc3BsaXQoJy0+JykKICAgIHIgPSB0aW1lc3RhbXBfcmFuZ2UocGFydHNbMF0pCiAgICBpZiAociAhPSAtMSBhbmQgbGVuKHBhcnRzKSA+IDEpIG9yIGxlbihwYXJ0cykgPiAyOgogICAgICAgIGRpZSgiRXJyb3I6IERhdGUgYW5kIHJhbmdlICclcycgaGFzIGludmFsaWQgc3RydWN0dXJlIiAlIHRleHQpCiAgICBpZiByICE9IC0xOgogICAgICAgIG5vdyA9IGludCh0aW1lLnRpbWUoKSAqIDEwMDApCiAgICAgICAgcmV0dXJuIFtub3cgLSByLCBub3ddCgogICAgIyBEYXRlIHNwZWMKICAgIHN0YXJ0X2dyb3VwID0gdGltZXN0YW1wX2dyb3VwKHBhcnRzWzBdKQogICAgc3RhcnQgPSBzdGFydF9ncm91cFswXQogICAgZW5kID0gc3RhcnQgKyBzdGFydF9ncm91cFsxXQoKICAgIGlmIGxlbihwYXJ0cykgPiAxOgogICAgICAgIGVuZF9yYW5nZSA9IHRpbWVzdGFtcF9yYW5nZShwYXJ0c1sxXSkKICAgICAgICBpZiBlbmRfcmFuZ2UgIT0gLTE6CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgZW5kX3JhbmdlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW5kX2dyb3VwID0gdGltZXN0YW1wX2dyb3VwKHBhcnRzWzFdKQogICAgICAgICAgICBlbmQgPSBlbmRfZ3JvdXBbMF0gKyBlbmRfZ3JvdXBbMV0KCiAgICByZXR1cm4gW3N0YXJ0LCBlbmRdCgoKZGVmIGNob29zZV9hY2NvdW50X2tleShhY2NvdW50cyk6CiAgICAiIiIKICAgIEFsbG93cyB1c2VyIHRvIHNlbGVjdCB0aGUgcmlnaHQgYWNjb3VudC4KICAgICIiIgogICAgaWYgbGVuKGFjY291bnRzKSA9PSAwOgogICAgICAgIGRpZSgnTm8gYWNjb3VudCBpcyBhc3NvY2lhdGVkIHdpdGggeW91ciBwcm9maWxlLiBMb2cgaW4gdG8gTG9nZW50cmllcyB0byBjcmVhdGUgYSBuZXcgYWNjb3VudC4nKQogICAgaWYgbGVuKGFjY291bnRzKSA9PSAxOgogICAgICAgIHJldHVybiBhY2NvdW50c1swXVsnYWNjb3VudF9rZXknXQoKICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihhY2NvdW50cykpOgogICAgICAgIGFjY291bnQgPSBhY2NvdW50c1tpXQogICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsICdbJXNdICVzICVzJyAlICgKICAgICAgICAgICAgaSwgYWNjb3VudFsnYWNjb3VudF9rZXknXVs6OF0sIGFjY291bnRbJ25hbWUnXSkKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZWN0aW9uID0gaW50KHJhd19pbnB1dCgnUGljayBhY2NvdW50IHlvdSB3b3VsZCBsaWtlIHRvIHVzZTogJykpCiAgICAgICAgICAgIGlmIHNlbGVjdGlvbiBpbiByYW5nZSgwLCBsZW4oYWNjb3VudHMpKToKICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50c1tzZWxlY3Rpb25dWydhY2NvdW50X2tleSddCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnSW52YWxpZCBjaG9pY2UuIFBsZWFzZSB0cnkgYWdhaW4gb3IgYnJlYWsgd2l0aCBDdHJsK0MuJwoKCmRlZiByZXRyaWV2ZV9hY2NvdW50X2tleSgpOgogICAgIiIiCiAgICBSZXRyaWV2ZXMgYWNjb3VudCBrZXlzIGZyb20gdGhlIHdlYiBzZXJ2ZXIuCiAgICAiIiIKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VybmFtZSA9IHJhd19pbnB1dCgnRW1haWw6ICcpCiAgICAgICAgICAgIHBhc3N3b3JkID0gZ2V0cGFzcy5nZXRwYXNzKCkKICAgICAgICAgICAgYyA9IGRvbWFpbl9jb25uZWN0KGNvbmZpZywgRG9tYWluLk1BSU4sIERvbWFpbikKICAgICAgICAgICAgYy5yZXF1ZXN0KCdQT1NUJywgQUNDT1VOVF9LRVlTX0FQSSwKICAgICAgICAgICAgICAgICAgICAgIHVybGxpYi51cmxlbmNvZGUoeyd1c2VybmFtZSc6IHVzZXJuYW1lLCAncGFzc3dvcmQnOiBwYXNzd29yZH0pLAogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICdSZWZlcmVyJzogJ2h0dHBzOi8vbG9nZW50cmllcy5jb20vbG9naW4vJywKICAgICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsCiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICByZXNwb25zZSA9IGMuZ2V0cmVzcG9uc2UoKQogICAgICAgICAgICBpZiBub3QgcmVzcG9uc2Ugb3IgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMDoKICAgICAgICAgICAgICAgIHJlc3BfdmFsID0gJ2VycicKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlOgogICAgICAgICAgICAgICAgICAgIHJlc3BfdmFsID0gcmVzcG9uc2Uuc3RhdHVzCiAgICAgICAgICAgICAgICBpZiByZXNwX3ZhbCA9PSA0MDM6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgJ0Vycm9yOiBMb2dpbiBmYWlsZWQuIEludmFsaWQgY3JlZGVudGlhbHMuJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnRXJyb3I6IFVuZXhwZWN0ZWQgbG9naW4gcmVzcG9uc2UgZnJvbSBsb2dlbnRyaWVzICglcykuJyAlIHJlc3BfdmFsCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkYXRhID0ganNvbl9sb2FkcyhyZXNwb25zZS5yZWFkKCkpCiAgICAgICAgICAgICAgICByZXR1cm4gY2hvb3NlX2FjY291bnRfa2V5KGRhdGFbJ2FjY291bnRzJ10pCiAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvciwgbXNnOgogICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnRXJyb3I6IENhbm5vdCBjb250YWN0IHNlcnZlciwgJXMnICUgbXNnCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3IsIG1zZzoKICAgICAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgJ0Vycm9yOiBJbnZhbGlkIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciAoUGFyc2luZyBlcnJvciAlcyknICUgbXNnCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnRXJyb3I6IEludmFsaWQgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLCB1c2VyIGtleSBub3QgcHJlc2VudC4nCiAgICAgICAgZXhjZXB0IEVPRkVycm9yOgogICAgICAgICAgICAjIEN0cmwrRCBpbiBnZXRfcGFzcywgc2ltdWxhdGUgQ3RybCtDCiAgICAgICAgICAgIHJhaXNlIEtleWJvYXJkSW50ZXJydXB0KCkKCiAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgJ1RyeSB0byBsb2cgaW4gYWdhaW4sIG9yIHByZXNzIEN0cmwrQyB0byBicmVhaycKCgpjbGFzcyBTdGF0cyhvYmplY3QpOgoKICAgICIiIkNvbGxlY3RzIHN0YXRpc3RpY3MgYWJvdXQgdGhlIHN5c3RlbSB3b3JrIGxvYWQuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi50aW1lciA9IE5vbmUKICAgICAgICBzZWxmLnRvX3JlbW92ZSA9IEZhbHNlCiAgICAgICAgc2VsZi5maXJzdCA9IFRydWUKCiAgICAgICAgIyBNZW1vcnkgZmllbGRzIHdlIGFyZSBsb29raW5nIGZvciBpbiAvcHJvYy9tZW1pbmZvCiAgICAgICAgc2VsZi5NRU1fRklFTERTID0gWydNZW1Ub3RhbDonLCAnQWN0aXZlOicsICdDYWNoZWQ6J10KICAgICAgICAjIEJsb2NrIGRldmljZXMgaW4gdGhlIHN5c3RlbQogICAgICAgIGFsbF9kZXZpY2VzID0gW29zLnBhdGguYmFzZW5hbWUoZmlsZW5hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgZm9yIGZpbGVuYW1lIGluIGdsb2IuZ2xvYihTWVNfQkxPQ0tfREVWICsgJy8qJyldCiAgICAgICAgIyBNb25pdG9yZWQgZGV2aWNlcyAoYWxsIGRldmljZXMgZXhjZXB0IGxvb3ApCiAgICAgICAgc2VsZi5vdXJfZGV2aWNlcyA9IGZyb3plbnNldChbZGV2aWNlX25hbWUgZm9yIGRldmljZV9uYW1lIGluIGFsbF9kZXZpY2VzIGlmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90IGRldmljZV9uYW1lLnN0YXJ0c3dpdGgoImxvb3AiKSBhbmQgbm90IGRldmljZV9uYW1lLnN0YXJ0c3dpdGgoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyYW0iKSBhbmQgbm90IGRldmljZV9uYW1lLnN0YXJ0c3dpdGgoIm1kIildKQoKICAgICAgICBzZWxmLnByZXZfY3B1X3N0YXRzID0gWzAsIDAsIDAsIDAsIDAsIDAsIDBdCiAgICAgICAgc2VsZi5wcmV2X2Rpc2tfc3RhdHMgPSBbMCwgMF0KICAgICAgICBzZWxmLnByZXZfbmV0X3N0YXRzID0gWzAsIDBdCiAgICAgICAgc2VsZi50b3RhbCA9IHt9CiAgICAgICAgc2VsZi50b3RhbFsnZHInXSA9IDAKICAgICAgICBzZWxmLnRvdGFsWydkdyddID0gMAogICAgICAgIHNlbGYudG90YWxbJ25pJ10gPSAwCiAgICAgICAgc2VsZi50b3RhbFsnbm8nXSA9IDAKCiAgICAgICAgc2VsZi5wcm9jZmlsZXN5c3RlbSA9IFRydWUKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoQ1BVU1RBVFNfRklMRSk6CiAgICAgICAgICAgICMgc3RvcmUgc3lzdGVtIHR5cGUgZm9yIGxhdGVyIHJlZmVyZW5jZSBpbiBwdWxsaW5nIHN0YXRzCiAgICAgICAgICAgICMgaW4gYW4gYWx0ZXJuYXRlIG1hbm5lcgogICAgICAgICAgICBzZWxmLnByb2NmaWxlc3lzdGVtID0gRmFsc2UKICAgICAgICAgICAgc2VsZi51bmFtZSA9IHBsYXRmb3JtLnVuYW1lKCkKICAgICAgICAgICAgc2VsZi5zeXMgPSBzZWxmLnVuYW1lWzBdCiAgICAgICAgICAgIGxvZy5kZWJ1Zygnc3lzOiAlcycsIHNlbGYuc3lzKQoKICAgICAgICAjIGZvciBzY2FsaW5nIGluIG9zeF90b3Bfc3RhdHMgLS0ga2V5IGlzIGEgc2NhbGUgZmFjdG9yIChnaWcsCiAgICAgICAgIyBtZWcsIGV0YyksIHZhbHVlIGlzIHdoYXQgdG8gbXVsdGlwbHkgYnkgdG8gZ2V0IHRvIGtpbG9ieXRlcwogICAgICAgIHNlbGYuc2NhbGUya2IgPSB7J00nOiAxMDI0LCAnRyc6IDEwNDg1NzZ9CgogICAgICAgIGlmIG5vdCBjb25maWcuZGVidWdfbm9zdGF0czoKICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAjIE5ldyBzdGF0cyB3aWxsIGdvIGhlcmUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2F2ZV9kYXRhKGRhdGEsIG5hbWUsIHZhbHVlKToKICAgICAgICAiIiIKICAgICAgICBTYXZlcyB0aGUgdmFsdWUgdW5kZXIgdGhlIG5hbWUgZ2l2ZW4uIE5lZ2F0aXZlIHZhbHVlcyBhcmUgc2V0IHRvIDAuCiAgICAgICAgIiIiCiAgICAgICAgaWYgdmFsdWUgPj0gMDoKICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGF0YVtuYW1lXSA9IDAKCiAgICBkZWYgY3B1X3N0YXRzKHNlbGYsIGRhdGEpOgogICAgICAgICIiIgogICAgICAgIENvbGxlY3RzIENQVSBzdGF0aXN0aWNzLiBWaXJ0dWFsIHRpY2tzIGFyZSBpZ25vcmVkLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZWlucHV0LmlucHV0KFtDUFVTVEFUU19GSUxFXSk6CiAgICAgICAgICAgICAgICBpZiBsZW4obGluZSkgPCAxMzoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKCdjcHUgJyk6CiAgICAgICAgICAgICAgICAgICAgcmF3X3N0YXRzID0gW2xvbmcocGFydCkgZm9yIHBhcnQgaW4gbGluZS5zcGxpdCgpWzE6OF1dCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZmlsZWlucHV0LmNsb3NlKCkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjdScsIHJhd19zdGF0c1swXSAtIHNlbGYucHJldl9jcHVfc3RhdHNbMF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NsJywgcmF3X3N0YXRzWzFdIC0gc2VsZi5wcmV2X2NwdV9zdGF0c1sxXSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3MnLCByYXdfc3RhdHNbMl0gLSBzZWxmLnByZXZfY3B1X3N0YXRzWzJdKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjaScsIHJhd19zdGF0c1szXSAtIHNlbGYucHJldl9jcHVfc3RhdHNbM10pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NpbycsIHJhd19zdGF0c1s0XSAtIHNlbGYucHJldl9jcHVfc3RhdHNbNF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NxJywgcmF3X3N0YXRzWzVdIC0gc2VsZi5wcmV2X2NwdV9zdGF0c1s1XSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3NxJywgcmF3X3N0YXRzWzZdIC0gc2VsZi5wcmV2X2NwdV9zdGF0c1s2XSkKICAgICAgICBzZWxmLnByZXZfY3B1X3N0YXRzID0gcmF3X3N0YXRzCgogICAgZGVmIGRpc2tfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgQ29sbGVjdHMgZGlzayBzdGF0aXN0aWNzLiBJbnRlcmVzdGVkIGluIGJsb2NrIGRldmljZXMgb25seS4KICAgICAgICAiIiIKICAgICAgICByZWFkcyA9IDBMCiAgICAgICAgd3JpdGVzID0gMEwKICAgICAgICAjIEZvciBhbGwgYmxvY2sgZGV2aWNlcwogICAgICAgIGZvciBkZXZpY2UgaW4gc2VsZi5vdXJfZGV2aWNlczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBSZWFkIGRldmljZSBzdGF0cwogICAgICAgICAgICAgICAgZiA9IG9wZW4oU1lTX0JMT0NLX0RFViArIGRldmljZSArICcvc3RhdCcsICdyJykKICAgICAgICAgICAgICAgIGxpbmUgPSBmLnJlYWQoKQogICAgICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgUGFyc2UgZGV2aWNlIHN0YXRzCiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCA3OgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgcmVhZHMgKz0gbG9uZyhwYXJ0c1syXSkKICAgICAgICAgICAgd3JpdGVzICs9IGxvbmcocGFydHNbNl0pCgogICAgICAgIHJlYWRzICo9IDUxMgogICAgICAgIHdyaXRlcyAqPSA1MTIKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnZHInLCByZWFkcyAtIHNlbGYucHJldl9kaXNrX3N0YXRzWzBdKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdkdycsIHdyaXRlcyAtIHNlbGYucHJldl9kaXNrX3N0YXRzWzFdKQogICAgICAgIHNlbGYucHJldl9kaXNrX3N0YXRzID0gW3JlYWRzLCB3cml0ZXNdCiAgICAgICAgc2VsZi50b3RhbFsnZHInXSA9IHJlYWRzCiAgICAgICAgc2VsZi50b3RhbFsnZHcnXSA9IHdyaXRlcwoKICAgIGRlZiBtZW1fc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgQ29sbGVjdHMgbWVtb3J5IHN0YXRpc3RpY3MuCiAgICAgICAgIiIiCiAgICAgICAgbWVtX3ZhcnMgPSB7fQogICAgICAgIGZvciBmaWVsZCBpbiBzZWxmLk1FTV9GSUVMRFM6CiAgICAgICAgICAgIG1lbV92YXJzW2ZpZWxkXSA9IDBMCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlaW5wdXQuaW5wdXQoW01FTVNUQVRTX0ZJTEVdKToKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICBuYW1lID0gcGFydHNbMF0KICAgICAgICAgICAgICAgIGlmIG5hbWUgaW4gc2VsZi5NRU1fRklFTERTOgogICAgICAgICAgICAgICAgICAgIG1lbV92YXJzW25hbWVdID0gbG9uZyhwYXJ0c1sxXSkKICAgICAgICAgICAgZmlsZWlucHV0LmNsb3NlKCkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ210JywgbWVtX3ZhcnNbc2VsZi5NRU1fRklFTERTWzBdXSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbWEnLCBtZW1fdmFyc1tzZWxmLk1FTV9GSUVMRFNbMV1dKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdtYycsIG1lbV92YXJzW3NlbGYuTUVNX0ZJRUxEU1syXV0pCgogICAgZGVmIG5ldF9zdGF0cyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBDb2xsZWN0cyBuZXR3b3JrIHN0YXRpc3RpY3MuIENvbGxlY3Rpbmcgb25seSBzZWxlY3RlZCBpbnRlcmZhY2VzLgogICAgICAgICIiIgogICAgICAgIHJlY2VpdmUgPSAwTAogICAgICAgIHRyYW5zbWl0ID0gMEwKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGVpbnB1dC5pbnB1dChbTkVUU1RBVFNfRklMRV0pOgogICAgICAgICAgICAgICAgaWYgbGluZVs6NV0gaW4gTkVUX0RFVklDRVM6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnJlcGxhY2UoJzonLCAnICcpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICByZWNlaXZlICs9IGxvbmcocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgdHJhbnNtaXQgKz0gbG9uZyhwYXJ0c1s5XSkKICAgICAgICAgICAgZmlsZWlucHV0LmNsb3NlKCkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICduaScsIHJlY2VpdmUgLSBzZWxmLnByZXZfbmV0X3N0YXRzWzBdKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdubycsIHRyYW5zbWl0IC0gc2VsZi5wcmV2X25ldF9zdGF0c1sxXSkKICAgICAgICBzZWxmLnByZXZfbmV0X3N0YXRzID0gW3JlY2VpdmUsIHRyYW5zbWl0XQogICAgICAgIHNlbGYudG90YWxbJ25pJ10gPSByZWNlaXZlCiAgICAgICAgc2VsZi50b3RhbFsnbm8nXSA9IHRyYW5zbWl0CgogICAgZGVmIG9zeF90b3Bfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgRGFyd2luL09TLVggZG9lc24ndCBzZWVtIHRvIHByb3ZpZGUgbmVhcmx5IHRoZSBzYW1lIGFtb3VudCBvZgogICAgICAgIGRldGFpbCBhcyB0aGUgL3Byb2MgZmlsZXN5c3RlbSB1bmRlciBMaW51eCAtLSBhdCBsZWFzdCBub3QKICAgICAgICBlYXNpbHkgYWNjZXNzaWJsZSB0byB0aGUgY29tbWFuZCBsaW5lLiAgVGhlIGhlYWRlcnMgZnJvbQogICAgICAgIHRvcCgxKSBzZWVtIHRvIGJlIHRoZSBxdWlja2VzdCAmIG1vc3QgZGV0YWlsZWQgc291cmNlIG9mIGRhdGEKICAgICAgICBhYm91dCBDUFUsIGFuZCBkaXNrIHRyYW5zZmVyIGFzIHNlcGFyYXRlZCBpbnRvIHJlYWRzICYgd3JpdGVzLgogICAgICAgICh2cy4gaW9zdGF0LCB3aGljaCBzaG93cyBDUFUgbGVzcyBncmFudWxhcmx5OyBpdCBzaG93cyBtb3JlCiAgICAgICAgIGRldGFpbCBhYm91dCBwZXItZGlzayBJTywgYnV0IGRvZXMgbm90IHNwbGl0IElPIGludG8gcmVhZHMgYW5kCiAgICAgICAgIHdyaXRlcykKCiAgICAgICAgRnJ1c3RyYXRpbmdseSwgdGhlIGxldmVsIG9mIHBlci1kaXNrIHN0YXRpc3RpY3MgZnJvbSB0b3AgaXMKICAgICAgICBpbmNyZWRpYmx5IHVuLWdyYW51bGFyCgogICAgICAgIFdlJ2xsIGdldCBwaHlzaWNhbCBtZW1vcnkgZGV0YWlscyBmcm9tIGhlcmUgdG9vCiAgICAgICAgIiIiCiAgICAgICAgY3B1cmUgPSByZS5jb21waWxlKHInQ1BVIHVzYWdlOlxzKyhbXGQuXSspXCUgdXNlciwgKFtcZC5dKylcJSBzeXMsICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgcicoW1xkLl0rKVwlIGlkbGUnKQogICAgICAgIG1lbXJlID0gcmUuY29tcGlsZShyJ1BoeXNNZW06XHMrKFxkK1x3Kykgd2lyZWQsICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgcicoXGQrXHcrKSBhY3RpdmUsIChcZCtcdyspIGluYWN0aXZlLCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHInKFxkK1x3KykgdXNlZCwgKFxkK1x3KykgZnJlZS4nKQogICAgICAgIGRpc2tyZSA9IHJlLmNvbXBpbGUocidEaXNrczogKFxkKykvKFxkK1x3KykgcmVhZCwgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcicoXGQrKS8oXGQrXHcrKSB3cml0dGVuLicpCgogICAgICAgICMgc2NhbGluZyByb3V0aW5lIGZvciB1c2UgaW4gbWFwKCkgbGF0ZXIKICAgICAgICBkZWYgc2NhbGV0b2tiKHZhbHVlKToKICAgICAgICAgICAgIyB0YWtlIGEgdmFsdWUgbGlrZSAxMjA5TSBvciAxMEcgYW5kIHJldHVybiBhbiBpbnRlZ2VyCiAgICAgICAgICAgICMgcmVwcmVzZW50aW5nIHRoZSB2YWx1ZSBpbiBraWxvYnl0ZXMKCiAgICAgICAgICAgIChzaXplLCBzY2FsZSkgPSByZS5zcGxpdCgnKFtBLXpdKyknLCB2YWx1ZSlbOjJdCiAgICAgICAgICAgIHNpemUgPSBpbnQoc2l6ZSkKICAgICAgICAgICAgaWYgc2NhbGU6CiAgICAgICAgICAgICAgICBpZiBzY2FsZSBpbiBzZWxmLnNjYWxlMmtiOgogICAgICAgICAgICAgICAgICAgIHNpemUgKj0gc2VsZi5zY2FsZTJrYltzY2FsZV0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoIkVycm9yOiB2YWx1ZSBpbiAlcyBleHByZXNzZWQgaW4gIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaW1lbnNpb24gSSBjYW4ndCB0cmFuc2xhdGUgdG8ga2I6ICVzICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lLCBzaXplLCBzY2FsZSkKICAgICAgICAgICAgcmV0dXJuIHNpemUKCiAgICAgICAgIyB0aGUgZmlyc3Qgc2V0IG9mICd0b3AnIGhlYWRlcnMgZGlzcGxheSBhdmVyYWdlIHZhbHVlcyBvdmVyCiAgICAgICAgIyBzeXN0ZW0gdXB0aW1lLiAgc28gd2Ugb25seSB3YW50IHRvIHJlYWQgdGhlIHNlY29uZCBzZXQgdGhhdCB3ZQogICAgICAgICMgc2VlLgogICAgICAgIHRvcHBhc3MgPSAwCgogICAgICAgICMgd2Ugc2hvdWxkIHJlYWxseSBkbyB0aGlzIGZpcnN0LCBzbyB0aGF0IHdlIGRvbid0IHdhc3RlIGFueSB0aW1lCiAgICAgICAgIyBpZiB0b3AgZmFpbHMgdG8gd29yay4gIGhvd2V2ZXIsIGl0ICdyZWFkcycgYmV0dGVyIGF0IHRoaXMgcG9pbnQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHByb2MgPSBzdWJwcm9jZXNzLlBvcGVuKFsndG9wJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctaScsICcyJywgJy1sJywgJzInLCAnLW4nLCAnMCddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGZvciBsaW5lIGluIHByb2Muc3Rkb3V0OgogICAgICAgICAgICAjIHNraXAgdGhlIGZpcnN0IG91dHB1dAogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoJ1Byb2Nlc3NlczogJyk6CiAgICAgICAgICAgICAgICB0b3BwYXNzICs9IDEKICAgICAgICAgICAgZWxpZiBsaW5lLnN0YXJ0c3dpdGgoJ0NQVSB1c2FnZTogJykgYW5kIHRvcHBhc3MgPT0gMjoKICAgICAgICAgICAgICAgIGNwdXJlc3VsdCA9IGNwdXJlLm1hdGNoKGxpbmUpCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIHRoZSBkYXRhIHdlIHNlbmQgdG8gbG9nZW50cmllcyBpcyBleHBlY3RlZCB0byBiZSBpbiB0ZXJtcwogICAgICAgICAgICAgICAgb2YgY2VudGlzZWNvbmRzIG9mICh1c2VyL3N5c3RlbS9pZGxlL2V0YykgdGltZSBhcyBhbGwgd2UKICAgICAgICAgICAgICAgIGhhdmUgaXMgJSwgbXVsdGlwbHkgdGhhdCAlIGJ5IHRoZSBFUE9DSCBhbmQgMTAwLgogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICBpZiBjcHVyZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgKGN1LCBjcywgY2kpID0gbWFwKGxhbWJkYSB4OiBpbnQoZmxvYXQoeCkgKiAxMDAgKiBFUE9DSCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNwdXJlc3VsdC5ncm91cCgxLCAyLCAzKSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3UnLCBjdSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3MnLCBjcykKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2knLCBjaSkKICAgICAgICAgICAgICAgICAgICAjIHNlbmQgemVybyBpbiBjYXNlIGFsbCBtdXN0IGJlIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2wnLCAwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjaW8nLCAwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjcScsIDApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NzcScsIDApCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogY291bGQgbm90IHBhcnNlIENQVSBzdGF0cyAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluIHRvcCBvdXRwdXQgbGluZSAlcyIsIGxpbmUpCgogICAgICAgICAgICBlbGlmIGxpbmUuc3RhcnRzd2l0aCgnUGh5c01lbTogJykgYW5kIHRvcHBhc3MgPT0gMjoKICAgICAgICAgICAgICAgICIiIgogICAgICAgICAgICAgICAgT1MtWCBoYXMgbm8gZml4ZWQgY2FjaGUgc2l6ZSAtLSBjYWNoZWQgcGFnZXMgYXJlIHN0b3JlZCBpbgogICAgICAgICAgICAgICAgdmlydHVhbCBtZW1vcnkgYXMgcGFydCBvZiB0aGUgVW5pZmllZCBCdWZmZXIgQ2FjaGUuICBJdAogICAgICAgICAgICAgICAgd291bGQgYXBwZWFyIHRvIGJlIG5lYXJseSBpbXBvc3NpYmxlIHRvIGZpbmQgb3V0IHdoYXQgdGhlCiAgICAgICAgICAgICAgICBjdXJyZW50IHNpemUgb2YgdGhlIFVCQyBpcywgc2F2ZSBydW5uaW5nIHB1cmdlKDgpIGFuZAogICAgICAgICAgICAgICAgY29tcGFyaW5nIHRoZSB2YWx1ZXMgYmVmb3JlIGFuZCBhZnRlciAtLSBVQkMgdW5jZXJ0YWludHkKICAgICAgICAgICAgICAgIHByaW5jaXBhbD8gOi0pCgogICAgICAgICAgICAgICAgaHR0cDovL3dhZ2VybGFicy5jb20vYmxvZy8yMDA4LzAzLzA0L2hhY2tpbmctdGhlLW1hYy1vc3gtdW5pZmllZC1idWZmZXItY2FjaGUvCiAgICAgICAgICAgICAgICBib29rcy5nb29nbGUuaWUvYm9va3M/aXNibj0wMTMyNzAyMjY2CiAgICAgICAgICAgICAgICBodHRwOi8vcmV2aWV3cy5jbmV0LmNvbS84MzAxLTEzNzI3XzctNTczNzIyNjctMjYzL3B1cmdlLXRoZS1vcy14LWRpc2stY2FjaGUtdG8tYW5hbHl6ZS1tZW1vcnktdXNhZ2UvCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIG1lbXJlc3VsdCA9IG1lbXJlLm1hdGNoKGxpbmUpCiAgICAgICAgICAgICAgICBpZiBtZW1yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgIyBsb2dlbnRyaWVzIGlzIGV4cGVjdGluZyB2YWx1ZXMgaW4ga2lsb2J5dGVzCiAgICAgICAgICAgICAgICAgICAgKHdpcmVkLCBhY3RpdmUsIGluYWN0aXZlLCB1c2VkLCBmcmVlKSA9IG1hcCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGV0b2tiLCBtZW1yZXN1bHQuZ3JvdXAoMSwgMiwgMywgNCwgNSkpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ210JywgdXNlZCArIGZyZWUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ21hJywgYWN0aXZlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdtYycsIDApCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogY291bGQgbm90IHBhcnNlIG1lbW9yeSBzdGF0cyAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluIHRvcCBvdXRwdXQgbGluZSAlcyIsIGxpbmUpCgogICAgICAgICAgICBlbGlmIGxpbmUuc3RhcnRzd2l0aCgnRGlza3M6ICcpIGFuZCB0b3BwYXNzID09IDI6CiAgICAgICAgICAgICAgICBkaXNrcmVzdWx0ID0gZGlza3JlLm1hdGNoKGxpbmUpCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIHRoZSBkYXRhIHdlIHNlbmQgdG8gbG9nZW50cmllcyBpcyBleHBlY3RlZCB0byBiZSBpbiBieXRlcwogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICBpZiBkaXNrcmVzdWx0OgogICAgICAgICAgICAgICAgICAgIChyZWFkcywgd3JpdGVzKSA9IG1hcChzY2FsZXRva2IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2tyZXN1bHQuZ3JvdXAoMiwgNCkpCiAgICAgICAgICAgICAgICAgICAgcmVhZHMgKj0gMTAyNAogICAgICAgICAgICAgICAgICAgIHdyaXRlcyAqPSAxMDI0CgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdkcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZHMgLSBzZWxmLnByZXZfZGlza19zdGF0c1swXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnZHcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlcyAtIHNlbGYucHJldl9kaXNrX3N0YXRzWzFdKQogICAgICAgICAgICAgICAgICAgIHNlbGYucHJldl9kaXNrX3N0YXRzID0gW3JlYWRzLCB3cml0ZXNdCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogY291bGQgbm90IHBhcnNlIGRpc2sgc3RhdHMgIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbiB0b3Agb3V0cHV0IGxpbmUgJXMiLCBsaW5lKQoKICAgIGRlZiBzdW5vc190b3Bfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgU3VuT1MvU21hcnRPUyBkb2Vzbid0IHNlZW0gdG8gcHJvdmlkZSBuZWFybHkgdGhlIHNhbWUgYW1vdW50IG9mCiAgICAgICAgZGV0YWlsIGFzIHRoZSAvcHJvYyBmaWxlc3lzdGVtIHVuZGVyIExpbnV4IC0tIGF0IGxlYXN0IG5vdAogICAgICAgIGVhc2lseSBhY2Nlc3NpYmxlIHRvIHRoZSBjb21tYW5kIGxpbmUuICBUaGUgaGVhZGVycyBmcm9tCiAgICAgICAgdG9wKDEpIHNlZW0gdG8gYmUgdGhlIHF1aWNrZXN0ICYgbW9zdCBkZXRhaWxlZCBzb3VyY2Ugb2YgZGF0YQogICAgICAgIGFib3V0IENQVSwgYW5kIGRpc2sgdHJhbnNmZXIgYXMgc2VwYXJhdGVkIGludG8gcmVhZHMgJiB3cml0ZXMuCiAgICAgICAgKHZzLiBpb3N0YXQsIHdoaWNoIHNob3dzIENQVSBsZXNzIGdyYW51bGFybHk7IGl0IHNob3dzIG1vcmUKICAgICAgICAgZGV0YWlsIGFib3V0IHBlci1kaXNrIElPLCBidXQgZG9lcyBub3Qgc3BsaXQgSU8gaW50byByZWFkcyBhbmQKICAgICAgICAgd3JpdGVzKQoKICAgICAgICBGcnVzdHJhdGluZ2x5LCB0aGUgbGV2ZWwgb2YgcGVyLWRpc2sgc3RhdGlzdGljcyBmcm9tIHRvcCBpcwogICAgICAgIGluY3JlZGlibHkgdW4tZ3JhbnVsYXIKCiAgICAgICAgV2UnbGwgZ2V0IHBoeXNpY2FsIG1lbW9yeSBkZXRhaWxzIGZyb20gaGVyZSB0b28KICAgICAgICAiIiIKICAgICAgICBjcHVyZSA9IHJlLmNvbXBpbGUocidDUFUgc3RhdGVzOlxzKyhbXGQuXSspXCUgaWRsZSxccysoW1xkLl0rKVwlIHVzZXIsXHMrJwogICAgICAgICAgICAgICAgICAgICAgICAgICByJyhbXGQuXSspXCUga2VybmVsLFxzKyhbXGQuXSspXCUgaW93YWl0JykKICAgICAgICBtZW1yZSA9IHJlLmNvbXBpbGUocidNZW1vcnk6XHMrKFxkK1x3KykgcGh5cyBtZW0sIChcZCtcdyspIGZyZWUgbWVtLCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHInKFxkK1x3KykgdG90YWwgc3dhcCwgKFxkK1x3KykgZnJlZSBzd2FwJykKCiAgICAgICAgIyBzY2FsaW5nIHJvdXRpbmUgZm9yIHVzZSBpbiBtYXAoKSBsYXRlcgogICAgICAgIGRlZiBzY2FsZXRva2IodmFsdWUpOgogICAgICAgICAgICAjIHRha2UgYSB2YWx1ZSBsaWtlIDEyMDlNIG9yIDEwRyBhbmQgcmV0dXJuIGFuIGludGVnZXIKICAgICAgICAgICAgIyByZXByZXNlbnRpbmcgdGhlIHZhbHVlIGluIGtpbG9ieXRlcwoKICAgICAgICAgICAgKHNpemUsIHNjYWxlKSA9IHJlLnNwbGl0KCcoW0Etel0rKScsIHZhbHVlKVs6Ml0KICAgICAgICAgICAgc2l6ZSA9IGludChzaXplKQogICAgICAgICAgICBpZiBzY2FsZToKICAgICAgICAgICAgICAgIGlmIHNjYWxlIGluIHNlbGYuc2NhbGUya2I6CiAgICAgICAgICAgICAgICAgICAgc2l6ZSAqPSBzZWxmLnNjYWxlMmtiW3NjYWxlXQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2cud2FybmluZygiRXJyb3I6IHZhbHVlIGluICVzIGV4cHJlc3NlZCBpbiAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpbWVuc2lvbiBJIGNhbid0IHRyYW5zbGF0ZSB0byBrYjogJXMgJXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUsIHNpemUsIHNjYWxlKQogICAgICAgICAgICByZXR1cm4gc2l6ZQoKICAgICAgICAjIHRoZSBmaXJzdCBzZXQgb2YgJ3RvcCcgaGVhZGVycyBkaXNwbGF5IGF2ZXJhZ2UgdmFsdWVzIG92ZXIKICAgICAgICAjIHN5c3RlbSB1cHRpbWUuICBzbyB3ZSBvbmx5IHdhbnQgdG8gcmVhZCB0aGUgc2Vjb25kIHNldCB0aGF0IHdlCiAgICAgICAgIyBzZWUuCiAgICAgICAgdG9wcGFzcyA9IDAKCiAgICAgICAgIyB3ZSBzaG91bGQgcmVhbGx5IGRvIHRoaXMgZmlyc3QsIHNvIHRoYXQgd2UgZG9uJ3Qgd2FzdGUgYW55IHRpbWUKICAgICAgICAjIGlmIHRvcCBmYWlscyB0byB3b3JrLiAgaG93ZXZlciwgaXQgJ3JlYWRzJyBiZXR0ZXIgYXQgdGhpcyBwb2ludAogICAgICAgIHRyeToKICAgICAgICAgICAgcHJvYyA9IHN1YnByb2Nlc3MuUG9wZW4oWyd0b3AnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1pJywgJzInLCAnLWwnLCAnMicsICctbicsICcwJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZm9yIGxpbmUgaW4gcHJvYy5zdGRvdXQ6CiAgICAgICAgICAgICMgc2tpcCB0aGUgZmlyc3Qgb3V0cHV0CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnbG9hZCBhdmVyYWdlczogJyk6CiAgICAgICAgICAgICAgICB0b3BwYXNzICs9IDIKICAgICAgICAgICAgZWxpZiBsaW5lLnN0YXJ0c3dpdGgoJ0NQVSBzdGF0ZXM6ICcpIGFuZCB0b3BwYXNzID09IDI6CiAgICAgICAgICAgICAgICBjcHVyZXN1bHQgPSBjcHVyZS5tYXRjaChsaW5lKQogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICB0aGUgZGF0YSB3ZSBzZW5kIHRvIGxvZ2VudHJpZXMgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gdGVybXMKICAgICAgICAgICAgICAgIG9mIGNlbnRpc2Vjb25kcyBvZiAoaWRsZS91c2VyL2tlcm5lbC9ldGMpIHRpbWUgYXMgYWxsIHdlCiAgICAgICAgICAgICAgICBoYXZlIGlzICUsIG11bHRpcGx5IHRoYXQgJSBieSB0aGUgRVBPQ0ggYW5kIDEwMC4KICAgICAgICAgICAgICAgICIiIgogICAgICAgICAgICAgICAgaWYgY3B1cmVzdWx0OgogICAgICAgICAgICAgICAgICAgIChjaSwgY3UsIGNzLCBjaW8pID0gbWFwKGxhbWJkYSB4OiBpbnQoZmxvYXQoeCkgKiAxMDAgKiBFUE9DSCAqIDEwMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNwdXJlc3VsdC5ncm91cCgxLCAyLCAzLCA0KSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3UnLCBjdSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3MnLCBjcykKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2knLCBjaSkKICAgICAgICAgICAgICAgICAgICAjIHNlbmQgemVybyBpbiBjYXNlIGFsbCBtdXN0IGJlIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2wnLCAwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjaW8nLCBjaW8pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NxJywgMCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3NxJywgMCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoIkVycm9yOiBjb3VsZCBub3QgcGFyc2UgQ1BVIHN0YXRzICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW4gdG9wIG91dHB1dCBsaW5lICVzIiwgbGluZSkKCiAgICAgICAgICAgIGVsaWYgbGluZS5zdGFydHN3aXRoKCdNZW1vcnk6ICcpIGFuZCB0b3BwYXNzID09IDI6CiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIFRvcCBpcyBpbmFjY3VyYXRlIG9uIFNtYXJ0T1MgYW5kIHN0YXRlcyB0aGUgZnJlZSBtZW1vcnkgb2YKICAgICAgICAgICAgICAgIHRoZSBlbnRpcmUgbm9kZSwgcmF0aGVyIHRoYW4ganVzdCB0aGUgdmlydHVhbCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICIiIgogICAgICAgICAgICAgICAgbWVtcmVzdWx0ID0gbWVtcmUubWF0Y2gobGluZSkKICAgICAgICAgICAgICAgIGlmIG1lbXJlc3VsdDoKICAgICAgICAgICAgICAgICAgICAjIGxvZ2VudHJpZXMgaXMgZXhwZWN0aW5nIHZhbHVlcyBpbiBraWxvYnl0ZXMKICAgICAgICAgICAgICAgICAgICAodG90YWwsIGZhbHNlZnJlZSwgc3dhcCwgZnJlZXN3YXApID0gbWFwKAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZXRva2IsIG1lbXJlc3VsdC5ncm91cCgxLCAyLCAzLCA0KSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbXQnLCB0b3RhbCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbWEnLCBzd2FwIC0gZnJlZXN3YXApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ21jJywgMCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoIkVycm9yOiBjb3VsZCBub3QgcGFyc2UgbWVtb3J5IHN0YXRzICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW4gdG9wIG91dHB1dCBsaW5lICVzIiwgbGluZSkKCiAgICBkZWYgc3Vub3NfZGlza19zdGF0cyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICB0aGUgZGF0YSB3ZSBzZW5kIHRvIGxvZ2VudHJpZXMgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gYnl0ZXMKICAgICAgICAiIiIKCiAgICAgICAgc2QwID0gY2FsbCgna3N0YXQgLW4gc2QwIHwgZWdyZXAgIm5yZWFkfG53cml0dGVuIicpCiAgICAgICAgc2QxID0gY2FsbCgna3N0YXQgLW4gc2QxIHwgZWdyZXAgIm5yZWFkfG53cml0dGVuIicpCiAgICAgICAgc2QyID0gY2FsbCgna3N0YXQgLW4gc2QyIHwgZWdyZXAgIm5yZWFkfG53cml0dGVuIicpCgogICAgICAgIHJlYWRzID0gMEwKICAgICAgICB3cml0ZXMgPSAwTAoKICAgICAgICBmb3IgZGlzayBpbiBbc2QwLCBzZDEsIHNkMl06CiAgICAgICAgICAgIGZvciBsaW5lIGluIGRpc2suc3BsaXQoIlxuIik6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBub3QgcGFydHNbMV0uaXNkaWdpdCgpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gIm5yZWFkIjoKICAgICAgICAgICAgICAgICAgICByZWFkcyArPSBsb25nKHBhcnRzWzFdKQogICAgICAgICAgICAgICAgZWxpZiBwYXJ0c1swXSA9PSAibndyaXR0ZW4iOgogICAgICAgICAgICAgICAgICAgIHdyaXRlcyArPSBsb25nKHBhcnRzWzFdKQoKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnZHInLAogICAgICAgICAgICAgICAgICAgICAgIHJlYWRzIC0gc2VsZi5wcmV2X2Rpc2tfc3RhdHNbMF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2R3JywKICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXMgLSBzZWxmLnByZXZfZGlza19zdGF0c1sxXSkKICAgICAgICBzZWxmLnByZXZfZGlza19zdGF0cyA9IFtyZWFkcywgd3JpdGVzXQoKICAgIGRlZiBuZXRzdGF0c19zdGF0cyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBSZWFkIG5ldHdvcmsgYnl0ZXMgaW4vb3V0IGZyb20gdGhlIG91dHB1dCBvZiAibmV0c3RhdCAtcyIKICAgICAgICBOb3QgZXhhY3QsIGFzIG9uIE9TLVggaXQgZG9lc24ndCBkaXNwbGF5IGJ5dGVzIGZvciBldmVyeSBwcm90b2NvbCwKICAgICAgICBidXQgbW9yZSBleGFjdCB0aGFuIHVzaW5nICd0b3AnIG9yICduZXRzdGF0IDxpbnRlcnZhbD4nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcm9jID0gc3VicHJvY2Vzcy5Qb3BlbihbJ25ldHN0YXQnLCAnLWJpJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyBpZiB3ZSBzZWUgMTEgbm9uLWJsYW5rIGZpZWxkcywKICAgICAgICAjICM3IGlzIGlucHV0IGJ5dGVzLCBhbmQgIzEwIGlzIG91dHB1dCBieXRlcywgYnV0IGF2b2lkIGR1cGxpY2F0ZQogICAgICAgICMgZGV2aWNlIGxpbmVzCgogICAgICAgIHJlY2VpdmUgPSAwTAogICAgICAgIHRyYW5zbWl0ID0gMEwKICAgICAgICBuZXRzZWVuID0ge30KCiAgICAgICAgZm9yIGxpbmUgaW4gcHJvYy5zdGRvdXQ6CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnTmFtZScpOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMTE6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBwYXJ0c1sxXSBpbiBuZXRzZWVuOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgbm90IHBhcnRzWzZdLmlzZGlnaXQoKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNlaXZlICs9IGxvbmcocGFydHNbNl0pCiAgICAgICAgICAgIHRyYW5zbWl0ICs9IGxvbmcocGFydHNbOV0pCiAgICAgICAgICAgIG5ldHNlZW5bcGFydHNbMF1dID0gMQoKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbmknLCByZWNlaXZlIC0gc2VsZi5wcmV2X25ldF9zdGF0c1swXSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbm8nLCB0cmFuc21pdCAtIHNlbGYucHJldl9uZXRfc3RhdHNbMV0pCiAgICAgICAgc2VsZi5wcmV2X25ldF9zdGF0cyA9IFtyZWNlaXZlLCB0cmFuc21pdF0KCiAgICBkZWYgc3Vub3NfbmV0c3RhdHNfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZCBuZXR3b3JrIGJ5dGVzIGluL291dCBmcm9tIHRoZSBvdXRwdXQgb2YgIm5ldHN0YXQgLWkiCiAgICAgICAgTm90IGV4YWN0LCBhcyBvbiBTdW5PUyBpdCBkb2Vzbid0IGRpc3BsYXkgYnl0ZXMgZm9yIGV2ZXJ5IHByb3RvY29sLAogICAgICAgIGJ1dCBtb3JlIGV4YWN0IHRoYW4gdXNpbmcgJ3RvcCcgb3IgJ25ldHN0YXQgPGludGVydmFsPicKICAgICAgICAiIiIKICAgICAgICBuZXQwID0gY2FsbCgna3N0YXQgLW4gbmV0MCB8IGdyZXAgImJ5dGVzNjQiJykKICAgICAgICBuZXQxID0gY2FsbCgna3N0YXQgLW4gbmV0MSB8IGdyZXAgImJ5dGVzNjQiJykKCiAgICAgICAgcmVjZWl2ZSA9IDBMCiAgICAgICAgdHJhbnNtaXQgPSAwTAoKICAgICAgICBmb3IgbmV0d29yayBpbiBbbmV0MCwgbmV0MV06CiAgICAgICAgICAgIGZvciBsaW5lIGluIG5ldHdvcmsuc3BsaXQoIlxuIik6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBub3QgcGFydHNbMV0uaXNkaWdpdCgpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gImlieXRlczY0IjoKICAgICAgICAgICAgICAgICAgICByZWNlaXZlICs9IGxvbmcocGFydHNbMV0pCiAgICAgICAgICAgICAgICBlbGlmIHBhcnRzWzBdID09ICJvYnl0ZXM2NCI6CiAgICAgICAgICAgICAgICAgICAgdHJhbnNtaXQgKz0gbG9uZyhwYXJ0c1sxXSkKCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ25pJywgcmVjZWl2ZSAtIHNlbGYucHJldl9uZXRfc3RhdHNbMF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ25vJywgdHJhbnNtaXQgLSBzZWxmLnByZXZfbmV0X3N0YXRzWzFdKQogICAgICAgIHNlbGYucHJldl9uZXRfc3RhdHMgPSBbcmVjZWl2ZSwgdHJhbnNtaXRdCgogICAgZGVmIHN0YXRzKHNlbGYpOgogICAgICAgICIiIkNvbGxlY3RzIHN0YXRpc3RpY3MuIiIiCiAgICAgICAgZGF0YSA9IHt9CgogICAgICAgIGlmIHNlbGYucHJvY2ZpbGVzeXN0ZW06CiAgICAgICAgICAgIHNlbGYuY3B1X3N0YXRzKGRhdGEpCiAgICAgICAgICAgIHNlbGYuZGlza19zdGF0cyhkYXRhKQogICAgICAgICAgICBzZWxmLm1lbV9zdGF0cyhkYXRhKQogICAgICAgICAgICBzZWxmLm5ldF9zdGF0cyhkYXRhKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHNlbGYuc3lzID09ICJEYXJ3aW4iOgogICAgICAgICAgICAgICAgc2VsZi5vc3hfdG9wX3N0YXRzKGRhdGEpCiAgICAgICAgICAgICAgICBzZWxmLm5ldHN0YXRzX3N0YXRzKGRhdGEpCiAgICAgICAgICAgIGlmIHNlbGYuc3lzID09ICJTdW5PUyI6CiAgICAgICAgICAgICAgICBzZWxmLnN1bm9zX3RvcF9zdGF0cyhkYXRhKQogICAgICAgICAgICAgICAgc2VsZi5zdW5vc19kaXNrX3N0YXRzKGRhdGEpCiAgICAgICAgICAgICAgICBzZWxmLnN1bm9zX25ldHN0YXRzX3N0YXRzKGRhdGEpCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgbmV3X3JlcXVlc3QocnEpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSBhcGlfcmVxdWVzdCgKICAgICAgICAgICAgICAgIHJxLCBzaWxlbnQ9bm90IGNvbmZpZy5kZWJ1ZywgZGllX29uX2Vycm9yPUZhbHNlKQogICAgICAgICAgICBpZiBjb25maWcuZGVidWdfc3RhdHM6CiAgICAgICAgICAgICAgICBsb2cuaW5mbyhyZXNwb25zZSkKICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIHNjaGVkdWxlKHNlbGYsIG5leHRfc3RlcCk6CiAgICAgICAgaWYgbm90IHNlbGYudG9fcmVtb3ZlOgogICAgICAgICAgICBzZWxmLnRpbWVyID0gdGhyZWFkaW5nLlRpbWVyKG5leHRfc3RlcCwgc2VsZi5zZW5kX3N0YXRzLCAoKSkKICAgICAgICAgICAgc2VsZi50aW1lci5kYWVtb24gPSBUcnVlCiAgICAgICAgICAgIHNlbGYudGltZXIuc3RhcnQoKQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICBzZWxmLnNjaGVkdWxlKDEpCgogICAgZGVmIHNlbmRfc3RhdHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ29sbGVjdHMgYWxsIHN0YXRpc3RpY3MgYW5kIHNlbmRzIHRoZW0gdG8gTG9nZW50cmllcy4KICAgICAgICAiIiIKICAgICAgICBldGhhbG9uID0gdGltZS50aW1lKCkKCiAgICAgICAgcmVzdWx0cyA9IHNlbGYuc3RhdHMoKQogICAgICAgIHJlc3VsdHNbJ3JlcXVlc3QnXSA9IFJRX1dPUktMT0FECiAgICAgICAgcmVzdWx0c1snaG9zdF9rZXknXSA9IGNvbmZpZy5hZ2VudF9rZXkKICAgICAgICBpZiBjb25maWcuZGVidWdfc3RhdHM6CiAgICAgICAgICAgIGxvZy5pbmZvKHJlc3VsdHMpCiAgICAgICAgaWYgbm90IHNlbGYuZmlyc3Q6CiAgICAgICAgICAgICMgU2VuZCBkYXRhCiAgICAgICAgICAgIGlmIG5vdCBjb25maWcuZGF0YWh1YjoKICAgICAgICAgICAgICAgIHNlbGYubmV3X3JlcXVlc3QocmVzdWx0cykKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZpcnN0ID0gRmFsc2UKCiAgICAgICAgZXRoYWxvbiArPSBFUE9DSAogICAgICAgIG5leHRfc3RlcCA9IChldGhhbG9uIC0gdGltZS50aW1lKCkpICUgRVBPQ0gKICAgICAgICBzZWxmLnNjaGVkdWxlKG5leHRfc3RlcCkKCiAgICBkZWYgY2FuY2VsKHNlbGYpOgogICAgICAgIHNlbGYudG9fcmVtb3ZlID0gVHJ1ZQogICAgICAgIGlmIHNlbGYudGltZXI6CiAgICAgICAgICAgIHNlbGYudGltZXIuY2FuY2VsKCkKCmNsYXNzIEZvbGxvd011bHRpbG9nKG9iamVjdCk6CiAgICAiIiIKICAgIFRoZSBGb2xsb3dNdWx0aWxvZyBpcyByZXNwb25zaWJsZSBmb3IgaGFuZGxpbmcgdGhvc2UgbG9ncyB0aGF0IHdlcmUgc2V0LXVwIHVzaW5nIHRoZQogICAgJy0tbXVsdGlsb2cnIG9wdGlvbiBhbmQgdGhhdCBtYXkgaGF2ZSBhIHdpbGRjYXJkIGluIHRoZSBwYXRobmFtZS4KICAgIEluIHdoaWNoIGNhc2UgbXVsdGlwbGUgbG9jYWwgKGxvZykgZmlsZXMgd2lsbCBiZSBmb2xsb3dlZCwgYnV0IHdpdGggYWxsIHRoZSBuZXcgZXZlbnRzCiAgICBmcm9tIGFsbCB0aGUgZmlsZXMgZm9yd2FyZGVkIHRvIHRoZSBzYW1lIHNpbmdsZSBsb2cgaW4gdGhlIGxvZ2VudHJpZXMgaW5mcmFzdHJ1Y3R1cmUuCiAgICAiIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAKICAgICAgICAgICAgICAgICBuYW1lLCAKICAgICAgICAgICAgICAgICBlbnRyeV9maWx0ZXIsIAogICAgICAgICAgICAgICAgIGVudHJ5X2Zvcm1hdHRlciwgCiAgICAgICAgICAgICAgICAgZW50cnlfaWRlbnRpZmllciwgCiAgICAgICAgICAgICAgICAgdHJhbnNwb3J0LCAKICAgICAgICAgICAgICAgICBtYXhfbnVtX2ZvbGxvd2Vycz1NQVhfRklMRVNfRk9MTE9XRUQgKToKICAgICAgICAiIiIgSW5pdGlhbGl6ZXMgdGhlIEZvbGxvd011bHRpbG9nLiAiIiIKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5mbHVzaCA9IFRydWUKICAgICAgICBzZWxmLmVudHJ5X2ZpbHRlciA9IGVudHJ5X2ZpbHRlcgogICAgICAgIHNlbGYuZW50cnlfZm9ybWF0dGVyID0gZW50cnlfZm9ybWF0dGVyCiAgICAgICAgc2VsZi5lbnRyeV9pZGVudGlmaWVyID0gZW50cnlfaWRlbnRpZmllcgogICAgICAgIHNlbGYudHJhbnNwb3J0ID0gdHJhbnNwb3J0CgogICAgICAgIHNlbGYuX3NodXRkb3duID0gRmFsc2UKICAgICAgICBzZWxmLl9tYXhfbnVtX2ZvbGxvd2Vycz1tYXhfbnVtX2ZvbGxvd2VycwogICAgICAgIHNlbGYuX2ZvbGxvd2VycyA9IFtdCiAgICAgICAgc2VsZi5fd29ya2VyID0gdGhyZWFkaW5nLlRocmVhZCgKICAgICAgICAgICAgdGFyZ2V0PXNlbGYuc3VwZXJ2aXNlX2ZvbGxvd2VycywgbmFtZT1zZWxmLm5hbWUpCiAgICAgICAgc2VsZi5fd29ya2VyLmRhZW1vbiA9IFRydWUKICAgICAgICBzZWxmLl93b3JrZXIuc3RhcnQoKQoKICAgIGRlZiBfZmlsZV90ZXN0KHNlbGYsIGNhbmRpZGF0ZSk6CiAgICAgICAgIiIiCiAgICAgICAgT25seSByZWd1bGFyIGZpbGVzIHBhc3NlZAogICAgICAgICIiIgogICAgICAgICMgRmFpbCBpZiBhIHN5bWJvbGljIGxpbmsKICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhjYW5kaWRhdGUpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAjIEZhaWwgaWYgbm90IGEgcmVndWxhciBmaWxlIChwYXNzZXMgbGlua3MhKQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShjYW5kaWRhdGUpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgX2FwcGVuZF9mb2xsb3dlcnMoc2VsZiwgYWRkX2ZpbGVzKTogICAgICAgIAogICAgICAgIGZvciBmaWxlbmFtZSBpbiBhZGRfZmlsZXM6CiAgICAgICAgICAgIGlmIGxlbihzZWxmLl9mb2xsb3dlcnMpIDwgc2VsZi5fbWF4X251bV9mb2xsb3dlcnM6ICAgICAgICAKICAgICAgICAgICAgICAgIGZvbGxvd2VyID0gRm9sbG93ZXIoZmlsZW5hbWUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVudHJ5X2ZpbHRlciwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW50cnlfZm9ybWF0dGVyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lbnRyeV9pZGVudGlmaWVyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc3BvcnQsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUcnVlKQogICAgICAgICAgICAgICAgc2VsZi5fZm9sbG93ZXJzLmFwcGVuZChmb2xsb3dlcikKICAgICAgICAgICAgICAgIGlmIGNvbmZpZy5kZWJ1Z19tdWx0aWxvZzoKICAgICAgICAgICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAiTnVtYmVyIG9mIGZvbGxvd2VycyBpbmNyZWFzZWQgdG86ICVzICIgJWxlbihzZWxmLl9mb2xsb3dlcnMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2cuZGVidWcoIldhcm5pbmc6IEFsbG93ZWQgbWF4aW11bSBvZiBmaWxlcyB0aGF0IGNhbiBiZSBmb2xsb3dlZCByZWFjaGVkIikKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgZGVmIF9yZW1vdmVfZm9sbG93ZXJzKHNlbGYsIHJlbW92ZWRfZmlsZXMpOgogICAgICAgIGZvciBmb2xsb3dlciBpbiBzZWxmLl9mb2xsb3dlcnM6CiAgICAgICAgICAgIGlmIGZvbGxvd2VyLm5hbWUgaW4gcmVtb3ZlZF9maWxlczogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb2xsb3dlci5jbG9zZSgpCiAgICAgICAgICAgICAgICBzZWxmLl9mb2xsb3dlcnMucmVtb3ZlKGZvbGxvd2VyKQogICAgICAgICAgICAgICAgaWYgY29uZmlnLmRlYnVnX211bHRpbG9nOgogICAgICAgICAgICAgICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsICJOdW1iZXIgb2YgZm9sbG93ZXJzIGRlY3JlYXNlZCB0bzogJXMgIiAlbGVuKHNlbGYuX2ZvbGxvd2VycykKICAgICAgICAgICAgICAgIAogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFN0b3BzIGFsbCBGb2xsb3dNdWx0aWxvZyBhY3Rpdml0eSwgYW5kIHRoZW4gbG9vcHMgdGhyb3VnaCBsaXN0IG9mIGV4aXN0aW5nCiAgICAgICAgZm9sbG93ZXJzIHRvIGNsb3NlIGVhY2ggb25lIC0gdGhlbiB3YWl0cyBmb3IgdGhlIHdvcmtlciB0aHJlYWQgdG8gc3RvcC4KICAgICAgICAiIiIKICAgICAgICBzZWxmLl9zaHV0ZG93biA9IFRydWUKICAgICAgICAjIFJ1biB0aHJvdWdoIGxpc3Qgb2YgZm9sbG93ZXJzIGNsb3NpbmcgZWFjaCBvbmUKICAgICAgICBmb3IgZm9sbG93ZXIgaW4gc2VsZi5fZm9sbG93ZXJzOgogICAgICAgICAgICBmb2xsb3dlci5jbG9zZSgpCiAgICAgICAgc2VsZi5fd29ya2VyLmpvaW4oRk9MTE9XTVVMVElfSk9JTl9JTlRFUlZBTCkKICAgICAgICAKICAgIGRlZiBzdXBlcnZpc2VfZm9sbG93ZXJzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgICBJbnN0YW50aWF0ZXMgYSBGb2xsb3dlciBvYmplY3QgZm9yIGVhY2ggZmlsZSBmb3VuZCAtIGFsbCBsb2cgZXZlbnRzIGZyb20gYWxsCiAgICAgICAgIGZpbGVzIGFyZSBmb3J3YXJkZWQgdG8gdGhlIHNhbWUgbG9nIGluIHRoZSBsRSBpbmZyYXN0cnVjdHVyZQogICAgICAgICIiIiAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3NldCA9IHNldChbZmlsZW5hbWUgZm9yIGZpbGVuYW1lIGluIGdsb2IuZ2xvYihzZWxmLm5hbWUpXSkgICAgICAgICAKICAgICAgICBleGNlcHQgb3MuZXJyb3I6CiAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3I6IEZvbGxvd2VyTXVsdGlwbGUgZ2xvYiBoYXMgZmFpbGVkIikKICAgICAgICBpZiBsZW4oc3RhcnRfc2V0KSA9PSAwOgogICAgICAgICAgICBsb2cuZXJyb3IoIkZvbGxvd011bHRpbG9nOiBubyBmaWxlcyBmb3VuZCBpbiBPUyB0byBiZSBmb2xsb3dlZCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5fYXBwZW5kX2ZvbGxvd2VycyhzdGFydF9zZXQpCiAgICAgICAgd2hpbGUgbm90IHNlbGYuX3NodXRkb3duOgogICAgICAgICAgICB0aW1lLnNsZWVwKFJFVFJZX0dMT0JfSU5URVJWQUwpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGN1cnJlbnRfc2V0ID0gc2V0KFtmaWxlbmFtZSBmb3IgZmlsZW5hbWUgaW4gZ2xvYi5nbG9iKHNlbGYubmFtZSldKSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IG9zLmVycm9yOgogICAgICAgICAgICAgICAgbG9nLmVycm9yKCJFcnJvcjogRm9sbG93ZXJNdWx0aXBsZSBnbG9iIGhhcyBmYWlsZWQiKQogICAgICAgICAgICBmb2xsb3dlZF9maWxlcyA9IFtmb2xsb3dlci5uYW1lIGZvciBmb2xsb3dlciBpbiBzZWxmLl9mb2xsb3dlcnNdCiAgICAgICAgICAgIGFkZGVkX2ZpbGVzID0gW2ZpbGVuYW1lIGZvciBmaWxlbmFtZSBpbiBjdXJyZW50X3NldCBpZiBub3QgZmlsZW5hbWUgaW4gZm9sbG93ZWRfZmlsZXNdICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9mb2xsb3dlcnMoYWRkZWRfZmlsZXMpICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZW1vdmVkX2ZpbGVzID0gW2ZpbGVuYW1lIGZvciBmaWxlbmFtZSBpbiBmb2xsb3dlZF9maWxlcyBpZiBub3QgZmlsZW5hbWUgaW4gY3VycmVudF9zZXRdCiAgICAgICAgICAgIHNlbGYuX3JlbW92ZV9mb2xsb3dlcnMocmVtb3ZlZF9maWxlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgpjbGFzcyBGb2xsb3dlcihvYmplY3QpOgoKICAgICIiIgogICAgVGhlIGZvbGxvd2VyIGtlZXBzIGFuIGV5ZSBvbiB0aGUgZmlsZSBzcGVjaWZpZWQgYW5kIHNlbmRzIG5ldyBldmVudHMgdG8gdGhlCiAgICBsb2dlbnRyaWVzIGluZnJhc3RydWN0dXJlLiAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIAogICAgICAgICAgICAgICAgIG5hbWUsIAogICAgICAgICAgICAgICAgIGVudHJ5X2ZpbHRlciwgCiAgICAgICAgICAgICAgICAgZW50cnlfZm9ybWF0dGVyLCAKICAgICAgICAgICAgICAgICBlbnRyeV9pZGVudGlmaWVyLCAKICAgICAgICAgICAgICAgICB0cmFuc3BvcnQsIAogICAgICAgICAgICAgICAgIGRpc2FibGVfZ2xvYj1GYWxzZSk6CiAgICAgICAgIiIiIEluaXRpYWxpemVzIHRoZSBmb2xsb3dlci4gIiIiCiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQogICAgICAgIHNlbGYuZmx1c2ggPSBUcnVlCiAgICAgICAgc2VsZi5lbnRyeV9maWx0ZXIgPSBlbnRyeV9maWx0ZXIKICAgICAgICBzZWxmLmVudHJ5X2Zvcm1hdHRlciA9IGVudHJ5X2Zvcm1hdHRlcgogICAgICAgIHNlbGYuZW50cnlfaWRlbnRpZmllciA9IGVudHJ5X2lkZW50aWZpZXIKICAgICAgICBzZWxmLnRyYW5zcG9ydCA9IHRyYW5zcG9ydAogICAgICAgICMgRm9sbG93TXVsdGlsb2cgdXNhZ2UKICAgICAgICBzZWxmLl9kaXNhYmxlX2dsb2IgPSBkaXNhYmxlX2dsb2IKCiAgICAgICAgc2VsZi5fZmlsZSA9IE5vbmUKICAgICAgICBzZWxmLl9zaHV0ZG93biA9IEZhbHNlCiAgICAgICAgc2VsZi5fcmVhZF9maWxlX3Jlc3QgPSAnJwogICAgICAgIHNlbGYuX2VudHJ5X3Jlc3QgPSBbXQogICAgICAgIHNlbGYuX3dvcmtlciA9IHRocmVhZGluZy5UaHJlYWQoCiAgICAgICAgICAgIHRhcmdldD1zZWxmLm1vbml0b3Jsb2dzLCBuYW1lPXNlbGYubmFtZSkKICAgICAgICBzZWxmLl93b3JrZXIuZGFlbW9uID0gVHJ1ZQogICAgICAgIHNlbGYuX3dvcmtlci5zdGFydCgpCgogICAgZGVmIF9maWxlX2NhbmRpZGF0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGxpc3Qgb2YgZmlsZSBuYW1lcyB3aGljaCBjb3JyZXNwb25kcyB0byB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY2FuZGlkYXRlcyA9IGdsb2IuZ2xvYihzZWxmLm5hbWUpCgogICAgICAgICAgICBpZiBsZW4oY2FuZGlkYXRlcykgPT0gMDoKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICBjYW5kaWRhdGVfdGltZXMgPSBbW29zLnBhdGguZ2V0bXRpbWUobmFtZSksIG5hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgbmFtZSBpbiBjYW5kaWRhdGVzXQogICAgICAgICAgICBjYW5kaWRhdGVfdGltZXMuc29ydCgpCiAgICAgICAgICAgIGNhbmRpZGF0ZV90aW1lcy5yZXZlcnNlKCkKICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZV90aW1lc1swXVsxXQogICAgICAgIGV4Y2VwdCBvcy5lcnJvcjoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX29wZW5fbG9nKHNlbGYpOgogICAgICAgICIiIktlZXBzIHRyeWluZyB0byByZS1vcGVuIHRoZSBsb2cgZmlsZS4gUmV0dXJucyB3aGVuIHRoZSBmaWxlIGhhcyBiZWVuCiAgICAgICAgb3BlbmVkIG9yIHdoZW4gcmVxdWVzdGVkIHRvIHJlbW92ZS4gICIiIgogICAgICAgIGVycm9yX2luZm8gPSBUcnVlCiAgICAgICAgc2VsZi5yZWFsX25hbWUgPSBOb25lCgogICAgICAgIHdoaWxlIG5vdCBzZWxmLl9zaHV0ZG93bjoKICAgICAgICAgICAgIyBGb2xsb3dNdWx0aWxvZyB1c2FnZQogICAgICAgICAgICBpZiBzZWxmLl9kaXNhYmxlX2dsb2I6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGUgPSBzZWxmLm5hbWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZSA9IHNlbGYuX2ZpbGVfY2FuZGlkYXRlKCkKCiAgICAgICAgICAgIGlmIGNhbmRpZGF0ZToKICAgICAgICAgICAgICAgIHNlbGYucmVhbF9uYW1lID0gY2FuZGlkYXRlCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfbG9nKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9maWxlID0gb3BlbihzZWxmLnJlYWxfbmFtZSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZXhjZXB0IElPRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgaWYgZXJyb3JfaW5mbzoKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCJDYW5ub3Qgb3BlbiBmaWxlICclcycsIHJlLXRyeWluZyBpbiAlc3MgaW50ZXJ2YWxzIiwKICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubmFtZSwgUkVPUEVOX0lOVCkKICAgICAgICAgICAgICAgIGVycm9yX2luZm8gPSBGYWxzZQogICAgICAgICAgICB0aW1lLnNsZWVwKFJFT1BFTl9UUllfSU5URVJWQUwpCgogICAgZGVmIF9jbG9zZV9sb2coc2VsZik6CiAgICAgICAgaWYgc2VsZi5fZmlsZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fZmlsZS5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBzZWxmLl9maWxlID0gTm9uZQoKICAgIGRlZiBfbG9nX3JlbmFtZShzZWxmKToKICAgICAgICAiIiJEZXRlY3RzIGZpbGUgcmVuYW1lLiIiIgoKICAgICAgICAjIEdldCBmaWxlIGNhbmRpZGF0ZXMKICAgICAgICBjYW5kaWRhdGUgPSBzZWxmLl9maWxlX2NhbmRpZGF0ZSgpCiAgICAgICAgaWYgbm90IGNhbmRpZGF0ZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHRyeToKICAgICAgICAgICAgY3RpbWUxID0gb3MuZnN0YXQoc2VsZi5fZmlsZS5maWxlbm8oKSkuc3RfbXRpbWUKICAgICAgICAgICAgY3RpbWVfbmV3ID0gb3MucGF0aC5nZXRtdGltZShjYW5kaWRhdGUpCiAgICAgICAgICAgIGN0aW1lMiA9IG9zLmZzdGF0KHNlbGYuX2ZpbGUuZmlsZW5vKCkpLnN0X210aW1lCiAgICAgICAgZXhjZXB0IG9zLmVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIGN0aW1lMSA9PSBjdGltZTIgYW5kIGN0aW1lMSAhPSBjdGltZV9uZXc6CiAgICAgICAgICAgICMgV2UgaGF2ZSBhIG5hbWUgY2hhbmdlIGFjY29yZGluZyB0byB0aGUgdGltZQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3JlYWRfbG9nX2xpbmVzKHNlbGYpOgogICAgICAgICIiIiBSZWFkcyBhIGJsb2NrIG9mIGxpbmVzIGZyb20gdGhlIGxvZy4gQ2hlY2tzIG1heGltYWwgbGluZSBzaXplLiAiIiIKICAgICAgICBidWZmID0gc2VsZi5fZmlsZS5yZWFkKE1BWF9CTE9DS19TSVpFIC0gbGVuKHNlbGYuX3JlYWRfZmlsZV9yZXN0KSkKICAgICAgICBidWZmX2xpbmVzID0gYnVmZi5zcGxpdCgnXG4nKQogICAgICAgIGlmIGxlbihzZWxmLl9yZWFkX2ZpbGVfcmVzdCkgPiAwOgogICAgICAgICAgICBidWZmX2xpbmVzWzBdID0gc2VsZi5fcmVhZF9maWxlX3Jlc3QgKyBidWZmX2xpbmVzWzBdCgogICAgICAgIHNlbGYuX3JlYWRfZmlsZV9yZXN0ID0gYnVmZl9saW5lc1stMV0KCiAgICAgICAgIyBMaW1pdCBzaXplIG9mIF9yZWFkX2ZpbGVfcmVzdAogICAgICAgIGlmIGxlbihzZWxmLl9yZWFkX2ZpbGVfcmVzdCkgPj0gTUFYX0JMT0NLX1NJWkU6CiAgICAgICAgICAgIGJ1ZmZfbGluZXMuYXBwZW5kKHNlbGYuX3JlYWRfZmlsZV9yZXN0WzpNQVhfQkxPQ0tfU0laRV0pCiAgICAgICAgICAgIHNlbGYuX3JlYWRfZmlsZV9yZXN0ID0gc2VsZi5fcmVhZF9maWxlX3Jlc3RbTUFYX0JMT0NLX1NJWkU6XQoKICAgICAgICByZXR1cm4gW2xpbmUuZGVjb2RlKCd1dGYtOCcsICdpZ25vcmUnKSBmb3IgbGluZSBpbiBidWZmX2xpbmVzWzotMV1dCgogICAgZGVmIF9zZXRfZmlsZV9wb3NpdGlvbihzZWxmLCBvZmZzZXQsIHN0YXJ0PUZJTEVfQkVHSU4pOgogICAgICAgICIiIiBNb3ZlIHRoZSBwb3NpdGlvbiBvZiBmaWxlcG9pbnRlcnMuIiIiCiAgICAgICAgc2VsZi5fZmlsZS5zZWVrKG9mZnNldCwgc3RhcnQpCgogICAgZGVmIF9nZXRfZmlsZV9wb3NpdGlvbihzZWxmKToKICAgICAgICAiIiIgUmV0dXJucyB0aGUgcG9zaXRpb24gZmlsZXBvaW50ZXJzLiIiIgogICAgICAgIHBvcyA9IHNlbGYuX2ZpbGUudGVsbCgpCiAgICAgICAgcmV0dXJuIHBvcwoKICAgIGRlZiBfY29sbGVjdF9saW5lcyhzZWxmLCBsaW5lcyk6CiAgICAgICAgIiIiQWNjZXB0cyBsaW5lcyByZWNlaXZlZCBhbmQgbWVyZ2VzIHRoZW0gdG8gbXVsdGlsaW5lIGV2ZW50cy4KICAgICAgICAiIiIKICAgICAgICAjIEZhc3QgdHJhY2sKICAgICAgICBpZiBub3Qgc2VsZi5lbnRyeV9pZGVudGlmaWVyOgogICAgICAgICAgICByZXR1cm4gbGluZXMKICAgICAgICBpZiBub3QgbGluZXM6CiAgICAgICAgICAgIGlmIHNlbGYuX2VudHJ5X3Jlc3Q6CiAgICAgICAgICAgICAgICB4ID0gW0xJTkVfU0VQQVJBVE9SLmpvaW4oc2VsZi5fZW50cnlfcmVzdCldCiAgICAgICAgICAgICAgICBzZWxmLl9lbnRyeV9yZXN0ID0gW10KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHggPSBbXQogICAgICAgICAgICByZXR1cm4geAogICAgICAgICMgRW50cnkgc2VwYXJhdG9yIGlzIHNwZWNpZmllZAogICAgICAgIG5ld19saW5lcyA9IFtdCiAgICAgICAgbmV3X2VudHJ5ID0gc2VsZi5fZW50cnlfcmVzdAogICAgICAgIHNlbGYuX2VudHJ5X3Jlc3QgPSBbXQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBpZiBzZWxmLmVudHJ5X2lkZW50aWZpZXIuc2VhcmNoKGxpbmUpOgogICAgICAgICAgICAgICAgaWYgbmV3X2VudHJ5OgogICAgICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoTElORV9TRVBBUkFUT1Iuam9pbihuZXdfZW50cnkpKQogICAgICAgICAgICAgICAgICAgIG5ld19lbnRyeSA9IFtdCiAgICAgICAgICAgICAgICBuZXdfZW50cnkuYXBwZW5kKGxpbmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBuZXdfZW50cnkuYXBwZW5kKGxpbmUpCiAgICAgICAgc2VsZi5fZW50cnlfcmVzdCA9IG5ld19lbnRyeQogICAgICAgIHJldHVybiBuZXdfbGluZXMKCiAgICBkZWYgX2dldF9saW5lcyhzZWxmKToKICAgICAgICAiIiJSZXR1cm5zIGEgYmxvY2sgb2YgbmV3bHkgZGV0ZWN0ZWQgbGluZSBmcm9tIHRoZSBsb2cuIFJldHVybnMgTm9uZSBpbgogICAgICAgIGNhc2Ugb2YgdGltZW91dC4KICAgICAgICAiIiIKICAgICAgICAjIE1vdmVzIGF0IHRoZSBlbmQgb2YgdGhlIGxvZyBmaWxlCiAgICAgICAgaWYgc2VsZi5mbHVzaDoKICAgICAgICAgICAgc2VsZi5fc2V0X2ZpbGVfcG9zaXRpb24oMCwgRklMRV9FTkQpCiAgICAgICAgICAgIHNlbGYuZmx1c2ggPSBGYWxzZQoKICAgICAgICAjIFRPRE86IGludmVzdGlnYXRlIHNlbGVjdC1saWtlIGFwcHJvYWNoPwogICAgICAgIGlkbGVfY250ID0gMAogICAgICAgIGlhYV9jbnQgPSAwCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIHdoaWxlIGlhYV9jbnQgIT0gSUFBX0lOVEVSVkFMIGFuZCBub3Qgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgICMgQ29sbGVjdCBsaW5lcwogICAgICAgICAgICBsaW5lcyA9IHNlbGYuX3JlYWRfbG9nX2xpbmVzKCkKICAgICAgICAgICAgbGluZXMgPSBzZWxmLl9jb2xsZWN0X2xpbmVzKGxpbmVzKQogICAgICAgICAgICBpZiBsaW5lczoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAjIE5vIGxpbmUsIHdhaXQKICAgICAgICAgICAgdGltZS5zbGVlcChUQUlMX1JFQ0hFQ0spCgogICAgICAgICAgICBsaW5lcyA9IHNlbGYuX2NvbGxlY3RfbGluZXMoW10pCiAgICAgICAgICAgIGlmIGxpbmVzOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICMgTG9nIHJlbmFtZSBjaGVjawogICAgICAgICAgICBpZGxlX2NudCArPSAxCiAgICAgICAgICAgIGlmIGlkbGVfY250ID09IE5BTUVfQ0hFQ0s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9sb2dfcmVuYW1lKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fb3Blbl9sb2coKQogICAgICAgICAgICAgICAgICAgIGlhYV9jbnQgPSAwCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgUmVjb3ZlciBmcm9tIGV4dGVybmFsIGZpbGUgbW9kaWZpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gPSBzZWxmLl9nZXRfZmlsZV9wb3NpdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2ZpbGVfcG9zaXRpb24oMCwgRklMRV9FTkQpCiAgICAgICAgICAgICAgICAgICAgZmlsZV9zaXplID0gc2VsZi5fZ2V0X2ZpbGVfcG9zaXRpb24oKQoKICAgICAgICAgICAgICAgICAgICBpZiBmaWxlX3NpemUgPCBwb3NpdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBGaWxlIGhhcyBiZWVuIGV4dGVybmFseSBtb2RpZmllZAogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IDAKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfZmlsZV9wb3NpdGlvbihwb3NpdGlvbikKICAgICAgICAgICAgICAgIGlkbGVfY250ID0gMAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUbyByZXNldCBlbmQtb2YtbGluZSBlcnJvcgogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2ZpbGVfcG9zaXRpb24oc2VsZi5fZ2V0X2ZpbGVfcG9zaXRpb24oKSkKICAgICAgICAgICAgaWFhX2NudCArPSAxCgogICAgICAgIHJldHVybiBsaW5lcwoKICAgIGRlZiBfc2VuZF9saW5lcyhzZWxmLCBsaW5lcyk6CiAgICAgICAgIiIiIFNlbmRzIGxpbmVzLiAiIiIKICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBsaW5lID0gc2VsZi5lbnRyeV9maWx0ZXIobGluZSkKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBjb25maWcuZGVidWdfZXZlbnRzOgogICAgICAgICAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgbGluZQogICAgICAgICAgICBsaW5lID0gc2VsZi5lbnRyeV9mb3JtYXR0ZXIobGluZSkKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBzZWxmLnRyYW5zcG9ydC5zZW5kKGxpbmUpCgogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIkNsb3NlcyB0aGUgZm9sbG93ZXIgYnkgc2V0dGluZyB0aGUgc2h1dGRvd24gZmxhZyBhbmQgd2FpdGluZyBmb3IgdGhlCiAgICAgICAgd29ya2VyIHRocmVhZCB0byBzdG9wLiIiIgogICAgICAgIHNlbGYuX3NodXRkb3duID0gVHJ1ZQogICAgICAgIHNlbGYuX3dvcmtlci5qb2luKEZPTExPV0VSX0pPSU5fSU5URVJWQUwpCgogICAgZGVmIG1vbml0b3Jsb2dzKHNlbGYpOgogICAgICAgICIiIiBPcGVucyB0aGUgbG9nIGZpbGUgYW5kIHN0YXJ0cyB0byBjb2xsZWN0IG5ldyBldmVudHMuICIiIgogICAgICAgIHNlbGYuX29wZW5fbG9nKCkKICAgICAgICB3aGlsZSBub3Qgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxpbmVzID0gc2VsZi5fZ2V0X2xpbmVzKCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZW5kX2xpbmVzKGxpbmVzKQogICAgICAgICAgICAgICAgZXhjZXB0IElPRXJyb3IsIGU6CiAgICAgICAgICAgICAgICAgICAgaWYgY29uZmlnLmRlYnVnOgogICAgICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoIklPRXJyb3I6ICVzIiwgZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9vcGVuX2xvZygpCiAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yLCBlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKCJVbmljb2RlRXJyb3Igc2VuZGluZyBsaW5lcyBgJXMnIiwgbGluZXMsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiQ2F1Z2h0IHVua25vd24gZXJyb3IgYCVzJyB3aGlsZSBzZW5kaW5nIGxpbmVzICVzIiwgZSwgbGluZXMsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkNhdWdodCB1bmtub3duIGVycm9yIGAlcycgd2hpbGUgc2VuZGluZyBsaW5lIiwgZSwgZXhjX2luZm89VHJ1ZSkKICAgICAgICBzZWxmLl9jbG9zZV9sb2coKQoKCmNsYXNzIFRyYW5zcG9ydChvYmplY3QpOgoKICAgICIiIkVuY2Fwc3VsYXRlcyBzaW1wbGUgY29ubmVjdGlvbiB0byBhIHJlbW90ZSBob3N0LiBUaGUgY29ubmVjdGlvbiBtYXkgYmUKICAgIGVuY3J5cHRlZC4gRWFjaCBjb21tdW5pY2F0aW9uIGlzIHN0YXJ0ZWQgd2l0aCB0aGUgcHJlYW1ibGUuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGVuZHBvaW50LCBwb3J0LCB1c2Vfc3NsLCBwcmVhbWJsZSwgZGVidWdfdHJhbnNwb3J0X2V2ZW50cywgcHJveHkpOgogICAgICAgICMgQ29weSB0cmFuc3BvcnQgY29uZmlndXJhdGlvbgogICAgICAgIHNlbGYuZW5kcG9pbnQgPSBlbmRwb2ludAogICAgICAgIHNlbGYucG9ydCA9IHBvcnQKICAgICAgICBzZWxmLnVzZV9zc2wgPSB1c2Vfc3NsCiAgICAgICAgc2VsZi5wcmVhbWJsZSA9IHByZWFtYmxlCiAgICAgICAgc2VsZi5fZW50cmllcyA9IFF1ZXVlLlF1ZXVlKFNFTkRfUVVFVUVfU0laRSkKICAgICAgICBzZWxmLl9zb2NrZXQgPSBOb25lICMgU29ja2V0IHdpdGggb3B0aW9uYWwgVExTIGVuY3lwdGlvbgogICAgICAgIHNlbGYuX2RlYnVnX3RyYW5zcG9ydF9ldmVudHMgPSBkZWJ1Z190cmFuc3BvcnRfZXZlbnRzCgogICAgICAgIHNlbGYuX3NodXRkb3duID0gRmFsc2UKCiAgICAgICAgIyBwcm94eSBzZXR1cAogICAgICAgIHNlbGYuX3VzZV9wcm94eSA9IEZhbHNlCgogICAgICAgIChwcm94eV90eXBlX3N0ciwgc2VsZi5fcHJveHlfdXJsLCBzZWxmLl9wcm94eV9wb3J0KSA9IHByb3h5CgogICAgICAgIGlmIHByb3h5X3R5cGVfc3RyICE9IE5PVF9TRVQgYW5kIHNlbGYuX3Byb3h5X3VybCAhPSBOT1RfU0VUIGFuZCBzZWxmLl9wcm94eV9wb3J0ICE9IE5PVF9TRVQ6CiAgICAgICAgICAgIHNlbGYuX3VzZV9wcm94eSA9IFRydWUKICAgICAgICAgICAgaWYgcHJveHlfdHlwZV9zdHIgPT0gIkhUVFAiOgogICAgICAgICAgICAgICAgc2VsZi5fcHJveHlfdHlwZSA9IHNvY2tzLlBST1hZX1RZUEVfSFRUUAogICAgICAgICAgICBlbGlmIHByb3h5X3R5cGVfc3RyID09ICJTT0NLUzUiOgogICAgICAgICAgICAgICAgc2VsZi5fcHJveHlfdHlwZSA9IHNvY2tzLlBST1hZX1RZUEVfU09DS1M1CiAgICAgICAgICAgIGVsaWYgcHJveHlfdHlwZV9zdHIgPT0gIlNPQ0tTNCI6CiAgICAgICAgICAgICAgICBzZWxmLl9wcm94eV90eXBlID0gc29ja3MuUFJPWFlfVFlQRV9TT0NLUzQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuX3VzZV9wcm94eSA9IEZhbHNlCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkludmFsaWRlIHByb3h5IHR5cGUuIE9ubHkgSFRUUCwgU09DS1M1IGFuZCBTT0NLUzQgYXJlIGFjY2VwdGVkIikKCiAgICAgICAgaWYgc2VsZi5fdXNlX3Byb3h5OgogICAgICAgICAgICBsb2cuaW5mbygiVXNpbmcgcHJveHkgd2l0aCBwcm94eV90eXBlOiAlcywgcHJveHktdXJsOiAlcywgcHJveHktcG9ydDogJXMiLAogICAgICAgICAgICAgICAgICAgICBwcm94eV90eXBlX3N0ciwgc2VsZi5fcHJveHlfdXJsLCBzZWxmLl9wcm94eV9wb3J0KQoKICAgICAgICAjIEdldCBjZXJ0aWZpY2F0ZSBuYW1lCiAgICAgICAgY2VydF9uYW1lID0gTm9uZQogICAgICAgIGlmIG5vdCBjb25maWcudXNlX2NhX3Byb3ZpZGVkOgogICAgICAgICAgICBjZXJ0X25hbWUgPSBzeXN0ZW1fY2VydF9maWxlKCkKICAgICAgICAgICAgaWYgY2VydF9uYW1lIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjZXJ0X25hbWUgPSBkZWZhdWx0X2NlcnRfZmlsZShjb25maWcpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2VydF9uYW1lID0gZGVmYXVsdF9jZXJ0X2ZpbGUoY29uZmlnKQoKICAgICAgICBpZiB1c2Vfc3NsIGFuZCBub3QgY2VydF9uYW1lOgogICAgICAgICAgICBkaWUoJ0Nhbm5vdCBnZXQgZGVmYXVsdCBjZXJ0aWZpY2F0ZSBmaWxlIG5hbWUgdG8gcHJvdmlkZSBjb25uZWN0aW9uIG92ZXIgU1NMIScpCiAgICAgICAgICAgICMgWFhYIERvIHdlIG5lZWQgdG8gZGllIGhlcmU/CiAgICAgICAgc2VsZi5fY2VydHMgPSBjZXJ0X25hbWUKCiAgICAgICAgIyBTdGFydCBhc3luY2hyb25vdXMgd29ya2VyCiAgICAgICAgc2VsZi5fd29ya2VyID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5ydW4pCiAgICAgICAgc2VsZi5fd29ya2VyLmRhZW1vbiA9IFRydWUKICAgICAgICBzZWxmLl93b3JrZXIuc3RhcnQoKQoKICAgIGRlZiBfZ2V0X2FkZHJlc3Moc2VsZiwgdXNlX3Byb3h5KToKICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmVuZHBvaW50CiAgICAgICAgZWxzZToKICAgICAgICAgICAgIiIiUmV0dXJucyBhbiBJUCBhZGRyZXNzIG9mIHRoZSBlbmRwb2ludC4gSWYgdGhlIGVuZHBvaW50IHJlc29sdmVzIHRvCiAgICAgICAgICAgIG11bHRpcGxlIGFkZHJlc3NlcywgYSByYW5kb20gb25lIGlzIHNlbGVjdGVkLiBUaGlzIHdvcmtzIGJldHRlciB0aGFuCiAgICAgICAgICAgIGRlZmF1bHQgc2VsZWN0aW9uLiIiIgogICAgICAgICAgICByZXR1cm4gcmFuZG9tLmNob2ljZSgKICAgICAgICAgICAgICAgIHNvY2tldC5nZXRhZGRyaW5mbyhzZWxmLmVuZHBvaW50LCBzZWxmLnBvcnQpKVs0XVswXQoKICAgIGRlZiBfY29ubmVjdF9zc2woc2VsZiwgcGxhaW5fc29ja2V0KToKICAgICAgICAiIiJDb25uZWN0cyB0aGUgc29ja2V0IGFuZCB3cmFwcyBpbiBTU0wuIFJldHVybnMgdGhlIHdyYXBwZWQgc29ja2V0CiAgICAgICAgb3IgTm9uZSBpbiBjYXNlIG9mIElPIG9yIG90aGVyIGVycm9ycy4iIiIKICAgICAgICAjIEZJWE1FIHRoaXMgY29kZSBpZ25vcmVzIC0tbG9jYWwKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFkZHJlc3MgPSAnLScKICAgICAgICAgICAgYWRkcmVzcyA9IHNlbGYuX2dldF9hZGRyZXNzKHNlbGYuX3VzZV9wcm94eSkKICAgICAgICAgICAgcyA9IHBsYWluX3NvY2tldAogICAgICAgICAgICBzLmNvbm5lY3QoKGFkZHJlc3MsIHNlbGYucG9ydCkpCgogICAgICAgICAgICBpZiBGRUFUX1NTTDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzID0gd3JhcF9zb2NrZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWluX3NvY2tldCwgY2FfY2VydHM9c2VsZi5fY2VydHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwgc3NsX3ZlcnNpb249c3NsLlBST1RPQ09MX1RMU3YxLAogICAgICAgICAgICAgICAgICAgICAgICBjaXBoZXJzPSJISUdIOi1hTlVMTDotZU5VTEw6LVBTSzpSQzQtU0hBOlJDNC1NRDUiKQogICAgICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBzID0gd3JhcF9zb2NrZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWluX3NvY2tldCwgY2FfY2VydHM9c2VsZi5fY2VydHMsIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwKICAgICAgICAgICAgICAgICAgICAgICAgc3NsX3ZlcnNpb249c3NsLlBST1RPQ09MX1RMU3YxKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtYXRjaF9ob3N0bmFtZShzLmdldHBlZXJjZXJ0KCksIHNlbGYuZW5kcG9pbnQpCiAgICAgICAgICAgICAgICBleGNlcHQgQ2VydGlmaWNhdGVFcnJvciwgY2U6CiAgICAgICAgICAgICAgICAgICAgcmVwb3J0KCJDb3VsZCBub3QgdmFsaWRhdGUgU1NMIGNlcnRpZmljYXRlIGZvciAlczogJXMiICUKICAgICAgICAgICAgICAgICAgICAgICAgKHNlbGYuZW5kcG9pbnQsIGNlLm1lc3NhZ2UpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzID0gd3JhcF9zb2NrZXQocGxhaW5fc29ja2V0LCBjYV9jZXJ0cz1zZWxmLl9jZXJ0cykKICAgICAgICAgICAgcmV0dXJuIHMKCiAgICAgICAgZXhjZXB0IElPRXJyb3IsIGU6CiAgICAgICAgICAgIGNhdXNlID0gZS5zdHJlcnJvcgogICAgICAgICAgICBpZiBub3QgY2F1c2U6CiAgICAgICAgICAgICAgICBjYXVzZSA9ICIoTm8gcmVhc29uIGdpdmVuKSIKICAgICAgICAgICAgcmVwb3J0KCJDYW4ndCBjb25uZWN0IHRvICVzLyVzIHZpYSBTU0wgYXQgcG9ydCAlcy4gTWFrZSBzdXJlIHRoYXQgdGhlIGhvc3QgYW5kIHBvcnQgYXJlIHJlYWNoYWJsZSAiCiAgICAgICAgICAgICAgICAgICAiYW5kIHNwZWFrIFNTTDogJXMiICUgKHNlbGYuZW5kcG9pbnQsIGFkZHJlc3MsIHNlbGYucG9ydCwgY2F1c2UpKQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9jb25uZWN0X3BsYWluKHNlbGYsIHBsYWluX3NvY2tldCk6CiAgICAgICAgIiIiQ29ubmVjdHMgdGhlIHNvY2tldCB3aXRoIHRoZSBzb2NrZXQgZ2l2ZW4uIFJldHVybnMgdGhlIHNvY2tldCBvciBOb25lIGluIGNhc2Ugb2YgSU8gZXJyb3JzLiIiIgogICAgICAgIGFkZHJlc3MgPSBzZWxmLl9nZXRfYWRkcmVzcyhzZWxmLl91c2VfcHJveHkpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwbGFpbl9zb2NrZXQuY29ubmVjdCgoYWRkcmVzcywgc2VsZi5wb3J0KSkKICAgICAgICBleGNlcHQgSU9FcnJvciwgZToKICAgICAgICAgICAgY2F1c2UgPSBlLnN0cmVycm9yCiAgICAgICAgICAgIGlmIG5vdCBjYXVzZToKICAgICAgICAgICAgICAgIGNhdXNlID0gIiIKICAgICAgICAgICAgcmVwb3J0KCJDYW4ndCBjb25uZWN0IHRvICVzLyVzIGF0IHBvcnQgJXMuIE1ha2Ugc3VyZSB0aGF0IHRoZSBob3N0IGFuZCBwb3J0IGFyZSByZWFjaGFibGVcbiIKICAgICAgICAgICAgICAgICAgICJFcnJvciBtZXNzYWdlOiAlcyIgJSAoc2VsZi5lbmRwb2ludCwgYWRkcmVzcywgc2VsZi5wb3J0LCBlLnN0cmVycm9yKSkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gcGxhaW5fc29ja2V0CgogICAgZGVmIF9vcGVuX2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIiIiIE9wZW5zIGEgcHVzaCBjb25uZWN0aW9uIHRvIGxvZ2VudHJpZXMuICIiIgogICAgICAgIGxvZy5kZWJ1ZygiT3BlbmluZyBjb25uZWN0aW9uICVzOiVzICVzIiwKICAgICAgICAgICAgICAgICAgc2VsZi5lbmRwb2ludCwgc2VsZi5wb3J0LCBzZWxmLnByZWFtYmxlLnN0cmlwKCkpCiAgICAgICAgcmV0cnkgPSAwCiAgICAgICAgZGVsYXkgPSBTUlZfUkVDT05fVE9fTUlOCiAgICAgICAgIyBLZWVwIHRyeWluZyB0byBvcGVuIHRoZSBjb25uZWN0aW9uCiAgICAgICAgd2hpbGUgbm90IHNlbGYuX3NodXRkb3duOgogICAgICAgICAgICBzZWxmLl9jbG9zZV9jb25uZWN0aW9uKCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcyA9IE5vbmUKICAgICAgICAgICAgICAgIGlmIHNlbGYuX3VzZV9wcm94eToKICAgICAgICAgICAgICAgICAgICBzID0gc29ja3Muc29ja3NvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICAgICAgICAgIHMuc2V0cHJveHkoc2VsZi5fcHJveHlfdHlwZSwgc2VsZi5fcHJveHlfdXJsLCBzZWxmLl9wcm94eV9wb3J0KQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQoKICAgICAgICAgICAgICAgIHMuc2V0dGltZW91dChUQ1BfVElNRU9VVCkKICAgICAgICAgICAgICAgIGlmIHNlbGYudXNlX3NzbDoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzZWxmLl9jb25uZWN0X3NzbChzKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzZWxmLl9jb25uZWN0X3BsYWluKHMpCgogICAgICAgICAgICAgICAgIyBJZiB0aGUgc29ja2V0IGlzIG9wZW4sIHNlbmQgcHJlYW1ibGUgYW5kIGxlYXZlCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9zb2NrZXQ6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcmVhbWJsZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNlbmQoc2VsZi5wcmVhbWJsZSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAjIFhYWAoKICAgICAgICAgICAgIyBXYWl0IGJldHdlZW4gYXR0ZW1wdHMKICAgICAgICAgICAgdGltZS5zbGVlcChkZWxheSkKICAgICAgICAgICAgcmV0cnkgKz0gMQogICAgICAgICAgICBkZWxheSAqPSAyCiAgICAgICAgICAgIGlmIGRlbGF5ID4gU1JWX1JFQ09OX1RPX01BWDoKICAgICAgICAgICAgICAgIGRlbGF5ID0gU1JWX1JFQ09OX1RPX01BWAoKICAgIGRlZiBfY2xvc2VfY29ubmVjdGlvbihzZWxmKToKICAgICAgICBpZiBzZWxmLl9zb2NrZXQ6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgc2VsZi5fc29ja2V0ID0gTm9uZQoKICAgIGRlZiBfc2VuZF9lbnRyeShzZWxmLCBlbnRyeSk6CiAgICAgICAgIiIiU2VuZHMgdGhlIGVudHJ5LiBJZiB0aGUgY29ubmVjdGlvbiBmYWlscyBpdCB3aWxsIHJlLW9wZW4gaXQgYW5kIHRyeQogICAgICAgIGFnYWluLiIiIgogICAgICAgICMgS2VlcCBzZW5kaW5nIGRhdGEgdW50aWwgc3VjY2Vzc2Z1bAogICAgICAgIHdoaWxlIG5vdCBzZWxmLl9zaHV0ZG93bjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNlbmQoZW50cnkuZW5jb2RlKCd1dGY4JykpCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9kZWJ1Z190cmFuc3BvcnRfZXZlbnRzOgogICAgICAgICAgICAgICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsIGVudHJ5LmVuY29kZSgndXRmOCcpLAogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuX29wZW5fY29ubmVjdGlvbigpCgogICAgZGVmIHNlbmQoc2VsZiwgZW50cnkpOgogICAgICAgICIiIlNlbmRzIHRoZSBlbnRyeSBnaXZlbi4gRGVwZW5kaW5nIG9uIHRyYW5zcG9ydCBjb25maWd1cmF0aW9uIGl0IHdpbGwKICAgICAgICBibG9jayB1bnRpbCB0aGUgZW50cnkgaXMgc2VudCBvciBpdCB3aWxsIHF1ZXVlIHRoZSBlbnRyeSBmb3IgYXN5bmMKICAgICAgICBzZW5kLgoKICAgICAgICBOb3RlOiBlbnRyeSBtdXN0IGVuZCB3aXRoIGEgbmV3IGxpbmUKICAgICAgICAiIiIKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9lbnRyaWVzLnB1dF9ub3dhaXQoZW50cnkpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgUXVldWUuRnVsbDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9lbnRyaWVzLmdldF9ub3dhaXQoKQogICAgICAgICAgICAgICAgZXhjZXB0IFF1ZXVlLkVtcHR5OgogICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi5fc2h1dGRvd24gPSBUcnVlCiAgICAgICAgc2VsZi5fd29ya2VyLmpvaW4oVFJBTlNQT1JUX0pPSU5fSU5URVJWQUwpCgogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiJXaGVuIHJ1biB3aXRoIGJhY2tncm91ZCB0aHJlYWQgaXQgY29sbGVjdHMgZW50cmllcyBmcm9tIGludGVybmFsCiAgICAgICAgcXVldWUgYW5kIHNlbmRzIHRoZW0gdG8gZGVzdGluYXRpb24uIiIiCiAgICAgICAgc2VsZi5fb3Blbl9jb25uZWN0aW9uKCkKICAgICAgICB3aGlsZSBub3Qgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGVudHJ5ID0gc2VsZi5fZW50cmllcy5nZXQoVHJ1ZSwgMSkKICAgICAgICAgICAgICAgIHNlbGYuX3NlbmRfZW50cnkoZW50cnkgKyAnXG4nKQogICAgICAgICAgICBleGNlcHQgUXVldWUuRW1wdHk6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkV4Y2VwdGlvbiBpbiBydW46ICVzIiwgdHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICBzZWxmLl9jbG9zZV9jb25uZWN0aW9uKCkKCgpjbGFzcyBEZWZhdWx0VHJhbnNwb3J0KG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHhjb25maWcpOgogICAgICAgIHNlbGYuX3RyYW5zcG9ydCA9IE5vbmUKICAgICAgICBzZWxmLl9jb25maWcgPSB4Y29uZmlnCgogICAgZGVmIGdldChzZWxmKToKICAgICAgICBpZiBub3Qgc2VsZi5fdHJhbnNwb3J0OgogICAgICAgICAgICB1c2Vfc3NsID0gbm90IHNlbGYuX2NvbmZpZy5zdXBwcmVzc19zc2wKICAgICAgICAgICAgaWYgc2VsZi5fY29uZmlnLmRhdGFodWI6CiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IHNlbGYuX2NvbmZpZy5kYXRhaHViX2lwCiAgICAgICAgICAgICAgICBwb3J0ID0gc2VsZi5fY29uZmlnLmRhdGFodWJfcG9ydAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW5kcG9pbnQgPSBEb21haW4uREFUQQogICAgICAgICAgICAgICAgaWYgdXNlX3NzbDoKICAgICAgICAgICAgICAgICAgICBwb3J0ID0gNDQzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MAogICAgICAgICAgICBpZiBjb25maWcuZm9yY2VfZG9tYWluOgogICAgICAgICAgICAgICAgZW5kcG9pbnQgPSBzZWxmLl9jb25maWcuZm9yY2VfZG9tYWluCiAgICAgICAgICAgIGVsaWYgc2VsZi5fY29uZmlnLmZvcmNlX2RhdGFfaG9zdDoKICAgICAgICAgICAgICAgIGVuZHBvaW50ID0gc2VsZi5fY29uZmlnLmZvcmNlX2RhdGFfaG9zdAogICAgICAgICAgICBpZiBzZWxmLl9jb25maWcuZGVidWdfbG9jYWw6CiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IERvbWFpbi5MT0NBTAogICAgICAgICAgICAgICAgcG9ydCA9IDEwMDAwCiAgICAgICAgICAgICAgICB1c2Vfc3NsID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5fdHJhbnNwb3J0ID0gVHJhbnNwb3J0KAogICAgICAgICAgICAgICAgZW5kcG9pbnQsIHBvcnQsIHVzZV9zc2wsICcnLCBzZWxmLl9jb25maWcuZGVidWdfdHJhbnNwb3J0X2V2ZW50cywKICAgICAgICAgICAgICAgIChzZWxmLl9jb25maWcucHJveHlfdHlwZSwgc2VsZi5fY29uZmlnLnByb3h5X3VybCwgc2VsZi5fY29uZmlnLnByb3h5X3BvcnQpKQogICAgICAgIHJldHVybiBzZWxmLl90cmFuc3BvcnQKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgaWYgc2VsZi5fdHJhbnNwb3J0OgogICAgICAgICAgICBzZWxmLl90cmFuc3BvcnQuY2xvc2UoKQoKCmNsYXNzIENvbmZpZ3VyZWRMb2cob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgdG9rZW4sIGRlc3RpbmF0aW9uLCBwYXRoLCBmb3JtYXR0ZXIsIGVudHJ5X2lkZW50aWZpZXIpOgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKICAgICAgICBzZWxmLnRva2VuID0gdG9rZW4KICAgICAgICBzZWxmLmRlc3RpbmF0aW9uID0gZGVzdGluYXRpb24KICAgICAgICBzZWxmLnBhdGggPSBwYXRoCiAgICAgICAgc2VsZi5mb3JtYXR0ZXIgPSBmb3JtYXR0ZXIKICAgICAgICBzZWxmLmVudHJ5X2lkZW50aWZpZXIgPSBlbnRyeV9pZGVudGlmaWVyCiAgICAgICAgc2VsZi5sb2dzZXQgPSBOb25lCiAgICAgICAgc2VsZi5zZXRfa2V5ID0gTm9uZQogICAgICAgIHNlbGYubG9nX2tleSA9IE5vbmUKCiAgICBkZWYgaXNfbG9nc2V0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEZsYWcgb24gd2hldGhlciBpdHMgYSB2YWxpZCBzaGFyZWRsb2cvbG9nc2V0LgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmxvZ3NldAoKCmNsYXNzIEZhdGFsQ29uZmlndXJhdGlvbkVycm9yKEV4Y2VwdGlvbik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1zZyk6CiAgICAgICAgc2VsZi5tc2cgPSBtc2cKCgpjbGFzcyBDb25maWcob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5jb25maWdfZGlyX25hbWUgPSBzZWxmLmdldF9jb25maWdfZGlyKCkKICAgICAgICBzZWxmLmNvbmZpZ19maWxlbmFtZSA9IHNlbGYuY29uZmlnX2Rpcl9uYW1lICsgTEVfQ09ORklHCiAgICAgICAgc2VsZi5jb25maWdfZCA9IG9zLnBhdGguam9pbihzZWxmLmNvbmZpZ19kaXJfbmFtZSwgJ2NvbmYuZCcpCiAgICAgICAgc2VsZi5pbmNsdWRlID0gTk9UX1NFVAoKICAgICAgICAjIENvbmZpZ3VyYXRpb24gdmFyaWFibGVzCiAgICAgICAgc2VsZi5hZ2VudF9rZXkgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5zdXBwcmVzc19zc2wgPSBGYWxzZQogICAgICAgIHNlbGYudXNlX2NhX3Byb3ZpZGVkID0gRmFsc2UKICAgICAgICBzZWxmLnVzZXJfa2V5ID0gREVGQVVMVF9VU0VSX0tFWQogICAgICAgIHNlbGYuZGF0YWh1YiA9IE5PVF9TRVQKICAgICAgICBzZWxmLmRhdGFodWJfaXAgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5kYXRhaHViX3BvcnQgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSBOT1RfU0VUCiAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IE5PVF9TRVQKICAgICAgICBzZWxmLmNvbmZpZ3VyZWRfbG9ncyA9IFtdCiAgICAgICAgc2VsZi5tZXRyaWNzID0gbWV0cmljcy5NZXRyaWNzQ29uZmlnKCkKCiAgICAgICAgIyBTcGVjaWFsIG9wdGlvbnMKICAgICAgICBzZWxmLmRhZW1vbiA9IEZhbHNlCiAgICAgICAgc2VsZi5maWx0ZXJzID0gTk9UX1NFVAogICAgICAgIHNlbGYuZm9ybWF0dGVycyA9IE5PVF9TRVQKICAgICAgICBzZWxmLmZvcm1hdHRlciA9IE5PVF9TRVQKICAgICAgICBzZWxmLmVudHJ5X2lkZW50aWZpZXIgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5mb3JjZSA9IEZhbHNlCiAgICAgICAgc2VsZi5ob3N0bmFtZSA9IE5PVF9TRVQKICAgICAgICBzZWxmLnYxX21ldHJpY3MgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5uYW1lID0gTk9UX1NFVAogICAgICAgIHNlbGYubm9fdGltZXN0YW1wcyA9IEZhbHNlCiAgICAgICAgc2VsZi5waWRfZmlsZSA9IFBJRF9GSUxFCiAgICAgICAgc2VsZi5zdGQgPSBGYWxzZQogICAgICAgIHNlbGYuc3RkX2FsbCA9IEZhbHNlCiAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSBOT1RfU0VUCiAgICAgICAgc2VsZi50eXBlX29wdCA9IE5PVF9TRVQKICAgICAgICBzZWxmLnV1aWQgPSBGYWxzZQogICAgICAgIHNlbGYueGxpc3QgPSBGYWxzZQogICAgICAgIHNlbGYueWVzID0gRmFsc2UKICAgICAgICBzZWxmLm11bHRpbG9nID0gRmFsc2UKICAgICAgICAjIEJlaGF2aW91ciBhc3NvY2lhdGVkIHdpdGggZGFlbW9udG9vbHMvbXVsdGlsb2cKCiAgICAgICAgI3Byb3h5CiAgICAgICAgc2VsZi51c2VfcHJveHkgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5wcm94eV90eXBlID0gTk9UX1NFVAogICAgICAgIHNlbGYucHJveHlfdXJsID0gTk9UX1NFVAogICAgICAgIHNlbGYucHJveHlfcG9ydCA9IE5PVF9TRVQKCiAgICAgICAgIyBEZWJ1ZyBvcHRpb25zCgogICAgICAgICMgRW5hYmxlZCBmaW5lLWdyYWluZWQgbG9nZ2luZwogICAgICAgIHNlbGYuZGVidWcgPSBGYWxzZQogICAgICAgICMgQ29tbWFuZCBsaW5lIGFyZ3MgdG8gc3RkZXJyCiAgICAgICAgc2VsZi5kZWJ1Z19jbWRfbGluZSA9IEZhbHNlCiAgICAgICAgIyBNdWx0aWxvZyBzcGVjaWZpYyBkZWJ1Z2dpbmcgdG8gc3RkZXJyCiAgICAgICAgc2VsZi5kZWJ1Z19tdWx0aWxvZyA9IEZhbHNlCiAgICAgICAgIyBBbGwgcmVjb2duaXplZCBldmVudHMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfZXZlbnRzID0gRmFsc2UKICAgICAgICAjIEFsbCB0cmFuc3BvcnRlZCBldmVudHMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfdHJhbnNwb3J0X2V2ZW50cyA9IEZhbHNlCiAgICAgICAgIyBBbGwgZmlsdGVyaW5nIGFjdGlvbnMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfZmlsdGVycyA9IEZhbHNlCiAgICAgICAgIyBBbGwgZm9ybWF0dGVyaW5nIGFjdGlvbnMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfZm9ybWF0dGVycyA9IEZhbHNlCiAgICAgICAgIyBBbGwgbWV0cmljcyBhY3Rpb25zIGFyZSBsb2dnZWQKICAgICAgICBzZWxmLmRlYnVnX21ldHJpY3MgPSBGYWxzZQogICAgICAgICMgQWRhcHRlciBjb25uZWN0cyB0byBsb2NhaG9zdAogICAgICAgIHNlbGYuZGVidWdfbG9jYWwgPSBGYWxzZQogICAgICAgICMgRG8gbm90IGNvbGxlY3Qgc3RhdGlzdGljcwogICAgICAgIHNlbGYuZGVidWdfbm9zdGF0cyA9IEZhbHNlCiAgICAgICAgIyBDb2xsZWN0ZWQgc3RhdGlzdGljcyBhcmUgbG9nZ2VkCiAgICAgICAgc2VsZi5kZWJ1Z19zdGF0cyA9IEZhbHNlCiAgICAgICAgIyBDb2xsZWN0IHN0YXRpc3RpY3Mgb25seQogICAgICAgIHNlbGYuZGVidWdfc3RhdHNfb25seSA9IEZhbHNlCiAgICAgICAgIyBDb21tYW5kcyBwYXNzZWQgdG8gc2VydmVyIGFyZSBsb2dnZWQKICAgICAgICBzZWxmLmRlYnVnX3JlcXVlc3RzID0gRmFsc2UKICAgICAgICAjIERpc3BsYXkgc3lzdGVtIGluZm9ybWF0aW9uIGFuZCBleGl0CiAgICAgICAgc2VsZi5kZWJ1Z19zeXN0ZW0gPSBGYWxzZQogICAgICAgICMgRGlzcGxheSBsaXN0IG9mIGxvZ3MgaW4gdGhlIHN5c3RlbQogICAgICAgIHNlbGYuZGVidWdfbG9nbGlzdCA9IEZhbHNlCiAgICAgICAgIyBGb3JjZSBob3N0IGZvciBhcGkKICAgICAgICBzZWxmLmZvcmNlX2FwaV9ob3N0ID0gTk9UX1NFVAogICAgICAgICMgRm9yY2UgaG9zdCBmb3IgZGF0YQogICAgICAgIHNlbGYuZm9yY2VfZGF0YV9ob3N0ID0gTk9UX1NFVAogICAgICAgICMgRm9yY2UgaG9zdCBmb3IgdGhpcyBkb21haW4KICAgICAgICBzZWxmLmZvcmNlX2RvbWFpbiA9IE5PVF9TRVQKCiAgICBkZWYgZ2V0X2NvbmZpZ19kaXIoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgSWRlbnRpZmllcyBhIGNvbmZpZ3VyYXRpb24gZGlyZWN0b3J5IGZvciB0aGUgY3VycmVudCB1c2VyLgogICAgICAgIEFsd2F5cyB0ZXJtaW5hdGVkIHdpdGggc2xhc2guCiAgICAgICAgIiIiCiAgICAgICAgaWYgb3MuZ2V0ZXVpZCgpID09IDA6CiAgICAgICAgICAgICMgUnVubmluZyBhcyByb290CiAgICAgICAgICAgIGNfZGlyID0gQ09ORklHX0RJUl9TWVNURU0KICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFJ1bm5pbmcgYXMgYW4gb3JkaW5hcnkgdXNlcgogICAgICAgICAgICBjX2RpciA9IG9zLnBhdGguZXhwYW5kdXNlcignficpICsgJy8nICsgQ09ORklHX0RJUl9VU0VSCgogICAgICAgIHJldHVybiBjX2RpciArICcvJwoKICAgIGRlZiBjbGVhbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBXaXBlcyBvdXQgb2xkIGNvbmZpZ3VyYXRpb24gZmlsZS4gUmV0dXJucyBUcnVlIGlmIHN1Y2Nlc3NmdWwuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcy5yZW1vdmUoc2VsZi5jb25maWdfZmlsZW5hbWUpCiAgICAgICAgZXhjZXB0IE9TRXJyb3IsIGU6CiAgICAgICAgICAgIGlmIGUuZXJybm8gIT0gMjoKICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogJXM6ICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY29uZmlnX2ZpbGVuYW1lLCBlLnN0cmVycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgX2xpc3RfY29uZmlncyhzZWxmLCBwYXRoKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgbGlzdCBvZiBjb25maWd1cmF0aW9uIGZpbGVzIGxvY2F0ZWQgaW4gdGhlIHBhdGguCiAgICAgICAgIiIiCiAgICAgICAgY29uZmlncyA9IFtdCiAgICAgICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsocGF0aCk6CiAgICAgICAgICAgIGZvciBmaWxlbmFtZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgIGlmIGZpbGVuYW1lLmVuZHN3aXRoKENPTkZfU1VGRklYKToKICAgICAgICAgICAgICAgICAgICBjb25maWdzLmFwcGVuZChvcy5wYXRoLmpvaW4ocm9vdCwgZmlsZW5hbWUpKQogICAgICAgIHJldHVybiBzb3J0ZWQoY29uZmlncykKCiAgICBkZWYgX2dldF9pZl9kZWYoc2VsZiwgY29uZiwgcGFyYW0sIHBhcmFtX25hbWUpOgogICAgICAgIGlmIHBhcmFtID09IE5PVF9TRVQ6CiAgICAgICAgICAgIG5ld19wYXJhbSA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgcGFyYW1fbmFtZSkKICAgICAgICAgICAgaWYgbmV3X3BhcmFtICE9ICcnOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ld19wYXJhbQogICAgICAgIHJldHVybiBwYXJhbQoKICAgIGRlZiBsb2FkKHNlbGYsIGxvYWRfaW5jbHVkZV9kaXJzPVRydWUpOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemVzIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycyBmcm9tIHRoZSBjb25maWd1cmF0aW9uCiAgICAgICAgZmlsZS4gIFJldHVybnMgVHJ1ZSBpZiBzdWNjZXNzZnVsLCBGYWxzZSBvdGhlcndpc2UuIERvZXMgbm90CiAgICAgICAgdG91Y2ggYWxyZWFkeSBkZWZpbmVkIHBhcmFtZXRlcnMuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICBsb2FkX2luY2x1ZGVfZGlycyAoYm9vbCk6IHNwZWNpZnkgaWYgZmlsZXMgZnJvbSB0aGUgaW5jbHVkZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RvcnkgYXJlIGxvYWRlZAogICAgICAgICIiIgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbmYgPSBDb25maWdQYXJzZXIuU2FmZUNvbmZpZ1BhcnNlcih7CiAgICAgICAgICAgICAgICBVU0VSX0tFWV9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBBR0VOVF9LRVlfUEFSQU06ICcnLAogICAgICAgICAgICAgICAgRklMVEVSU19QQVJBTTogJycsCiAgICAgICAgICAgICAgICBGT1JNQVRURVJTX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIEZPUk1BVFRFUl9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBFTlRSWV9JREVOVElGSUVSX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIFNVUFBSRVNTX1NTTF9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBGT1JDRV9ET01BSU5fUEFSQU06ICcnLAogICAgICAgICAgICAgICAgVVNFX0NBX1BST1ZJREVEX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIERBVEFIVUJfUEFSQU06ICcnLAogICAgICAgICAgICAgICAgU1lTU1RBVF9UT0tFTl9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBIT1NUTkFNRV9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBWMV9NRVRSSUNTX1BBUkFNOiAnVHJ1ZScsCiAgICAgICAgICAgICAgICBQVUxMX1NFUlZFUl9TSURFX0NPTkZJR19QQVJBTTogJ1RydWUnLAogICAgICAgICAgICAgICAgSU5DTFVERV9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBQUk9YWV9UWVBFX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIFBST1hZX1VSTF9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBQUk9YWV9QT1JUX1BBUkFNOiAnJywKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICMgUmVhZCBjb25maWd1cmF0aW9uIGZpbGVzIGZyb20gZGVmYXVsdCBkaXJlY3RvcmllcwogICAgICAgICAgICBjb25maWdfZmlsZXMgPSBbc2VsZi5jb25maWdfZmlsZW5hbWVdCiAgICAgICAgICAgIGlmIGxvYWRfaW5jbHVkZV9kaXJzOgogICAgICAgICAgICAgICAgY29uZmlnX2ZpbGVzLmV4dGVuZChzZWxmLl9saXN0X2NvbmZpZ3Moc2VsZi5jb25maWdfZCkpCgogICAgICAgICAgICAjIEFkanVzdCBjb25maWd1cmF0aW9uIGZpbGUgcGVybWlzc2lvbnMgdG8gYmUgb25seSByZWFkYWJsZSBieSBvbndlciArIGdyb3VwCiAgICAgICAgICAgIGZvciBfY29uZmlnIGluIGNvbmZpZ19maWxlczoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoX2NvbmZpZyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgICAgIHdvcmxkX3JlYWRhYmxlID0gYm9vbChvcy5zdGF0KF9jb25maWcpLnN0X21vZGUgJiBzdGF0LlNfSVJPVEgpCiAgICAgICAgICAgICAgICAgICAgaWYgd29ybGRfcmVhZGFibGU6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKF9jb25maWcsIDA2NDApCiAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICBsb2cud2FybignQ291bGQgbm90IGFkanVzdCBwZXJtaXNzaW9ucyBmb3IgY29uZmlnIGZpbGUgJXMnLCBfY29uZmlnLCBleGNfaW5mbz1UcnVlKQoKICAgICAgICAgICAgY29uZi5yZWFkKGNvbmZpZ19maWxlcykKCiAgICAgICAgICAgICMgRmFpbCBpZiBubyBjb25maWd1cmF0aW9uIGZpbGUgZXhpc3QKICAgICAgICAgICAgaWYgbm90IGNvbmYuaGFzX3NlY3Rpb24oTUFJTl9TRUNUKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBHZXQgb3B0aW9uYWwgdXNlci1wcm92aWRlZCBjb25maWd1cmF0aW9uIGRpcmVjdG9yeQogICAgICAgICAgICBzZWxmLmluY2x1ZGUgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuaW5jbHVkZSwgSU5DTFVERV9QQVJBTSkKCiAgICAgICAgICAgICMgTG9hZCBjb25maWd1cmF0aW9uIGZpbGVzIGZyb20gdXNlci1wcm92aWRlZCBkaXJlY3RvcnkKICAgICAgICAgICAgaWYgbG9hZF9pbmNsdWRlX2RpcnMgYW5kIHNlbGYuaW5jbHVkZToKICAgICAgICAgICAgICAgIGNvbmZpZ19maWxlcy5leHRlbmQoY29uZi5yZWFkKHNlbGYuX2xpc3RfY29uZmlncyhzZWxmLmluY2x1ZGUpKSkKCiAgICAgICAgICAgIGxvZy5kZWJ1ZygnQ29uZmlndXJhdGlvbiBmaWxlcyBsb2FkZWQ6ICVzJywgJywgJy5qb2luKGNvbmZpZ19maWxlcykpCgogICAgICAgICAgICAjIExvYWQgcGFyYW1ldGVycwogICAgICAgICAgICBzZWxmLnVzZXJfa2V5ID0gc2VsZi5fZ2V0X2lmX2RlZihjb25mLCBzZWxmLnVzZXJfa2V5LCBVU0VSX0tFWV9QQVJBTSkKICAgICAgICAgICAgc2VsZi5hZ2VudF9rZXkgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuYWdlbnRfa2V5LCBBR0VOVF9LRVlfUEFSQU0pCiAgICAgICAgICAgIHNlbGYuZmlsdGVycyA9IHNlbGYuX2dldF9pZl9kZWYoY29uZiwgc2VsZi5maWx0ZXJzLCBGSUxURVJTX1BBUkFNKQogICAgICAgICAgICBzZWxmLmZvcm1hdHRlcnMgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuZm9ybWF0dGVycywgRk9STUFUVEVSU19QQVJBTSkKICAgICAgICAgICAgc2VsZi5mb3JtYXR0ZXIgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuZm9ybWF0dGVyLCBGT1JNQVRURVJfUEFSQU0pCiAgICAgICAgICAgIHNlbGYuZW50cnlfaWRlbnRpZmllciA9IHNlbGYuX2dldF9pZl9kZWYoY29uZiwgc2VsZi5lbnRyeV9pZGVudGlmaWVyLCBFTlRSWV9JREVOVElGSUVSX1BBUkFNKQogICAgICAgICAgICBzZWxmLmhvc3RuYW1lID0gc2VsZi5fZ2V0X2lmX2RlZihjb25mLCBzZWxmLmhvc3RuYW1lLCBIT1NUTkFNRV9QQVJBTSkKICAgICAgICAgICAgc2VsZi52MV9tZXRyaWNzID0gc2VsZi5fZ2V0X2lmX2RlZihjb25mLCBzZWxmLnYxX21ldHJpY3MsIFYxX01FVFJJQ1NfUEFSQU0pCiAgICAgICAgICAgIGlmIHNlbGYucHVsbF9zZXJ2ZXJfc2lkZV9jb25maWcgPT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIG5ld19wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgUFVMTF9TRVJWRVJfU0lERV9DT05GSUdfUEFSQU0pCiAgICAgICAgICAgICAgICBzZWxmLnB1bGxfc2VydmVyX3NpZGVfY29uZmlnID0gbmV3X3B1bGxfc2VydmVyX3NpZGVfY29uZmlnID09ICdUcnVlJwogICAgICAgICAgICAgICAgaWYgbmV3X3B1bGxfc2VydmVyX3NpZGVfY29uZmlnIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IFRydWUKCiAgICAgICAgICAgICMgUHJveHkgY29uZmlndXJhdGlvbgogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3R5cGUgPT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfdHlwZSA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgUFJPWFlfVFlQRV9QQVJBTSkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3R5cGU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV90eXBlID0gTk9UX1NFVAogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3VybCA9PSBOT1RfU0VUOgogICAgICAgICAgICAgICAgc2VsZi5wcm94eV91cmwgPSBjb25mLmdldChNQUlOX1NFQ1QsIFBST1hZX1VSTF9QQVJBTSkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3VybDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3VybCA9IE5PVF9TRVQKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9wb3J0ID09IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBwcm94eV9wb3J0ID0gY29uZi5nZXQoTUFJTl9TRUNULCBQUk9YWV9QT1JUX1BBUkFNKQogICAgICAgICAgICAgICAgaWYgbm90IHByb3h5X3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9wb3J0ID0gTk9UX1NFVAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3BvcnQgPSBpbnQocHJveHlfcG9ydCkKCiAgICAgICAgICAgIGlmIHNlbGYucHJveHlfdHlwZSAhPSBOT1RfU0VUIGFuZCBzZWxmLnByb3h5X3VybCAhPSBOT1RfU0VUIGFuZCBzZWxmLnByb3h5X3BvcnQgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIHNlbGYudXNlX3Byb3h5ID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi51c2VfcHJveHkgPSBGYWxzZQoKICAgICAgICAgICAgbmV3X3N1cHByZXNzX3NzbCA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgU1VQUFJFU1NfU1NMX1BBUkFNKQogICAgICAgICAgICBpZiBuZXdfc3VwcHJlc3Nfc3NsID09ICdUcnVlJzoKICAgICAgICAgICAgICAgIHNlbGYuc3VwcHJlc3Nfc3NsID0gbmV3X3N1cHByZXNzX3NzbCA9PSAnVHJ1ZScKICAgICAgICAgICAgbmV3X2ZvcmNlX2RvbWFpbiA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgRk9SQ0VfRE9NQUlOX1BBUkFNKQogICAgICAgICAgICBpZiBuZXdfZm9yY2VfZG9tYWluOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9kb21haW4gPSBuZXdfZm9yY2VfZG9tYWluCiAgICAgICAgICAgIGlmIHNlbGYuZGF0YWh1YiA9PSBOT1RfU0VUOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfZGF0YWh1Yl9zZXR0aW5ncygKICAgICAgICAgICAgICAgICAgICBjb25mLmdldChNQUlOX1NFQ1QsIERBVEFIVUJfUEFSQU0pLCBzaG91bGRfZGllPUZhbHNlKQogICAgICAgICAgICBpZiBzZWxmLnN5c3RlbV9zdGF0c190b2tlbiA9PSBOT1RfU0VUOgogICAgICAgICAgICAgICAgc3lzdGVtX3N0YXRzX3Rva2VuX3N0ciA9IGNvbmYuZ2V0KAogICAgICAgICAgICAgICAgICAgIE1BSU5fU0VDVCwgU1lTU1RBVF9UT0tFTl9QQVJBTSkKICAgICAgICAgICAgICAgIGlmIHN5c3RlbV9zdGF0c190b2tlbl9zdHIgIT0gJyc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSBzeXN0ZW1fc3RhdHNfdG9rZW5fc3RyCgogICAgICAgICAgICBzZWxmLm1ldHJpY3MubG9hZChjb25mKQoKICAgICAgICAgICAgc2VsZi5sb2FkX2NvbmZpZ3VyZWRfbG9ncyhjb25mKQoKICAgICAgICBleGNlcHQgQ29uZmlnUGFyc2VyLk5vU2VjdGlvbkVycm9yLCBlMDoKICAgICAgICAgICAgcmFpc2UgRmF0YWxDb25maWd1cmF0aW9uRXJyb3IoJyVzJyVlMCkKICAgICAgICBleGNlcHQgQ29uZmlnUGFyc2VyLk5vT3B0aW9uRXJyb3IsIGUxOgogICAgICAgICAgICByYWlzZSBGYXRhbENvbmZpZ3VyYXRpb25FcnJvcignJXMnJWUxKQogICAgICAgIGV4Y2VwdCBDb25maWdQYXJzZXIuTWlzc2luZ1NlY3Rpb25IZWFkZXJFcnJvciwgZTI6CiAgICAgICAgICAgIHJhaXNlIEZhdGFsQ29uZmlndXJhdGlvbkVycm9yKCclcyclZTIpCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgbG9hZF9jb25maWd1cmVkX2xvZ3Moc2VsZiwgY29uZik6CiAgICAgICAgZ2xvYmFsIGxvZwogICAgICAgICIiIgogICAgICAgIExvYWRzIGNvbmZpZ3VyZWQgbG9ncyBmcm9tIHRoZSBjb25maWd1cmF0aW9uIGZpbGUuCiAgICAgICAgVGhlc2UgYXJlIGxvZ3MgdGhhdCB1c2UgdG9rZW5zLgogICAgICAgICIiIgogICAgICAgIHNlbGYuY29uZmlndXJlZF9sb2dzID0gW10KICAgICAgICBhY2NvdW50X2hvc3RzID0gTm9uZQogICAgICAgIGZvciBuYW1lIGluIGNvbmYuc2VjdGlvbnMoKToKICAgICAgICAgICAgaWYgbmFtZSAhPSBNQUlOX1NFQ1Q6CiAgICAgICAgICAgICAgICB0b2tlbiA9ICcnCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgeHRva2VuID0gY29uZi5nZXQobmFtZSwgVE9LRU5fUEFSQU0pCiAgICAgICAgICAgICAgICAgICAgaWYgeHRva2VuOgogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHV1aWRfcGFyc2UoeHRva2VuKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgdG9rZW46CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cud2FybmluZygiSW52YWxpZCBsb2cgdG9rZW4gYCVzJyBpbiBhcHBsaWNhdGlvbiBgJXMnLiIsIHh0b2tlbiwgbmFtZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBDb25maWdQYXJzZXIuTm9PcHRpb25FcnJvcjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHBhdGggPSBjb25mLmdldChuYW1lLCBQQVRIX1BBUkFNKQogICAgICAgICAgICAgICAgZXhjZXB0IENvbmZpZ1BhcnNlci5Ob09wdGlvbkVycm9yOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJOb3RlOiBSZXF1aXJlZCBwYXJhbWV0ZXIgYCVzJyBub3QgZm91bmQgaW4gYXBwbGljYXRpb24gYCVzJywgc2tpcHBpbmcgdGhpcyBhcHBsaWNhdGlvbiIsIFBBVEhfUEFSQU0sIG5hbWUpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9ICcnCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb25mLmdldChuYW1lLCBERVNUSU5BVElPTl9QQVJBTSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBDb25maWdQYXJzZXIuTm9PcHRpb25FcnJvcjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAgICAgZm9ybWF0dGVyID0gJycKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXIgPSBjb25mLmdldChuYW1lLCBGT1JNQVRURVJfUEFSQU0pCiAgICAgICAgICAgICAgICBleGNlcHQgQ29uZmlnUGFyc2VyLk5vT3B0aW9uRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgICAgIGVudHJ5X2lkZW50aWZpZXIgPSAnJwogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGVudHJ5X2lkZW50aWZpZXIgPSBjb25mLmdldChuYW1lLCBFTlRSWV9JREVOVElGSUVSX1BBUkFNKQogICAgICAgICAgICAgICAgZXhjZXB0IENvbmZpZ1BhcnNlci5Ob09wdGlvbkVycm9yOgogICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICAgICBjb25maWd1cmVkX2xvZyA9IENvbmZpZ3VyZWRMb2cobmFtZSwgdG9rZW4sIGRlc3RpbmF0aW9uLCBwYXRoLCBmb3JtYXR0ZXIsIGVudHJ5X2lkZW50aWZpZXIpCiAgICAgICAgICAgICAgICBzZWxmLmNvbmZpZ3VyZWRfbG9ncy5hcHBlbmQoY29uZmlndXJlZF9sb2cpCgogICAgZGVmIHNhdmUoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZXMgY29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzIGludG8gdGhlIGNvbmZpZ3VyYXRpb24gZmlsZS4KICAgICAgICBUaGUgZmlsZSB3aXRoIGNlcnRpZmljYXRlcyBpcyBhZGRlZCBhcyB3ZWxsLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY29uZiA9IENvbmZpZ1BhcnNlci5TYWZlQ29uZmlnUGFyc2VyKCkKICAgICAgICAgICAgY3JlYXRlX2NvbmZfZGlyKHNlbGYpCiAgICAgICAgICAgIGNvbmZfZmlsZSA9IG9wZW4oc2VsZi5jb25maWdfZmlsZW5hbWUsICd3YicpCiAgICAgICAgICAgIGNvbmYuYWRkX3NlY3Rpb24oTUFJTl9TRUNUKQogICAgICAgICAgICBpZiBzZWxmLnVzZXJfa2V5ICE9IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIFVTRVJfS0VZX1BBUkFNLCBzZWxmLnVzZXJfa2V5KQogICAgICAgICAgICBpZiBzZWxmLmFnZW50X2tleSAhPSBOT1RfU0VUOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBBR0VOVF9LRVlfUEFSQU0sIHNlbGYuYWdlbnRfa2V5KQogICAgICAgICAgICBpZiBzZWxmLmZpbHRlcnMgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgRklMVEVSU19QQVJBTSwgc2VsZi5maWx0ZXJzKQogICAgICAgICAgICBpZiBzZWxmLmZvcm1hdHRlcnMgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgRk9STUFUVEVSU19QQVJBTSwgc2VsZi5mb3JtYXR0ZXJzKQogICAgICAgICAgICBpZiBzZWxmLmZvcm1hdHRlciAhPSBOT1RfU0VUOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBGT1JNQVRURVJfUEFSQU0sIHNlbGYuZm9ybWF0dGVyKQogICAgICAgICAgICBpZiBzZWxmLnYxX21ldHJpY3MgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgVjFfTUVUUklDU19QQVJBTSwgc2VsZi52MV9tZXRyaWNzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBWMV9NRVRSSUNTX1BBUkFNLCAnRmFsc2UnKQogICAgICAgICAgICBpZiBzZWxmLmhvc3RuYW1lICE9IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIEhPU1ROQU1FX1BBUkFNLCBzZWxmLmhvc3RuYW1lKQogICAgICAgICAgICBpZiBzZWxmLnN1cHByZXNzX3NzbDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgU1VQUFJFU1NfU1NMX1BBUkFNLCAnVHJ1ZScpCiAgICAgICAgICAgIGlmIHNlbGYudXNlX2NhX3Byb3ZpZGVkOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBVU0VfQ0FfUFJPVklERURfUEFSQU0sICdUcnVlJykKICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9kb21haW46CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIEZPUkNFX0RPTUFJTl9QQVJBTSwgc2VsZi5mb3JjZV9kb21haW4pCiAgICAgICAgICAgIGlmIHNlbGYucHVsbF9zZXJ2ZXJfc2lkZV9jb25maWcgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgUFVMTF9TRVJWRVJfU0lERV9DT05GSUdfUEFSQU0sICIlcyIgJQogICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZykKICAgICAgICAgICAgaWYgc2VsZi5kYXRhaHViICE9IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIERBVEFIVUJfUEFSQU0sIHNlbGYuZGF0YWh1YikKICAgICAgICAgICAgaWYgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KAogICAgICAgICAgICAgICAgICAgIE1BSU5fU0VDVCwgU1lTU1RBVF9UT0tFTl9QQVJBTSwgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4pCgogICAgICAgICAgICBmb3IgY2xvZyBpbiBzZWxmLmNvbmZpZ3VyZWRfbG9nczoKICAgICAgICAgICAgICAgIGNvbmYuYWRkX3NlY3Rpb24oY2xvZy5uYW1lKQogICAgICAgICAgICAgICAgaWYgY2xvZy50b2tlbjoKICAgICAgICAgICAgICAgICAgICBjb25mLnNldChjbG9nLm5hbWUsIFRPS0VOX1BBUkFNLCBjbG9nLnRva2VuKQogICAgICAgICAgICAgICAgY29uZi5zZXQoY2xvZy5uYW1lLCBQQVRIX1BBUkFNLCBjbG9nLnBhdGgpCiAgICAgICAgICAgICAgICBpZiBjbG9nLmRlc3RpbmF0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbmYuc2V0KGNsb2cubmFtZSwgREVTVElOQVRJT05fUEFSQU0sIGNsb2cuZGVzdGluYXRpb24pCgogICAgICAgICAgICBzZWxmLm1ldHJpY3Muc2F2ZShjb25mKQoKICAgICAgICAgICAgY29uZi53cml0ZShjb25mX2ZpbGUpCiAgICAgICAgZXhjZXB0IElPRXJyb3IsIGU6CiAgICAgICAgICAgIGRpZSgiRXJyb3I6IElPIGVycm9yIHdoZW4gd3JpdGluZyB0byBjb25maWcgZmlsZTogJXMiICUgZSkKCiAgICBkZWYgY2hlY2tfa2V5KHNlbGYsIGtleSk6CiAgICAgICAgIiIiCiAgICAgICAgQ2hlY2tzIGlmIHRoZSBrZXkgbG9va3MgZmluZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBsZW4oa2V5KSA9PSBLRVlfTEVOCgogICAgZGVmIHNldF91c2VyX2tleShzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfa2V5KHZhbHVlKToKICAgICAgICAgICAgZGllKCdFcnJvcjogVXNlciBrZXkgZG9lcyBub3QgbG9vayByaWdodC4nKQogICAgICAgIHNlbGYudXNlcl9rZXkgPSB2YWx1ZQoKICAgIGRlZiB1c2VyX2tleV9yZXF1aXJlZChzZWxmLCBhc2tfZm9yX2l0KToKICAgICAgICAiIiIKICAgICAgICBFeGl0cyB3aXRoIGVycm9yIG1lc3NhZ2UgaWYgdGhlIHVzZXIga2V5IGlzIG5vdCBkZWZpbmVkLgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYudXNlcl9rZXkgPT0gTk9UX1NFVDoKICAgICAgICAgICAgaWYgYXNrX2Zvcl9pdDoKICAgICAgICAgICAgICAgIGxvZy5pbmZvKAogICAgICAgICAgICAgICAgICAgICJBY2NvdW50IGtleSBpcyByZXF1aXJlZC4gRW50ZXIgeW91ciBMb2dlbnRyaWVzIGxvZ2luICIKICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbHMgb3Igc3BlY2lmeSB0aGUgYWNjb3VudCBrZXkgd2l0aCAiCiAgICAgICAgICAgICAgICAgICAgIi0tYWNjb3VudC1rZXkgcGFyYW1ldGVyLiIpCiAgICAgICAgICAgICAgICBzZWxmLnVzZXJfa2V5ID0gcmV0cmlldmVfYWNjb3VudF9rZXkoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZGllKCJBY2NvdW50IGtleSBpcyByZXF1aXJlZC4gRW50ZXIgeW91ciBhY2NvdW50IGtleSB3aXRoIC0tYWNjb3VudC1rZXkgcGFyYW1ldGVyLiIpCiAgICAgICAgICAgIGNvbmZpZy5zYXZlKCkKCiAgICBkZWYgc2V0X3N5c3RlbV9zdGF0X3Rva2VuKHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19rZXkodmFsdWUpOgogICAgICAgICAgICBkaWUoJ0Vycm9yOiBzeXN0ZW0gc3RhdCB0b2tlbiBkb2VzIG5vdCBsb29rIHJpZ2h0LicpCiAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSB2YWx1ZQoKICAgIGRlZiBzeXN0ZW1fc3RhdHNfdG9rZW5fcmVxdWlyZWQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPT0gTk9UX1NFVDoKICAgICAgICAgICAgZGllKCJTeXN0ZW0gc3RhdCB0b2tlbiBpcyByZXF1aXJlZC4iKQogICAgICAgIGNvbmZpZy5zYXZlKCkKCiAgICBkZWYgc2V0X2FnZW50X2tleShzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfa2V5KHZhbHVlKToKICAgICAgICAgICAgZGllKCdFcnJvcjogQWdlbnQga2V5IGRvZXMgbm90IGxvb2sgcmlnaHQuJykKICAgICAgICBzZWxmLmFnZW50X2tleSA9IHZhbHVlCgogICAgZGVmIGFnZW50X2tleV9yZXF1aXJlZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBFeGl0cyB3aXRoIGVycm9yIG1lc3NhZ2UgaWYgdGhlIGFnZW50IGtleSBpcyBub3QgZGVmaW5lZC4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmFnZW50X2tleSA9PSBOT1RfU0VUOgogICAgICAgICAgICBkaWUoIkhvc3Qga2V5IGlzIHJlcXVpcmVkLiBSZWdpc3RlciB0aGUgaG9zdCBvciBzcGVjaWZ5IHRoZSBob3N0IGtleSB3aXRoIHRoZSAtLWhvc3Qta2V5IHBhcmFtZXRlci4iKQoKICAgIGRlZiBoYXZlX2FnZW50X2tleShzZWxmKToKICAgICAgICAiIiJUZXN0cyBpZiB0aGUgYWdlbnQga2V5IGhhcyBiZWVuIGFzc2lnbmVkIHRvIHRoaXMgaW5zdGFuY2UuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuYWdlbnRfa2V5ICE9ICcnCgogICAgZGVmIGhvc3RuYW1lX3JlcXVpcmVkKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFNldHMgdGhlIGhvc3RuYW1lIHBhcmFtZXRlciBiYXNlZCBvbiBzZXJ2ZXIgbmV0d29yayBuYW1lLiBJZgogICAgICAgIHRoZSBob3N0bmFtZSBpcyBzZXQgYWxyZWFkeSwgaXQgaXMga2VwdCB1bnRvdWNoZWQuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5ob3N0bmFtZSA9PSBOT1RfU0VUOgogICAgICAgICAgICBzZWxmLmhvc3RuYW1lID0gc29ja2V0LmdldGZxZG4oKQogICAgICAgIHJldHVybiBzZWxmLmhvc3RuYW1lCgogICAgZGVmIG5hbWVfcmVxdWlyZWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgU2V0cyBob3N0IG5hbWUgaWYgbm90IHNldCBhbHJlYWR5LiBUaGUgbmV3IGhvc3QgbmFtZSBpcwogICAgICAgIGRlbGl2ZXJlZCBmcm9tIGl0cyBob3N0bmFtZS4gQXMgYSBzaWRlIGVmZmVjdCB0aGlzCiAgICAgICAgZnVuY3Rpb24gc2V0cyBhIGhvc3RuYW1lIGFzIHdlbGwuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5uYW1lID09IE5PVF9TRVQ6CiAgICAgICAgICAgIHNlbGYubmFtZSA9IHNlbGYuaG9zdG5hbWVfcmVxdWlyZWQoKS5zcGxpdCgnLicpWzBdCiAgICAgICAgcmV0dXJuIHNlbGYubmFtZQoKICAgICMgVGhlIG1ldGhvZCBnZXRzIGFsbCBwYXJhbWV0ZXJzIG9mIGdpdmVuIHR5cGUgZnJvbSBhcmd1bWVudCBsaXN0LAogICAgIyBjaGVja3MgZm9yIHRoZWlyIGZvcm1hdCBhbmQgcmV0dXJucyBsaXN0IG9mIHZhbHVlcyBvZiBwYXJhbWV0ZXJzCiAgICAjIG9mIHNwZWNpZmllZCB0eXBlLiBFLmc6IFdlIGhhdmUgcGFyYW1zID0gWyd0cnVlJywgMTI3LjAuMC4xLCAxMDAwMF0gdGhlIGNhbGwgb2YKICAgICMgY2hlY2tfYW5kX2dldF9wYXJhbV9ieV90eXBlKHBhcmFtcywgdHlwZT0nYm9vbCcpIHlpZWxkcyBbVHJ1ZV0KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2hlY2tfYW5kX2dldF9wYXJhbV9ieV90eXBlKHBhcmFtcywgdHlwZT0nYm9vbCcpOgogICAgICAgIHJldF9wYXJhbSA9IFtdCgogICAgICAgIGZvciBwIGluIHBhcmFtczoKICAgICAgICAgICAgZm91bmQgPSBGYWxzZQogICAgICAgICAgICBwID0gcC5sb3dlcigpCiAgICAgICAgICAgIGlmIHR5cGUgPT0gJ2lwYWRkcic6CiAgICAgICAgICAgICAgICBpZiBwLmZpbmQoJy4nKSAhPSAtMToKICAgICAgICAgICAgICAgICAgICBvY3RldHMgPSBwLnNwbGl0KCcuJywgNCkKICAgICAgICAgICAgICAgICAgICBvY3RldHNfb2sgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG9jdGV0cykgPT0gNDoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG9jdGV0IGluIG9jdGV0czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9jdGV0c19vayAmPSAob2N0ZXQuaXNkaWdpdCgpKSBhbmQgKDAgPD0gaW50KG9jdGV0KSA8PSAyNTUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgb2N0ZXRzX29rID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IG9jdGV0c19vawogICAgICAgICAgICBlbGlmIHR5cGUgPT0gJ2Jvb2wnOgogICAgICAgICAgICAgICAgaWYgKHAuZmluZCgndHJ1ZScpICE9IC0xIGFuZCBsZW4ocCkgPT0gNCkgb3IgKHAuZmluZCgnZmFsc2UnKSAhPSAtMSBhbmQgbGVuKHApID09IDUpOgogICAgICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICBlbGlmIHR5cGUgPT0gJ251bWVyaWMnOgogICAgICAgICAgICAgICAgaWYgcC5pc2RpZ2l0KCk6CiAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBOYW1lRXJyb3IoJ1Vua25vd24gdHlwZSBuYW1lJykKCiAgICAgICAgICAgIGlmIGZvdW5kOgogICAgICAgICAgICAgICAgaWYgdHlwZSA9PSAnbnVtZXJpYyc6CiAgICAgICAgICAgICAgICAgICAgcmV0X3BhcmFtLmFwcGVuZChpbnQocCkpCiAgICAgICAgICAgICAgICBlbGlmIHR5cGUgPT0gJ2Jvb2wnOgogICAgICAgICAgICAgICAgICAgIHJldF9wYXJhbS5hcHBlbmQocCA9PSAndHJ1ZScpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldF9wYXJhbS5hcHBlbmQocCkKCiAgICAgICAgcmV0dXJuIHJldF9wYXJhbQoKICAgIGRlZiBzZXRfZGF0YWh1Yl9zZXR0aW5ncyhzZWxmLCB2YWx1ZSwgc2hvdWxkX2RpZT1UcnVlKToKICAgICAgICBpZiBub3QgdmFsdWUgYW5kIHNob3VsZF9kaWU6CiAgICAgICAgICAgIGRpZSgnLS1kYXRhaHViIHJlcXVpcmVzIGEgcGFyYW1ldGVyJykKICAgICAgICBlbGlmIG5vdCB2YWx1ZSBhbmQgbm90IHNob3VsZF9kaWU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB2YWx1ZXMgPSB2YWx1ZS5zcGxpdCgiOiIpCiAgICAgICAgaWYgbGVuKHZhbHVlcykgPiAyOgogICAgICAgICAgICBkaWUoIkNhbm5vdCBwYXJzZSAlcyBmb3IgLS1kYXRhaHViLiBFeHBlY3RlZCBmb3JtYXQ6IGhvc3RuYW1lOnBvcnQiICUKICAgICAgICAgICAgICAgIHZhbHVlKQoKICAgICAgICBzZWxmLmRhdGFodWJfaXAgPSB2YWx1ZXNbMF0KICAgICAgICBpZiBsZW4odmFsdWVzKSA9PSAyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmRhdGFodWJfcG9ydCA9IGludCh2YWx1ZXNbMV0pCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgZGllKCJDYW5ub3QgcGFyc2UgJXMgYXMgcG9ydC4gU3BlY2lmeSBhIHZhbGlkIC0tZGF0YWh1YiBhZGRyZXNzIiAlCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzWzFdKQogICAgICAgIHNlbGYuZGF0YWh1YiA9IHZhbHVlCgogICAgZGVmIHZhbGlkYXRlX3BhdGhuYW1lKHNlbGYsIGFyZ3M9Tm9uZSwgY21kX2xpbmU9VHJ1ZSwgcGF0aD1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBGb3IgdGhlICctLW11bHRpbG9nJyBvcHRpb24gd2hlcmUgYSB3aWxkY2FyZCBjYW4gYmUgdXNlZCBpbiB0aGUgZGlyZWN0b3J5IG5hbWUuCiAgICAgICAgVmFsaWRhdGVzIHRoZSBzdHJpbmcgdGhhdCBpcyBwYXNzZWQgdG8gdGhlIGFnZW50IGZyb20gY29tbWFuZCBsaW5lLCBjb25maWcgZmlsZSBvciBzZXJ2ZXIuCiAgICAgICAgSWYgZXJyb3IgZnJvbSBjb21tYW5kIGxpbmUsIHRoZW4gZXJyb3IgbWVzc2FnZSB3cml0dGVuIHRvIGNvbW1vbmQgbGluZSBhbmQgYWdlbnQgcXVpdHMuCiAgICAgICAgSWYgZXJyb3IgZnJvbSBjb25maWcgZmlsZSAob3Igc2VydmVyKSB0aGVuIGVycm9yIG1lc3NhZ2Ugd3JpdHRlbiB0byBsb2cgYW5kIEZhbHNlIGlzIHJldHVybmVkLgogICAgICAgIDpwYXJhbSBhcmdzOiB0aGUgcGF0aG5hbWUgZ2l2ZW4gdG8gdGhlIGFnZW50CiAgICAgICAgOnJldHVybjogICAgVHJ1ZSBpZiBva2F5LCB0aGUgYWdlbnQgd2lsbCBkaWUgb3RoZXJ3aXNlCiAgICAgICAgIiIiICAgICAgICAKICAgICAgICBpZiBjbWRfbGluZSBhbmQgcGF0aCBpcyBOb25lOgogICAgICAgICAgICBpZiBhcmdzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcG5hbWVfc2xpY2UgPSBhcmdzWzE6XQogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSB0aGF0IGEgcGF0aG5hbWUgaXMgZGV0ZWN0ZWQgaW4gcGFyYW1ldGVycyB0byBhZ2VudAogICAgICAgICAgICAgICAgaWYgbGVuKHBuYW1lX3NsaWNlKSA9PSAwOgogICAgICAgICAgICAgICAgICAgIGRpZSgiXG5FcnJvcjogTm8gcGF0aG5hbWUgZGV0ZWN0ZWQgLSBTcGVjaWZ5IHRoZSBwYXRoIHRvIHRoZSBmaWxlIHRvIGJlIGZvbGxvd2VkXG4iIAogICAgICAgICAgICAgICAgICAgICAgICArIE1VTFRJTE9HX1VTQUdFLCBFWElUX09LKQogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSB0aGF0IGFnZW50IGlzIG5vdCByZWNlaXZpbmcgYSBsaXN0IG9mIHBhdGhuYW1lcyAocG9zc2libHkgc2hlbGwgaXMgZXhwYW5kaW5nIHdpbGRjYXJkKQogICAgICAgICAgICAgICAgaWYgbGVuKHBuYW1lX3NsaWNlKSA+IDE6CiAgICAgICAgICAgICAgICAgICAgZGllKCJcbkVycm9yOiBUb28gbWFueSBhcmd1bWVudHMgYmVpbmcgcGFzc2VkIHRvIGFnZW50XG4iICsgTVVMVElMT0dfVVNBR0UsIEVYSVRfT0spCiAgICAgICAgICAgICAgICBwbmFtZSA9IHN0cihwbmFtZV9zbGljZVswXSkKICAgICAgICBlbGlmIG5vdCBjbWRfbGluZSBhbmQgcGF0aCBpcyBOb25lOgogICAgICAgICAgICAjIEZvciBhbnl0aGluZyBub3QgY29taW5nIGluIG9uIGNvbW1hbmQgbGluZSBubyBvdXRwdXQgaXMgd3JpdHRlbiB0byBjb21tYW5kIGxpbmUKICAgICAgICAgICAgbG9nLmVycm9yKCJFcnJvcjogUGF0aG5hbWUgYXJndW1lbnQgaXMgZW1wdHkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbGlmIG5vdCBjbWRfbGluZSBhbmQgcGF0aCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcG5hbWU9cGF0aAogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5iYXNlbmFtZShwbmFtZSkKICAgICAgICAjIFZlcmlmeSB0aGVyZSBpcyBhIGZpbGVuYW1lCiAgICAgICAgaWYgbm90IGZpbGVuYW1lOgogICAgICAgICAgICBpZiBub3QgY21kX2xpbmU6CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkVycm9yOiBObyBmaWxlbmFtZSBkZXRlY3RlZCBpbiB0aGUgcGF0aG5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkaWUoIlxuRXJyb3I6IE5vIGZpbGVuYW1lIGRldGVjdGVkIC0gU3BlY2lmeSB0aGUgZmlsZW5hbWUgdG8gYmUgZm9sbG93ZWRcbiIgKyBNVUxUSUxPR19VU0FHRSwgRVhJVF9PSykKICAgICAgICAjIENoZWNrIGlmIGEgd2lsZGNhcmQgZGV0ZWN0ZWQgaW4gcGF0aG5hbWUKICAgICAgICBpZiAnKicgaW4gcG5hbWU6CiAgICAgICAgICAgICMgVmVyaWZ5IHRoYXQgb25seSBvbmUgd2lsZGNhcmQgaXMgaW4gcGF0aG5hbWUKICAgICAgICAgICAgaWYgcG5hbWUuY291bnQoJyonKSA+IDE6CiAgICAgICAgICAgICAgICBpZiBub3QgY21kX2xpbmU6CiAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKCJFcnJvcjogTW9yZSB0aGVuIG9uZSB3aWxkY2FyZCAqIGRldGVjdGVkIGluIHBhdGhuYW1lIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRpZSgiXG5FcnJvcjogT25seSBvbmUgd2lsZGNhcmQgKiBhbGxvd2VkXG4iICsgTVVMVElMT0dfVVNBR0UsIEVYSVRfT0spCiAgICAgICAgICAgICMgVmVyaWZ5IHRoYXQgbm8gd2lsZGNhcmQgaXMgaW4gZmlsZW5hbWUKICAgICAgICAgICAgaWYgJyonIGluIGZpbGVuYW1lOgogICAgICAgICAgICAgICAgaWYgbm90IGNtZF9saW5lOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3I6IFdpbGRjYXJkIGRldGVjdGVkIGluIGZpbGVuYW1lIG9mIHBhdGggYXJndW1lbnQiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkaWUoIlxuRXJyb3I6IE5vIHdpbGRjYXJkICogYWxsb3dlZCBpbiBmaWxlbmFtZVxuIiArIE1VTFRJTE9HX1VTQUdFLCBFWElUX09LKQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHByb2Nlc3NfcGFyYW1zKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgIiIiCiAgICAgICAgUGFyc2VzIGNvbW1hbmQgbGluZSBwYXJhbWV0ZXJzIGFuZCB1cGRhdGVzIGNvbmZpZyBwYXJhbWV0ZXJzIGFjY29yZGluZ2x5CiAgICAgICAgIiIiCiAgICAgICAgcGFyYW1fbGlzdCA9ICIiInVzZXIta2V5PSBhY2NvdW50LWtleT0gYWdlbnQta2V5PSBob3N0LWtleT0gbm8tdGltZXN0YW1wcyBkZWJ1Zy1ldmVudHMKICAgICAgICAgICAgICAgICAgICBkZWJ1Zy10cmFuc3BvcnQtZXZlbnRzIGRlYnVnLW1ldHJpY3MKICAgICAgICAgICAgICAgICAgICBkZWJ1Zy1maWx0ZXJzIGRlYnVnLWZvcm1hdHRlcnMgZGVidWctbG9nbGlzdCBsb2NhbCBkZWJ1Zy1zdGF0cyBkZWJ1Zy1ub3N0YXRzCiAgICAgICAgICAgICAgICAgICAgZGVidWctc3RhdHMtb25seSBkZWJ1Zy1jbWQtbGluZSBkZWJ1Zy1zeXN0ZW0gaGVscCB2ZXJzaW9uIHllcyBmb3JjZSB1dWlkIGxpc3QKICAgICAgICAgICAgICAgICAgICBzdGQgc3RkLWFsbCBuYW1lPSBob3N0bmFtZT0gdHlwZT0gcGlkLWZpbGU9IGRlYnVnIG5vLWRlZmF1bHRzCiAgICAgICAgICAgICAgICAgICAgc3VwcHJlc3Mtc3NsIHVzZS1jYS1wcm92aWRlZCBmb3JjZS1hcGktaG9zdD0gZm9yY2UtZG9tYWluPQogICAgICAgICAgICAgICAgICAgIHN5c3RlbS1zdGF0LXRva2VuPSBkYXRhaHViPSBsZWdhY3lfdjFfbWV0cmljcwogICAgICAgICAgICAgICAgICAgIHB1bGwtc2VydmVyLXNpZGUtY29uZmlnPSBjb25maWc9IGNvbmZpZy5kPSBtdWx0aWxvZyBkZWJ1Zy1tdWx0aWxvZyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgb3B0bGlzdCwgYXJncyA9IGdldG9wdC5nbnVfZ2V0b3B0KHBhcmFtcywgJycsIHBhcmFtX2xpc3Quc3BsaXQoKSkKICAgICAgICBleGNlcHQgZ2V0b3B0LkdldG9wdEVycm9yLCBlcnI6CiAgICAgICAgICAgIGRpZSgiUGFyYW1ldGVyIGVycm9yOiAiICsgc3RyKGVycikpCiAgICAgICAgZm9yIG5hbWUsIHZhbHVlIGluIG9wdGxpc3Q6CiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0taGVscCI6CiAgICAgICAgICAgICAgICBwcmludF91c2FnZSgpCiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0tdmVyc2lvbiI6CiAgICAgICAgICAgICAgICBwcmludF91c2FnZShUcnVlKQogICAgICAgICAgICBpZiBuYW1lID09ICItLWNvbmZpZyI6CiAgICAgICAgICAgICAgICBzZWxmLmNvbmZpZ19maWxlbmFtZSA9IHZhbHVlCiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0tY29uZmlnLmQiOgogICAgICAgICAgICAgICAgc2VsZi5jb25maWdfZCA9IHZhbHVlCiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0teWVzIjoKICAgICAgICAgICAgICAgIHNlbGYueWVzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tdXNlci1rZXkiOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfdXNlcl9rZXkodmFsdWUpCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1hY2NvdW50LWtleSI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF91c2VyX2tleSh2YWx1ZSkKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWFnZW50LWtleSI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9hZ2VudF9rZXkodmFsdWUpCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1ob3N0LWtleSI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9hZ2VudF9rZXkodmFsdWUpCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1mb3JjZSI6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tbGlzdCI6CiAgICAgICAgICAgICAgICBzZWxmLnhsaXN0ID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tdXVpZCI6CiAgICAgICAgICAgICAgICBzZWxmLnV1aWQgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1uYW1lIjoKICAgICAgICAgICAgICAgIHNlbGYubmFtZSA9IHZhbHVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1ob3N0bmFtZSI6CiAgICAgICAgICAgICAgICBzZWxmLmhvc3RuYW1lID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWxlZ2FjeV92MV9tZXRyaWNzIjoKICAgICAgICAgICAgICAgIHNlbGYudjFfbWV0cmljcyA9ICdUcnVlJwogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tcGlkLWZpbGUiOgogICAgICAgICAgICAgICAgaWYgdmFsdWUgPT0gJyc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5waWRfZmlsZSA9IE5vbmUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5waWRfZmlsZSA9IHZhbHVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1zdGQiOgogICAgICAgICAgICAgICAgc2VsZi5zdGQgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS10eXBlIjoKICAgICAgICAgICAgICAgIHNlbGYudHlwZV9vcHQgPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tc3RkLWFsbCI6CiAgICAgICAgICAgICAgICBzZWxmLnN0ZF9hbGwgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1uby10aW1lc3RhbXBzIjoKICAgICAgICAgICAgICAgIHNlbGYubm9fdGltZXN0YW1wcyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWcgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1jbWQtbGluZSI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2NtZF9saW5lID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctbXVsdGlsb2ciOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19tdWx0aWxvZyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLWV2ZW50cyI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2V2ZW50cyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLXRyYW5zcG9ydC1ldmVudHMiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z190cmFuc3BvcnRfZXZlbnRzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctZmlsdGVycyI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2ZpbHRlcnMgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1mb3JtYXR0ZXJzIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfZm9ybWF0dGVycyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLW1ldHJpY3MiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19tZXRyaWNzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tbG9jYWwiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19sb2NhbCA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLXN0YXRzIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfc3RhdHMgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1ub3N0YXRzIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfbm9zdGF0cyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLXN0YXRzLW9ubHkiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19zdGF0c19vbmx5ID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctbG9nbGlzdCI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2xvZ2xpc3QgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1yZXF1ZXN0cyI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX3JlcXVlc3RzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctc3lzdGVtIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfc3lzdGVtID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tc3VwcHJlc3Mtc3NsIjoKICAgICAgICAgICAgICAgIHNlbGYuc3VwcHJlc3Nfc3NsID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZm9yY2UtYXBpLWhvc3QiOgogICAgICAgICAgICAgICAgaWYgdmFsdWUgYW5kIHZhbHVlICE9ICcnOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9yY2VfYXBpX2hvc3QgPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZm9yY2UtZGF0YS1ob3N0IjoKICAgICAgICAgICAgICAgIGlmIHZhbHVlIGFuZCB2YWx1ZSAhPSAnJzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX2RhdGFfaG9zdCA9IHZhbHVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1mb3JjZS1kb21haW4iOgogICAgICAgICAgICAgICAgaWYgdmFsdWUgYW5kIHZhbHVlICE9ICcnOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9yY2VfZG9tYWluID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLXVzZS1jYS1wcm92aWRlZCI6CiAgICAgICAgICAgICAgICBzZWxmLnVzZV9jYV9wcm92aWRlZCA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLXN5c3RlbS1zdGF0LXRva2VuIjoKICAgICAgICAgICAgICAgIHNlbGYuc2V0X3N5c3RlbV9zdGF0X3Rva2VuKHZhbHVlKQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tcHVsbC1zZXJ2ZXItc2lkZS1jb25maWciOgogICAgICAgICAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IHZhbHVlID09ICJUcnVlIgogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGF0YWh1YiI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9kYXRhaHViX3NldHRpbmdzKHZhbHVlKQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tbXVsdGlsb2ciOgogICAgICAgICAgICAgICAgIyBzZWxmLm11bHRpbG9nIGlzIG9ubHkgVHJ1ZSBpZiBwYXRobmFtZSBpcyBnb29kCiAgICAgICAgICAgICAgICBzZWxmLm11bHRpbG9nID0gc2VsZi52YWxpZGF0ZV9wYXRobmFtZShhcmdzLFRydWUsTm9uZSkKCiAgICAgICAgaWYgc2VsZi5kYXRhaHViX2lwIGFuZCBub3Qgc2VsZi5kYXRhaHViX3BvcnQ6CiAgICAgICAgICAgIGlmIHNlbGYuc3VwcHJlc3Nfc3NsOgogICAgICAgICAgICAgICAgc2VsZi5kYXRhaHViX3BvcnQgPSBMRV9ERUZBVUxUX05PTl9TU0xfUE9SVAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5kYXRhaHViX3BvcnQgPSBMRV9ERUZBVUxUX1NTTF9QT1JUCgogICAgICAgIGlmIHNlbGYuZGVidWdfbG9jYWwgYW5kIHNlbGYuZm9yY2VfYXBpX2hvc3Q6CiAgICAgICAgICAgIGRpZSgiRG8gbm90IHNwZWNpZnkgLS1sb2NhbCBhbmQgLS1mb3JjZS1hcGktaG9zdCBhdCB0aGUgc2FtZSB0aW1lLiIpCiAgICAgICAgaWYgc2VsZi5kZWJ1Z19sb2NhbCBhbmQgc2VsZi5mb3JjZV9kYXRhX2hvc3Q6CiAgICAgICAgICAgIGRpZSgiRG8gbm90IHNwZWNpZnkgLS1sb2NhbCBhbmQgLS1mb3JjZS1kYXRhLWhvc3QgYXQgdGhlIHNhbWUgdGltZS4iKQogICAgICAgIGlmIHNlbGYuZGVidWdfbG9jYWwgYW5kIHNlbGYuZm9yY2VfZG9tYWluOgogICAgICAgICAgICBkaWUoIkRvIG5vdCBzcGVjaWZ5IC0tbG9jYWwgYW5kIC0tZm9yY2UtZG9tYWluIGF0IHRoZSBzYW1lIHRpbWUuIikKICAgICAgICByZXR1cm4gYXJncwoKY29uZmlnID0gQ29uZmlnKCkKCgpkZWYgZG9fcmVxdWVzdChjb25uLCBvcGVyYXRpb24sIGFkZHIsIGRhdGE9Tm9uZSwgaGVhZGVycz17fSk6CiAgICBsb2cuZGVidWcoJ0RvbWFpbiByZXF1ZXN0OiAlcyAlcyAlcyAlcycsIG9wZXJhdGlvbiwgYWRkciwgZGF0YSwgaGVhZGVycykKICAgIGlmIGRhdGE6CiAgICAgICAgY29ubi5yZXF1ZXN0KG9wZXJhdGlvbiwgYWRkciwgZGF0YSwgaGVhZGVycz1oZWFkZXJzKQogICAgZWxzZToKICAgICAgICBjb25uLnJlcXVlc3Qob3BlcmF0aW9uLCBhZGRyLCBoZWFkZXJzPWhlYWRlcnMpCgoKZGVmIGdldF9yZXNwb25zZShvcGVyYXRpb24sIGFkZHIsIGRhdGE9Tm9uZSwgaGVhZGVycz17fSwgc2lsZW50PUZhbHNlLCBkaWVfb25fZXJyb3I9VHJ1ZSwgZG9tYWluPURvbWFpbi5BUEkpOgogICAgIiIiCiAgICBSZXR1cm5zIHJlc3BvbnNlIGZyb20gdGhlIGRvbWFpbiBvciBBUEkgc2VydmVyLgogICAgIiIiCiAgICByZXNwb25zZSA9IE5vbmUKICAgIGNvbm4gPSBOb25lCiAgICB0cnk6CiAgICAgICAgY29ubiA9IGRvbWFpbl9jb25uZWN0KGNvbmZpZywgZG9tYWluLCBEb21haW4pCiAgICAgICAgZG9fcmVxdWVzdChjb25uLCBvcGVyYXRpb24sIGFkZHIsIGRhdGEsIGhlYWRlcnMpCiAgICAgICAgcmVzcG9uc2UgPSBjb25uLmdldHJlc3BvbnNlKCkKICAgICAgICByZXR1cm4gcmVzcG9uc2UsIGNvbm4KICAgIGV4Y2VwdCBzb2NrZXQuc3NsZXJyb3IsIG1zZzogICMgTmV0d29yayBlcnJvcgogICAgICAgIGlmIG5vdCBzaWxlbnQ6CiAgICAgICAgICAgIGxvZy5pbmZvKCJTU0wgZXJyb3I6ICVzIiwgbXNnKQogICAgZXhjZXB0IHNvY2tldC5lcnJvciwgbXNnOiAgIyBOZXR3b3JrIGVycm9yCiAgICAgICAgaWYgbm90IHNpbGVudDoKICAgICAgICAgICAgbG9nLmRlYnVnKCJOZXR3b3JrIGVycm9yOiAlcyIsIG1zZykKICAgIGV4Y2VwdCBodHRwbGliLkJhZFN0YXR1c0xpbmU6CiAgICAgICAgZXJyb3IgPSAiSW50ZXJuYWwgZXJyb3IsIGJhZCBzdGF0dXMgbGluZSIKICAgICAgICBpZiBkaWVfb25fZXJyb3I6CiAgICAgICAgICAgIGRpZShlcnJvcikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2cuaW5mbyhlcnJvcikKCiAgICByZXR1cm4gTm9uZSwgTm9uZQoKCmRlZiBhcGlfcmVxdWVzdChyZXF1ZXN0LCByZXF1aXJlZD1GYWxzZSwgY2hlY2tfc3RhdHVzPUZhbHNlLCBzaWxlbnQ9RmFsc2UsIGRpZV9vbl9lcnJvcj1UcnVlKToKICAgICIiIgogICAgUHJvY2Vzc2VzIGEgcmVxdWVzdCBvbiB0aGUgbG9nZW50cmllcyBkb21haW4uCiAgICAiIiIKICAgICMgT2J0YWluIHJlc3BvbnNlCiAgICByZXNwb25zZSwgY29ubiA9IGdldF9yZXNwb25zZSgKICAgICAgICAiUE9TVCIsIExFX1NFUlZFUl9BUEksIHVybGxpYi51cmxlbmNvZGUocmVxdWVzdCksCiAgICAgICAgc2lsZW50PXNpbGVudCwgZGllX29uX2Vycm9yPWRpZV9vbl9lcnJvciwgZG9tYWluPURvbWFpbi5BUEksCiAgICAgICAgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnfSkKCiAgICAjIENoZWNrIHRoZSByZXNwb25zZQogICAgaWYgbm90IHJlc3BvbnNlOgogICAgICAgIGlmIHJlcXVpcmVkOgogICAgICAgICAgICBkaWUoIkVycm9yOiBDYW5ub3QgcHJvY2VzcyBMRSByZXF1ZXN0LCBubyByZXNwb25zZSIpCiAgICAgICAgaWYgY29ubjoKICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGlmIHJlc3BvbnNlLnN0YXR1cyAhPSAyMDA6CiAgICAgICAgaWYgcmVxdWlyZWQ6CiAgICAgICAgICAgIGRpZSgiRXJyb3I6IENhbm5vdCBwcm9jZXNzIExFIHJlcXVlc3Q6ICglcykiICUgcmVzcG9uc2Uuc3RhdHVzKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIHJldHVybiBOb25lCgogICAgeHJlc3BvbnNlID0gcmVzcG9uc2UucmVhZCgpCiAgICBjb25uLmNsb3NlKCkKICAgIGxvZy5kZWJ1ZygnRG9tYWluIHJlc3BvbnNlOiAiJXMiJywgeHJlc3BvbnNlKQogICAgdHJ5OgogICAgICAgIGRfcmVzcG9uc2UgPSBqc29uX2xvYWRzKHhyZXNwb25zZSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIGVycm9yID0gJ0Vycm9yOiBJbnZhbGlkIHJlc3BvbnNlLCBwYXJzZSBlcnJvci4nCiAgICAgICAgaWYgZGllX29uX2Vycm9yOgogICAgICAgICAgICBkaWUoZXJyb3IpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmluZm8oZXJyb3IpCiAgICAgICAgICAgIGRfcmVzcG9uc2UgPSBOb25lCgogICAgaWYgY2hlY2tfc3RhdHVzIGFuZCBkX3Jlc3BvbnNlWydyZXNwb25zZSddICE9ICdvayc6CiAgICAgICAgcmVhc29uID0gZF9yZXNwb25zZVsncmVhc29uJ10KCiAgICAgICAgIyBTcGVjaWFsIGNvbXBhdGliaWxpdHkgY2FzZTogY2hhbmdlIGdyb3VwIHRvIGhvc3QKICAgICAgICByZWFzb24gPSByZWFzb24ucmVwbGFjZSggJ1RoZSBncm91cCB3aXRoIElEJywgJ1RoZSBob3N0IHdpdGggSUQnKQoKICAgICAgICBlcnJvciA9ICJFcnJvcjogJXMiICUgcmVhc29uCiAgICAgICAgaWYgZGllX29uX2Vycm9yOgogICAgICAgICAgICBkaWUoZXJyb3IpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmluZm8oZXJyb3IpCiAgICAgICAgICAgIGRfcmVzcG9uc2UgPSBOb25lCgogICAgcmV0dXJuIGRfcmVzcG9uc2UKCgpkZWYgcHVsbF9yZXF1ZXN0KHdoYXQsIHBhcmFtcyk6CiAgICAiIiIKICAgIFByb2Nlc3NlcyBhIHB1bGwgcmVxdWVzdCBvbiB0aGUgbG9nZW50cmllcyBkb21haW4uCiAgICAiIiIKICAgIHJlc3BvbnNlID0gTm9uZQoKICAgICMgT2J0YWluIHJlc3BvbnNlCiAgICBhZGRyID0gJy8lcy8lcy8/JXMnICUgKAogICAgICAgIGNvbmZpZy51c2VyX2tleSwgdXJsbGliLnF1b3RlKHdoYXQpLCB1cmxsaWIudXJsZW5jb2RlKHBhcmFtcykpCiAgICByZXNwb25zZSwgY29ubiA9IGdldF9yZXNwb25zZSgiR0VUIiwgYWRkciwgZG9tYWluPURvbWFpbi5QVUxMKQoKICAgICMgQ2hlY2sgdGhlIHJlc3BvbnNlCiAgICBpZiBub3QgcmVzcG9uc2U6CiAgICAgICAgZGllKCJFcnJvcjogQ2Fubm90IHByb2Nlc3MgTEUgcmVxdWVzdCwgbm8gcmVzcG9uc2UiKQogICAgaWYgcmVzcG9uc2Uuc3RhdHVzID09IDQwNDoKICAgICAgICBkaWUoIkVycm9yOiBMb2cgbm90IGZvdW5kIikKICAgIGlmIHJlc3BvbnNlLnN0YXR1cyAhPSAyMDA6CiAgICAgICAgZGllKCJFcnJvcjogQ2Fubm90IHByb2Nlc3MgTEUgcmVxdWVzdDogKCVzKSIgJSByZXNwb25zZS5zdGF0dXMpCgogICAgd2hpbGUgVHJ1ZToKICAgICAgICBkYXRhID0gcmVzcG9uc2UucmVhZCg2NTUzNikKICAgICAgICBpZiBsZW4oZGF0YSkgPT0gMDoKICAgICAgICAgICAgYnJlYWsKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKGRhdGEpCiAgICBjb25uLmNsb3NlKCkKCgpkZWYgcmVxdWVzdChyZXF1ZXN0LCByZXF1aXJlZD1GYWxzZSwgY2hlY2tfc3RhdHVzPUZhbHNlLCBydHlwZT0nR0VUJywgcmV0cnk9RmFsc2UpOgogICAgIiIiCiAgICBQcm9jZXNzZXMgYSBsaXN0IHJlcXVlc3Qgb24gdGhlIEFQSSBzZXJ2ZXIuCiAgICAiIiIKICAgIG5vdGljZWQgPSBGYWxzZQogICAgd2hpbGUgVHJ1ZToKICAgICAgICAjIE9idGFpbiByZXNwb25zZQogICAgICAgIHJlc3BvbnNlLCBjb25uID0gZ2V0X3Jlc3BvbnNlKAogICAgICAgICAgICBydHlwZSwgdXJsbGliLnF1b3RlKCcvJyArIGNvbmZpZy51c2VyX2tleSArICcvJyArIHJlcXVlc3QpLAogICAgICAgICAgICBkaWVfb25fZXJyb3I9bm90IHJldHJ5KQoKICAgICAgICAjIENoZWNrIHRoZSByZXNwb25zZQogICAgICAgIGlmIHJlc3BvbnNlOgogICAgICAgICAgICBicmVhawogICAgICAgIGlmIHJlcXVpcmVkOgogICAgICAgICAgICBkaWUoJ0Vycm9yOiBDYW5ub3QgcHJvY2VzcyBMRSByZXF1ZXN0LCBubyByZXNwb25zZScpCiAgICAgICAgaWYgcmV0cnk6CiAgICAgICAgICAgIGlmIG5vdCBub3RpY2VkOgogICAgICAgICAgICAgICAgbG9nLmluZm8oJ0Vycm9yOiBObyByZXNwb25zZSBmcm9tIExFLCByZS10cnlpbmcgaW4gJXNzIGludGVydmFscycsCiAgICAgICAgICAgICAgICAgICAgICAgICBTUlZfUkVDT05fVElNRU9VVCkKICAgICAgICAgICAgICAgIG5vdGljZWQgPSBUcnVlCiAgICAgICAgICAgIHRpbWUuc2xlZXAoU1JWX1JFQ09OX1RJTUVPVVQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICByZXNwb25zZSA9IHJlc3BvbnNlLnJlYWQoKQogICAgY29ubi5jbG9zZSgpCiAgICBsb2cuZGVidWcoJ0xpc3QgcmVzcG9uc2U6ICVzJywgcmVzcG9uc2UpCiAgICB0cnk6CiAgICAgICAgZF9yZXNwb25zZSA9IGpzb25fbG9hZHMocmVzcG9uc2UpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBkaWUoJ0Vycm9yOiBJbnZhbGlkIHJlc3BvbnNlICglcyknICUgcmVzcG9uc2UpCgogICAgaWYgY2hlY2tfc3RhdHVzIGFuZCBkX3Jlc3BvbnNlWydyZXNwb25zZSddICE9ICdvayc6CiAgICAgICAgZGllKCdFcnJvcjogJXMnICUgZF9yZXNwb25zZVsncmVhc29uJ10pCgogICAgcmV0dXJuIGRfcmVzcG9uc2UKCgpkZWYgX3N0YXJ0dXBfaW5mbygpOgogICAgIiIiCiAgICBQcmludHMgY29ycmVjdCBzdGFydHVwIGluZm9ybWF0aW9uIGJhc2VkIG9uIE9TCiAgICAiIiIKICAgIGlmICdkYXJ3aW4nIGluIHN5cy5wbGF0Zm9ybToKICAgICAgICBsb2cuaW5mbygKICAgICAgICAgICAgJyAgc3VkbyBsYXVuY2hjdGwgdW5sb2FkIC9MaWJyYXJ5L0xhdW5jaERhZW1vbnMvY29tLmxvZ2VudHJpZXMuYWdlbnQucGxpc3QnKQogICAgICAgIGxvZy5pbmZvKAogICAgICAgICAgICAnICBzdWRvIGxhdW5jaGN0bCBsb2FkIC9MaWJyYXJ5L0xhdW5jaERhZW1vbnMvY29tLmxvZ2VudHJpZXMuYWdlbnQucGxpc3QnKQogICAgZWxpZiAnbGludXgnIGluIHN5cy5wbGF0Zm9ybToKICAgICAgICBsb2cuaW5mbygnICBzdWRvIHNlcnZpY2UgbG9nZW50cmllcyByZXN0YXJ0JykKICAgIGVsaWYgJ3N1bm9zJyBpbiBzeXMucGxhdGZvcm06CiAgICAgICAgbG9nLmluZm8oJyAgc3VkbyBzdmNhZG0gZGlzYWJsZSBsb2dlbnRyaWVzJykKICAgICAgICBsb2cuaW5mbygnICBzdWRvIHN2Y2FkbSBlbmFibGUgbG9nZW50cmllcycpCiAgICBlbHNlOgogICAgICAgIGxvZy5pbmZvKCcnKQoKCmRlZiBjcmVhdGVfbG9nKGhvc3Rfa2V5LCBuYW1lLCBmaWxlbmFtZSwgdHlwZV9vcHQsIGRvX2ZvbGxvdz1UcnVlLCBzb3VyY2U9Tm9uZSk6CiAgICAiIiIKICAgIENyZWF0ZXMgYSBsb2cgb24gc2VydmVyIHdpdGggZ2l2ZW4gcGFyYW1ldGVycy4KICAgICIiIgogICAgcmVxdWVzdCA9IHsKICAgICAgICAncmVxdWVzdCc6ICduZXdfbG9nJywKICAgICAgICAndXNlcl9rZXknOiBjb25maWcudXNlcl9rZXksCiAgICAgICAgJ2hvc3Rfa2V5JzogaG9zdF9rZXksCiAgICAgICAgJ25hbWUnOiBuYW1lLAogICAgICAgICdmaWxlbmFtZSc6IGZpbGVuYW1lLAogICAgICAgICd0eXBlJzogdHlwZV9vcHQsCiAgICB9CiAgICByZXF1ZXN0Wydmb2xsb3cnXSA9ICd0cnVlJwoKICAgIGlmIG5vdCBkb19mb2xsb3c6CiAgICAgICAgcmVxdWVzdFsnZm9sbG93J10gPSAnZmFsc2UnCgogICAgaWYgc291cmNlOgogICAgICAgIHJlcXVlc3RbJ3NvdXJjZSddID0gc291cmNlCiAgICByZXNwID0gYXBpX3JlcXVlc3QocmVxdWVzdCwgVHJ1ZSwgVHJ1ZSkKCiAgICBpZiByZXNwWydyZXNwb25zZSddID09ICdvayc6CiAgICAgICAgcmV0dXJuIHJlc3BbJ2xvZyddCiAgICByZXR1cm4gTm9uZQoKCmRlZiBjcmVhdGVfaG9zdChuYW1lLCBob3N0bmFtZSwgc3lzdGVtLCBkaXN0bmFtZSwgZGlzdHZlcik6CiAgICAiIiIKICAgIENyZWF0ZXMgYSBuZXcgaG9zdCBvbiBzZXJ2ZXIgd2l0aCBnaXZlbiBwYXJhbWV0ZXJzLgogICAgIiIiCiAgICByZXF1ZXN0ID0gewogICAgICAgICdyZXF1ZXN0JzogJ3JlZ2lzdGVyJywKICAgICAgICAndXNlcl9rZXknOiBjb25maWcudXNlcl9rZXksCiAgICAgICAgJ25hbWUnOiBuYW1lLAogICAgICAgICdob3N0bmFtZSc6IGhvc3RuYW1lLAogICAgICAgICdzeXN0ZW0nOiBzeXN0ZW0sCiAgICAgICAgJ2Rpc3RuYW1lJzogZGlzdG5hbWUsCiAgICAgICAgJ2Rpc3R2ZXInOiBkaXN0dmVyCiAgICB9CiAgICByZXNwID0gYXBpX3JlcXVlc3QocmVxdWVzdCwgVHJ1ZSwgVHJ1ZSkKICAgIGlmIHJlc3BbJ3Jlc3BvbnNlJ10gPT0gJ29rJzoKICAgICAgICByZXR1cm4gcmVzcFsnaG9zdCddCiAgICBlbHNlOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIHJlcXVlc3RfZm9sbG93KGZpbGVuYW1lLCBuYW1lLCB0eXBlX29wdCk6CiAgICAiIiIKICAgIENyZWF0ZXMgYSBuZXcgbG9nIHRvIGZvbGxvdyB0aGUgZmlsZSBnaXZlbi4KICAgICIiIgogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCiAgICBmb2xsb3dlZF9sb2cgPSBjcmVhdGVfbG9nKGNvbmZpZy5hZ2VudF9rZXksIG5hbWUsIGZpbGVuYW1lLCB0eXBlX29wdCkKICAgIHByaW50ICJXaWxsIGZvbGxvdyAlcyBhcyAlcyIgJSAoZmlsZW5hbWUsIG5hbWUpCiAgICBsb2cuaW5mbygiRG9uJ3QgZm9yZ2V0IHRvIHJlc3RhcnQgdGhlIGRhZW1vbiIpCiAgICBfc3RhcnR1cF9pbmZvKCkKICAgIHJldHVybiBmb2xsb3dlZF9sb2cKCgpkZWYgcmVxdWVzdF9ob3N0cyhsb2FkX2xvZ3M9RmFsc2UpOgogICAgIiIiUmV0dXJucyBsaXN0IG9mIHJlZ2lzdGVyZWQgaG9zdHMuCiAgICAiIiIKICAgIGlmIGxvYWRfbG9nczoKICAgICAgICB4bG9hZF9sb2dzID0gJ3RydWUnCiAgICBlbHNlOgogICAgICAgIHhsb2FkX2xvZ3MgPSAnZmFsc2UnCiAgICByZXNwb25zZSA9IGFwaV9yZXF1ZXN0KHsKICAgICAgICAncmVxdWVzdCc6ICdnZXRfdXNlcicsCiAgICAgICAgJ2xvYWRfaG9zdHMnOiAndHJ1ZScsCiAgICAgICAgJ2xvYWRfbG9ncyc6IHhsb2FkX2xvZ3MsCiAgICAgICAgJ3VzZXJfa2V5JzogY29uZmlnLnVzZXJfa2V5fSwgVHJ1ZSwgVHJ1ZSkKCiAgICByZXR1cm4gcmVzcG9uc2VbJ2hvc3RzJ10KCgpkZWYgZ2V0X29yX2NyZWF0ZV9ob3N0KGhvc3RfbmFtZSk6CiAgICAiIiJHZXRzIG9yIGNyZWF0ZXMgYSBuZXcgaG9zdC4KICAgICIiIgogICAgIyBSZXRyaWV2ZSB0aGUgaG9zdCB2aWEgQVBJCiAgICBhY2NvdW50X2hvc3RzID0gcmVxdWVzdF9ob3N0cyhsb2FkX2xvZ3M9VHJ1ZSkKICAgIGhvc3QgPSBmaW5kX2FwaV9vYmpfYnlfbmFtZShhY2NvdW50X2hvc3RzLCBob3N0X25hbWUpCgogICAgaWYgbm90IGhvc3Q6CiAgICAgICAgIyBJZiBpdCBkb2VzIG5vdCBleGlzdCwgY3JlYXRlIGEgbmV3IG9uZQogICAgICAgIGhvc3QgPSBjcmVhdGVfaG9zdChob3N0X25hbWUsICcnLCAnJywgJycsICcnKQoKICAgIHJldHVybiBob3N0WydrZXknXQoKCmRlZiBnZXRfb3JfY3JlYXRlX2xvZyhob3N0X2tleSwgbG9nX25hbWUsIGRlc3RpbmF0aW9uKToKICAgICIiIiBHZXRzIG9yIGNyZWF0ZXMgYSBsb2cgZm9yIHRoZSBob3N0IGdpdmVuLiBJdCByZXR1cm5zIGxvZ3MncyB0b2tlbiBvcgogICAgTm9uZS4KICAgICIiIgogICAgaWYgbm90IGhvc3Rfa2V5OgogICAgICAgIHJldHVybiBOb25lCgogICAgIyBSZXRyaWV2ZSB0aGUgbG9nIHZpYSBBUEkKICAgIGFjY291bnRfaG9zdHMgPSByZXF1ZXN0X2hvc3RzKGxvYWRfbG9ncz1UcnVlKQogICAgaG9zdCA9IGZpbmRfYXBpX29ial9ieV9rZXkoYWNjb3VudF9ob3N0cywgaG9zdF9rZXkpCiAgICBpZiBub3QgaG9zdDoKICAgICAgICByZXR1cm4gTm9uZQogICAgeGxvZyA9IGZpbmRfYXBpX29ial9ieV9uYW1lKGhvc3RbJ2xvZ3MnXSwgbG9nX25hbWUpCiAgICBpZiBub3QgeGxvZzoKICAgICAgICAjIFRyeSB0byBjcmVhdGUgdGhlIGxvZwogICAgICAgIHhsb2cgPSBjcmVhdGVfbG9nKGhvc3RbJ2tleSddLCBsb2dfbmFtZSwgJycsICcnLCBkb19mb2xsb3c9RmFsc2UsIHNvdXJjZT0ndG9rZW4nKQogICAgICAgIGlmIG5vdCB4bG9nOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIHJldHVybiB4bG9nLmdldCgndG9rZW4nLCBOb25lKQoKCiMKIyBDb21tYW5kcwojCgpkZWYgY21kX2luaXQoYXJncyk6CiAgICAiIiIKICAgIFNhdmVzIHZhcmlhYmxlcyBnaXZlbiB0byB0aGUgY29uZmlndXJhdGlvbiBmaWxlLiBWYXJpYWJsZXMgbm90CiAgICBzcGVjaWZpZWQgYXJlIG5vdCBzYXZlZCBhbmQgdGh1cyBhcmUgb3ZlcndyaXR0ZW4gd2l0aCBkZWZhdWx0IHZhbHVlLgogICAgVGhlIGNvbmZpZ3VyYXRpb24gZGlyZWN0b3J5IGlzIGNyZWF0ZWQgaWYgaXQgZG9lcyBub3QgZXhpdC4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBjb25maWcudXNlcl9rZXlfcmVxdWlyZWQoVHJ1ZSkKICAgIGNvbmZpZy5zYXZlKCkKICAgIGxvZy5pbmZvKCJJbml0aWFsaXplZCIpCgoKZGVmIGNtZF9yZWluaXQoYXJncyk6CiAgICAiIiIKICAgIFNhdmVzIHZhcmlhYmxlcyBnaXZlbiB0byB0aGUgY29uZmlndXJhdGlvbiBmaWxlLiBUaGUgY29uZmlndXJhdGlvbgogICAgZGlyZWN0b3J5IGlzIGNyZWF0ZWQgaWYgaXQgZG9lcyBub3QgZXhpdC4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBjb25maWcubG9hZChsb2FkX2luY2x1ZGVfZGlycz1GYWxzZSkKICAgIGNvbmZpZy5zYXZlKCkKICAgIGxvZy5pbmZvKCJSZWluaXRpYWxpemVkIikKCgpkZWYgY21kX3JlZ2lzdGVyKGFyZ3MpOgogICAgIiIiCiAgICBSZWdpc3RlcnMgdGhlIGFnZW50IGluIGxvZ2VudHJpZXMgaW5mcmFzdHJ1Y3R1cmUuIFRoZSBuZXdseSBvYnRhaW5lZAogICAgYWdlbnQga2V5IGlzIHN0b3JlZCBpbiB0aGUgY29uZmlndXJhdGlvbiBmaWxlLgogICAgIiIiCiAgICBub19tb3JlX2FyZ3MoYXJncykKICAgIGNvbmZpZy5sb2FkKCkKCiAgICBpZiBjb25maWcuYWdlbnRfa2V5ICE9IE5PVF9TRVQgYW5kIG5vdCBjb25maWcuZm9yY2U6CiAgICAgICAgcmVwb3J0KCJXYXJuaW5nOiBTZXJ2ZXIgYWxyZWFkeSByZWdpc3RlcmVkLiBVc2UgLS1mb3JjZSB0byBvdmVycmlkZSBjdXJyZW50IHJlZ2lzdHJhdGlvbi4iKQogICAgICAgIHJldHVybgogICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKFRydWUpCiAgICBjb25maWcuaG9zdG5hbWVfcmVxdWlyZWQoKQogICAgY29uZmlnLm5hbWVfcmVxdWlyZWQoKQoKICAgIHNpID0gc3lzdGVtX2RldGVjdChUcnVlKQoKICAgIGhvc3QgPSBjcmVhdGVfaG9zdChjb25maWcubmFtZSwgY29uZmlnLmhvc3RuYW1lLCBzaVsnc3lzdGVtJ10sIHNpWydkaXN0bmFtZSddLCBzaVsnZGlzdHZlciddKQoKICAgIGNvbmZpZy5hZ2VudF9rZXkgPSBob3N0WydrZXknXQogICAgY29uZmlnLnNhdmUoKQoKICAgIGxvZy5pbmZvKCJSZWdpc3RlcmVkICVzICglcykiLCBjb25maWcubmFtZSwgY29uZmlnLmhvc3RuYW1lKQoKICAgICMgUmVnaXN0ZXJpbmcgbG9ncwogICAgbG9ncyA9IFtdCiAgICBpZiBjb25maWcuc3RkIG9yIGNvbmZpZy5zdGRfYWxsOgogICAgICAgIGxvZ3MgPSBjb2xsZWN0X2xvZ19uYW1lcyhzaSkKICAgIGZvciBsb2d4IGluIGxvZ3M6CiAgICAgICAgaWYgY29uZmlnLnN0ZF9hbGwgb3IgbG9neFsnZGVmYXVsdCddID09ICcxJzoKICAgICAgICAgICAgcmVxdWVzdF9mb2xsb3cobG9neFsnZmlsZW5hbWUnXSwgbG9neFsnbmFtZSddLCBsb2d4Wyd0eXBlJ10pCgojIFRoZSBmdW5jdGlvbiBjaGVja3MgZm9yIDIgdGhpbmdzOiAxKSB0aGF0IHRoZSBwYXRoIGlzIG5vdCBlbXB0eTsKIyAyKSB0aGUgcGF0aCBzdGFydHMgd2l0aCAnLycgY2hhcmFjdGVyIHdoaWNoIGluZGljYXRlcyB0aGF0IHRoZSBsb2cgaGFzCiMgYSAicGh5c2ljYWwiIHBhdGggd2hpY2ggc3RhcnRzIGZyb20gZmlsZXN5c3RlbSByb290LgoKCmRlZiBjaGVja19maWxlX25hbWUoZmlsZV9uYW1lKToKICAgIHJldHVybiBmaWxlX25hbWUuc3RhcnRzd2l0aCgnLycpCgoKZGVmIGdldF9maWx0ZXJzKGF2YWlsYWJsZV9maWx0ZXJzLCBmaWx0ZXJfZmlsZW5hbWVzLCBsb2dfbmFtZSwgbG9nX2lkLCBsb2dfZmlsZW5hbWUsIGxvZ190b2tlbik6CiAgICAjIENoZWNrIGZpbHRlcnMKICAgIGlmIG5vdCBmaWx0ZXJfZmlsZW5hbWVzKGxvZ19maWxlbmFtZSk6CiAgICAgICAgZGVidWdfZmlsdGVycygKICAgICAgICAgICAgIiBMb2cgYmxvY2tlZCBieSBmaWx0ZXJfZmlsZW5hbWVzLCBub3QgZm9sbG93aW5nIikKICAgICAgICBsb2cuaW5mbygKICAgICAgICAgICAgJ05vdCBmb2xsb3dpbmcgJXMsIGJsb2NrZWQgYnkgZmlsdGVyX2ZpbGVuYW1lcycsIGxvZ19uYW1lKQogICAgICAgIHJldHVybiBOb25lCiAgICBkZWJ1Z19maWx0ZXJzKAogICAgICAgICIgTG9va2luZyBmb3IgZmlsdGVycyBieSBsb2dfbmFtZT0lcyBsb2dfaWQ9JXMgdG9rZW49JXMiLCBsb2dfbmFtZSwgbG9nX2lkLCBsb2dfdG9rZW4pCgogICAgZW50cnlfZmlsdGVyID0gTm9uZQogICAgaWYgbm90IGVudHJ5X2ZpbHRlciBhbmQgbG9nX25hbWU6CiAgICAgICAgZGVidWdfZmlsdGVycygiIExvb2tpbmcgZm9yIGZpbHRlcnMgYnkgbG9nIG5hbWUiKQogICAgICAgIGVudHJ5X2ZpbHRlciA9IGF2YWlsYWJsZV9maWx0ZXJzLmdldChsb2dfbmFtZSkKICAgICAgICBpZiBub3QgZW50cnlfZmlsdGVyOgogICAgICAgICAgICBkZWJ1Z19maWx0ZXJzKCIgTm8gZmlsdGVyIGZvdW5kIGJ5IGxvZyBuYW1lIikKCiAgICBpZiBub3QgZW50cnlfZmlsdGVyIGFuZCBsb2dfaWQ6CiAgICAgICAgZGVidWdfZmlsdGVycygiIExvb2tpbmcgZm9yIGZpbHRlcnMgYnkgbG9nIElEIikKICAgICAgICBlbnRyeV9maWx0ZXIgPSBhdmFpbGFibGVfZmlsdGVycy5nZXQobG9nX2lkKQogICAgICAgIGlmIG5vdCBlbnRyeV9maWx0ZXI6CiAgICAgICAgICAgIGRlYnVnX2ZpbHRlcnMoIiBObyBmaWx0ZXIgZm91bmQgYnkgbG9nIElEIikKCiAgICBpZiBub3QgZW50cnlfZmlsdGVyIGFuZCBsb2dfdG9rZW46CiAgICAgICAgZGVidWdfZmlsdGVycygiIExvb2tpbmcgZm9yIGZpbHRlcnMgYnkgdG9rZW4iKQogICAgICAgIGVudHJ5X2ZpbHRlciA9IGF2YWlsYWJsZV9maWx0ZXJzLmdldChsb2dfdG9rZW4pCiAgICAgICAgaWYgbm90IGVudHJ5X2ZpbHRlcjoKICAgICAgICAgICAgZGVidWdfZmlsdGVycygiIE5vIGZpbHRlciBmb3VuZCBieSB0b2tlbiIpCgogICAgaWYgZW50cnlfZmlsdGVyIGFuZCBub3QgaGFzYXR0cihlbnRyeV9maWx0ZXIsICdfX2NhbGxfXycpOgogICAgICAgIGRlYnVnX2ZpbHRlcnMoCiAgICAgICAgICAgICIgRmlsdGVyIGZvdW5kLCBidXQgaWdub3JlZCBiZWNhdXNlIGl0J3Mgbm90IGEgZnVuY3Rpb24iKQogICAgICAgIGVudHJ5X2ZpbHRlciA9IE5vbmUKICAgIGlmIG5vdCBlbnRyeV9maWx0ZXI6CiAgICAgICAgZW50cnlfZmlsdGVyID0gZmlsdGVyX2V2ZW50cwogICAgICAgIGRlYnVnX2ZpbHRlcnMoIiBObyBmaWx0ZXIgZm91bmQiKQogICAgZWxzZToKICAgICAgICBkZWJ1Z19maWx0ZXJzKCIgVXNpbmcgZmlsdGVyICVzIiwgZW50cnlfZmlsdGVyKQogICAgcmV0dXJuIGVudHJ5X2ZpbHRlcgoKCmRlZiBnZXRfZm9ybWF0dGVycyhkZWZhdWx0X2Zvcm1hdHRlciwgYXZhaWxhYmxlX2Zvcm1hdHRlcnMsIGxvZ19uYW1lLCBsb2dfaWQsIGxvZ19maWxlbmFtZSwgbG9nX3Rva2VuKToKICAgIGRlYnVnX2Zvcm1hdHRlcnMoCiAgICAgICAgIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IGxvZ19uYW1lPSVzIGlkPSVzIHRva2VuPSVzIiwgbG9nX25hbWUsIGxvZ19pZCwgbG9nX3Rva2VuKQoKICAgIGVudHJ5X2Zvcm1hdHRlciA9IE5vbmUKICAgIGlmIG5vdCBlbnRyeV9mb3JtYXR0ZXIgYW5kIGxvZ19uYW1lOgogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IGxvZyBuYW1lIikKICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBhdmFpbGFibGVfZm9ybWF0dGVycy5nZXQobG9nX25hbWUpCiAgICAgICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlcjoKICAgICAgICAgICAgZGVidWdfZm9ybWF0dGVycygiIE5vIGZvcm1hdHRlciBmb3VuZCBieSBsb2cgbmFtZSIpCgogICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlciBhbmQgbG9nX2lkOgogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IGxvZyBJRCIpCiAgICAgICAgZW50cnlfZm9ybWF0dGVyID0gYXZhaWxhYmxlX2Zvcm1hdHRlcnMuZ2V0KGxvZ19pZCkKICAgICAgICBpZiBub3QgZW50cnlfZm9ybWF0dGVyOgogICAgICAgICAgICBkZWJ1Z19mb3JtYXR0ZXJzKCIgTm8gZm9ybWF0dGVyIGZvdW5kIGJ5IGxvZyBJRCIpCgogICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlciBhbmQgbG9nX3Rva2VuOgogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IHRva2VuIikKICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBhdmFpbGFibGVfZm9ybWF0dGVycy5nZXQobG9nX3Rva2VuKQogICAgICAgIGlmIG5vdCBlbnRyeV9mb3JtYXR0ZXI6CiAgICAgICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBObyBmb3JtYXR0ZXIgZm91bmQgYnkgdG9rZW4iKQoKICAgIGlmIGVudHJ5X2Zvcm1hdHRlciBhbmQgbm90IGhhc2F0dHIoZW50cnlfZm9ybWF0dGVyLCAnX19jYWxsX18nKToKICAgICAgICBkZWJ1Z19mb3JtYXR0ZXJzKAogICAgICAgICAgICAiIEZvcm1hdHRlciBmb3VuZCwgYnV0IGlnbm9yZWQgYmVjYXVzZSBpdCdzIG5vdCBhIGZ1bmN0aW9uIikKICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBOb25lCgogICAgaWYgZW50cnlfZm9ybWF0dGVyOgogICAgICAgIGZvcm0gPSBlbnRyeV9mb3JtYXR0ZXIoY29uZmlnLmhvc3RuYW1lLCBsb2dfbmFtZSwgbG9nX3Rva2VuKQogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBGb3JtYXR0ZXIgZm91bmQiKQogICAgZWxzZToKICAgICAgICBmb3JtID0gZGVmYXVsdF9mb3JtYXR0ZXIKICAgICAgICBkZWJ1Z19mb3JtYXR0ZXJzKCIgTm8gZm9ybWF0dGVyIGZvdW5kIikKCiAgICByZXR1cm4gZm9ybQoKZGVmIF9pbml0X2VudHJ5X2lkZW50aWZpZXIoZW50cnlfaWRlbnRpZmllcik6CiAgICAiIiJDb21waWxlcyBlbnRyeSBzZXBhcmF0b3IgZGVmaW5lZCBieSByZWd1bGFyIGV4cHJlc3Npb24uIElmIHRoZQogICAgY29tcGlsYXRpb24gaXMgbm90IHN1Y2Nlc3NmdWxsLCBpdCByZXR1cm4gTm9uZS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIHJldHVybiByZS5jb21waWxlKGVudHJ5X2lkZW50aWZpZXIpCiAgICBleGNlcHQgcmUuZXJyb3I6CiAgICAgICAgcmV0dXJuIE5vbmUKCmRlZiBzdGFydF9mb2xsb3dlcnMoZGVmYXVsdF90cmFuc3BvcnQpOgogICAgIiIiCiAgICBMb2FkcyBsb2dzIGZyb20gdGhlIHNlcnZlciAob3IgY29uZmlndXJhdGlvbikgYW5kIGluaXRpYWxpemVzIGZvbGxvd2Vycy4KICAgICIiIgogICAgbm90aWNlZCA9IEZhbHNlCiAgICBsb2dzID0gW10KICAgIGZvbGxvd2VycyA9IFtdCiAgICB0cmFuc3BvcnRzID0gW10KICAgIGZvbGxvd19tdWx0aWxvZ3MgPSBbXQoKICAgIGlmIGNvbmZpZy5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZzoKICAgICAgICAjIFVzZSBMRSBzZXJ2ZXIgYXMgdGhlIHNvdXJjZSBmb3IgbGlzdCBvZiBmb2xsb3dlZCBsb2dzCiAgICAgICAgc2VydmVyX2xvZ3MgPSBbXQogICAgICAgIHdoaWxlIG5vdCBzZXJ2ZXJfbG9nczoKICAgICAgICAgICAgcmVzcCA9IHJlcXVlc3QoJ2hvc3RzLyVzLycgJQogICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuYWdlbnRfa2V5LCBGYWxzZSwgRmFsc2UsIHJldHJ5PVRydWUpCiAgICAgICAgICAgIGlmIHJlc3BbJ3Jlc3BvbnNlJ10gIT0gJ29rJzoKICAgICAgICAgICAgICAgIGlmIG5vdCBub3RpY2VkOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcignRXJyb3IgcmV0cmlldmluZyBsaXN0IG9mIGxvZ3M6ICVzLCByZXRyeWluZyBpbiAlc3MgaW50ZXJ2YWxzJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcFsncmVhc29uJ10sIFNSVl9SRUNPTl9USU1FT1VUKQogICAgICAgICAgICAgICAgICAgIG5vdGljZWQgPSBUcnVlCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKFNSVl9SRUNPTl9USU1FT1VUKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgc2VydmVyX2xvZ3MgPSByZXNwWydsaXN0J10KICAgICAgICAgICAgaWYgbm90IHNlcnZlcl9sb2dzOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChTUlZfUkVDT05fVElNRU9VVCkKICAgICAgICAjIFNlbGVjdCBsb2dzIGZvciB0aGUgYWdlbnQKICAgICAgICBmb3IgbCBpbiBzZXJ2ZXJfbG9nczoKICAgICAgICAgICAgaWYgbC5nZXQoJ2ZvbGxvdycpID09ICd0cnVlJzoKICAgICAgICAgICAgICAgIGxbJ2Zvcm1hdHRlciddID0gJycKICAgICAgICAgICAgICAgIGxbJ2VudHJ5X2lkZW50aWZpZXInXSA9ICcnCiAgICAgICAgICAgICAgICBsb2dzLmFwcGVuZChsKQoKICAgIGZvciBjbCBpbiBjb25maWcuY29uZmlndXJlZF9sb2dzOgogICAgICAgICMgQ29uc3RydWN0IHJlc3BvbnNlLWxpa2UgaXRlbSB3aGljaCBoYXMgdGhlIHNhbWUgc3RydWN0dXJlIGFzIG9uZXMKICAgICAgICAjIHJldHVybmVkIGJ5IExFIFNlcnZlci4KICAgICAgICBsb2dzLmFwcGVuZCgKICAgICAgICAgICAgeyd0eXBlJzogJ3Rva2VuJywgJ25hbWUnOiBjbC5uYW1lLCAnZmlsZW5hbWUnOiBjbC5wYXRoLCAna2V5JzogJycsICd0b2tlbic6IGNsLnRva2VuLAogICAgICAgICAgICAgICAgICAgICAnZm9ybWF0dGVyJzogY2wuZm9ybWF0dGVyLCAnZW50cnlfaWRlbnRpZmllcic6IGNsLmVudHJ5X2lkZW50aWZpZXIsICdmb2xsb3cnOiAndHJ1ZSd9KQoKICAgIGF2YWlsYWJsZV9maWx0ZXJzID0ge30KICAgIGZpbHRlcl9maWxlbmFtZXMgPSBkZWZhdWx0X2ZpbHRlcl9maWxlbmFtZXMKICAgIGlmIGNvbmZpZy5maWx0ZXJzICE9IE5PVF9TRVQ6CiAgICAgICAgc3lzLnBhdGguYXBwZW5kKGNvbmZpZy5maWx0ZXJzKQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGZpbHRlcnMKCiAgICAgICAgICAgIGF2YWlsYWJsZV9maWx0ZXJzID0gZ2V0YXR0cihmaWx0ZXJzLCAnZmlsdGVycycsIHt9KQogICAgICAgICAgICBmaWx0ZXJfZmlsZW5hbWVzID0gZ2V0YXR0cigKICAgICAgICAgICAgICAgIGZpbHRlcnMsICdmaWx0ZXJfZmlsZW5hbWVzJywgZGVmYXVsdF9maWx0ZXJfZmlsZW5hbWVzKQoKICAgICAgICAgICAgZGVidWdfZmlsdGVycygiQXZhaWxhYmxlIGZpbHRlcnM6ICVzIiwgYXZhaWxhYmxlX2ZpbHRlcnMua2V5cygpKQogICAgICAgICAgICBkZWJ1Z19maWx0ZXJzKCJGaWx0ZXIgZmlsZW5hbWVzOiAlcyIsIGZpbHRlcl9maWxlbmFtZXMpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBsb2cuZXJyb3IoJ0Nhbm5vdCBpbXBvcnQgZXZlbnQgZmlsdGVyIG1vZHVsZSAlczogJXMnLAogICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmZpbHRlcnMsIHN5cy5leGNfaW5mbygpWzFdKQogICAgICAgICAgICBsb2cuZXJyb3IoJ0RldGFpbHM6ICVzJywgdHJhY2ViYWNrLnByaW50X2V4YyhzeXMuZXhjX2luZm8oKSkpCgogICAgYXZhaWxhYmxlX2Zvcm1hdHRlcnMgPSB7fQogICAgaWYgY29uZmlnLmZvcm1hdHRlcnMgIT0gTk9UX1NFVDoKICAgICAgICBzeXMucGF0aC5hcHBlbmQoY29uZmlnLmZvcm1hdHRlcnMpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZm9ybWF0dGVycwoKICAgICAgICAgICAgYXZhaWxhYmxlX2Zvcm1hdHRlcnMgPSBnZXRhdHRyKGZvcm1hdHRlcnMsICdmb3JtYXR0ZXJzJywge30pCiAgICAgICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIkF2YWlsYWJsZSBmb3JtYXR0ZXJzOiAlcyIsIGF2YWlsYWJsZV9mb3JtYXR0ZXJzLmtleXMoKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIGxvZy5lcnJvcignQ2Fubm90IGltcG9ydCBldmVudCBmb3JtYXR0ZXIgbW9kdWxlICVzOiAlcycsCiAgICAgICAgICAgICAgICAgICAgICBjb25maWcuZm9ybWF0dGVycywgc3lzLmV4Y19pbmZvKClbMV0pCiAgICAgICAgICAgIGxvZy5lcnJvcignRGV0YWlsczogJXMnLCB0cmFjZWJhY2sucHJpbnRfZXhjKHN5cy5leGNfaW5mbygpKSkKCiAgICAjIFN0YXJ0IGZvbGxvd2VycwogICAgZm9yIGwgaW4gbG9nczoKICAgICAgICAjIE5vdGUhIFRva2VuLXR5cGUgbG9ncyBoYXZlIGZvbGxvdyBwYXJhbSA9PSBmYWxzZSBieSBkZWZhdWx0LCBzbyB3ZSBuZWVkIHRvCiAgICAgICAgIyBjaGVjayBhbHNvIHRoZSB0eXBlIG9mIHRoZSBsb2cuCiAgICAgICAgaWYgbFsnZm9sbG93J10gPT0gJ3RydWUnIG9yIGxbJ3R5cGUnXSA9PSAndG9rZW4nOgogICAgICAgICAgICBsb2dfbmFtZSA9IGxbJ25hbWUnXQogICAgICAgICAgICBsb2dfZmlsZW5hbWUgPSBsWydmaWxlbmFtZSddCiAgICAgICAgICAgIGxvZ19rZXkgPSBsWydrZXknXQogICAgICAgICAgICBsb2dfdG9rZW4gPSAnJwogICAgICAgICAgICBpZiBsWyd0eXBlJ10gPT0gJ3Rva2VuJzoKICAgICAgICAgICAgICAgIGxvZ190b2tlbiA9IGxbJ3Rva2VuJ10KICAgICAgICAgICAgbXVsdGlsb2dfZmlsZW5hbWUgPSBGYWxzZQogICAgICAgICAgICBpZiBsb2dfZmlsZW5hbWUuc3RhcnRzd2l0aChQUkVGSVhfTVVMVElMT0dfRklMRU5BTUUpOiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nX2ZpbGVuYW1lID0gbG9nX2ZpbGVuYW1lLnJlcGxhY2UoUFJFRklYX01VTFRJTE9HX0ZJTEVOQU1FLCcnLDEpLmxzdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgY29uZmlnLnZhbGlkYXRlX3BhdGhuYW1lKE5vbmUsRmFsc2UsbG9nX2ZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgbXVsdGlsb2dfZmlsZW5hbWUgPSBUcnVlCgogICAgICAgICAgICAjIERvIG5vdCBzdGFydCBhIGZvbGxvd2VyIGZvciBhIGxvZyB3aXRoIGFic2VudCBmaWxlcGF0aC4KICAgICAgICAgICAgaWYgbm90IGNoZWNrX2ZpbGVfbmFtZShsb2dfZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgI2xvZy5pbmZvKCJBZnRlciBjaGVja19maWxlX25hbWU6bG9nX2ZpbGVuYW1lICVzIixsb2dfZmlsZW5hbWUgKQoKICAgICAgICAgICAgZW50cnlfZmlsdGVyID0gZ2V0X2ZpbHRlcnMoYXZhaWxhYmxlX2ZpbHRlcnMsIGZpbHRlcl9maWxlbmFtZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ19uYW1lLCBsb2dfa2V5LCBsb2dfZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ190b2tlbikKICAgICAgICAgICAgaWYgbm90IGVudHJ5X2ZpbHRlcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIEZvcm1hdHRlciBpcyB0YWtlbiBhY2NvcmRpbmcgdG8gbG9jYWwgc3BlY2lmaWNhdGlvbiwgZ2xvYmFsIHNwZWNpZmljYXRpb24KICAgICAgICAgICAgIyBhbmQgdXNlci1wcm92aWRlZCBmb3JtYXR0ZXIKICAgICAgICAgICAgZW50cnlfZm9ybWF0dGVyID0gZm9ybWF0cy5nZXRfZm9ybWF0dGVyKGxbJ2Zvcm1hdHRlciddLCBjb25maWcuaG9zdG5hbWUsIGxvZ19uYW1lLCBsb2dfdG9rZW4pCiAgICAgICAgICAgIGlmIG5vdCBlbnRyeV9mb3JtYXR0ZXI6CiAgICAgICAgICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBmb3JtYXRzLmdldF9mb3JtYXR0ZXIoY29uZmlnLmZvcm1hdHRlciwgY29uZmlnLmhvc3RuYW1lLCBsb2dfbmFtZSwgbG9nX3Rva2VuKQogICAgICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBnZXRfZm9ybWF0dGVycyhlbnRyeV9mb3JtYXR0ZXIsIGF2YWlsYWJsZV9mb3JtYXR0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dfbmFtZSwgbG9nX2tleSwgbG9nX2ZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dfdG9rZW4pCgogICAgICAgICAgICBzX2VudHJ5X2lkZW50aWZpZXIgPSBsWydlbnRyeV9pZGVudGlmaWVyJ10KICAgICAgICAgICAgaWYgbm90IHNfZW50cnlfaWRlbnRpZmllcjoKICAgICAgICAgICAgICAgIHNfZW50cnlfaWRlbnRpZmllciA9IGNvbmZpZy5lbnRyeV9pZGVudGlmaWVyCiAgICAgICAgICAgIGlmIHNfZW50cnlfaWRlbnRpZmllcjoKICAgICAgICAgICAgICAgIGVudHJ5X2lkZW50aWZpZXIgPSBfaW5pdF9lbnRyeV9pZGVudGlmaWVyKHNfZW50cnlfaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIGlmIG5vdCBlbnRyeV9pZGVudGlmaWVyOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiSW52YWxpZCBlbnRyeSBzZXBhcmF0b3IgYCVzJyBpZ25vcmVkIiwgc19lbnRyeV9pZGVudGlmaWVyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW50cnlfaWRlbnRpZmllciA9IE5vbmUKCiAgICAgICAgICAgIGxvZy5pbmZvKCJGb2xsb3dpbmcgJXMiLCBsb2dfZmlsZW5hbWUpCgogICAgICAgICAgICBpZiBsb2dfdG9rZW4gb3IgY29uZmlnLmRhdGFodWI6CiAgICAgICAgICAgICAgICB0cmFuc3BvcnQgPSBkZWZhdWx0X3RyYW5zcG9ydC5nZXQoKQogICAgICAgICAgICBlbGlmIGxvZ19rZXk6CiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IERvbWFpbi5EQVRBCiAgICAgICAgICAgICAgICBwb3J0ID0gNDQzCiAgICAgICAgICAgICAgICB1c2Vfc3NsID0gbm90IGNvbmZpZy5zdXBwcmVzc19zc2wKICAgICAgICAgICAgICAgIGlmIG5vdCB1c2Vfc3NsOgogICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MAogICAgICAgICAgICAgICAgaWYgY29uZmlnLmZvcmNlX2RvbWFpbjoKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludCA9IGNvbmZpZy5mb3JjZV9kb21haW4KICAgICAgICAgICAgICAgIGlmIGNvbmZpZy5kZWJ1Z19sb2NhbDoKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludCA9IERvbWFpbi5MT0NBTAogICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MDgxCiAgICAgICAgICAgICAgICAgICAgdXNlX3NzbCA9IEZhbHNlCiAgICAgICAgICAgICAgICBwcmVhbWJsZSA9ICdQVVQgLyVzL2hvc3RzLyVzLyVzLz9yZWFsdGltZT0xIEhUVFAvMS4wXHJcblxyXG4nICUgKAogICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VyX2tleSwgY29uZmlnLmFnZW50X2tleSwgbG9nX2tleSkKCiAgICAgICAgICAgICAgICAjIFNwZWNpYWwgY2FzZSBmb3IgSFRUUCBQVVQKICAgICAgICAgICAgICAgICMgVXNlIHBsYWluIGZvcm1hdHRlciBpZiBubyBmb3JtYXR0ZXIgaXMgZGVmaW5lZAogICAgICAgICAgICAgICAgdHJhbnNwb3J0ID0gVHJhbnNwb3J0KGVuZHBvaW50LCBwb3J0LCB1c2Vfc3NsLCBwcmVhbWJsZSwgY29uZmlnLmRlYnVnX3RyYW5zcG9ydF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvbmZpZy5wcm94eV90eXBlLCBjb25maWcucHJveHlfdXJsLCBjb25maWcucHJveHlfcG9ydCkpCiAgICAgICAgICAgICAgICB0cmFuc3BvcnRzLmFwcGVuZCh0cmFuc3BvcnQpCiAgICAgICAgICAgICAgICAjIERlZmF1bHQgZm9ybWF0dGVyIGlzIHBsYWluCiAgICAgICAgICAgICAgICBpZiBub3QgZW50cnlfZm9ybWF0dGVyOgogICAgICAgICAgICAgICAgICAgIGVudHJ5X2Zvcm1hdHRlciA9IGZvcm1hdHMuZ2V0X2Zvcm1hdHRlcigncGxhaW4nLCBjb25maWcuaG9zdG5hbWUsIGxvZ19uYW1lLCBsb2dfdG9rZW4pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBEZWZhdWx0IGZvcm1hdHRlciBpcyBzeXNsb2cKICAgICAgICAgICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlcjoKICAgICAgICAgICAgICAgIGVudHJ5X2Zvcm1hdHRlciA9IGZvcm1hdHMuZ2V0X2Zvcm1hdHRlcignc3lzbG9nJywgY29uZmlnLmhvc3RuYW1lLCBsb2dfbmFtZSwgbG9nX3Rva2VuKQoKICAgICAgICAgICAgIyBJbnN0YW50aWF0ZSB0aGUgZm9sbG93X211bHRpbG9nIGZvciAnbXVsdGlsb2cnIGZpbGVuYW1lLCBvdGhlcndpc2UgdGhlIGluZGl2aWR1YWwgZm9sbG93ZXIKICAgICAgICAgICAgaWYgbXVsdGlsb2dfZmlsZW5hbWU6ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9sbG93X211bHRpbG9nID0gRm9sbG93TXVsdGlsb2cobG9nX2ZpbGVuYW1lLCBlbnRyeV9maWx0ZXIsIGVudHJ5X2Zvcm1hdHRlciwgZW50cnlfaWRlbnRpZmllciwgdHJhbnNwb3J0KQogICAgICAgICAgICAgICAgZm9sbG93X211bHRpbG9ncy5hcHBlbmQoZm9sbG93X211bHRpbG9nKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZm9sbG93ZXIgPSBGb2xsb3dlcihsb2dfZmlsZW5hbWUsIGVudHJ5X2ZpbHRlciwgZW50cnlfZm9ybWF0dGVyLCBlbnRyeV9pZGVudGlmaWVyLCB0cmFuc3BvcnQpCiAgICAgICAgICAgICAgICBmb2xsb3dlcnMuYXBwZW5kKGZvbGxvd2VyKQogICAgcmV0dXJuIChmb2xsb3dlcnMsIHRyYW5zcG9ydHMsIGZvbGxvd19tdWx0aWxvZ3MpCgoKZGVmIGlzX2ZvbGxvd2VkKGZpbGVuYW1lKToKICAgICIiIkNoZWNrcyBpZiB0aGUgZmlsZSBnaXZlbiBpcyBmb2xsb3dlZC4KICAgICIiIgogICAgaG9zdCA9IHJlcXVlc3QoJ2hvc3RzLyVzLycgJSBjb25maWcuYWdlbnRfa2V5LCBUcnVlLCBUcnVlKQogICAgbG9ncyA9IGhvc3RbJ2xpc3QnXQogICAgZm9yIGlsb2cgaW4gbG9nczoKICAgICAgICBpZiBpbG9nWydmb2xsb3cnXSA9PSAndHJ1ZScgYW5kIGZpbGVuYW1lID09IGlsb2dbJ2ZpbGVuYW1lJ106CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCmRlZiBnZXRfbG9nX25hbWVzX2Zvcl9maWxlcyhmaWxlbmFtZXMpOgogICAgIiIiCiAgICBDaGVja3MgaWYgZWFjaCBmaWxlIGluIGEgbGlzdCBvZiBmaWxlcyBpcyBmb2xsb3dlZC4gV2lsbCBvbmx5IG1ha2UgdGhlIG9uZSBjYWxsIG9uIHRoZSBzZXJ2ZXIhCiAgICBJZiBpdCBpcywgZ2V0cyB0aGUgJ25hbWUnIG9mIHRoZSBsb2cgZm9yIHRoaXMgZmlsZS4gSWYgbm90LCB0aGVuIGEgJ05vbmUnIGlzIHVzZWQuCiAgICA6cGFyYW0gZmlsZW5hbWVzOiAgIHRoZSBsaXN0IG9mIGZpbGVuYW1lcyBvZiBpbnRlcmVzdAogICAgOnJldHVybjogICAgcmV0dXJucyBhIHt9IG9mIGZpbGVuYW1lcyB3aXRoIGVpdGhlciB0aGUKICAgICAgICAgICAgICAgIGFzc29jaWF0ZWQgbG9nIG5hbWUgb3IgJ05vbmUnIGZvciBlYWNoIGZpbGUKICAgICIiIgogICAgaWYgbGVuKGZpbGVuYW1lcykgPT0gMDoKICAgICAgICBkaWUoJ1xuV2FybmluZzogTGlzdCBvZiBmaWxlbmFtZXMgaXMgZW1wdHlcbicpCiAgICBob3N0ID0gcmVxdWVzdCgnaG9zdHMvJXMvJyAlIGNvbmZpZy5hZ2VudF9rZXksIFRydWUsIFRydWUpCiAgICBsb2dzID0gaG9zdFsnbGlzdCddCiAgICByZXN1bHQgPSB7fQogICAgZm9yIGZpbGVuYW1lIGluIGZpbGVuYW1lczoKICAgICAgICByZXN1bHRbZmlsZW5hbWVdID0gTk9UX1NFVAogICAgICAgIGZvciBpbG9nIGluIGxvZ3M6CiAgICAgICAgICAgIGlmIGlsb2dbJ2ZvbGxvdyddID09ICd0cnVlJyBhbmQgZmlsZW5hbWUgPT0gaWxvZ1snZmlsZW5hbWUnXToKICAgICAgICAgICAgICAgIHJlc3VsdFtmaWxlbmFtZV0gPSBzdHIoaWxvZ1snbmFtZSddKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZXRfbG9nbGlzdF93aXRoX3BhdGhzKCk6CiAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgbGlzdCBvZiBhbGwgZGVzdGluYXRpb24gbG9ncyBvbiB0aGUgbG9nZW50cmllcyBpbmZyYXN0cnVjdHVyZSBmb3IKICAgICAgICBhIGhvc3Qgd2l0aCB0aGUgcGF0aCB0aGF0IHRoZSBsb2cgaXMgdXNpbmcgZm9yIGZvbGxvd2luZyBhIGZpbGUgb3IgbXV0bGlwbGUgZmlsZXMKICAgIDpyZXR1cm4gOgogICAgIiIiCiAgICBob3N0ID0gcmVxdWVzdCgnaG9zdHMvJXMvJyAlIGNvbmZpZy5hZ2VudF9rZXksIFRydWUsIFRydWUpCiAgICBsb2dzID0gaG9zdFsnbGlzdCddCiAgICByZXN1bHQgPSB7fQogICAgZm9yIGlsb2cgaW4gbG9nczoKICAgICAgICBpZiBpbG9nWydmb2xsb3cnXSA9PSAndHJ1ZSc6CiAgICAgICAgICAgIHJlc3VsdFtzdHIoaWxvZ1snbmFtZSddKV0gPSBzdHIoaWxvZ1snZmlsZW5hbWUnXSkKICAgIHJldHVybiByZXN1bHQKCgpkZWYgY3JlYXRlX2NvbmZpZ3VyZWRfbG9ncyhjb25maWd1cmVkX2xvZ3MpOgogICAgIiIiIEdldCB0b2tlbnMgZm9yIGFsbCBjb25maWd1cmVkIGxvZ3MuIExvZ3Mgd2l0aCBubyB0b2tlbiBzcGVjaWZpZWQgYXJlCiAgICByZXRyaWV2ZWQgdmlhIEFQSSBhbmQgY3JlYXRlZCBpZiBuZWVkZWQuCiAgICAiIiIKICAgIGZvciBjbG9nIGluIGNvbmZpZ3VyZWRfbG9nczoKICAgICAgICBpZiBub3QgY2xvZy5kZXN0aW5hdGlvbiBhbmQgbm90IGNsb2cudG9rZW46CiAgICAgICAgICAgIGxvZy5lcnJvcignSWdub3Jpbmcgc2VjdGlvbiAlcyBhcyBuZWl0aGVyICVzIG5vciAlcyBpcyBzcGVjaWZpZWQnLCBjbG9nLm5hbWUsIFRPS0VOX1BBUkFNLCBERVNUSU5BVElPTl9QQVJBTSkKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgY2xvZy5kZXN0aW5hdGlvbiBhbmQgbm90IGNsb2cudG9rZW46CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIChob3N0bmFtZSwgbG9nbmFtZSkgPSBjbG9nLmRlc3RpbmF0aW9uLnNwbGl0KCcvJywgMSkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJ0lnbm9yaW5nIHNlY3Rpb24gJXMgc2luY2UgYCVzXCcgZG9lcyBub3QgY29udGFpbiBob3N0JywgY2xvZy5uYW1lLCBERVNUSU5BVElPTl9QQVJBTSkKICAgICAgICAgICAgaG9zdF9rZXkgPSBnZXRfb3JfY3JlYXRlX2hvc3QoaG9zdG5hbWUpCiAgICAgICAgICAgIHRva2VuID0gZ2V0X29yX2NyZWF0ZV9sb2coaG9zdF9rZXksIGxvZ25hbWUsIGNsb2cuZGVzdGluYXRpb24pCiAgICAgICAgICAgIGlmIG5vdCB0b2tlbjoKICAgICAgICAgICAgICAgIGxvZy5lcnJvcignSWdub3Jpbmcgc2VjdGlvbiAlcywgY2Fubm90IGNyZWF0ZSBsb2cnICUgY2xvZy5uYW1lKQoKICAgICAgICAgICAgY2xvZy50b2tlbiA9IHRva2VuCgoKZGVmIGNtZF9tb25pdG9yKGFyZ3MpOgogICAgIiIiTW9uaXRvcnMgaG9zdCBhY3Rpdml0eSBhbmQgc2VuZHMgZXZlbnRzIGNvbGxlY3RlZCB0byBsb2dlbnRyaWVzCiAgICBpbmZyYXN0cnVjdHVyZS4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBjb25maWcubG9hZCgpCiAgICBzdGF0cyA9IE5vbmUKICAgIHNtZXRyaWNzID0gTm9uZQoKICAgICMgV2UgbmVlZCBhY2NvdW50IGFuZCBob3N0IElEIHRvIGdldCBzZXJ2ZXIgc2lkZSBjb25maWd1cmF0aW9uCiAgICBpZiBjb25maWcucHVsbF9zZXJ2ZXJfc2lkZV9jb25maWc6CiAgICAgICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKG5vdCBjb25maWcuZGFlbW9uKQogICAgICAgIGNvbmZpZy5hZ2VudF9rZXlfcmVxdWlyZWQoKQoKICAgICMgRW5zdXJlIGFsbCBjb25maWd1cmVkIGxvZ3MgYXJlIGNyZWF0ZWQKICAgIGlmIGNvbmZpZy5jb25maWd1cmVkX2xvZ3MgYW5kIG5vdCBjb25maWcuZGF0YWh1YjoKICAgICAgICBjcmVhdGVfY29uZmlndXJlZF9sb2dzKGNvbmZpZy5jb25maWd1cmVkX2xvZ3MpCgogICAgaWYgY29uZmlnLmRhZW1vbjoKICAgICAgICBkYWVtb25pemUoKQoKICAgICMgU3RhcnQgZGVmYXVsdCB0cmFuc3BvcnQgY2hhbm5lbAogICAgZGVmYXVsdF90cmFuc3BvcnQgPSBEZWZhdWx0VHJhbnNwb3J0KGNvbmZpZykKCiAgICAjIFJlZ2lzdGVyIHJlc291cmNlIG1vbml0b3JpbmcKICAgIGlmIGNvbmZpZy5hZ2VudF9rZXkgIT0gTk9UX1NFVCBhbmQgY29uZmlnLnYxX21ldHJpY3MgIT0gJ0ZhbHNlJzoKICAgICAgICBsb2cuZGVidWcoIkVuYWJsaW5nIFYxIG1ldHJpY3MiKQogICAgICAgIHN0YXRzID0gU3RhdHMoKQogICAgICAgIHN0YXRzLnN0YXJ0KCkKICAgIGVsc2U6CiAgICAgICAgbG9nLmRlYnVnKCJWMSBtZXRyaWNzIGRpc2FibGVkIikKICAgIGZvcm1hdHRlciA9IGZvcm1hdHMuRm9ybWF0U3lzbG9nKGNvbmZpZy5ob3N0bmFtZSwgJ2xlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5tZXRyaWNzLnRva2VuKQogICAgc21ldHJpY3MgPSBtZXRyaWNzLk1ldHJpY3MoY29uZmlnLm1ldHJpY3MsIGRlZmF1bHRfdHJhbnNwb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlciwgY29uZmlnLmRlYnVnX21ldHJpY3MpCiAgICBzbWV0cmljcy5zdGFydCgpCgogICAgZm9sbG93ZXJzID0gW10KICAgIHRyYW5zcG9ydHMgPSBbXQogICAgZm9sbG93X211bHRpbG9ncyA9IFtdCiAgICB0cnk6CiAgICAgICAgIyBMb2FkIGxvZ3MgdG8gZm9sbG93IGFuZCBzdGFydCBmb2xsb3dpbmcgdGhlbQogICAgICAgIGlmIG5vdCBjb25maWcuZGVidWdfc3RhdHNfb25seToKICAgICAgICAgICAgKGZvbGxvd2VycywgdHJhbnNwb3J0cywgZm9sbG93X211bHRpbG9ncykgPSBzdGFydF9mb2xsb3dlcnMoZGVmYXVsdF90cmFuc3BvcnQpCgogICAgICAgICMgUGFyayB0aGlzIHRocmVhZAogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoNjAwKSAgIyBGSVhNRTogaXMgdGhlcmUgYSBiZXR0ZXIgd2F5PwogICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgIHBhc3MKCiAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAiXG5TaHV0dGluZyBkb3duIgogICAgIyBTdG9wIG1ldHJpY3MKICAgIGlmIHN0YXRzOgogICAgICAgIHN0YXRzLmNhbmNlbCgpCiAgICBpZiBzbWV0cmljczoKICAgICAgICBzbWV0cmljcy5jYW5jZWwoKQogICAgIyBDbG9zZSBmb2xsb3dlcnMKICAgIGZvciBmb2xsb3dlciBpbiBmb2xsb3dlcnM6CiAgICAgICAgZm9sbG93ZXIuY2xvc2UoKQogICAgIyBDbG9zZSBlYWNoIGZvbGxvd19tdWx0aWxvZyBhbmQgdGhlIGZvbGxvd2VycyBpdCBob2xkcwogICAgZm9yIGZvbGxvd19tdWx0aWxvZyBpbiBmb2xsb3dfbXVsdGlsb2dzOgogICAgICAgIGZvbGxvd19tdWx0aWxvZy5jbG9zZSgpCiAgICAjIENsb3NlIHRyYW5zcG9ydHMKICAgIGZvciB0cmFuc3BvcnQgaW4gdHJhbnNwb3J0czoKICAgICAgICB0cmFuc3BvcnQuY2xvc2UoKQogICAgZGVmYXVsdF90cmFuc3BvcnQuY2xvc2UoKQoKCmRlZiBjbWRfbW9uaXRvcl9kYWVtb24oYXJncyk6CiAgICAiIiJNb25pdG9ycyBhcyBhIGRhZW1vbiBob3N0IGFjdGl2aXR5IGFuZCBzZW5kcyBldmVudHMgY29sbGVjdGVkIHRvCiAgICBsb2dlbnRyaWVzIGluZnJhc3RydWN0dXJlLgogICAgIiIiCiAgICBjb25maWcuZGFlbW9uID0gVHJ1ZQogICAgY21kX21vbml0b3IoYXJncykKCgpkZWYgY21kX2ZvbGxvdyhhcmdzKToKICAgICIiIgogICAgRm9sbG93IHRoZSBsb2cgZmlsZSBnaXZlbi4KICAgICIiIgogICAgaWYgbGVuKGFyZ3MpID09IDA6CiAgICAgICAgZGllKCJFcnJvcjogU3BlY2lmeSB0aGUgZmlsZSBuYW1lIG9mIHRoZSBsb2cgdG8gZm9sbG93LiIpCiAgICBpZiBsZW4oYXJncykgPiAxOgogICAgICAgIGRpZSgiRXJyb3I6IFRvbyBtYW55IGFyZ3VtZW50cy5cbiIKICAgICAgICAgICAgIkEgY29tbW9uIG1pc3Rha2UgaXMgdG8gdXNlIHdpbGRjYXJkcyBpbiBwYXRoIHRoYXQgaXMgYmVpbmcgIgogICAgICAgICAgICAiZXhwYW5kZWQgYnkgc2hlbGwuIEVuY2xvc2UgdGhlIHBhdGggaW4gc2luZ2xlIHF1b3RlcyB0byBhdm9pZCAiCiAgICAgICAgICAgICJleHBhbnNpb24uIikKCiAgICBjb25maWcubG9hZCgpCiAgICBjb25maWcuYWdlbnRfa2V5X3JlcXVpcmVkKCkKICAgICMgRklYTUU6IGZvbGxvdyB0byBhZGQgbG9ncyBpbnRvIGxvY2FsIGNvbmZpZ3VyYXRpb24KCiAgICBhcmcgPSBhcmdzWzBdCiAgICBmaWxlbmFtZSA9IG9zLnBhdGguYWJzcGF0aChhcmcpCiAgICBuYW1lID0gY29uZmlnLm5hbWUKICAgIGlmIG5hbWUgPT0gTk9UX1NFVDoKICAgICAgICBuYW1lID0gb3MucGF0aC5iYXNlbmFtZShmaWxlbmFtZSkKICAgIHR5cGVfb3B0ID0gY29uZmlnLnR5cGVfb3B0CiAgICBpZiB0eXBlX29wdCA9PSBOT1RfU0VUOgogICAgICAgIHR5cGVfb3B0ID0gIiIKCiAgICAjIENoZWNrIHRoYXQgd2UgZG9uJ3QgZm9sbG93IHRoYXQgZmlsZSBhbHJlYWR5CiAgICBpZiBub3QgY29uZmlnLmZvcmNlIGFuZCBpc19mb2xsb3dlZChmaWxlbmFtZSk6CiAgICAgICAgbG9nLndhcm5pbmcoJ0FscmVhZHkgZm9sbG93aW5nICVzJywgZmlsZW5hbWUpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbGVuKGdsb2IuZ2xvYihmaWxlbmFtZSkpID09IDA6CiAgICAgICAgbG9nLndhcm5pbmcoJ1xuV2FybmluZzogRmlsZSAlcyBkb2VzIG5vdCBleGlzdFxuJywgZmlsZW5hbWUpCgogICAgcmVxdWVzdF9mb2xsb3coZmlsZW5hbWUsIG5hbWUsIHR5cGVfb3B0KQoKCmRlZiBjbWRfZm9sbG93X211bHRpbG9nKGFyZ3MpOgogICAgIiIiCiAgICBGb2xsb3cgdGhlIGxvZyhzKSBhcyBkZWZpbmVkIGluIHN0cmluZyBwYXNzZWQgdG8gYWdlbnQgd2l0aAogICAgdGhlICctLW11bHRpbG9nJyBwYXJhbWV0ZXIgaW5jbHVkZWQgLSBtb2RpZmljYXRpb24gb2YgY21kX2ZvbGxvdwogICAgIiIiCiAgICBpZiBsZW4oYXJncykgPT0gMDoKICAgICAgICBkaWUoIkVycm9yOiBTcGVjaWZ5IHRoZSBmaWxlIG5hbWUgb2YgdGhlIGxvZyB0byBmb2xsb3cuIikKICAgIGlmIGxlbihhcmdzKSA+IDE6CiAgICAgICAgZGllKCJFcnJvcjogVG9vIG1hbnkgYXJndW1lbnRzLlxuIgogICAgICAgICAgICAiQSBjb21tb24gbWlzdGFrZSBpcyB0byB1c2Ugd2lsZGNhcmRzIGluIHBhdGggdGhhdCBpcyBiZWluZyAiCiAgICAgICAgICAgICJleHBhbmRlZCBieSBzaGVsbC4gRW5jbG9zZSB0aGUgcGF0aCBpbiBzaW5nbGUgcXVvdGVzIHRvIGF2b2lkICIKICAgICAgICAgICAgImV4cGFuc2lvbi4iKQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCiAgICBhcmcgPSBhcmdzWzBdCiAgICBwYXRoID0gb3MucGF0aC5hYnNwYXRoKGFyZykKICAgICMgV2hlbiB0ZXN0aW5nIGlnbm9yZSB1c2VyIGlucHV0CiAgICBpZiBjb25maWcuZGVidWdfbXVsdGlsb2c6CiAgICAgICAgZm9sbG93ID0gVHJ1ZQogICAgZWxzZToKICAgICAgICBmb2xsb3cgPSB1c2VyX3Byb21wdChwYXRoKQogICAgaWYgZm9sbG93OgogICAgICAgIG5hbWUgPSBjb25maWcubmFtZQogICAgICAgIGlmIG5hbWUgPT0gTk9UX1NFVDoKICAgICAgICAgICAgbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUocGF0aCkKICAgICAgICB0eXBlX29wdCA9IGNvbmZpZy50eXBlX29wdAogICAgICAgIGlmIHR5cGVfb3B0ID09IE5PVF9TRVQ6CiAgICAgICAgICAgIHR5cGVfb3B0ID0gIiIKICAgICAgICBmaWxlbmFtZSA9IFBSRUZJWF9NVUxUSUxPR19GSUxFTkFNRSArIHBhdGgKICAgICAgICByZXF1ZXN0X2ZvbGxvdyhmaWxlbmFtZSwgbmFtZSwgdHlwZV9vcHQpCgpkZWYgdXNlcl9wcm9tcHQocGF0aCk6CiAgICAiIiIKICAgIERpc3BsYXlzIDIgbGlzdHMgLSBmaWxlcyBhbHJlYWR5IGZvbGxvd2VkIHdpdGggbG9nIG5hbWVzLCBhbmQgdGhvc2Ugbm90LgogICAgUHJvbXB0cyB1c2VyIGlmIHRoZXkgd2lzaCB0byBmb2xsb3cgZmlsZXMgb3Igbm90CiAgICAiIiIKICAgIGZpbGVfY2FuZGlkYXRlcyA9IGdsb2IuZ2xvYihwYXRoKQogICAgbG9nbGlzdF93aXRoX3BhdGhzID0gZ2V0X2xvZ2xpc3Rfd2l0aF9wYXRocygpCiAgICBpZGVudGljYWxfcGF0aCA9IEZhbHNlCiAgICBwcmludCAiXG5FeGlzdGluZyBkZXN0aW5hdGlvbiBMb2dzIGZvciB0aGlzIGhvc3QgYW5kIHRoZSBhc3NvY2lhdGVkIFBhdGhzIGFyZToiCiAgICBwcmludCgnXHR7MDo1MH17MX0nLmZvcm1hdCgnTE9HTkFNRScsICdQQVRIJykpCiAgICBmb3IgbG9nbmFtZSwgZmlsZXBhdGggaW4gbG9nbGlzdF93aXRoX3BhdGhzLml0ZW1zKCk6CiAgICAgICAgIyBUZXN0IGlmIGFuIGlkZW50aWNhbCBwYXRoIGlzIGFscmVhZHkgaW4gdXNlIQogICAgICAgIGlmIHBhdGggPT0gZmlsZXBhdGgucmVwbGFjZShQUkVGSVhfTVVMVElMT0dfRklMRU5BTUUsJycsMSkubHN0cmlwKCk6CiAgICAgICAgICAgIGlkZW50aWNhbF9wYXRoID0gVHJ1ZQogICAgICAgICAgICBwcmludCgnXHR7MDo0MH17MToxMH17Mn0nLmZvcm1hdChsb2duYW1lLCJJREVOVElDQUwiLCBmaWxlcGF0aCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoJ1x0ezA6NTB9ezF9Jy5mb3JtYXQobG9nbmFtZSwgZmlsZXBhdGgpKQogICAgaWYgaWRlbnRpY2FsX3BhdGg6CiAgICAgICAgcHJpbnQgIk5PVEU6IHRoZXJlIGFyZSBkZXN0aW5hdGlvbiBsb2dzIGluIGFib3ZlIGxpc3Qgd2l0aCBpZGVudGljYWwgcGF0aHMuIgogICAgcHJpbnQgIlxuUmVxdWVzdGVkIHBhdGggaXM6ICVzIiAlIHBhdGgKICAgIGlmIGxlbihmaWxlX2NhbmRpZGF0ZXMpID09IDA6CiAgICAgICAgcHJpbnQgIlxuTm8gRmlsZXMgd2VyZSBmb3VuZCBmb3IgdGhpcyBwYXRoIGF0IHRoaXMgdGltZS5cbiIKICAgIGVsc2U6CiAgICAgICAgcHJpbnQgIlxuRmlsZXMgZm91bmQgZm9yIHRoaXMgcGF0aDoiCiAgICAgICAgZmlsZV9jb3VudCA9IDAKICAgICAgICBmb3IgZmlsZW5hbWUgaW4gZmlsZV9jYW5kaWRhdGVzOgogICAgICAgICAgICBpZiBmaWxlX2NvdW50IDwgTUFYX0ZJTEVTX0ZPTExPV0VEOgogICAgICAgICAgICAgICAgcHJpbnQgKCdcdHswfScuZm9ybWF0KGZpbGVuYW1lKSkKICAgICAgICAgICAgICAgIGZpbGVfY291bnQgPSBmaWxlX2NvdW50KzEgICAgICAgIAogICAgd2hpbGUgVHJ1ZToKICAgICAgICBwcmludCAiXG5Vc2UgbmV3IHBhdGggdG8gZm9sbG93IGZpbGVzIFt5XSBvciBxdWl0IFtuXT8iICAgICAgICAKICAgICAgICB1c2VyX3Jlc3AgPSByYXdfaW5wdXQoKS5sb3dlcigpICAgICAgICAKICAgICAgICBpZiB1c2VyX3Jlc3AgPT0gJ24nOgogICAgICAgICAgICBzeXMuZXhpdChFWElUX09LKQogICAgICAgIGVsaWYgdXNlcl9yZXNwID09ICd5JzoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCAiUGxlYXNlIHRyeSBhZ2FpbiIKCmRlZiBjbWRfZm9sbG93ZWQoYXJncyk6CiAgICAiIiIKICAgIENoZWNrIGlmIHRoZSBsb2cgZmlsZSBnaXZlbiBpcyBmb2xsb3dlZC4KICAgICIiIgogICAgaWYgbGVuKGFyZ3MpID09IDA6CiAgICAgICAgZGllKCJFcnJvcjogU3BlY2lmeSB0aGUgZmlsZSBuYW1lIG9mIHRoZSBsb2cgdG8gdGVzdC4iKQogICAgaWYgbGVuKGFyZ3MpICE9IDE6CiAgICAgICAgZGllKCJFcnJvcjogVG9vIG1hbnkgYXJndW1lbnRzLiBPbmx5IG9uZSBmaWxlIG5hbWUgYWxsb3dlZC4iKQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCgogICAgZmlsZW5hbWUgPSBvcy5wYXRoLmFic3BhdGgoYXJnc1swXSkKCiAgICAjIENoZWNrIHRoYXQgd2UgZG9uJ3QgZm9sbG93IHRoYXQgZmlsZSBhbHJlYWR5CiAgICBpZiBpc19mb2xsb3dlZChmaWxlbmFtZSk6CiAgICAgICAgcHJpbnQgJ0ZvbGxvd2luZyAlcycgJSBmaWxlbmFtZQogICAgICAgIHN5cy5leGl0KEVYSVRfT0spCiAgICBlbHNlOgogICAgICAgIHByaW50ICdOT1QgZm9sbG93aW5nICVzJyAlIGZpbGVuYW1lCiAgICAgICAgc3lzLmV4aXQoRVhJVF9OTykKCgpkZWYgY21kX2NsZWFuKGFyZ3MpOgogICAgIiIiCiAgICBXaXBlcyBvdXQgb2xkIGNvbmZpZ3VyYXRpb24gZmlsZS4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBpZiBjb25maWcuY2xlYW4oKToKICAgICAgICBsb2cuaW5mbygnQ29uZmlndXJhdGlvbiBjbGVhbicpCgoKZGVmIGNtZF93aG9hbWkoYXJncyk6CiAgICAiIiIKICAgIERpc3BsYXlzIGluZm9ybWF0aW9uIGFib3V0IHRoaXMgaG9zdC4KICAgICIiIgogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCiAgICBub19tb3JlX2FyZ3MoYXJncykKCiAgICBsaXN0X29iamVjdChyZXF1ZXN0KCdob3N0cy8lcycgJSBjb25maWcuYWdlbnRfa2V5LCBUcnVlLCBUcnVlKSkKICAgIHByaW50ICcnCiAgICBsaXN0X29iamVjdChyZXF1ZXN0KCdob3N0cy8lcy8nICUgY29uZmlnLmFnZW50X2tleSwgVHJ1ZSwgVHJ1ZSkpCgoKZGVmIGxvZ3R5cGVfbmFtZShsb2d0eXBlX3V1aWQpOgogICAgIiIiIFByb3ZpZGVzIG5hbWUgZm9yIHRoZSBsb2d0eXBlIGdpdmVuLgogICAgIiIiCiAgICAjIExvb2sgZm9yIGVtYmVkZGVkIHN0cnVjdHVyZXMKICAgIGZvciBzdHJ1Y3R1cmVfbmFtZSwgc3RydWN0dXJlX2lkIGluIEVNQkVEREVEX1NUUlVDVFVSRVMuaXRlcml0ZW1zKCk6CiAgICAgICAgaWYgc3RydWN0dXJlX2lkID09IGxvZ3R5cGVfdXVpZDoKICAgICAgICAgICAgcmV0dXJuIHN0cnVjdHVyZV9uYW1lCgogICAgIyBTZWFyY2ggZm9yIGxvZ3R5cGVzIHByb3ZpZGVkIGJ5IHRoZSBiYWNrZW5kCiAgICByZXNwb25zZSA9IHJlcXVlc3QoJ2xvZ3R5cGVzJywgVHJ1ZSwgVHJ1ZSkKICAgIGFsbF9sb2d0eXBlcyA9IHJlc3BvbnNlWydsaXN0J10KICAgIGZvciBsb2d0eXBlIGluIGFsbF9sb2d0eXBlczoKICAgICAgICBpZiBsb2d0eXBlX3V1aWQgPT0gbG9ndHlwZVsna2V5J106CiAgICAgICAgICAgIHJldHVybiBsb2d0eXBlWydzaG9ydGN1dCddCgogICAgcmV0dXJuICd1bmtub3duJwoKCmRlZiBsaXN0X29iamVjdChyZXF1ZXN0LCBob3N0bmFtZXM9RmFsc2UpOgogICAgIiIiCiAgICBMaXN0cyBvYmplY3QgcmVxdWVzdCBnaXZlbi4KICAgICIiIgogICAgdCA9IHJlcXVlc3RbJ29iamVjdCddCiAgICBpbmRleF9uYW1lID0gJ25hbWUnCiAgICBpdGVtX25hbWUgPSAnJwogICAgaWYgdCA9PSAncm9vdGxpc3QnOgogICAgICAgIGl0ZW1fbmFtZSA9ICdpdGVtJwogICAgZWxpZiB0ID09ICdob3N0JzoKICAgICAgICBwcmludCAnbmFtZSA9JywgcmVxdWVzdFsnbmFtZSddCiAgICAgICAgcHJpbnQgJ2hvc3RuYW1lID0nLCByZXF1ZXN0Wydob3N0bmFtZSddCiAgICAgICAgcHJpbnQgJ2tleSA9JywgcmVxdWVzdFsna2V5J10KICAgICAgICBwcmludCAnZGlzdHJpYnV0aW9uID0nLCByZXF1ZXN0WydkaXN0bmFtZSddCiAgICAgICAgcHJpbnQgJ2Rpc3R2ZXIgPScsIHJlcXVlc3RbJ2Rpc3R2ZXInXQogICAgICAgIHJldHVybgogICAgZWxpZiB0ID09ICdsb2cnOgogICAgICAgIHByaW50ICduYW1lID0nLCByZXF1ZXN0WyduYW1lJ10KICAgICAgICBwcmludCAnZmlsZW5hbWUgPScsIHJlcXVlc3RbJ2ZpbGVuYW1lJ10KICAgICAgICBwcmludCAna2V5ID0nLCByZXF1ZXN0WydrZXknXQogICAgICAgIHByaW50ICd0eXBlID0nLCByZXF1ZXN0Wyd0eXBlJ10KICAgICAgICBwcmludCAnZm9sbG93ID0nLCByZXF1ZXN0Wydmb2xsb3cnXQogICAgICAgIGlmICd0b2tlbicgaW4gcmVxdWVzdDoKICAgICAgICAgICAgcHJpbnQgJ3Rva2VuID0nLCByZXF1ZXN0Wyd0b2tlbiddCiAgICAgICAgaWYgJ2xvZ3R5cGUnIGluIHJlcXVlc3Q6CiAgICAgICAgICAgIHByaW50ICdsb2d0eXBlID0nLCBsb2d0eXBlX25hbWUocmVxdWVzdFsnbG9ndHlwZSddKQogICAgICAgIHJldHVybgogICAgZWxpZiB0ID09ICdsaXN0JzoKICAgICAgICBwcmludCAnbmFtZSA9JywgcmVxdWVzdFsnbmFtZSddCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIHQgPT0gJ2hvc3RsaXN0JzoKICAgICAgICBpdGVtX25hbWUgPSAnaG9zdCcKICAgICAgICBpZiBob3N0bmFtZXM6CiAgICAgICAgICAgIGluZGV4X25hbWUgPSAnaG9zdG5hbWUnCiAgICBlbGlmIHQgPT0gJ2xvZ3R5cGUnOgogICAgICAgIHByaW50ICd0aXRsZSA9JywgcmVxdWVzdFsndGl0bGUnXQogICAgICAgIHByaW50ICdkZXNjcmlwdGlvbiA9JywgcmVxdWVzdFsnZGVzYyddCiAgICAgICAgcHJpbnQgJ3Nob3J0Y3V0ID0nLCByZXF1ZXN0WydzaG9ydGN1dCddCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIHQgPT0gJ2xvZ2xpc3QnOgogICAgICAgIGl0ZW1fbmFtZSA9ICdsb2cnCiAgICBlbGlmIHQgPT0gJ2xvZ3R5cGVsaXN0JzoKICAgICAgICBpdGVtX25hbWUgPSAnbG9ndHlwZScKICAgICAgICBpbmRleF9uYW1lID0gJ3Nob3J0Y3V0JwogICAgZWxzZToKICAgICAgICBkaWUoJ1Vua25vd24gb2JqZWN0IHR5cGUgIiVzIi4gQWdlbnQgdG9vIG9sZD8nICUgdCkKCiAgICAjIFN0YW5kYXJkIGxpc3QsIHByaW50IGl0IHNvcnRlZAogICAgaWxpc3QgPSByZXF1ZXN0WydsaXN0J10KICAgIGlsaXN0ID0gc29ydGVkKGlsaXN0LCBrZXk9bGFtYmRhIGl0ZW06IGl0ZW1baW5kZXhfbmFtZV0pCiAgICBmb3IgaXRlbSBpbiBpbGlzdDoKICAgICAgICBpZiBjb25maWcudXVpZDoKICAgICAgICAgICAgcHJpbnQgaXRlbVsna2V5J10sCiAgICAgICAgcHJpbnQgIiVzIiAlIChpdGVtW2luZGV4X25hbWVdKQogICAgcHJpbnRfdG90YWwoaWxpc3QsIGl0ZW1fbmFtZSkKCgpkZWYgaXNfbG9nX2ZzKGFkZHIpOgogICAgIiIiVGVzdHMgaWYgdGhlIGFkZHJlc3MgcG9pbnRzIGZvciBhIGxvZy4KICAgICIiIgogICAgbG9nX2FkZHJzID0gW3InKGxvZ3N8YXBwcykvLiovJywKICAgICAgICAgICAgICAgICByJ2hvc3QobmFtZSk/cy8uKi8uKi8nXQogICAgZm9yIGxhIGluIGxvZ19hZGRyczoKICAgICAgICBpZiByZS5tYXRjaChsYSwgYWRkcik6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgY21kX2xzX2lwcyhhZ3MpOgogICAgIiIiCiAgICBMaXN0IElQcyB1c2VkIGJ5IHRoZSBhZ2VudC4KICAgICIiIgogICAgbCA9IFtdCiAgICBmb3IgbmFtZSBpbiBbRG9tYWluLk1BSU4sIERvbWFpbi5BUEksIERvbWFpbi5EQVRBLCBEb21haW4uUFVMTF06CiAgICAgICAgZm9yIGluZm8gaW4gc29ja2V0LmdldGFkZHJpbmZvKG5hbWUsIE5vbmUsIDAsIDAsIHNvY2tldC5JUFBST1RPX1RDUCk6CiAgICAgICAgICAgIGlwID0gaW5mb1s0XVswXQogICAgICAgICAgICBwcmludCA+PnN5cy5zdGRlcnIsICclLTE2cyAlcycgJSAoaXAsIG5hbWUpCiAgICAgICAgICAgIGwuYXBwZW5kKGlwKQogICAgcHJpbnQgbAogICAgcHJpbnQgJyAnLmpvaW4obCkKCgpkZWYgY21kX2xzKGFyZ3MpOgogICAgIiIiCiAgICBHZW5lcmFsIGxpc3QgY29tbWFuZAogICAgIiIiCiAgICBpZiBsZW4oYXJncykgPT0gMSBhbmQgYXJnc1swXSA9PSAnaXBzJzoKICAgICAgICBjbWRfbHNfaXBzKGFyZ3MpCiAgICAgICAgcmV0dXJuCiAgICBpZiBsZW4oYXJncykgPT0gMDoKICAgICAgICBhcmdzID0gWycvJ10KICAgIGNvbmZpZy5sb2FkKCkKICAgIGNvbmZpZy51c2VyX2tleV9yZXF1aXJlZChUcnVlKQoKICAgIGFkZHIgPSBhcmdzWzBdCiAgICBpZiBhZGRyLnN0YXJ0c3dpdGgoJy8nKToKICAgICAgICBhZGRyID0gYWRkclsxOl0KICAgICMgTWFrZSBzdXJlIHdlIGFyZSBub3QgZG93bmxvYWRpbmcgbG9nCiAgICBpZiBpc19sb2dfZnMoYWRkcik6CiAgICAgICAgZGllKCdVc2UgcHVsbCB0byBnZXQgbG9nIGNvbnRlbnQuJykKCiAgICAjIGlmIGFkZHIuY291bnQoJy8nKSA+IDI6CiAgICAjIGRpZSggJ1BhdGggbm90IGZvdW5kJykKICAgIGxpc3Rfb2JqZWN0KHJlcXVlc3QoYWRkciwgVHJ1ZSwgVHJ1ZSksCiAgICAgICAgICAgICAgICBob3N0bmFtZXM9YWRkci5zdGFydHN3aXRoKCdob3N0bmFtZXMnKSkKCgpkZWYgY21kX3JtKGFyZ3MpOgogICAgIiIiCiAgICBHZW5lcmFsIHJlbW92ZSBjb21tYW5kCiAgICAiIiIKICAgIGlmIGxlbihhcmdzKSA9PSAwOgogICAgICAgIGFyZ3MgPSBbJy8nXQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKFRydWUpCgogICAgYWRkciA9IGFyZ3NbMF0KICAgIGlmIGFkZHIuc3RhcnRzd2l0aCgnLycpOgogICAgICAgIGFkZHIgPSBhZGRyWzE6XQogICAgaWYgYWRkci5jb3VudCgnLycpID4gMjoKICAgICAgICBkaWUoJ1BhdGggbm90IGZvdW5kJykKICAgIHJlc3BvbnNlID0gcmVxdWVzdChhZGRyLCBUcnVlLCBUcnVlLCBydHlwZT0nREVMRVRFJykKICAgIHJlcG9ydChyZXNwb25zZVsncmVhc29uJ10pCgoKZGVmIGNtZF9wdWxsKGFyZ3MpOgogICAgIiIiCiAgICBMb2cgcHVsbCBjb21tYW5kCiAgICAiIiIKICAgIGlmIGxlbihhcmdzKSA9PSAwOgogICAgICAgIGRpZShQVUxMX1VTQUdFKQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKFRydWUpCgogICAgcGFyYW1zID0ge30KCiAgICBhZGRyID0gYXJnc1swXQogICAgaWYgYWRkci5zdGFydHN3aXRoKCcvJyk6CiAgICAgICAgYWRkciA9IGFkZHJbMTpdCiAgICBpZiBhZGRyLmVuZHN3aXRoKCcvJyk6CiAgICAgICAgYWRkciA9IGFkZHJbOi0xXQogICAgaWYgbm90IGlzX2xvZ19mcyhhZGRyICsgJy8nKToKICAgICAgICBkaWUoJ0Vycm9yOiBOb3QgYSBsb2cnKQoKICAgIGlmIGxlbihhcmdzKSA+IDE6CiAgICAgICAgdGltZV9yYW5nZSA9IHBhcnNlX3RpbWVzdGFtcF9yYW5nZShhcmdzWzFdKQogICAgICAgIHBhcmFtc1snc3RhcnQnXSA9IHRpbWVfcmFuZ2VbMF0KICAgICAgICBwYXJhbXNbJ2VuZCddID0gdGltZV9yYW5nZVsxXQogICAgaWYgbGVuKGFyZ3MpID4gMjoKICAgICAgICBwYXJhbXNbJ2ZpbHRlciddID0gYXJnc1syXQogICAgaWYgbGVuKGFyZ3MpID4gMzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxpbWl0ID0gaW50KGFyZ3NbM10pCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIGRpZSgnRXJyb3I6IExpbWl0IG11c3QgYmUgaW50ZWdlcicpCiAgICAgICAgaWYgbGltaXQgPCAxOgogICAgICAgICAgICBkaWUoJ0xpbWl0IG11c3QgYmUgYWJvdmUgMCcpCiAgICAgICAgcGFyYW1zWydsaW1pdCddID0gbGltaXQKCiAgICBwdWxsX3JlcXVlc3QoYWRkciwgcGFyYW1zKQoKCiMKIyBNYWluIG1ldGhvZAojCgpkZWYgbWFpbl9yb290KCk6CiAgICAiIiJTZXJpb3VzIGJ1c2luZXNzIHN0YXJ0cyBoZXJlLgogICAgIiIiCiAgICAjIFJlYWQgY29tbWFuZCBsaW5lIHBhcmFtZXRlcnMKICAgIGFyZ3MgPSBjb25maWcucHJvY2Vzc19wYXJhbXMoc3lzLmFyZ3ZbMTpdKQoKICAgIGlmIGNvbmZpZy5kZWJ1ZzoKICAgICAgICBsb2cuc2V0TGV2ZWwobG9nZ2luZy5ERUJVRykKICAgIGlmIGNvbmZpZy5kZWJ1Z19zeXN0ZW06CiAgICAgICAgZGllKHN5c3RlbV9kZXRlY3QoVHJ1ZSkpCiAgICBpZiBjb25maWcuZGVidWdfbG9nbGlzdDoKICAgICAgICBkaWUoY29sbGVjdF9sb2dfbmFtZXMoc3lzdGVtX2RldGVjdChUcnVlKSkpCgogICAgaWYgY29uZmlnLmRlYnVnX2NtZF9saW5lOgogICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsICdEZWJ1ZyBjb21tYW5kIGxpbmUgYXJnczogJXMnICUgYXJncwoKICAgIGFyZ3YwID0gc3lzLmFyZ3ZbMF0KICAgIGlmIGFyZ3YwIGFuZCBhcmd2MCAhPSAnJzoKICAgICAgICBwbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoYXJndjApLnNwbGl0KCctJykKICAgICAgICBpZiBsZW4ocG5hbWUpICE9IDE6CiAgICAgICAgICAgIGFyZ3MuaW5zZXJ0KDAsIHBuYW1lWy0xXSkKCiAgICBpZiBsZW4oYXJncykgPT0gMDoKICAgICAgICByZXBvcnQoVVNBR0UpCiAgICAgICAgc3lzLmV4aXQoRVhJVF9IRUxQKQoKICAgIGNvbW1hbmRzID0gewogICAgICAgICdpbml0JzogY21kX2luaXQsCiAgICAgICAgJ3JlaW5pdCc6IGNtZF9yZWluaXQsCiAgICAgICAgJ3JlZ2lzdGVyJzogY21kX3JlZ2lzdGVyLAogICAgICAgICdtb25pdG9yJzogY21kX21vbml0b3IsCiAgICAgICAgJ21vbml0b3JkYWVtb24nOiBjbWRfbW9uaXRvcl9kYWVtb24sCiAgICAgICAgJ2ZvbGxvdyc6IGNtZF9mb2xsb3csCiAgICAgICAgJ2ZvbGxvd2VkJzogY21kX2ZvbGxvd2VkLAogICAgICAgICdjbGVhbic6IGNtZF9jbGVhbiwKICAgICAgICAnd2hvYW1pJzogY21kX3dob2FtaSwKICAgICAgICAjIEZpbGVzeXN0ZW0gb3BlcmF0aW9ucwogICAgICAgICdscyc6IGNtZF9scywKICAgICAgICAncm0nOiBjbWRfcm0sCiAgICAgICAgJ3B1bGwnOiBjbWRfcHVsbCwKICAgIH0KICAgIGZvciBjbWQsIGZ1bmMgaW4gY29tbWFuZHMuaXRlbXMoKToKICAgICAgICBpZiBjbWQgPT0gYXJnc1swXToKICAgICAgICAgICAgaWYgY29uZmlnLm11bHRpbG9nIGFuZCBjbWQgPT0gJ2ZvbGxvdyc6CiAgICAgICAgICAgICAgICByZXR1cm4gY21kX2ZvbGxvd19tdWx0aWxvZyhhcmdzWzE6XSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jKGFyZ3NbMTpdKQogICAgZGllKCdFcnJvcjogVW5rbm93biBjb21tYW5kICIlcyIuJyAlIGFyZ3NbMF0pCgoKZGVmIG1haW4oKToKICAgIHRyeToKICAgICAgICBtYWluX3Jvb3QoKQogICAgZXhjZXB0IEZhdGFsQ29uZmlndXJhdGlvbkVycm9yLCBlOgogICAgICAgIGxvZy5lcnJvcigiRmF0YWw6ICVzIiwgZS5tc2cpCiAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgZGllKCJcblRlcm1pbmF0ZWQiLCBFWElUX1RFUk1JTkFURUQpCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpCg==</text>
      </register>
      <register name="-" type="4">
        <text>handle exception</text>
      </register>
      <register name="/" type="4">
        <text encoding="base64">XDxpcGFkZHJfYWxpaGsyXD4=</text>
      </register>
      <register name="0" type="2">
        <text encoding="base64">ICAgICAgICAgICAgcnRuID0gYXdhaXQgc2VsZi5mdXR1cmVfdHJhZGUobG9jYWxfc3ltYm9sPWxvY2FsX2Nvbi5sb2NhbF9zeW1ib2wsIHR0eXBlPXR0eXBlLCBwcmljZT1wcmljZSwgYW1vdW50PWFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJhY3RfdHlwZT1sb2NhbF9jb24uZGVsaXZlcnkpCg==</text>
      </register>
      <register name="1" type="2">
        <text encoding="base64">IyEvdXNyL2Jpbi9lbnYgcHl0aG9uCiMgY29kaW5nOiB1dGYtOAojIHZpbTogc2V0IHRzPTQgc3c9NCBldDoKCiMKIyBMb2dlbnRyaWVzIEFnZW50IDxodHRwczovL2xvZ2VudHJpZXMuY29tLz4uCiMKCiMKIyBDb25zdGFudHMKIwoKZnJvbSB1dGlscyBpbXBvcnQgKgpmcm9tIF9faW5pdF9fIGltcG9ydCBfX3ZlcnNpb25fXwoKQ09SUCA9ICJsb2dlbnRyaWVzIgoKTk9UX1NFVCA9IE5vbmUKCiMgRGVmYXVsdCB1c2VyIGFuZCBhZ2VudCBrZXlzIG9mIG5vbmUgYXJlIGRlZmluZWQgaW4gY29uZmlndXJhdGlvbgpERUZBVUxUX1VTRVJfS0VZID0gTk9UX1NFVApERUZBVUxUX0FHRU5UX0tFWSA9IE5PVF9TRVQKCiMgQ29uZmlndXJhdGlvbiBmaWxlcwpDT05GSUdfRElSX1NZU1RFTSA9ICcvZXRjL2xlJwpDT05GSUdfRElSX1VTRVIgPSAnLmxlJwpMRV9DT05GSUcgPSAnY29uZmlnJyAjIERlZmF1bHQgY29uZmlndXJhdGlvbiBmaWxlCkNPTkZfU1VGRklYID0gJy5jb25mJyAjIEV4cGVjdGVkIHN1ZmZpeCBvZiBjb25maWd1cmF0aW9uIGZpbGVzCgpMT0NBTF9DT05GSUdfRElSX1VTRVIgPSAnLmxlJwpMT0NBTF9DT05GSUdfRElSX1NZU1RFTSA9ICcvZXRjL2xlJwoKUElEX0ZJTEUgPSAnL3Zhci9ydW4vbG9nZW50cmllcy5waWQnCgpNQUlOX1NFQ1QgPSAnTWFpbicKVVNFUl9LRVlfUEFSQU0gPSAndXNlci1rZXknCkFHRU5UX0tFWV9QQVJBTSA9ICdhZ2VudC1rZXknCkZJTFRFUlNfUEFSQU0gPSAnZmlsdGVycycKRk9STUFUVEVSU19QQVJBTSA9ICdmb3JtYXR0ZXJzJwpGT1JNQVRURVJfUEFSQU0gPSAnZm9ybWF0dGVyJwpFTlRSWV9JREVOVElGSUVSX1BBUkFNID0gJ2VudHJ5X2lkZW50aWZpZXInClNVUFBSRVNTX1NTTF9QQVJBTSA9ICdzdXBwcmVzc19zc2wnClVTRV9DQV9QUk9WSURFRF9QQVJBTSA9ICd1c2VfY2FfcHJvdmlkZWQnCkZPUkNFX0RPTUFJTl9QQVJBTSA9ICdmb3JjZV9kb21haW4nCkRBVEFIVUJfUEFSQU0gPSAnZGF0YWh1YicKU1lTU1RBVF9UT0tFTl9QQVJBTSA9ICdzeXN0ZW0tc3RhdC10b2tlbicKSE9TVE5BTUVfUEFSQU0gPSAnaG9zdG5hbWUnClYxX01FVFJJQ1NfUEFSQU0gPSAndjFfbWV0cmljcycKVE9LRU5fUEFSQU0gPSAndG9rZW4nClBBVEhfUEFSQU0gPSAncGF0aCcKSU5DTFVERV9QQVJBTSA9ICdpbmNsdWRlJwpERVNUSU5BVElPTl9QQVJBTSA9ICdkZXN0aW5hdGlvbicKUFVMTF9TRVJWRVJfU0lERV9DT05GSUdfUEFSQU0gPSAncHVsbC1zZXJ2ZXItc2lkZS1jb25maWcnCktFWV9MRU4gPSAzNgpBQ0NPVU5UX0tFWVNfQVBJID0gJy9hZ2VudC9hY2NvdW50LWtleXMvJwpJRF9MT0dTX0FQSSA9ICcvYWdlbnQvaWQtbG9ncy8nCgpMSU5FX1NFUEFSQVRPUiA9ICdceGUyXHg4MFx4YTgnLmRlY29kZSgndXRmOCcpCgpQUk9YWV9UWVBFX1BBUkFNID0gInByb3h5LXR5cGUiClBST1hZX1VSTF9QQVJBTSA9ICJwcm94eS11cmwiClBST1hZX1BPUlRfUEFSQU0gPSAicHJveHktcG9ydCIKCiMgTWF4aW1hbCBxdWV1ZSBzaXplIGZvciBldmVudHMgc2VudApTRU5EX1FVRVVFX1NJWkUgPSAzMjAwMAoKIyBMb2dlbnRyaWVzIHNlcnZlciBkZXRhaWxzCkxFX1NFUlZFUl9BUEkgPSAnLycKCkxFX0RFRkFVTFRfU1NMX1BPUlQgPSAyMDAwMApMRV9ERUZBVUxUX05PTl9TU0xfUE9SVCA9IDEwMDAwCgojIFN0cnVjdHVyZXMgZW1iZWRkZWQgKGJldGEpCkVNQkVEREVEX1NUUlVDVFVSRVMgPSB7CiAgICAjIEpTT04gd2l0aCBzdXBwb3J0IGZvciBuZXN0ZWQgb2JqZWN0cwogICAgImpzb24iOiAiNDQ0ZTYwN2YtMTRiZC00MDVlLWEyY2UtYzQ4OTJiNWEzYjE1IiwKICAgICMgR2VuZXJhbCBrdnAgcGFyc2VyCiAgICAia3ZwIjogIjM4MGQzZjM2LTFhOGQtNDVhZC05NzJmLTMwMDE3Njg4NzBjYSIsCiAgICAjIEFwYWNoZSBhY2Nlc3MgbG9nCiAgICAiaHR0cCI6ICI4MDNmZTdiYS1iZDJlLTQ0YmQtOGVlNy1mMDJmYTI1M2VmNWYiLAp9CgojICctLW11bHRpbG9nJyBvcHRpb24gcmVsYXRlZAojIE1heCBudW1iZXIgb2YgZmlsZXMgdGhhdCBhcmUgYWxsb3dlZCB0byBiZSBmb2xsb3dlZCBhdCBhbnkgb25lIHRpbWUgCk1BWF9GSUxFU19GT0xMT1dFRCA9IDEwMAojIFByZWZpeCB1c2VkIHRvIGRpc3Rpbmd1aXNoIHBhdGhuYW1lcyBpbiBjb25maWcgb3Igc2VydmVyIHNpZGUKIyBhcyBpbnRlbmRlZCBmb3IgbXV0bGlsb2cgYmVoYXZpb3VyClBSRUZJWF9NVUxUSUxPR19GSUxFTkFNRSA9ICJNdWx0aWxvZzoiCiMgVGltZSBpbnRlcnZhbCB0byByZXRyeSBnbG9iIG9mIG11bHRpbG9nIHBhdGhuYW1lIHRvIGNhdGNoIGFueSAKIyBjaGFuZ2UgaW4gcmVsZXZhbnQgZGlyZWN0b3JpZXMgdGhhdCBtYXkgaGF2ZSBiZWVuIGRlbGV0ZWQgb3IgYWRkZWQKUkVUUllfR0xPQl9JTlRFUlZBTCA9IDAuMjUwICMgaW4gc2Vjb25kcyAKIyBJbnRlcnZhbHMgZm9yIC5qb2luKCkgb24gc2V2ZXJhbCB0aHJlYWRzCkZPTExPV01VTFRJX0pPSU5fSU5URVJWQUwgPSAxLjAgICMgaW4gc2Vjb25kcwpGT0xMT1dFUl9KT0lOX0lOVEVSVkFMID0gMS4wICAgICMgaW4gc2Vjb25kcwpUUkFOU1BPUlRfSk9JTl9JTlRFUlZBTCA9IDEuNSAgICMgaW4gc2Vjb25kcwoKY2xhc3MgRG9tYWluKG9iamVjdCk6CgogICAgIiIiIExvZ2VudHJpZXMgZG9tYWlucy4gIiIiCiAgICAjIEdlbmVyYWwgZG9tYWlucwogICAgTUFJTiA9ICdsb2dlbnRyaWVzLmNvbScKICAgIEFQSSA9ICdhcGkubG9nZW50cmllcy5jb20nCiAgICBEQVRBID0gJ2RhdGEubG9nZW50cmllcy5jb20nCiAgICBQVUxMID0gJ3B1bGwubG9nZW50cmllcy5jb20nCiAgICAjIExvY2FsIGRlYnVnZ2luZwogICAgTUFJTl9MT0NBTCA9ICcxMjcuMC4wLjEnCiAgICBBUElfTE9DQUwgPSAnMTI3LjAuMC4xJwogICAgREFUQV9MT0NBTCA9ICcxMjcuMC4wLjEnCiAgICBMT0NBTCA9ICcxMjcuMC4wLjEnCgoKQ09OVEVOVF9MRU5HVEggPSAnY29udGVudC1sZW5ndGgnCgojIExvZyByb290IGRpcmVjdG9yeQpMT0dfUk9PVCA9ICcvdmFyL2xvZycKCiMgVGltZW91dCBhZnRlciBzZXJ2ZXIgY29ubmVjdGlvbiBmYWlsLiBNaWdodCBiZSBhIHRlbXBvcmFyeSBuZXR3b3JrCiMgZmFpbHVyZS4KU1JWX1JFQ09OX1RJTUVPVVQgPSAxMCAgIyBpbiBzZWNvbmRzClNSVl9SRUNPTl9UT19NSU4gPSAxICAgIyBpbiBzZWNvbmRzClNSVl9SRUNPTl9UT19NQVggPSAxMCAgIyBpbiBzZWNvbmRzCgojIFRpbWVvdXQgYWZ0ZXIgaW52YWxpZCBzZXJ2ZXIgcmVzcG9uc2UuIE1pZ2h0IGJlIGEgdmVyc2lvbiBtaXNobWFzaCBvcgojIHRlbXBvcmFyeSBzZXJ2ZXIvbmV0d29yayBmYWlsdXJlCklOVl9TUlZfUkVTUF9USU1FT1VUID0gMzAgICMgU2Vjb25kcwoKIyBUaW1lIGludGVydmFsIGJldHdlZW4gcmUtdHJ5aW5nIHRvIG9wZW4gbG9nIGZpbGUKUkVPUEVOX1RSWV9JTlRFUlZBTCA9IDEgICMgU2Vjb25kcwoKIyBOdW1iZXIgb2YgbGluZXMgd2hpY2ggY2FuIGJlIHNlbnQgaW4gb25lIGJ1Y2ssIHBpZ2d5YmFja2luZwpNQVhfTElORVNfU0VOVCA9IDEwCgojIFRpbWUgaW4gc2Vjb25kcyBzcGVuZCBiZXR3ZWVuIGxvZyByZS1jaGVja3MKVEFJTF9SRUNIRUNLID0gMC4yICAjIFNlY29uZHMKCiMgTnVtYmVyIG9mIGF0dGVtcHMgdG8gcmVhZCBhIGZpbGUsIHVudGlsIHRoZSBuYW1lIGlzIHJlY2hlY2sKTkFNRV9DSEVDSyA9IDQgICMgVEFJTF9SRUNIRUNLIGN5Y2xlcwoKIyBOdW1iZXIgb2YgcmVhZCBsaW5lIGZhbHNlIGF0dGVtcHMgYmV0d2VlbiBhcmUteW91LWFsaXZlIHBhY2tldHMKSUFBX0lOVEVSVkFMID0gMTAwCklBQV9UT0tFTiA9ICIjIyNMRS1JQUEjIyNcbiIKCiMgTWF4aW1hbCBzaXplIG9mIGEgYmxvY2sgb2YgZXZlbnRzCk1BWF9CTE9DS19TSVpFID0gNjU1MzYgLSA1MTIgIyBTcGFjZSBmb3IgZm9ybWF0dGluZwoKIyBJbnRlcnZhbCBiZXR3ZWVuIGF0dGFtcHRzIHRvIG9wZW4gYSBmaWxlClJFT1BFTl9JTlQgPSAxICAjIFNlY29uZHMKCiMgTGludXggYmxvY2sgZGV2aWNlcwpTWVNfQkxPQ0tfREVWID0gJy9zeXMvYmxvY2svJwojIExpbnV4IENQVSBzdGF0IGZpbGUKQ1BVU1RBVFNfRklMRSA9ICcvcHJvYy9zdGF0JwojIExpbnV4IG1tZW9yeSBzdGF0IGZpbGUKTUVNU1RBVFNfRklMRSA9ICcvcHJvYy9tZW1pbmZvJwojIExpbnV4IG5ldHdvcmsgc3RhdCBmaWxlCk5FVFNUQVRTX0ZJTEUgPSAnL3Byb2MvbmV0L2RldicKCiMgTGlzdCBvZiBhY2NlcHRlZCBuZXR3b3JrIGRldmljZXMKTkVUX0RFVklDRVMgPSBbJyAgZXRoJywgJyB3bGFuJywgJ3ZlbmV0JywgJyB2ZXRoJ10KCkVQT0NIID0gNSAgIyBpbiBzZWNvbmRzCgpRVUVVRV9XQUlUX1RJTUUgPSAxICAjIHRpbWUgaW4gc2Vjb25kcyB0byB3YWl0IGZvciByZWFkaW5nIGZyb20gdGhlIHRyYW5zcG9ydCBxdWV1ZSBpZiBpdCBpcyBlbXB0eQoKCiMgRmlsZSBIYW5kbGVyIFBvc2l0aW9ucwpGSUxFX0JFR0lOID0gMApGSUxFX0NVUlJFTlQgPSAxCkZJTEVfRU5EID0gMgoKIyBDb25maWcgcmVzcG9uc2UgcGFyYW1ldGVycwpDT05GX1JFU1BPTlNFID0gJ3Jlc3BvbnNlJwpDT05GX1JFQVNPTiA9ICdyZWFzb24nCkNPTkZfTE9HUyA9ICdsb2dzJwpDT05GX1NFUlZFUlMgPSAnc2VydmVycycKQ09ORl9PSyA9ICdvaycKCiMgU2VydmVyIHJlcXVlc3RzClJRX1dPUktMT0FEID0gJ3B1c2hfd2wnCgojIFJlbGVhc2UgaW5mb3JtYXRpb24gb24gTFNCIHN5c3RlbXMKTFNCX1JFTEVBU0UgPSAnL2V0Yy9sc2ItcmVsZWFzZScKCgojCiMgVXNhZ2UgaGVscAojCgpQVUxMX1VTQUdFID0gInB1bGwgPHBhdGg+IDx3aGVuPiA8ZmlsdGVyPiA8bGltaXQ+IgpQVVNIX1VTQUdFID0gInB1c2ggPGZpbGU+IDxwYXRoPiA8bG9nLXR5cGU+IgpVU0FHRSA9ICJMb2dlbnRyaWVzIGFnZW50IHZlcnNpb24gIiArIF9fdmVyc2lvbl9fICsgIiIiCnVzYWdlOiBsZSBDT01NQU5EIFtBUkdTXQoKV2hlcmUgY29tbWFuZCBpcyBvbmUgb2Y6CiAgaW5pdCAgICAgIFdyaXRlIGxvY2FsIGNvbmZpZ3VyYXRpb24gZmlsZQogIHJlaW5pdCAgICBBcyBpbml0IGJ1dCBkb2VzIG5vdCByZXNldCB1bmRlZmluZWQgcGFyYW1ldGVycwogIHJlZ2lzdGVyICBSZWdpc3RlciB0aGlzIGhvc3QKICAgIC0tbmFtZT0gIG5hbWUgb2YgdGhlIGhvc3QKICAgIC0taG9zdG5hbWU9ICBob3N0bmFtZSBvZiB0aGUgaG9zdAogIHdob2FtaSAgICBEaXNwbGF5cyBzZXR0aW5ncyBmb3IgdGhpcyBob3N0CiAgbW9uaXRvciAgIE1vbml0b3IgdGhpcyBob3N0CiAgZm9sbG93IDxmaWxlbmFtZT4gIEZvbGxvdyB0aGUgZ2l2ZW4gbG9nCiAgICAtLW5hbWU9ICBuYW1lIG9mIHRoZSBsb2cKICAgIC0tdHlwZT0gIHR5cGUgb2YgdGhlIGxvZwogICAgLS1tdWx0aWxvZyBvcHRpb24gdXNlZCB3aXRoIGRpcmVjdG9yeSB3aWxkY2FyZCAqIChyZXN0cmljdGVkIGJlaGF2aW91cikKICBmb2xsb3dlZCA8ZmlsZW5hbWU+ICBDaGVjayBpZiB0aGUgZmlsZSBpcyBmb2xsb3dlZAogIGNsZWFuICAgICBSZW1vdmVzIGNvbmZpZ3VyYXRpb24gZmlsZQogIGxzICAgICAgICBMaXN0IGludGVybmFsIGZpbGVzeXN0ZW0gYW5kIHNldHRpbmdzOiA8cGF0aD4KICBybSAgICAgICAgUmVtb3ZlIGVudGl0eTogPHBhdGg+CiAgcHVsbCAgICAgIFB1bGwgbG9nIGZpbGU6IDxwYXRoPiA8d2hlbj4gPGZpbHRlcj4gPGxpbWl0PgoKV2hlcmUgcGFyYW1ldGVycyBhcmU6CiAgLS1oZWxwICAgICAgICAgICAgICAgICAgc2hvdyB1c2FnZSBoZWxwIGFuZCBleGl0CiAgLS12ZXJzaW9uICAgICAgICAgICAgICAgZGlzcGxheSB2ZXJzaW9uIG51bWJlciBhbmQgZXhpdAogIC0tY29uZmlnPSAgICAgICAgICAgICAgIGxvYWQgc3BlY2lmaWVkIGNvbmZpZ3VyYXRpb24KICAtLWNvbmZpZy5kPSAgICAgICAgICAgICBsb2FkIGNvbmZpZ3VyYXRpb25zIGZyb20gZGlyZWN0b3J5CiAgLS1hY2NvdW50LWtleT0gICAgICAgICAgc2V0IGFjY291bnQga2V5IGFuZCBleGl0CiAgLS1ob3N0LWtleT0gICAgICAgICAgICAgc2V0IGxvY2FsIGhvc3Qga2V5IGFuZCBleGl0LCBnZW5lcmF0ZSBrZXkgaWYga2V5IGlzIGVtcHR5CiAgLS1uby10aW1lc3RhbXBzICAgICAgICAgbm8gdGltZXN0YW1wcyBpbiBhZ2VudCByZXBvcnRpbmdzCiAgLS1mb3JjZSAgICAgICAgICAgICAgICAgZm9yY2UgZ2l2ZW4gb3BlcmF0aW9uCiAgLS1zdXBwcmVzcy1zc2wgICAgICAgICAgZG8gbm90IHVzZSBTU0wgd2l0aCBBUEkgc2VydmVyCiAgLS15ZXMgICAgICAgICAgICAgICAgICAgYWx3YXlzIHJlc3BvbmQgeWVzCiAgLS1kYXRhaHViICAgICAgICAgICAgICAgc2VuZCBsb2dzIHRvIHRoZSBzcGVjaWZpZWQgZGF0YSBodWIgYWRkcmVzcwogICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBmb3JtYXQgaXMgYWRkcmVzczpwb3J0IHdpdGggcG9ydCBiZWluZyBvcHRpb25hbAogIC0tc3lzdGVtLXN0YXQtdG9rZW49ICAgIHNldCB0aGUgdG9rZW4gZm9yIHN5c3RlbSBzdGF0cyBsb2cgKGJldGEpCiAgLS1wdWxsLXNlcnZlci1zaWRlLWNvbmZpZz1GYWxzZSBkbyBub3QgdXNlIHNlcnZlci1zaWRlIGNvbmZpZyBmb3IgZm9sbG93aW5nIGZpbGVzIAoiIiIKCiMgTXVsdGlsb2cgb3B0aW9uIHVzYWdlCk1VTFRJTE9HX1VTQUdFID0gXAoiIiIKVXNhZ2U6CiAgQWdlbnQgaXMgZXhwZWN0aW5nIGEgcGF0aCBuYW1lIGZvciBhIGZpbGUsIHdoaWNoIHNob3VsZCBiZSBiZXR3ZWVuIHNpbmdsZSBxdW90ZXM6CiAgICAgICAgZXhhbXBsZTogXCcvdmFyL2xvZy9kaXJlY3RvcnluYW1lL2ZpbGUubG9nXCcKICBBICogd2lsZGNhcmQgZm9yIGV4cGFuc2lvbiBvZiBkaXJlY3RvcnkgbmFtZSBjYW4gYmUgdXNlZC4gT25seSB0aGUgb25lICogd2lsZGNhcmQgaXMgYWxsb3dlZC4KICBXaWxkY2FyZCBjYW4gbm90IGJlIHVzZWQgZm9yIGV4cGFuc2lvbiBvZiBmaWxlbmFtZSwgYnV0IGZvciBkaXJlY3RvcnkgbmFtZSBvbmx5LgogIFBsYWNlIHBhdGggbmFtZSB3aXRoIHdpbGRjYXJkIGJldHdlZW4gc2luZ2xlIHF1b3RlczoKICAgICAgICBleGFtcGxlOiBcIi92YXIvbG9nL2RpcmVjdG9yeSovZmlsZS5sb2dcIgoiIiIKCmRlZiBwcmludF91c2FnZSh2ZXJzaW9uX29ubHk9RmFsc2UpOgogICAgaWYgdmVyc2lvbl9vbmx5OgogICAgICAgIHJlcG9ydChfX3ZlcnNpb25fXykKICAgIGVsc2U6CiAgICAgICAgcmVwb3J0KFVTQUdFKQoKICAgIHN5cy5leGl0KEVYSVRfSEVMUCkKCgojCiMgTGlicmFyaWVzCiMKCiMgRG8gbm90IHJlbW92ZSAtIGZpeCBmb3IgUHl0aG9uICM4NDg0CnRyeToKICAgIGltcG9ydCBoYXNobGliCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHBhc3MKCmltcG9ydCBzdHJpbmcKaW1wb3J0IHJlCmltcG9ydCBRdWV1ZQppbXBvcnQgcmFuZG9tCmltcG9ydCBDb25maWdQYXJzZXIKaW1wb3J0IGZpbGVpbnB1dAppbXBvcnQgZ2V0b3B0CmltcG9ydCBnbG9iCmltcG9ydCBsb2dnaW5nCmltcG9ydCBvcwppbXBvcnQgb3MucGF0aAppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHNvY2tldAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3RhdAppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCBzeXMKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHVybGxpYgppbXBvcnQgaHR0cGxpYgppbXBvcnQgZ2V0cGFzcwppbXBvcnQgYXRleGl0CmltcG9ydCBsb2dnaW5nLmhhbmRsZXJzCmZyb20gYmFja3BvcnRzIGltcG9ydCBDZXJ0aWZpY2F0ZUVycm9yLCBtYXRjaF9ob3N0bmFtZQoKaW1wb3J0IGZvcm1hdHMKaW1wb3J0IG1ldHJpY3MKaW1wb3J0IHNvY2tzCgojIE9wdGlvbiB0byBhdm9pZCBpc3N1ZXMgYXJvdW5kIGVuY29kaW5ncwojcmVsb2FkKHN5cykKI3N5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoJ3V0ZjgnKQoKCiMgRXhwbGljaXRlbHkgc2V0IHVtYXNrIHRvIGFsbG93IHVzZXIgcncgKyBncm91cCByZWFkCm9zLnVtYXNrKHN0YXQuU19JV0dSUCB8IHN0YXQuU19JUk9USCB8IHN0YXQuU19JV09USCB8IHN0YXQuU19JWE9USCkKCiMKIyBTdGFydCBsb2dnaW5nCiMKCmxvZyA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKExPR19MRV9BR0VOVCkKaWYgbm90IGxvZzoKICAgIHJlcG9ydCgiQ2Fubm90IG9wZW4gbG9nIG91dHB1dCIpCiAgICBzeXMuZXhpdChFWElUX0VSUikKCmxvZy5zZXRMZXZlbChsb2dnaW5nLklORk8pCgpzdHJlYW1faGFuZGxlciA9IGxvZ2dpbmcuU3RyZWFtSGFuZGxlcigpCnN0cmVhbV9oYW5kbGVyLnNldExldmVsKGxvZ2dpbmcuREVCVUcpCnN0cmVhbV9oYW5kbGVyLnNldEZvcm1hdHRlcihsb2dnaW5nLkZvcm1hdHRlcigiJShtZXNzYWdlKXMiKSkKbG9nLmFkZEhhbmRsZXIoc3RyZWFtX2hhbmRsZXIpCgoKZGVmIGRlYnVnX2ZpbHRlcnMobXNnLCAqYXJncyk6CiAgICBpZiBjb25maWcuZGVidWdfZmlsdGVyczoKICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCBtc2cgJSBhcmdzCgpkZWYgZGVidWdfZm9ybWF0dGVycyhtc2csICphcmdzKToKICAgIGlmIGNvbmZpZy5kZWJ1Z19mb3JtYXR0ZXJzOgogICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsIG1zZyAlIGFyZ3MKCiMKIyBJbXBvcnRzIHRoYXQgbWF5IG5vdCBiZSBhdmFpbGFibGUKIwoKdHJ5OgogICAgaW1wb3J0IGpzb24KCiAgICB0cnk6CiAgICAgICAganNvbl9sb2FkcyA9IGpzb24ubG9hZHMKICAgICAgICBqc29uX2R1bXBzID0ganNvbi5kdW1wcwogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIGpzb25fbG9hZHMgPSBqc29uLnJlYWQKICAgICAgICBqc29uX2R1bXBzID0ganNvbi53cml0ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IHNpbXBsZWpzb24KICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBkaWUoJ05PVEU6IFBsZWFzZSBpbnN0YWxsIFB5dGhvbiAic2ltcGxlanNvbiIgcGFja2FnZSAocHl0aG9uLXNpbXBsZWpzb24pIG9yIGEgbmV3ZXIgUHl0aG9uICgyLjYpLicpCiAgICBqc29uX2xvYWRzID0gc2ltcGxlanNvbi5sb2FkcwogICAganNvbl9kdW1wcyA9IHNpbXBsZWpzb24uZHVtcHMKCmNsYXNzIExlZ2FjeVNzbFdyYXBwZXIob2JqZWN0KToKICAgICIiIldyYXBwZXIgYXJvdW5kIGxlZ2FjeSBTU0wgc3VwcG9ydCBpbiBQeXRob24gMi40LiBXZSBtaW1pYyBjZXJ0YWluCiAgICBzb2NrZXQncyBmdW5jdGlvbnMuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNvY2spOgogICAgICAgIHNlbGYuX3NvY2tldCA9IHNvY2tldC5zc2woc29jaykKCiAgICBkZWYgc2VuZChzZWxmLCBkYXRhKToKICAgICAgICBzZWxmLl9zb2NrZXQud3JpdGUoZGF0YSkKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi5fc29ja2V0LmNsb3NlKCkKCm5vX3NzbCA9IEZhbHNlCkZFQVRfU1NMID0gVHJ1ZQp0cnk6CiAgICBpbXBvcnQgc3NsCgogICAgd3JhcF9zb2NrZXQgPSBzc2wud3JhcF9zb2NrZXQKICAgIENFUlRfUkVRVUlSRUQgPSBzc2wuQ0VSVF9SRVFVSVJFRAoKZXhjZXB0IEltcG9ydEVycm9yOgogICAgbm9fc3NsID0gVHJ1ZQogICAgRkVBVF9TU0wgPSBGYWxzZQoKICAgIHRyeToKICAgICAgICBfID0gaHR0cGxpYi5IVFRQU0Nvbm5lY3Rpb24KICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICBkaWUoJ05PVEU6IFBsZWFzZSBpbnN0YWxsIFB5dGhvbiAic3NsIiBtb2R1bGUuJykKCiAgICBkZWYgd3JhcF9zb2NrZXQoc29jaywgY2FfY2VydHM9Tm9uZSwgY2VydF9yZXFzPU5vbmUpOgogICAgICAgIHJldHVybiBMZWdhY3lTc2xXcmFwcGVyKHNvY2spCgogICAgQ0VSVF9SRVFVSVJFRCA9IDAKCiMKIyBDdXN0b20gcHJvY3RpdGxlCiMKCgojCiMgVXNlci1kZWZpbmVkIGZpbHRlcmluZyBjb2RlCiMKCmRlZiBmaWx0ZXJfZXZlbnRzKGV2ZW50cyk6CiAgICAiIiIKICAgIFVzZXItZGVmaW5lZCBmaWx0ZXJpbmcgY29kZS4gRXZlbnRzIHBhc3NlZCBhcmUgYWJvdXQgdG8gYmUgc2VudCB0bwogICAgbG9nZW50cmllcyBzZXJ2ZXIuIE1ha2UgdGhlIHJlcXVpcmVkIG1vZGlmaWNhdGlvbnMgdG8gdGhlIGV2ZW50cyBzdWNoCiAgICBhcyByZW1vdmluZyB1bndhbnRlZCBvciBzZW5zaXRpdmUgaW5mb3JtYXRpb24uCiAgICAiIiIKICAgICMgQnkgZGVmYXVsdCwgdGhpcyBtZXRob2QgaXMgZW1wdHkKICAgIHJldHVybiBldmVudHMKCgpkZWYgZGVmYXVsdF9maWx0ZXJfZmlsZW5hbWVzKGZpbGVuYW1lKToKICAgICIiIgogICAgQnkgZGVmYXVsdCB3ZSBhbGxvdyB0byBmb2xsb3cgYW55IGZpbGVzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlndXJhdGlvbi4KICAgICIiIgogICAgcmV0dXJuIFRydWUKCmRlZiBmb3JtYXRfZW50cmllcyhkZWZhdWx0X2Zvcm1hdHRlciwgZW50cmllcyk6CiAgICAiIiIKICAgIFVzZXItZGVmaW5lZCBmb3JtYXR0ZXJpbmcgY29kZS4gRXZlbnRzIHBhc3NlZCBhcmUgYWJvdXQgdG8gYmUgc2VudCB0bwogICAgbG9nZW50cmllcyBzZXJ2ZXIuIE1ha2UgdGhlIHJlcXVpcmVkIG1vZGlmaWNhdGlvbnMgdG8gcHJvdmlkZSBjb3JyZWN0IGZvcm1hdC4KICAgICIiIgogICAgIyBCeSBkZWZhdWx0LCB0aGlzIG1ldGhvZCBpcyBlbXB0eQogICAgcmV0dXJuIGRlZmF1bHRfZm9ybWF0dGVyLmZvcm1hdF9saW5lKGVudHJpZXMpCgoKZGVmIGNhbGwoY29tbWFuZCk6CiAgICAiIiIKICAgIENhbGxzIHRoZSBnaXZlbiBjb21tYW5kIGluIE9TIGVudmlyb25tZW50LgogICAgIiIiCiAgICBvdXRwdXQgPSBzdWJwcm9jZXNzLlBvcGVuKAogICAgICAgIGNvbW1hbmQsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHNoZWxsPVRydWUpLnN0ZG91dC5yZWFkKCkKICAgIGlmIGxlbihvdXRwdXQpID09IDA6CiAgICAgICAgcmV0dXJuICcnCiAgICBpZiBvdXRwdXRbLTFdID09ICdcbic6CiAgICAgICAgb3V0cHV0ID0gb3V0cHV0WzotMV0KICAgIHJldHVybiBvdXRwdXQKCgpkZWYgdW5pcShhcnIpOgogICAgIiIiCiAgICBSZXR1cm5zIHRoZSBsaXN0IHdpdGggZHVwbGljYXRlIGVsZW1lbnRzIHJlbW92ZWQuCiAgICAiIiIKICAgIHJldHVybiBsaXN0KHNldChhcnIpKQoKCmRlZiBfbG9ja19waWRfZmlsZV9uYW1lKCk6CiAgICAiIiIKICAgIFJldHVybnMgcGF0aCB0byBhIGZpbGUgZm9yIHByb3RlY3RpbmcgY3JpdGljYWwgc2VjdGlvbgogICAgZm9yIGRhZW1vbml6aW5nIChzZWUgZGFlbW9uaXplKCkgKQogICAgIiIiCiAgICByZXR1cm4gY29uZmlnLnBpZF9maWxlICsgJy5sb2NrJwoKCmRlZiBfbG9ja19waWQoKToKICAgICIiIgogICAgVHJpZXMgdG8gZXhjbHVzaXZlbHkgb3BlbiBmaWxlIGZvciBwcm90ZWN0aW5nIG9mIGNyaXRpY2FsIHNlY3Rpb24KICAgIGZvciBkYWVtb25pemluZy4KICAgICIiIgogICAgZmlsZV9uYW1lID0gX2xvY2tfcGlkX2ZpbGVfbmFtZSgpCiAgICB0cnk6CiAgICAgICAgZmQgPSBvcy5vcGVuKGZpbGVfbmFtZSwgb3MuT19XUk9OTFkgfCBvcy5PX0NSRUFUIHwgb3MuT19FWENMKQogICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGlmIGZkID09IC0xOgogICAgICAgIHJldHVybiBOb25lCiAgICBvcy5jbG9zZShmZCkKICAgIHJldHVybiBUcnVlCgoKZGVmIF91bmxvY2tfcGlkKCk6CiAgICAiIiIKICAgIFJlbGVhc2VzIGZpbGUgZm9yIHByb3RlY3Rpbmcgb2YgY3JpdGljYWwgc2VjdGlvbiBmb3IgZGFlbW9uaXppbmcuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBmaWxlX25hbWUgPSBfbG9ja19waWRfZmlsZV9uYW1lKCkKICAgICAgICBvcy5yZW1vdmUoZmlsZV9uYW1lKQogICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgcGFzcwoKCmRlZiBfdHJ5X2RhZW1vbml6ZSgpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgZGFlbW9uIGZyb20gdGhlIGN1cnJlbnQgcHJvY2Vzcy4KICAgIGh0dHA6Ly93d3cuamVqaWsuY29tL2FydGljbGVzLzIwMDcvMDIvYV9zaW1wbGVfdW5peF9saW51eF9kYWVtb25faW5fcHl0aG9uLwogICAgQWx0ZXJuYXRpdmU6IHB5dGhvbi1kYWVtb24KICAgICIiIgoKICAgIHRyeToKICAgICAgICBwaWRmaWxlID0gZmlsZShjb25maWcucGlkX2ZpbGUsICdyJykKICAgICAgICBwaWQgPSBpbnQocGlkZmlsZS5yZWFkKCkuc3RyaXAoKSkKICAgICAgICBwaWRmaWxlLmNsb3NlKCkKICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgIHBpZCA9IE5vbmUKICAgIGlmIHBpZDoKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoJy9wcm9jJykgb3Igb3MucGF0aC5leGlzdHMoIi9wcm9jLyVkL3N0YXR1cyIgJSBwaWQpOgogICAgICAgICAgICByZXR1cm4gIlBpZGZpbGUgJXMgYWxyZWFkeSBleGlzdC4gRGFlbW9uIGFscmVhZHkgcnVubmluZz8iICUgY29uZmlnLnBpZF9maWxlCgogICAgdHJ5OgogICAgICAgICMgT3BlbiBwaWQgZmlsZQogICAgICAgIGlmIGNvbmZpZy5waWRfZmlsZToKICAgICAgICAgICAgZmlsZShjb25maWcucGlkX2ZpbGUsICd3JykuY2xvc2UoKQoKICAgICAgICBwaWQgPSBvcy5mb3JrKCkKICAgICAgICBpZiBwaWQgPiAwOgogICAgICAgICAgICBzeXMuZXhpdChFWElUX09LKQogICAgICAgIG9zLmNoZGlyKCIvIikKICAgICAgICBvcy5zZXRzaWQoKQogICAgICAgIG9zLnVtYXNrKDApCiAgICAgICAgcGlkID0gb3MuZm9yaygpCiAgICAgICAgaWYgcGlkID4gMDoKICAgICAgICAgICAgc3lzLmV4aXQoRVhJVF9PSykKICAgICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKICAgICAgICBzeXMuc3RkZXJyLmZsdXNoKCkKICAgICAgICBzaSA9IGZpbGUoJy9kZXYvbnVsbCcsICdyJykKICAgICAgICBzbyA9IGZpbGUoJy9kZXYvbnVsbCcsICdhKycpCiAgICAgICAgc2UgPSBmaWxlKCcvZGV2L251bGwnLCAnYSsnLCAwKQogICAgICAgIG9zLmR1cDIoc2kuZmlsZW5vKCksIHN5cy5zdGRpbi5maWxlbm8oKSkKICAgICAgICBvcy5kdXAyKHNvLmZpbGVubygpLCBzeXMuc3Rkb3V0LmZpbGVubygpKQogICAgICAgIG9zLmR1cDIoc2UuZmlsZW5vKCksIHN5cy5zdGRlcnIuZmlsZW5vKCkpCgogICAgICAgICMgV3JpdGUgcGlkIGZpbGUKICAgICAgICBpZiBjb25maWcucGlkX2ZpbGU6CiAgICAgICAgICAgIHBpZCA9IHN0cihvcy5nZXRwaWQoKSkKICAgICAgICAgICAgcGlkZmlsZSA9IGZpbGUoY29uZmlnLnBpZF9maWxlLCAndycpCiAgICAgICAgICAgIGF0ZXhpdC5yZWdpc3RlcihybV9waWRmaWxlKQogICAgICAgICAgICBwaWRmaWxlLndyaXRlKCIlc1xuIiAlIHBpZCkKICAgICAgICAgICAgcGlkZmlsZS5jbG9zZSgpCiAgICBleGNlcHQgT1NFcnJvciwgZToKICAgICAgICBybV9waWRmaWxlKGNvbmZpZykKICAgICAgICByZXR1cm4gIkNhbm5vdCBkYWVtb25pemU6ICVzIiAlIGUuc3RyZXJyb3IKICAgIHJldHVybiBOb25lCgoKZGVmIGRhZW1vbml6ZSgpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgZGFlbW9uIGZyb20gdGhlIGN1cnJlbnQgcHJvY2Vzcy4KCiAgICBJdCB1c2VzIGhlbHBlciBmaWxlIGFzIGEgbG9jayBhbmQgdGhlbiBjaGVja3MgaW5zaWRlIGNyaXRpY2FsIHNlY3Rpb24KICAgIHdoZXRoZXIgcGlkIGZpbGUgY29udGFpbnMgcGlkIG9mIGEgdmFsaWQgcHJvY2Vzcy4KICAgIElmIG5vdCB0aGVuIGl0IGRhZW1vbml6ZXMgaXRzZWxmLCBvdGhlcndpc2UgaXQgZGllcy4KICAgICIiIgogICAgaWYgbm90IF9sb2NrX3BpZCgpOgogICAgICAgIGRpZSgiRGFlbW9uIGFscmVhZHkgcnVubmluZy4gSWYgeW91IGFyZSBzdXJlIGl0IGlzbid0IHBsZWFzZSByZW1vdmUgJXMiICUKICAgICAgICAgICAgX2xvY2tfcGlkX2ZpbGVfbmFtZSgpKQogICAgZXJyID0gX3RyeV9kYWVtb25pemUoKQogICAgX3VubG9ja19waWQoKQogICAgaWYgZXJyOgogICAgICAgIGRpZSgiJXMiICUgZXJyKQoKICAgICMgU2V0dGluZyB0aGUgcHJvY3RpdGxlCiAgICBzZXRfcHJvY190aXRsZSgnbG9nZW50cmllcy1kYWVtb24nKQoKICAgICMgTG9nZ2luZyBmb3IgZGFlbW9uIG1vZGUKICAgIGxvZy5yZW1vdmVIYW5kbGVyKHN0cmVhbV9oYW5kbGVyKQogICAgc2hhbmRsZXIgPSBsb2dnaW5nLlN0cmVhbUhhbmRsZXIoKQogICAgc2hhbmRsZXIuc2V0TGV2ZWwobG9nZ2luZy5ERUJVRykKICAgIHNoYW5kbGVyLnNldEZvcm1hdHRlcihsb2dnaW5nLkZvcm1hdHRlcigiJShhc2N0aW1lKXMgICUobWVzc2FnZSlzIikpCiAgICBsb2cuYWRkSGFuZGxlcihzaGFuZGxlcikKCgpkZWYgcHJpbnRfdG90YWwoZWxlbXMsIG5hbWUpOgogICAgIiIiCiAgICBQcmludHMgdG90YWwgbnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBsaXN0CiAgICAiIiIKICAgIHRvdGFsID0gbGVuKGVsZW1zKQogICAgaWYgdG90YWwgPT0gMDoKICAgICAgICByZXBvcnQoIm5vICVzcyIgJSBuYW1lKQogICAgZWxpZiB0b3RhbCA9PSAxOgogICAgICAgIHJlcG9ydCgiMSAiICsgbmFtZSkKICAgIGVsc2U6CiAgICAgICAgcmVwb3J0KCIlZCAlc3MiICUgKHRvdGFsLCBuYW1lKSkKCgpkZWYgY29sbGVjdF9sb2dfbmFtZXMoc3lzdGVtX2luZm8pOgogICAgIiIiCiAgICBDb2xsZWN0cyBzdGFuZGFyZCBsb2NhbCBsb2dzIGFuZCBpZGVudGlmaWVzIHRoZW0uCiAgICAiIiIKICAgIGxvZ3MgPSBbXQogICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsoTE9HX1JPT1QpOgogICAgICAgIGZvciBuYW1lIGluIGZpbGVzOgogICAgICAgICAgICBpZiBuYW1lWy0zOl0gIT0gJy5neicgYW5kIHJlLm1hdGNoKHInLipcLlxkKyQnLCBuYW1lKSBpcyBOb25lOgogICAgICAgICAgICAgICAgbG9ncy5hcHBlbmQob3MucGF0aC5qb2luKHJvb3QsIG5hbWUpKQoKICAgIGxvZy5kZWJ1ZygiQ29sbGVjdGVkIGxvZ3M6ICVzIiwgbG9ncykKICAgIHRyeToKICAgICAgICBjID0gaHR0cGxpYi5IVFRQU0Nvbm5lY3Rpb24oTEVfU0VSVkVSX0FQSSkKICAgICAgICByZXF1ZXN0ID0gewogICAgICAgICAgICAnbG9ncyc6IGpzb25fZHVtcHMobG9ncyksCiAgICAgICAgICAgICdkaXN0bmFtZSc6IHN5c3RlbV9pbmZvWydkaXN0bmFtZSddLAogICAgICAgICAgICAnZGlzdHZlcic6IHN5c3RlbV9pbmZvWydkaXN0dmVyJ10KICAgICAgICB9CiAgICAgICAgbG9nLmRlYnVnKCJSZXF1ZXN0aW5nICVzIiwgcmVxdWVzdCkKICAgICAgICBjLnJlcXVlc3QoJ3Bvc3QnLCBJRF9MT0dTX0FQSSwgdXJsbGliLnVybGVuY29kZShyZXF1ZXN0KSwge30pCiAgICAgICAgcmVzcG9uc2UgPSBjLmdldHJlc3BvbnNlKCkKICAgICAgICBpZiBub3QgcmVzcG9uc2Ugb3IgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMDoKICAgICAgICAgICAgZGllKCdFcnJvcjogVW5leHBlY3RlZCByZXNwb25zZSBmcm9tIGxvZ2VudHJpZXMgKCVzKS4nICUKICAgICAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cykKICAgICAgICBkYXRhID0ganNvbl9sb2FkcyhyZXNwb25zZS5yZWFkKCkpCiAgICAgICAgbG9nX2RhdGEgPSBkYXRhWydsb2dzJ10KCiAgICAgICAgbG9nLmRlYnVnKCJJZGVudGlmaWVkIGxvZ3M6ICVzIiwgbG9nX2RhdGEpCiAgICBleGNlcHQgc29ja2V0LmVycm9yLCBtc2c6CiAgICAgICAgZGllKCdFcnJvcjogQ2Fubm90IGNvbnRhY3Qgc2VydmVyLCAlcycgJSBtc2cpCiAgICBleGNlcHQgVmFsdWVFcnJvciwgbXNnOgogICAgICAgIGRpZSgnRXJyb3I6IEludmFsaWQgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIChQYXJzaW5nIGVycm9yICVzKScgJSBtc2cpCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgZGllKCdFcnJvcjogSW52YWxpZCByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIsIGxvZyBkYXRhIG5vdCBwcmVzZW50LicpCgogICAgcmV0dXJuIGxvZ19kYXRhCgoKZGVmIGxzYl9yZWxlYXNlKHN5c3RlbV9pbmZvKToKICAgICMgR2VuZXJhbCBMU0Igc3lzdGVtCiAgICBpZiBvcy5wYXRoLmlzZmlsZShMU0JfUkVMRUFTRSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmaWVsZHMgPSBkaWN0KChhLnNwbGl0KCc9JykgZm9yIGEgaW4gcmZpbGUoTFNCX1JFTEVBU0UpLnNwbGl0KCdcbicpIGlmIGxlbihhLnNwbGl0KCc9JykpID09IDIpKQogICAgICAgICAgICBzeXN0ZW1faW5mb1snZGlzdG5hbWUnXSA9IGZpZWxkc1snRElTVFJJQl9JRCddCiAgICAgICAgICAgIHN5c3RlbV9pbmZvWydkaXN0dmVyJ10gPSBmaWVsZHNbJ0RJU1RSSUJfUkVMRUFTRSddCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICAjIEluZm9ybWF0aW9uIG5vdCBmb3VuZAogICAgcmV0dXJuIEZhbHNlCgoKZGVmIHJlbGVhc2VfdGVzdChmaWxlbmFtZSwgZGlzdG5hbWUsIHN5c3RlbV9pbmZvKToKICAgIGlmIG9zLnBhdGguaXNmaWxlKGZpbGVuYW1lKToKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdG5hbWUnXSA9IGRpc3RuYW1lCiAgICAgICAgc3lzdGVtX2luZm9bJ2Rpc3R2ZXInXSA9IHJmaWxlKGZpbGVuYW1lKQogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgc3lzdGVtX2RldGVjdChkZXRhaWxzKToKICAgICIiIgogICAgRGV0ZWN0cyB0aGUgY3VycmVudCBvcGVyYXRpbmcgc3lzdGVtLiBSZXR1cm5lZCBpbmZvcm1hdGlvbiBjb250YWluczoKICAgICAgICBkaXN0bmFtZTogZGlzdHJpYnV0aW9uIG5hbWUKICAgICAgICBkaXN0dmVyOiBkaXN0cmlidXRpb24gdmVyc2lvbgogICAgICAgIGtlcm5lbDoga2VybmVsIHR5cGUKICAgICAgICBzeXN0ZW06IHN5c3RlbSBuYW1lCiAgICAgICAgaG9zdG5hbWU6IGhvc3QgbmFtZQogICAgIiIiCiAgICB1bmFtZSA9IHBsYXRmb3JtLnVuYW1lKCkKICAgIHN5cyA9IHVuYW1lWzBdCiAgICBzeXN0ZW1faW5mbyA9IGRpY3Qoc3lzdGVtPXN5cywgaG9zdG5hbWU9c29ja2V0LmdldGZxZG4oKSwKICAgICAgICAgICAgICAgICAgICAgICBrZXJuZWw9JycsIGRpc3RuYW1lPScnLCBkaXN0dmVyPScnKQoKICAgIGlmIG5vdCBkZXRhaWxzOgogICAgICAgIHJldHVybiBzeXN0ZW1faW5mbwoKICAgIGlmIHN5cyA9PSAiU3VuT1MiOgogICAgICAgIHN5c3RlbV9pbmZvWydkaXN0bmFtZSddID0gY2FsbCgnY2F0IC9ldGMvcHJvZHVjdCB8IHNlZCAtbiAicy9OYW1lOiBcXCguKlxcKS9cXDEvcCInKQogICAgICAgIHN5c3RlbV9pbmZvWydkaXN0dmVyJ10gPSBjYWxsKCdjYXQgL2V0Yy9wcm9kdWN0IHwgc2VkIC1uICJzL0ltYWdlOiBcXCguKlxcKS9cXDEvcCInKQogICAgICAgIHN5c3RlbV9pbmZvWydrZXJuZWwnXSA9IHVuYW1lWzJdCiAgICBlbGlmIHN5cyA9PSAiQUlYIjoKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdHZlciddID0gY2FsbCgib3NsZXZlbCAtciIpCiAgICBlbGlmIHN5cyA9PSAiRGFyd2luIjoKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdG5hbWUnXSA9IGNhbGwoInN3X3ZlcnMgLXByb2R1Y3ROYW1lIikKICAgICAgICBzeXN0ZW1faW5mb1snZGlzdHZlciddID0gY2FsbCgic3dfdmVycyAtcHJvZHVjdFZlcnNpb24iKQogICAgICAgIHN5c3RlbV9pbmZvWydrZXJuZWwnXSA9IHVuYW1lWzJdCgogICAgZWxpZiBzeXMgPT0gIkxpbnV4IjoKICAgICAgICBzeXN0ZW1faW5mb1sna2VybmVsJ10gPSB1bmFtZVsyXQogICAgICAgICMgWFhYIENlbnRPUz8KICAgICAgICByZWxlYXNlcyA9IFsKICAgICAgICAgICAgWycvZXRjL2RlYmlhbl92ZXJzaW9uJywgJ0RlYmlhbiddLAogICAgICAgICAgICBbJy9ldGMvVW5pdGVkTGludXgtcmVsZWFzZScsICdVbml0ZWQgTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2FubnZpeC1yZWxlYXNlJywgJ0FubnZpeCddLAogICAgICAgICAgICBbJy9ldGMvYXJjaC1yZWxlYXNlJywgJ0FyY2ggTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2Fya2xpbnV4LXJlbGVhc2UnLCAnQXJrbGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2F1cm94LXJlbGVhc2UnLCAnQXVyb3ggTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL2JsYWNrY2F0LXJlbGVhc2UnLCAnQmxhY2tDYXQnXSwKICAgICAgICAgICAgWycvZXRjL2NvYmFsdC1yZWxlYXNlJywgJ0NvYmFsdCddLAogICAgICAgICAgICBbJy9ldGMvY29uZWN0aXZhLXJlbGVhc2UnLCAnQ29uZWN0aXZhJ10sCiAgICAgICAgICAgIFsnL2V0Yy9mZWRvcmEtcmVsZWFzZScsICdGZWRvcmEgQ29yZSddLAogICAgICAgICAgICBbJy9ldGMvZ2VudG9vLXJlbGVhc2UnLCAnR2VudG9vIExpbnV4J10sCiAgICAgICAgICAgIFsnL2V0Yy9pbW11bml4LXJlbGVhc2UnLCAnSW1tdW5peCddLAogICAgICAgICAgICBbJy9ldGMva25vcHBpeF92ZXJzaW9uJywgJ0tub3BwaXgnXSwKICAgICAgICAgICAgWycvZXRjL2xmcy1yZWxlYXNlJywgJ0xpbnV4LUZyb20tU2NyYXRjaCddLAogICAgICAgICAgICBbJy9ldGMvbGludXhwcGMtcmVsZWFzZScsICdMaW51eC1QUEMnXSwKICAgICAgICAgICAgWycvZXRjL21hbmRyaXZhLXJlbGVhc2UnLCAnTWFuZHJpdmEgTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL21hbmRyYWtlLXJlbGVhc2UnLCAnTWFuZHJha2UgTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL21hbmRha2VsaW51eC1yZWxlYXNlJywgJ01hbmRyYWtlIExpbnV4J10sCiAgICAgICAgICAgIFsnL2V0Yy9ta2xpbnV4LXJlbGVhc2UnLCAnTWtMaW51eCddLAogICAgICAgICAgICBbJy9ldGMvbmxkLXJlbGVhc2UnLCAnTm92ZWxsIExpbnV4IERlc2t0b3AnXSwKICAgICAgICAgICAgWycvZXRjL3BsZC1yZWxlYXNlJywgJ1BMRCBMaW51eCddLAogICAgICAgICAgICBbJy9ldGMvcmVkaGF0LXJlbGVhc2UnLCAnUmVkIEhhdCddLAogICAgICAgICAgICBbJy9ldGMvc2xhY2t3YXJlLXZlcnNpb24nLCAnU2xhY2t3YXJlJ10sCiAgICAgICAgICAgIFsnL2V0Yy9lLXNtaXRoLXJlbGVhc2UnLCAnU01FIFNlcnZlciddLAogICAgICAgICAgICBbJy9ldGMvcmVsZWFzZScsICdTb2xhcmlzIFNQQVJDJ10sCiAgICAgICAgICAgIFsnL2V0Yy9zdW4tcmVsZWFzZScsICdTdW4gSkRTJ10sCiAgICAgICAgICAgIFsnL2V0Yy9TdVNFLXJlbGVhc2UnLCAnU3VTRSddLAogICAgICAgICAgICBbJy9ldGMvc2xlcy1yZWxlYXNlJywgJ1N1U0UgTGludXggRVM5J10sCiAgICAgICAgICAgIFsnL2V0Yy90aW55c29mYS1yZWxlYXNlJywgJ1RpbnkgU29mYSddLAogICAgICAgICAgICBbJy9ldGMvdHVyYm9saW51eC1yZWxlYXNlJywgJ1R1cmJvTGludXgnXSwKICAgICAgICAgICAgWycvZXRjL3VsdHJhcGVuZ3Vpbi1yZWxlYXNlJywgJ1VsdHJhUGVuZ3VpbiddLAogICAgICAgICAgICBbJy9ldGMvdmEtcmVsZWFzZScsICdWQS1MaW51eC9SSC1WQUxFJ10sCiAgICAgICAgICAgIFsnL2V0Yy95ZWxsb3dkb2ctcmVsZWFzZScsICdZZWxsb3cgRG9nJ10sCiAgICAgICAgXQoKICAgICAgICAjIENoZWNrIGZvciBrbm93biBzeXN0ZW0gSURzCiAgICAgICAgZm9yIHJlbGVhc2UgaW4gcmVsZWFzZXM6CiAgICAgICAgICAgIGlmIHJlbGVhc2VfdGVzdChyZWxlYXNlWzBdLCByZWxlYXNlWzFdLCBzeXN0ZW1faW5mbyk6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICMgQ2hlY2sgZm9yIGdlbmVyYWwgTFNCIHN5c3RlbQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKExTQl9SRUxFQVNFKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZmllbGRzID0gZGljdCgoYS5zcGxpdCgnPScpIGZvciBhIGluIHJmaWxlKExTQl9SRUxFQVNFKS5zcGxpdCgnXG4nKSBpZiBsZW4oYS5zcGxpdCgnPScpKSA9PSAyKSkKICAgICAgICAgICAgICAgIHN5c3RlbV9pbmZvWydkaXN0bmFtZSddID0gZmllbGRzWydESVNUUklCX0lEJ10KICAgICAgICAgICAgICAgIHN5c3RlbV9pbmZvWydkaXN0dmVyJ10gPSBmaWVsZHNbJ0RJU1RSSUJfUkVMRUFTRSddCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBwYXNzCiAgICByZXR1cm4gc3lzdGVtX2luZm8KCgojIElkZW50aWZpZWQgcmFuZ2VzCgpTRUMgPSAxMDAwCk1JTiA9IDYwICogU0VDCkhPVVIgPSA2MCAqIE1JTgpEQVkgPSAyNCAqIEhPVVIKTU9OID0gMzEgKiBEQVkKWUVBUiA9IDM2NSAqIERBWQoKCmRlZiBkYXRlX3BhdHRlcm5zKCk6CiAgICAiIiIgR2VuZXJhdGVzIGRhdGUgcGF0dGVybnMgb2YgdGhlIGZvcm0gW2RheTwtPm1vbnRoIHllYXI/XS4KICAgICIiIgogICAgZm9yIHllYXIgaW4gWycgJVknLCAnICV5J106CiAgICAgICAgZm9yIG1vbiBpbiBbJyViJywgJyVCJywgJyVtJ106CiAgICAgICAgICAgIHlpZWxkIFsnJSVkICVzJXMnICUgKG1vbiwgeWVhciksIERBWSwgW11dCiAgICAgICAgICAgIHlpZWxkIFsnJXMgJSVkJXMnICUgKG1vbiwgeWVhciksIERBWSwgW11dCiAgICBmb3IgbW9uIGluIFsnJWInLCAnJUInXTogICMgWWVhciBlbXB0eQogICAgICAgIHlpZWxkIFsnJSVkICVzJyAlIChtb24pLCBEQVksIFtZRUFSXV0KICAgICAgICB5aWVsZCBbJyVzICUlZCcgJSAobW9uKSwgREFZLCBbWUVBUl1dCiAgICB5aWVsZCBbJyUlWSAlJWQgJXMnICUgKG1vbiksIERBWSwgW11dCiAgICB5aWVsZCBbJyUlWSAlcyAlJWQnICUgKG1vbiksIERBWSwgW11dCiAgICB5aWVsZCBbJyVZICVtICVkJywgREFZLCBbXV0KCgpkZWYgdGltZV9wYXR0ZXJucyhjX2NvbHMpOgogICAgIiIiR2VuZXJhdGVzIHRpbWUgcGF0dGVybnMgb2YgdGhlIGZvcm0gW2hvdXI6bWluOnNlYz9dIGluY2x1ZGluZyBlbXB0eQogICAgdGltZS4KICAgICIiIgogICAgaWYgY19jb2xzID49IDI6CiAgICAgICAgeWllbGQgWyclSDolTTolUycsIFNFQywgW11dCiAgICBpZiBjX2NvbHMgPj0gMToKICAgICAgICB5aWVsZCBbJyVIOiVNJywgTUlOLCBbXV0KICAgICAgICB5aWVsZCBbJyVJOiVNJXAnLCBNSU4sIFtdXQogICAgeWllbGQgWyclSSVwJywgSE9VUiwgW11dCgoKZGVmIGRhdGV0aW1lX3BhdHRlcm5zKGNfY29scyk6CiAgICAiIiJHZW5lcmF0ZXMgY29tYmluYXRpb25zIG9mIGRhdGUgYW5kIHRpbWUgcGF0dGVybnMuCiAgICAiIiIKICAgICMgR2VuZXJhdGUgZGF0ZXMgb25seQogICAgZm9yIGRhdGVfcGF0dGVybiBpbiBkYXRlX3BhdHRlcm5zKCk6CiAgICAgICAgeWllbGQgZGF0ZV9wYXR0ZXJuCgogICAgIyBHZW5lcmF0ZSBjb21iaW5hdGlvbnMKICAgIGZvciB0IGluIHRpbWVfcGF0dGVybnMoY19jb2xzKToKICAgICAgICBmb3IgZCBpbiBkYXRlX3BhdHRlcm5zKCk6CiAgICAgICAgICAgIHlpZWxkIFsnJXMgJXMnICUgKGRbMF0sIHRbMF0pLCB0WzFdLCBkWzJdXQogICAgICAgICAgICB5aWVsZCBbJyVzICVzJyAlICh0WzBdLCBkWzBdKSwgdFsxXSwgZFsyXV0KICAgICAgICB5aWVsZCBbdFswXSwgdFsxXSwgW1lFQVIsIE1PTiwgREFZXV0KCgpkZWYgdGltZXN0YW1wX3BhdHRlcm5zKHNhbXBsZSk6CiAgICAiIiJHZW5lcmF0ZXMgYWxsIHRpbWVzdGFtcCBwYXR0ZXJucyB3ZSBjYW4gaGFuZGxlLiBJdCBpcyBjb25zdHJ1Y3RlZCBieQogICAgZ2VuZXJhdGluZyBhbGwgcG9zc2libGUgY29tYmluYXRpb25zIG9mIGRhdGUsIHRpbWUsIGRheSBuYW1lIGFuZCB6b25lLiBUaGUKICAgIHBhdHRlcm4gaXMgW2RheV9uYW1lPyBkYXRlPC0+dGltZSB6b25lP10gcGx1cyBzaW1wbGUgZGF0ZSBhbmQgdGltZS4KICAgICIiIgogICAgIyBBbGwgdGltZXN0YW1wcyB2YXJpYXRpb25zCiAgICBkYXlfbmFtZSA9ICcnCiAgICBpZiBsZW4oc2FtcGxlKSA+IDA6CiAgICAgICAgaWYgc2FtcGxlWzBdIGluIHN0cmluZy5hc2NpaV9sZXR0ZXJzOgogICAgICAgICAgICBkYXlfbmFtZSA9ICclYSAnCiAgICBjX2NvbHMgPSBzYW1wbGUuY291bnQoJzonKQogICAgZm9yIHpvbmUgaW4gWycnLCAnICVaJywgJyAleiddOgogICAgICAgIGZvciBkdCBpbiBkYXRldGltZV9wYXR0ZXJucyhjX2NvbHMpOgogICAgICAgICAgICB5aWVsZCBbJyVzJXMlcycgJSAoZGF5X25hbWUsIGR0WzBdLCB6b25lKSwgZHRbMV0sIGR0WzJdXQoKCmRlZiB0aW1lc3RhbXBfZ3JvdXAodGV4dCk6CiAgICAiIiJSZXR1cm5zIGEgdHVwbGUgW3RpbWVzdGFtcCwgcmFuZ2VdIHdoaWNoIGNvcnJlc3BvbmRzIHRvIHRoZSBkYXRlIGFuZAogICAgdGltZSBnaXZlbi4gRXhpc3RzIG9uIHBhcnNlIGVycm9yLgogICAgIiIiCiAgICB0aW1lcCA9IHJlLnN1YihyJyArJywgJyAnLCByZS5zdWIocidbLSwuL10nLCAnICcsIHRleHQpKS5zdHJpcCgpCiAgICBzdGFydF90dXBsZSA9IE5vbmUKICAgIGZvciBwIGluIHRpbWVzdGFtcF9wYXR0ZXJucyh0aW1lcCk6CiAgICAgICAgcGF0dGVybiwgcmVzb2x1dGlvbiwgZmlsbGluZyA9IHAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3R1cGxlID0gdGltZS5zdHJwdGltZSh0aW1lcCwgcFswXSkKICAgICAgICAgICAgYnJlYWsKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgaWYgbm90IHN0YXJ0X3R1cGxlOgogICAgICAgIGRpZSgiRXJyb3I6IERhdGUgJyVzJyBub3QgcmVjb2duaXplZCIgJSB0ZXh0KQoKICAgIHRvZGF5ID0gZGF0ZXRpbWUuZGF0ZS50b2RheSgpCiAgICAjIENvbXBsZXRlIGZpbGxpbmcKICAgIGlmIFlFQVIgaW4gZmlsbGluZzoKICAgICAgICBzdGFydF90dXBsZS5ybV95ZWFyID0gdG9kYXkueWVhcgogICAgaWYgTU9OIGluIGZpbGxpbmc6CiAgICAgICAgc3RhcnRfdHVwbGUucm1fbW9udGggPSB0b2RheS5tb250aAogICAgaWYgREFZIGluIGZpbGxpbmc6CiAgICAgICAgc3RhcnRfdHVwbGUucm1fZGF5ID0gdG9kYXkuZGF5CiAgICByZXR1cm4gW2ludCh0aW1lLm1rdGltZShzdGFydF90dXBsZSkpICogMTAwMCwgcmVzb2x1dGlvbl0KCgpkZWYgdGltZXN0YW1wX3JhbmdlKHRleHQpOgogICAgIiIiSWRlbnRpZmllcyByYW5nZSBpbiB0aGUgdGV4dCBnaXZlbi4gUmV0dXJucyAtMSBpZiB0aGUgcmFuZ2UgaGFzIG5vdCBiZWVuCiAgICBpZGVudGlmaWVkLiAgIiIiCgogICAgIyBQYXJzZSByYW5nZQogICAgbSA9IHJlLm1hdGNoKHInXihsYXN0KT9ccyooXGQrKT9ccyooc3xzZWN8c2Vjb25kfG18bWlufG1pbnV0ZXxofGhvdXJ8ZHxkYXl8bW9ufG1vbnRofHl8eWVhcilzPyQnLCB0ZXh0LnN0cmlwKCkpCiAgICBpZiBub3QgbToKICAgICAgICByZXR1cm4gLTEKICAgIGNvdW50ID0gbS5ncm91cCgyKSAgIyBDb3VudCBvZiB0aW1lIGZyYW1lcwogICAgdGYgPSBtLmdyb3VwKDMpICAjIFRpbWUgZnJhbWUKICAgICMgR2V0IGNvdW50CiAgICBpZiBjb3VudDoKICAgICAgICBjb3VudCA9IGludChjb3VudCkKICAgIGVsc2U6CiAgICAgICAgY291bnQgPSAxCiAgICAjIEdldCB0aW1lIGZyYW1lCiAgICBmX2dyb3VwcyA9IFsKICAgICAgICBbWydzJywgJ3NlYycsICdzZWNvbmQnXSwgU0VDXSwKICAgICAgICBbWydtJywgJ21pbicsICdtaW51dGUnXSwgTUlOXSwKICAgICAgICBbWydoJywgJ2hvdXInXSwgSE9VUl0sCiAgICAgICAgW1snZCcsICdkYXknXSwgREFZXSwKICAgICAgICBbWydtb24nLCAnbW9udGgnXSwgTU9OXSwKICAgICAgICBbWyd5JywgJ3llYXInXSwgWUVBUl0sCiAgICBdCiAgICBmb3IgdGcgaW4gZl9ncm91cHM6CiAgICAgICAgaWYgdGYgaW4gdGdbMF06CiAgICAgICAgICAgIHJldHVybiBjb3VudCAqIHRnWzFdCiAgICByZXR1cm4gLTEKCgpkZWYgcGFyc2VfdGltZXN0YW1wX3JhbmdlKHRleHQpOgogICAgIiIiUGFyc2VzIHRoZSB0aW1lIHJhbmdlIGdpdmVuIGFuZCByZXR1cm4gc3RhcnQtZW5kIHBhaXIgb2YgdGltZXN0YW1wcy4KCiAgICBSZWNvZ25pemVkIHN0cnVjdHVyZXMgYXJlOgogICAgdHx0b2RheQogICAgeXx5ZXN0ZXJkYXkKICAgIGxhc3Q/IFxcZCogKG18bWlufG1pbnV0ZXxofGhvdXJ8ZHxkYXl8bW9ufG1vbnRofHl8eWVhcikgcz8KICAgIHJhbmdlCiAgICBkYXRldGltZQogICAgZGF0ZXRpbWUgLT4gcmFuZ2UKICAgIGRhdGV0aW1lIC0+IGRhdGV0aW1lCiAgICAiIiIKCiAgICB0ZXh0ID0gdGV4dC5zdHJpcCgpCiAgICAjIE5vIHRpbWUgZnJhbWUKICAgIGlmIHRleHQgPT0gJyc6CiAgICAgICAgcmV0dXJuIFswLCA5MjIzMzcyMDM2ODU0Nzc1ODA3XQoKICAgICMgRGF5IHNwZWMKICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICBpZiB0ZXh0IGluIFsndCcsICd0b2RheSddOgogICAgICAgIHRvZGF5ID0gaW50KHRpbWUubWt0aW1lKGRhdGV0aW1lLmRhdGV0aW1lKG5vdy55ZWFyLCBub3cubW9udGgsIG5vdy5kYXkpLnRpbWV0dXBsZSgpKSkgKiAxMDAwCiAgICAgICAgcmV0dXJuIFt0b2RheSwgdG9kYXkgKyBEQVldCiAgICBpZiB0ZXh0IGluIFsneScsICd5ZXN0ZXJkYXknXToKICAgICAgICB5ZXN0ZXJkYXkgPSBpbnQodGltZS5ta3RpbWUoCiAgICAgICAgICAgIChkYXRldGltZS5kYXRldGltZShub3cueWVhciwgbm93Lm1vbnRoLCBub3cuZGF5KSAtCiAgICAgICAgICAgIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpKS50aW1ldHVwbGUoKSkpICogMTAwMAogICAgICAgIHJldHVybiBbeWVzdGVyZGF5LCB5ZXN0ZXJkYXkgKyBEQVldCgogICAgIyBSYW5nZSBzcGVjCiAgICBwYXJ0cyA9IHRleHQuc3BsaXQoJy0+JykKICAgIHIgPSB0aW1lc3RhbXBfcmFuZ2UocGFydHNbMF0pCiAgICBpZiAociAhPSAtMSBhbmQgbGVuKHBhcnRzKSA+IDEpIG9yIGxlbihwYXJ0cykgPiAyOgogICAgICAgIGRpZSgiRXJyb3I6IERhdGUgYW5kIHJhbmdlICclcycgaGFzIGludmFsaWQgc3RydWN0dXJlIiAlIHRleHQpCiAgICBpZiByICE9IC0xOgogICAgICAgIG5vdyA9IGludCh0aW1lLnRpbWUoKSAqIDEwMDApCiAgICAgICAgcmV0dXJuIFtub3cgLSByLCBub3ddCgogICAgIyBEYXRlIHNwZWMKICAgIHN0YXJ0X2dyb3VwID0gdGltZXN0YW1wX2dyb3VwKHBhcnRzWzBdKQogICAgc3RhcnQgPSBzdGFydF9ncm91cFswXQogICAgZW5kID0gc3RhcnQgKyBzdGFydF9ncm91cFsxXQoKICAgIGlmIGxlbihwYXJ0cykgPiAxOgogICAgICAgIGVuZF9yYW5nZSA9IHRpbWVzdGFtcF9yYW5nZShwYXJ0c1sxXSkKICAgICAgICBpZiBlbmRfcmFuZ2UgIT0gLTE6CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgZW5kX3JhbmdlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZW5kX2dyb3VwID0gdGltZXN0YW1wX2dyb3VwKHBhcnRzWzFdKQogICAgICAgICAgICBlbmQgPSBlbmRfZ3JvdXBbMF0gKyBlbmRfZ3JvdXBbMV0KCiAgICByZXR1cm4gW3N0YXJ0LCBlbmRdCgoKZGVmIGNob29zZV9hY2NvdW50X2tleShhY2NvdW50cyk6CiAgICAiIiIKICAgIEFsbG93cyB1c2VyIHRvIHNlbGVjdCB0aGUgcmlnaHQgYWNjb3VudC4KICAgICIiIgogICAgaWYgbGVuKGFjY291bnRzKSA9PSAwOgogICAgICAgIGRpZSgnTm8gYWNjb3VudCBpcyBhc3NvY2lhdGVkIHdpdGggeW91ciBwcm9maWxlLiBMb2cgaW4gdG8gTG9nZW50cmllcyB0byBjcmVhdGUgYSBuZXcgYWNjb3VudC4nKQogICAgaWYgbGVuKGFjY291bnRzKSA9PSAxOgogICAgICAgIHJldHVybiBhY2NvdW50c1swXVsnYWNjb3VudF9rZXknXQoKICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihhY2NvdW50cykpOgogICAgICAgIGFjY291bnQgPSBhY2NvdW50c1tpXQogICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsICdbJXNdICVzICVzJyAlICgKICAgICAgICAgICAgaSwgYWNjb3VudFsnYWNjb3VudF9rZXknXVs6OF0sIGFjY291bnRbJ25hbWUnXSkKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZWN0aW9uID0gaW50KHJhd19pbnB1dCgnUGljayBhY2NvdW50IHlvdSB3b3VsZCBsaWtlIHRvIHVzZTogJykpCiAgICAgICAgICAgIGlmIHNlbGVjdGlvbiBpbiByYW5nZSgwLCBsZW4oYWNjb3VudHMpKToKICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50c1tzZWxlY3Rpb25dWydhY2NvdW50X2tleSddCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnSW52YWxpZCBjaG9pY2UuIFBsZWFzZSB0cnkgYWdhaW4gb3IgYnJlYWsgd2l0aCBDdHJsK0MuJwoKCmRlZiByZXRyaWV2ZV9hY2NvdW50X2tleSgpOgogICAgIiIiCiAgICBSZXRyaWV2ZXMgYWNjb3VudCBrZXlzIGZyb20gdGhlIHdlYiBzZXJ2ZXIuCiAgICAiIiIKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VybmFtZSA9IHJhd19pbnB1dCgnRW1haWw6ICcpCiAgICAgICAgICAgIHBhc3N3b3JkID0gZ2V0cGFzcy5nZXRwYXNzKCkKICAgICAgICAgICAgYyA9IGRvbWFpbl9jb25uZWN0KGNvbmZpZywgRG9tYWluLk1BSU4sIERvbWFpbikKICAgICAgICAgICAgYy5yZXF1ZXN0KCdQT1NUJywgQUNDT1VOVF9LRVlTX0FQSSwKICAgICAgICAgICAgICAgICAgICAgIHVybGxpYi51cmxlbmNvZGUoeyd1c2VybmFtZSc6IHVzZXJuYW1lLCAncGFzc3dvcmQnOiBwYXNzd29yZH0pLAogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICdSZWZlcmVyJzogJ2h0dHBzOi8vbG9nZW50cmllcy5jb20vbG9naW4vJywKICAgICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsCiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICByZXNwb25zZSA9IGMuZ2V0cmVzcG9uc2UoKQogICAgICAgICAgICBpZiBub3QgcmVzcG9uc2Ugb3IgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMDoKICAgICAgICAgICAgICAgIHJlc3BfdmFsID0gJ2VycicKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlOgogICAgICAgICAgICAgICAgICAgIHJlc3BfdmFsID0gcmVzcG9uc2Uuc3RhdHVzCiAgICAgICAgICAgICAgICBpZiByZXNwX3ZhbCA9PSA0MDM6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgJ0Vycm9yOiBMb2dpbiBmYWlsZWQuIEludmFsaWQgY3JlZGVudGlhbHMuJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnRXJyb3I6IFVuZXhwZWN0ZWQgbG9naW4gcmVzcG9uc2UgZnJvbSBsb2dlbnRyaWVzICglcykuJyAlIHJlc3BfdmFsCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkYXRhID0ganNvbl9sb2FkcyhyZXNwb25zZS5yZWFkKCkpCiAgICAgICAgICAgICAgICByZXR1cm4gY2hvb3NlX2FjY291bnRfa2V5KGRhdGFbJ2FjY291bnRzJ10pCiAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvciwgbXNnOgogICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnRXJyb3I6IENhbm5vdCBjb250YWN0IHNlcnZlciwgJXMnICUgbXNnCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3IsIG1zZzoKICAgICAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgJ0Vycm9yOiBJbnZhbGlkIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciAoUGFyc2luZyBlcnJvciAlcyknICUgbXNnCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAnRXJyb3I6IEludmFsaWQgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLCB1c2VyIGtleSBub3QgcHJlc2VudC4nCiAgICAgICAgZXhjZXB0IEVPRkVycm9yOgogICAgICAgICAgICAjIEN0cmwrRCBpbiBnZXRfcGFzcywgc2ltdWxhdGUgQ3RybCtDCiAgICAgICAgICAgIHJhaXNlIEtleWJvYXJkSW50ZXJydXB0KCkKCiAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgJ1RyeSB0byBsb2cgaW4gYWdhaW4sIG9yIHByZXNzIEN0cmwrQyB0byBicmVhaycKCgpjbGFzcyBTdGF0cyhvYmplY3QpOgoKICAgICIiIkNvbGxlY3RzIHN0YXRpc3RpY3MgYWJvdXQgdGhlIHN5c3RlbSB3b3JrIGxvYWQuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi50aW1lciA9IE5vbmUKICAgICAgICBzZWxmLnRvX3JlbW92ZSA9IEZhbHNlCiAgICAgICAgc2VsZi5maXJzdCA9IFRydWUKCiAgICAgICAgIyBNZW1vcnkgZmllbGRzIHdlIGFyZSBsb29raW5nIGZvciBpbiAvcHJvYy9tZW1pbmZvCiAgICAgICAgc2VsZi5NRU1fRklFTERTID0gWydNZW1Ub3RhbDonLCAnQWN0aXZlOicsICdDYWNoZWQ6J10KICAgICAgICAjIEJsb2NrIGRldmljZXMgaW4gdGhlIHN5c3RlbQogICAgICAgIGFsbF9kZXZpY2VzID0gW29zLnBhdGguYmFzZW5hbWUoZmlsZW5hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgZm9yIGZpbGVuYW1lIGluIGdsb2IuZ2xvYihTWVNfQkxPQ0tfREVWICsgJy8qJyldCiAgICAgICAgIyBNb25pdG9yZWQgZGV2aWNlcyAoYWxsIGRldmljZXMgZXhjZXB0IGxvb3ApCiAgICAgICAgc2VsZi5vdXJfZGV2aWNlcyA9IGZyb3plbnNldChbZGV2aWNlX25hbWUgZm9yIGRldmljZV9uYW1lIGluIGFsbF9kZXZpY2VzIGlmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90IGRldmljZV9uYW1lLnN0YXJ0c3dpdGgoImxvb3AiKSBhbmQgbm90IGRldmljZV9uYW1lLnN0YXJ0c3dpdGgoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyYW0iKSBhbmQgbm90IGRldmljZV9uYW1lLnN0YXJ0c3dpdGgoIm1kIildKQoKICAgICAgICBzZWxmLnByZXZfY3B1X3N0YXRzID0gWzAsIDAsIDAsIDAsIDAsIDAsIDBdCiAgICAgICAgc2VsZi5wcmV2X2Rpc2tfc3RhdHMgPSBbMCwgMF0KICAgICAgICBzZWxmLnByZXZfbmV0X3N0YXRzID0gWzAsIDBdCiAgICAgICAgc2VsZi50b3RhbCA9IHt9CiAgICAgICAgc2VsZi50b3RhbFsnZHInXSA9IDAKICAgICAgICBzZWxmLnRvdGFsWydkdyddID0gMAogICAgICAgIHNlbGYudG90YWxbJ25pJ10gPSAwCiAgICAgICAgc2VsZi50b3RhbFsnbm8nXSA9IDAKCiAgICAgICAgc2VsZi5wcm9jZmlsZXN5c3RlbSA9IFRydWUKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoQ1BVU1RBVFNfRklMRSk6CiAgICAgICAgICAgICMgc3RvcmUgc3lzdGVtIHR5cGUgZm9yIGxhdGVyIHJlZmVyZW5jZSBpbiBwdWxsaW5nIHN0YXRzCiAgICAgICAgICAgICMgaW4gYW4gYWx0ZXJuYXRlIG1hbm5lcgogICAgICAgICAgICBzZWxmLnByb2NmaWxlc3lzdGVtID0gRmFsc2UKICAgICAgICAgICAgc2VsZi51bmFtZSA9IHBsYXRmb3JtLnVuYW1lKCkKICAgICAgICAgICAgc2VsZi5zeXMgPSBzZWxmLnVuYW1lWzBdCiAgICAgICAgICAgIGxvZy5kZWJ1Zygnc3lzOiAlcycsIHNlbGYuc3lzKQoKICAgICAgICAjIGZvciBzY2FsaW5nIGluIG9zeF90b3Bfc3RhdHMgLS0ga2V5IGlzIGEgc2NhbGUgZmFjdG9yIChnaWcsCiAgICAgICAgIyBtZWcsIGV0YyksIHZhbHVlIGlzIHdoYXQgdG8gbXVsdGlwbHkgYnkgdG8gZ2V0IHRvIGtpbG9ieXRlcwogICAgICAgIHNlbGYuc2NhbGUya2IgPSB7J00nOiAxMDI0LCAnRyc6IDEwNDg1NzZ9CgogICAgICAgIGlmIG5vdCBjb25maWcuZGVidWdfbm9zdGF0czoKICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAjIE5ldyBzdGF0cyB3aWxsIGdvIGhlcmUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2F2ZV9kYXRhKGRhdGEsIG5hbWUsIHZhbHVlKToKICAgICAgICAiIiIKICAgICAgICBTYXZlcyB0aGUgdmFsdWUgdW5kZXIgdGhlIG5hbWUgZ2l2ZW4uIE5lZ2F0aXZlIHZhbHVlcyBhcmUgc2V0IHRvIDAuCiAgICAgICAgIiIiCiAgICAgICAgaWYgdmFsdWUgPj0gMDoKICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGF0YVtuYW1lXSA9IDAKCiAgICBkZWYgY3B1X3N0YXRzKHNlbGYsIGRhdGEpOgogICAgICAgICIiIgogICAgICAgIENvbGxlY3RzIENQVSBzdGF0aXN0aWNzLiBWaXJ0dWFsIHRpY2tzIGFyZSBpZ25vcmVkLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZWlucHV0LmlucHV0KFtDUFVTVEFUU19GSUxFXSk6CiAgICAgICAgICAgICAgICBpZiBsZW4obGluZSkgPCAxMzoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKCdjcHUgJyk6CiAgICAgICAgICAgICAgICAgICAgcmF3X3N0YXRzID0gW2xvbmcocGFydCkgZm9yIHBhcnQgaW4gbGluZS5zcGxpdCgpWzE6OF1dCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZmlsZWlucHV0LmNsb3NlKCkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjdScsIHJhd19zdGF0c1swXSAtIHNlbGYucHJldl9jcHVfc3RhdHNbMF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NsJywgcmF3X3N0YXRzWzFdIC0gc2VsZi5wcmV2X2NwdV9zdGF0c1sxXSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3MnLCByYXdfc3RhdHNbMl0gLSBzZWxmLnByZXZfY3B1X3N0YXRzWzJdKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjaScsIHJhd19zdGF0c1szXSAtIHNlbGYucHJldl9jcHVfc3RhdHNbM10pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NpbycsIHJhd19zdGF0c1s0XSAtIHNlbGYucHJldl9jcHVfc3RhdHNbNF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NxJywgcmF3X3N0YXRzWzVdIC0gc2VsZi5wcmV2X2NwdV9zdGF0c1s1XSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3NxJywgcmF3X3N0YXRzWzZdIC0gc2VsZi5wcmV2X2NwdV9zdGF0c1s2XSkKICAgICAgICBzZWxmLnByZXZfY3B1X3N0YXRzID0gcmF3X3N0YXRzCgogICAgZGVmIGRpc2tfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgQ29sbGVjdHMgZGlzayBzdGF0aXN0aWNzLiBJbnRlcmVzdGVkIGluIGJsb2NrIGRldmljZXMgb25seS4KICAgICAgICAiIiIKICAgICAgICByZWFkcyA9IDBMCiAgICAgICAgd3JpdGVzID0gMEwKICAgICAgICAjIEZvciBhbGwgYmxvY2sgZGV2aWNlcwogICAgICAgIGZvciBkZXZpY2UgaW4gc2VsZi5vdXJfZGV2aWNlczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBSZWFkIGRldmljZSBzdGF0cwogICAgICAgICAgICAgICAgZiA9IG9wZW4oU1lTX0JMT0NLX0RFViArIGRldmljZSArICcvc3RhdCcsICdyJykKICAgICAgICAgICAgICAgIGxpbmUgPSBmLnJlYWQoKQogICAgICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgUGFyc2UgZGV2aWNlIHN0YXRzCiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCA3OgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgcmVhZHMgKz0gbG9uZyhwYXJ0c1syXSkKICAgICAgICAgICAgd3JpdGVzICs9IGxvbmcocGFydHNbNl0pCgogICAgICAgIHJlYWRzICo9IDUxMgogICAgICAgIHdyaXRlcyAqPSA1MTIKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnZHInLCByZWFkcyAtIHNlbGYucHJldl9kaXNrX3N0YXRzWzBdKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdkdycsIHdyaXRlcyAtIHNlbGYucHJldl9kaXNrX3N0YXRzWzFdKQogICAgICAgIHNlbGYucHJldl9kaXNrX3N0YXRzID0gW3JlYWRzLCB3cml0ZXNdCiAgICAgICAgc2VsZi50b3RhbFsnZHInXSA9IHJlYWRzCiAgICAgICAgc2VsZi50b3RhbFsnZHcnXSA9IHdyaXRlcwoKICAgIGRlZiBtZW1fc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgQ29sbGVjdHMgbWVtb3J5IHN0YXRpc3RpY3MuCiAgICAgICAgIiIiCiAgICAgICAgbWVtX3ZhcnMgPSB7fQogICAgICAgIGZvciBmaWVsZCBpbiBzZWxmLk1FTV9GSUVMRFM6CiAgICAgICAgICAgIG1lbV92YXJzW2ZpZWxkXSA9IDBMCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlaW5wdXQuaW5wdXQoW01FTVNUQVRTX0ZJTEVdKToKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICBuYW1lID0gcGFydHNbMF0KICAgICAgICAgICAgICAgIGlmIG5hbWUgaW4gc2VsZi5NRU1fRklFTERTOgogICAgICAgICAgICAgICAgICAgIG1lbV92YXJzW25hbWVdID0gbG9uZyhwYXJ0c1sxXSkKICAgICAgICAgICAgZmlsZWlucHV0LmNsb3NlKCkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ210JywgbWVtX3ZhcnNbc2VsZi5NRU1fRklFTERTWzBdXSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbWEnLCBtZW1fdmFyc1tzZWxmLk1FTV9GSUVMRFNbMV1dKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdtYycsIG1lbV92YXJzW3NlbGYuTUVNX0ZJRUxEU1syXV0pCgogICAgZGVmIG5ldF9zdGF0cyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBDb2xsZWN0cyBuZXR3b3JrIHN0YXRpc3RpY3MuIENvbGxlY3Rpbmcgb25seSBzZWxlY3RlZCBpbnRlcmZhY2VzLgogICAgICAgICIiIgogICAgICAgIHJlY2VpdmUgPSAwTAogICAgICAgIHRyYW5zbWl0ID0gMEwKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGVpbnB1dC5pbnB1dChbTkVUU1RBVFNfRklMRV0pOgogICAgICAgICAgICAgICAgaWYgbGluZVs6NV0gaW4gTkVUX0RFVklDRVM6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnJlcGxhY2UoJzonLCAnICcpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICByZWNlaXZlICs9IGxvbmcocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgdHJhbnNtaXQgKz0gbG9uZyhwYXJ0c1s5XSkKICAgICAgICAgICAgZmlsZWlucHV0LmNsb3NlKCkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICduaScsIHJlY2VpdmUgLSBzZWxmLnByZXZfbmV0X3N0YXRzWzBdKQogICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdubycsIHRyYW5zbWl0IC0gc2VsZi5wcmV2X25ldF9zdGF0c1sxXSkKICAgICAgICBzZWxmLnByZXZfbmV0X3N0YXRzID0gW3JlY2VpdmUsIHRyYW5zbWl0XQogICAgICAgIHNlbGYudG90YWxbJ25pJ10gPSByZWNlaXZlCiAgICAgICAgc2VsZi50b3RhbFsnbm8nXSA9IHRyYW5zbWl0CgogICAgZGVmIG9zeF90b3Bfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgRGFyd2luL09TLVggZG9lc24ndCBzZWVtIHRvIHByb3ZpZGUgbmVhcmx5IHRoZSBzYW1lIGFtb3VudCBvZgogICAgICAgIGRldGFpbCBhcyB0aGUgL3Byb2MgZmlsZXN5c3RlbSB1bmRlciBMaW51eCAtLSBhdCBsZWFzdCBub3QKICAgICAgICBlYXNpbHkgYWNjZXNzaWJsZSB0byB0aGUgY29tbWFuZCBsaW5lLiAgVGhlIGhlYWRlcnMgZnJvbQogICAgICAgIHRvcCgxKSBzZWVtIHRvIGJlIHRoZSBxdWlja2VzdCAmIG1vc3QgZGV0YWlsZWQgc291cmNlIG9mIGRhdGEKICAgICAgICBhYm91dCBDUFUsIGFuZCBkaXNrIHRyYW5zZmVyIGFzIHNlcGFyYXRlZCBpbnRvIHJlYWRzICYgd3JpdGVzLgogICAgICAgICh2cy4gaW9zdGF0LCB3aGljaCBzaG93cyBDUFUgbGVzcyBncmFudWxhcmx5OyBpdCBzaG93cyBtb3JlCiAgICAgICAgIGRldGFpbCBhYm91dCBwZXItZGlzayBJTywgYnV0IGRvZXMgbm90IHNwbGl0IElPIGludG8gcmVhZHMgYW5kCiAgICAgICAgIHdyaXRlcykKCiAgICAgICAgRnJ1c3RyYXRpbmdseSwgdGhlIGxldmVsIG9mIHBlci1kaXNrIHN0YXRpc3RpY3MgZnJvbSB0b3AgaXMKICAgICAgICBpbmNyZWRpYmx5IHVuLWdyYW51bGFyCgogICAgICAgIFdlJ2xsIGdldCBwaHlzaWNhbCBtZW1vcnkgZGV0YWlscyBmcm9tIGhlcmUgdG9vCiAgICAgICAgIiIiCiAgICAgICAgY3B1cmUgPSByZS5jb21waWxlKHInQ1BVIHVzYWdlOlxzKyhbXGQuXSspXCUgdXNlciwgKFtcZC5dKylcJSBzeXMsICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgcicoW1xkLl0rKVwlIGlkbGUnKQogICAgICAgIG1lbXJlID0gcmUuY29tcGlsZShyJ1BoeXNNZW06XHMrKFxkK1x3Kykgd2lyZWQsICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgcicoXGQrXHcrKSBhY3RpdmUsIChcZCtcdyspIGluYWN0aXZlLCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHInKFxkK1x3KykgdXNlZCwgKFxkK1x3KykgZnJlZS4nKQogICAgICAgIGRpc2tyZSA9IHJlLmNvbXBpbGUocidEaXNrczogKFxkKykvKFxkK1x3KykgcmVhZCwgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcicoXGQrKS8oXGQrXHcrKSB3cml0dGVuLicpCgogICAgICAgICMgc2NhbGluZyByb3V0aW5lIGZvciB1c2UgaW4gbWFwKCkgbGF0ZXIKICAgICAgICBkZWYgc2NhbGV0b2tiKHZhbHVlKToKICAgICAgICAgICAgIyB0YWtlIGEgdmFsdWUgbGlrZSAxMjA5TSBvciAxMEcgYW5kIHJldHVybiBhbiBpbnRlZ2VyCiAgICAgICAgICAgICMgcmVwcmVzZW50aW5nIHRoZSB2YWx1ZSBpbiBraWxvYnl0ZXMKCiAgICAgICAgICAgIChzaXplLCBzY2FsZSkgPSByZS5zcGxpdCgnKFtBLXpdKyknLCB2YWx1ZSlbOjJdCiAgICAgICAgICAgIHNpemUgPSBpbnQoc2l6ZSkKICAgICAgICAgICAgaWYgc2NhbGU6CiAgICAgICAgICAgICAgICBpZiBzY2FsZSBpbiBzZWxmLnNjYWxlMmtiOgogICAgICAgICAgICAgICAgICAgIHNpemUgKj0gc2VsZi5zY2FsZTJrYltzY2FsZV0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoIkVycm9yOiB2YWx1ZSBpbiAlcyBleHByZXNzZWQgaW4gIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaW1lbnNpb24gSSBjYW4ndCB0cmFuc2xhdGUgdG8ga2I6ICVzICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lLCBzaXplLCBzY2FsZSkKICAgICAgICAgICAgcmV0dXJuIHNpemUKCiAgICAgICAgIyB0aGUgZmlyc3Qgc2V0IG9mICd0b3AnIGhlYWRlcnMgZGlzcGxheSBhdmVyYWdlIHZhbHVlcyBvdmVyCiAgICAgICAgIyBzeXN0ZW0gdXB0aW1lLiAgc28gd2Ugb25seSB3YW50IHRvIHJlYWQgdGhlIHNlY29uZCBzZXQgdGhhdCB3ZQogICAgICAgICMgc2VlLgogICAgICAgIHRvcHBhc3MgPSAwCgogICAgICAgICMgd2Ugc2hvdWxkIHJlYWxseSBkbyB0aGlzIGZpcnN0LCBzbyB0aGF0IHdlIGRvbid0IHdhc3RlIGFueSB0aW1lCiAgICAgICAgIyBpZiB0b3AgZmFpbHMgdG8gd29yay4gIGhvd2V2ZXIsIGl0ICdyZWFkcycgYmV0dGVyIGF0IHRoaXMgcG9pbnQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHByb2MgPSBzdWJwcm9jZXNzLlBvcGVuKFsndG9wJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctaScsICcyJywgJy1sJywgJzInLCAnLW4nLCAnMCddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGZvciBsaW5lIGluIHByb2Muc3Rkb3V0OgogICAgICAgICAgICAjIHNraXAgdGhlIGZpcnN0IG91dHB1dAogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoJ1Byb2Nlc3NlczogJyk6CiAgICAgICAgICAgICAgICB0b3BwYXNzICs9IDEKICAgICAgICAgICAgZWxpZiBsaW5lLnN0YXJ0c3dpdGgoJ0NQVSB1c2FnZTogJykgYW5kIHRvcHBhc3MgPT0gMjoKICAgICAgICAgICAgICAgIGNwdXJlc3VsdCA9IGNwdXJlLm1hdGNoKGxpbmUpCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIHRoZSBkYXRhIHdlIHNlbmQgdG8gbG9nZW50cmllcyBpcyBleHBlY3RlZCB0byBiZSBpbiB0ZXJtcwogICAgICAgICAgICAgICAgb2YgY2VudGlzZWNvbmRzIG9mICh1c2VyL3N5c3RlbS9pZGxlL2V0YykgdGltZSBhcyBhbGwgd2UKICAgICAgICAgICAgICAgIGhhdmUgaXMgJSwgbXVsdGlwbHkgdGhhdCAlIGJ5IHRoZSBFUE9DSCBhbmQgMTAwLgogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICBpZiBjcHVyZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgKGN1LCBjcywgY2kpID0gbWFwKGxhbWJkYSB4OiBpbnQoZmxvYXQoeCkgKiAxMDAgKiBFUE9DSCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNwdXJlc3VsdC5ncm91cCgxLCAyLCAzKSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3UnLCBjdSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3MnLCBjcykKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2knLCBjaSkKICAgICAgICAgICAgICAgICAgICAjIHNlbmQgemVybyBpbiBjYXNlIGFsbCBtdXN0IGJlIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2wnLCAwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjaW8nLCAwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjcScsIDApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NzcScsIDApCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogY291bGQgbm90IHBhcnNlIENQVSBzdGF0cyAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluIHRvcCBvdXRwdXQgbGluZSAlcyIsIGxpbmUpCgogICAgICAgICAgICBlbGlmIGxpbmUuc3RhcnRzd2l0aCgnUGh5c01lbTogJykgYW5kIHRvcHBhc3MgPT0gMjoKICAgICAgICAgICAgICAgICIiIgogICAgICAgICAgICAgICAgT1MtWCBoYXMgbm8gZml4ZWQgY2FjaGUgc2l6ZSAtLSBjYWNoZWQgcGFnZXMgYXJlIHN0b3JlZCBpbgogICAgICAgICAgICAgICAgdmlydHVhbCBtZW1vcnkgYXMgcGFydCBvZiB0aGUgVW5pZmllZCBCdWZmZXIgQ2FjaGUuICBJdAogICAgICAgICAgICAgICAgd291bGQgYXBwZWFyIHRvIGJlIG5lYXJseSBpbXBvc3NpYmxlIHRvIGZpbmQgb3V0IHdoYXQgdGhlCiAgICAgICAgICAgICAgICBjdXJyZW50IHNpemUgb2YgdGhlIFVCQyBpcywgc2F2ZSBydW5uaW5nIHB1cmdlKDgpIGFuZAogICAgICAgICAgICAgICAgY29tcGFyaW5nIHRoZSB2YWx1ZXMgYmVmb3JlIGFuZCBhZnRlciAtLSBVQkMgdW5jZXJ0YWludHkKICAgICAgICAgICAgICAgIHByaW5jaXBhbD8gOi0pCgogICAgICAgICAgICAgICAgaHR0cDovL3dhZ2VybGFicy5jb20vYmxvZy8yMDA4LzAzLzA0L2hhY2tpbmctdGhlLW1hYy1vc3gtdW5pZmllZC1idWZmZXItY2FjaGUvCiAgICAgICAgICAgICAgICBib29rcy5nb29nbGUuaWUvYm9va3M/aXNibj0wMTMyNzAyMjY2CiAgICAgICAgICAgICAgICBodHRwOi8vcmV2aWV3cy5jbmV0LmNvbS84MzAxLTEzNzI3XzctNTczNzIyNjctMjYzL3B1cmdlLXRoZS1vcy14LWRpc2stY2FjaGUtdG8tYW5hbHl6ZS1tZW1vcnktdXNhZ2UvCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIG1lbXJlc3VsdCA9IG1lbXJlLm1hdGNoKGxpbmUpCiAgICAgICAgICAgICAgICBpZiBtZW1yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgIyBsb2dlbnRyaWVzIGlzIGV4cGVjdGluZyB2YWx1ZXMgaW4ga2lsb2J5dGVzCiAgICAgICAgICAgICAgICAgICAgKHdpcmVkLCBhY3RpdmUsIGluYWN0aXZlLCB1c2VkLCBmcmVlKSA9IG1hcCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGV0b2tiLCBtZW1yZXN1bHQuZ3JvdXAoMSwgMiwgMywgNCwgNSkpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ210JywgdXNlZCArIGZyZWUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ21hJywgYWN0aXZlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdtYycsIDApCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogY291bGQgbm90IHBhcnNlIG1lbW9yeSBzdGF0cyAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluIHRvcCBvdXRwdXQgbGluZSAlcyIsIGxpbmUpCgogICAgICAgICAgICBlbGlmIGxpbmUuc3RhcnRzd2l0aCgnRGlza3M6ICcpIGFuZCB0b3BwYXNzID09IDI6CiAgICAgICAgICAgICAgICBkaXNrcmVzdWx0ID0gZGlza3JlLm1hdGNoKGxpbmUpCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIHRoZSBkYXRhIHdlIHNlbmQgdG8gbG9nZW50cmllcyBpcyBleHBlY3RlZCB0byBiZSBpbiBieXRlcwogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICBpZiBkaXNrcmVzdWx0OgogICAgICAgICAgICAgICAgICAgIChyZWFkcywgd3JpdGVzKSA9IG1hcChzY2FsZXRva2IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2tyZXN1bHQuZ3JvdXAoMiwgNCkpCiAgICAgICAgICAgICAgICAgICAgcmVhZHMgKj0gMTAyNAogICAgICAgICAgICAgICAgICAgIHdyaXRlcyAqPSAxMDI0CgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdkcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZHMgLSBzZWxmLnByZXZfZGlza19zdGF0c1swXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnZHcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlcyAtIHNlbGYucHJldl9kaXNrX3N0YXRzWzFdKQogICAgICAgICAgICAgICAgICAgIHNlbGYucHJldl9kaXNrX3N0YXRzID0gW3JlYWRzLCB3cml0ZXNdCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogY291bGQgbm90IHBhcnNlIGRpc2sgc3RhdHMgIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbiB0b3Agb3V0cHV0IGxpbmUgJXMiLCBsaW5lKQoKICAgIGRlZiBzdW5vc190b3Bfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgU3VuT1MvU21hcnRPUyBkb2Vzbid0IHNlZW0gdG8gcHJvdmlkZSBuZWFybHkgdGhlIHNhbWUgYW1vdW50IG9mCiAgICAgICAgZGV0YWlsIGFzIHRoZSAvcHJvYyBmaWxlc3lzdGVtIHVuZGVyIExpbnV4IC0tIGF0IGxlYXN0IG5vdAogICAgICAgIGVhc2lseSBhY2Nlc3NpYmxlIHRvIHRoZSBjb21tYW5kIGxpbmUuICBUaGUgaGVhZGVycyBmcm9tCiAgICAgICAgdG9wKDEpIHNlZW0gdG8gYmUgdGhlIHF1aWNrZXN0ICYgbW9zdCBkZXRhaWxlZCBzb3VyY2Ugb2YgZGF0YQogICAgICAgIGFib3V0IENQVSwgYW5kIGRpc2sgdHJhbnNmZXIgYXMgc2VwYXJhdGVkIGludG8gcmVhZHMgJiB3cml0ZXMuCiAgICAgICAgKHZzLiBpb3N0YXQsIHdoaWNoIHNob3dzIENQVSBsZXNzIGdyYW51bGFybHk7IGl0IHNob3dzIG1vcmUKICAgICAgICAgZGV0YWlsIGFib3V0IHBlci1kaXNrIElPLCBidXQgZG9lcyBub3Qgc3BsaXQgSU8gaW50byByZWFkcyBhbmQKICAgICAgICAgd3JpdGVzKQoKICAgICAgICBGcnVzdHJhdGluZ2x5LCB0aGUgbGV2ZWwgb2YgcGVyLWRpc2sgc3RhdGlzdGljcyBmcm9tIHRvcCBpcwogICAgICAgIGluY3JlZGlibHkgdW4tZ3JhbnVsYXIKCiAgICAgICAgV2UnbGwgZ2V0IHBoeXNpY2FsIG1lbW9yeSBkZXRhaWxzIGZyb20gaGVyZSB0b28KICAgICAgICAiIiIKICAgICAgICBjcHVyZSA9IHJlLmNvbXBpbGUocidDUFUgc3RhdGVzOlxzKyhbXGQuXSspXCUgaWRsZSxccysoW1xkLl0rKVwlIHVzZXIsXHMrJwogICAgICAgICAgICAgICAgICAgICAgICAgICByJyhbXGQuXSspXCUga2VybmVsLFxzKyhbXGQuXSspXCUgaW93YWl0JykKICAgICAgICBtZW1yZSA9IHJlLmNvbXBpbGUocidNZW1vcnk6XHMrKFxkK1x3KykgcGh5cyBtZW0sIChcZCtcdyspIGZyZWUgbWVtLCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHInKFxkK1x3KykgdG90YWwgc3dhcCwgKFxkK1x3KykgZnJlZSBzd2FwJykKCiAgICAgICAgIyBzY2FsaW5nIHJvdXRpbmUgZm9yIHVzZSBpbiBtYXAoKSBsYXRlcgogICAgICAgIGRlZiBzY2FsZXRva2IodmFsdWUpOgogICAgICAgICAgICAjIHRha2UgYSB2YWx1ZSBsaWtlIDEyMDlNIG9yIDEwRyBhbmQgcmV0dXJuIGFuIGludGVnZXIKICAgICAgICAgICAgIyByZXByZXNlbnRpbmcgdGhlIHZhbHVlIGluIGtpbG9ieXRlcwoKICAgICAgICAgICAgKHNpemUsIHNjYWxlKSA9IHJlLnNwbGl0KCcoW0Etel0rKScsIHZhbHVlKVs6Ml0KICAgICAgICAgICAgc2l6ZSA9IGludChzaXplKQogICAgICAgICAgICBpZiBzY2FsZToKICAgICAgICAgICAgICAgIGlmIHNjYWxlIGluIHNlbGYuc2NhbGUya2I6CiAgICAgICAgICAgICAgICAgICAgc2l6ZSAqPSBzZWxmLnNjYWxlMmtiW3NjYWxlXQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2cud2FybmluZygiRXJyb3I6IHZhbHVlIGluICVzIGV4cHJlc3NlZCBpbiAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpbWVuc2lvbiBJIGNhbid0IHRyYW5zbGF0ZSB0byBrYjogJXMgJXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUsIHNpemUsIHNjYWxlKQogICAgICAgICAgICByZXR1cm4gc2l6ZQoKICAgICAgICAjIHRoZSBmaXJzdCBzZXQgb2YgJ3RvcCcgaGVhZGVycyBkaXNwbGF5IGF2ZXJhZ2UgdmFsdWVzIG92ZXIKICAgICAgICAjIHN5c3RlbSB1cHRpbWUuICBzbyB3ZSBvbmx5IHdhbnQgdG8gcmVhZCB0aGUgc2Vjb25kIHNldCB0aGF0IHdlCiAgICAgICAgIyBzZWUuCiAgICAgICAgdG9wcGFzcyA9IDAKCiAgICAgICAgIyB3ZSBzaG91bGQgcmVhbGx5IGRvIHRoaXMgZmlyc3QsIHNvIHRoYXQgd2UgZG9uJ3Qgd2FzdGUgYW55IHRpbWUKICAgICAgICAjIGlmIHRvcCBmYWlscyB0byB3b3JrLiAgaG93ZXZlciwgaXQgJ3JlYWRzJyBiZXR0ZXIgYXQgdGhpcyBwb2ludAogICAgICAgIHRyeToKICAgICAgICAgICAgcHJvYyA9IHN1YnByb2Nlc3MuUG9wZW4oWyd0b3AnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1pJywgJzInLCAnLWwnLCAnMicsICctbicsICcwJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZm9yIGxpbmUgaW4gcHJvYy5zdGRvdXQ6CiAgICAgICAgICAgICMgc2tpcCB0aGUgZmlyc3Qgb3V0cHV0CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnbG9hZCBhdmVyYWdlczogJyk6CiAgICAgICAgICAgICAgICB0b3BwYXNzICs9IDIKICAgICAgICAgICAgZWxpZiBsaW5lLnN0YXJ0c3dpdGgoJ0NQVSBzdGF0ZXM6ICcpIGFuZCB0b3BwYXNzID09IDI6CiAgICAgICAgICAgICAgICBjcHVyZXN1bHQgPSBjcHVyZS5tYXRjaChsaW5lKQogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICB0aGUgZGF0YSB3ZSBzZW5kIHRvIGxvZ2VudHJpZXMgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gdGVybXMKICAgICAgICAgICAgICAgIG9mIGNlbnRpc2Vjb25kcyBvZiAoaWRsZS91c2VyL2tlcm5lbC9ldGMpIHRpbWUgYXMgYWxsIHdlCiAgICAgICAgICAgICAgICBoYXZlIGlzICUsIG11bHRpcGx5IHRoYXQgJSBieSB0aGUgRVBPQ0ggYW5kIDEwMC4KICAgICAgICAgICAgICAgICIiIgogICAgICAgICAgICAgICAgaWYgY3B1cmVzdWx0OgogICAgICAgICAgICAgICAgICAgIChjaSwgY3UsIGNzLCBjaW8pID0gbWFwKGxhbWJkYSB4OiBpbnQoZmxvYXQoeCkgKiAxMDAgKiBFUE9DSCAqIDEwMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNwdXJlc3VsdC5ncm91cCgxLCAyLCAzLCA0KSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3UnLCBjdSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3MnLCBjcykKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2knLCBjaSkKICAgICAgICAgICAgICAgICAgICAjIHNlbmQgemVybyBpbiBjYXNlIGFsbCBtdXN0IGJlIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY2wnLCAwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9kYXRhKGRhdGEsICdjaW8nLCBjaW8pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2NxJywgMCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnY3NxJywgMCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoIkVycm9yOiBjb3VsZCBub3QgcGFyc2UgQ1BVIHN0YXRzICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW4gdG9wIG91dHB1dCBsaW5lICVzIiwgbGluZSkKCiAgICAgICAgICAgIGVsaWYgbGluZS5zdGFydHN3aXRoKCdNZW1vcnk6ICcpIGFuZCB0b3BwYXNzID09IDI6CiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgICAgIFRvcCBpcyBpbmFjY3VyYXRlIG9uIFNtYXJ0T1MgYW5kIHN0YXRlcyB0aGUgZnJlZSBtZW1vcnkgb2YKICAgICAgICAgICAgICAgIHRoZSBlbnRpcmUgbm9kZSwgcmF0aGVyIHRoYW4ganVzdCB0aGUgdmlydHVhbCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICIiIgogICAgICAgICAgICAgICAgbWVtcmVzdWx0ID0gbWVtcmUubWF0Y2gobGluZSkKICAgICAgICAgICAgICAgIGlmIG1lbXJlc3VsdDoKICAgICAgICAgICAgICAgICAgICAjIGxvZ2VudHJpZXMgaXMgZXhwZWN0aW5nIHZhbHVlcyBpbiBraWxvYnl0ZXMKICAgICAgICAgICAgICAgICAgICAodG90YWwsIGZhbHNlZnJlZSwgc3dhcCwgZnJlZXN3YXApID0gbWFwKAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZXRva2IsIG1lbXJlc3VsdC5ncm91cCgxLCAyLCAzLCA0KSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbXQnLCB0b3RhbCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbWEnLCBzd2FwIC0gZnJlZXN3YXApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ21jJywgMCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoIkVycm9yOiBjb3VsZCBub3QgcGFyc2UgbWVtb3J5IHN0YXRzICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW4gdG9wIG91dHB1dCBsaW5lICVzIiwgbGluZSkKCiAgICBkZWYgc3Vub3NfZGlza19zdGF0cyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICB0aGUgZGF0YSB3ZSBzZW5kIHRvIGxvZ2VudHJpZXMgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gYnl0ZXMKICAgICAgICAiIiIKCiAgICAgICAgc2QwID0gY2FsbCgna3N0YXQgLW4gc2QwIHwgZWdyZXAgIm5yZWFkfG53cml0dGVuIicpCiAgICAgICAgc2QxID0gY2FsbCgna3N0YXQgLW4gc2QxIHwgZWdyZXAgIm5yZWFkfG53cml0dGVuIicpCiAgICAgICAgc2QyID0gY2FsbCgna3N0YXQgLW4gc2QyIHwgZWdyZXAgIm5yZWFkfG53cml0dGVuIicpCgogICAgICAgIHJlYWRzID0gMEwKICAgICAgICB3cml0ZXMgPSAwTAoKICAgICAgICBmb3IgZGlzayBpbiBbc2QwLCBzZDEsIHNkMl06CiAgICAgICAgICAgIGZvciBsaW5lIGluIGRpc2suc3BsaXQoIlxuIik6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBub3QgcGFydHNbMV0uaXNkaWdpdCgpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gIm5yZWFkIjoKICAgICAgICAgICAgICAgICAgICByZWFkcyArPSBsb25nKHBhcnRzWzFdKQogICAgICAgICAgICAgICAgZWxpZiBwYXJ0c1swXSA9PSAibndyaXR0ZW4iOgogICAgICAgICAgICAgICAgICAgIHdyaXRlcyArPSBsb25nKHBhcnRzWzFdKQoKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnZHInLAogICAgICAgICAgICAgICAgICAgICAgIHJlYWRzIC0gc2VsZi5wcmV2X2Rpc2tfc3RhdHNbMF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ2R3JywKICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXMgLSBzZWxmLnByZXZfZGlza19zdGF0c1sxXSkKICAgICAgICBzZWxmLnByZXZfZGlza19zdGF0cyA9IFtyZWFkcywgd3JpdGVzXQoKICAgIGRlZiBuZXRzdGF0c19zdGF0cyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBSZWFkIG5ldHdvcmsgYnl0ZXMgaW4vb3V0IGZyb20gdGhlIG91dHB1dCBvZiAibmV0c3RhdCAtcyIKICAgICAgICBOb3QgZXhhY3QsIGFzIG9uIE9TLVggaXQgZG9lc24ndCBkaXNwbGF5IGJ5dGVzIGZvciBldmVyeSBwcm90b2NvbCwKICAgICAgICBidXQgbW9yZSBleGFjdCB0aGFuIHVzaW5nICd0b3AnIG9yICduZXRzdGF0IDxpbnRlcnZhbD4nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcm9jID0gc3VicHJvY2Vzcy5Qb3BlbihbJ25ldHN0YXQnLCAnLWJpJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyBpZiB3ZSBzZWUgMTEgbm9uLWJsYW5rIGZpZWxkcywKICAgICAgICAjICM3IGlzIGlucHV0IGJ5dGVzLCBhbmQgIzEwIGlzIG91dHB1dCBieXRlcywgYnV0IGF2b2lkIGR1cGxpY2F0ZQogICAgICAgICMgZGV2aWNlIGxpbmVzCgogICAgICAgIHJlY2VpdmUgPSAwTAogICAgICAgIHRyYW5zbWl0ID0gMEwKICAgICAgICBuZXRzZWVuID0ge30KCiAgICAgICAgZm9yIGxpbmUgaW4gcHJvYy5zdGRvdXQ6CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnTmFtZScpOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMTE6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBwYXJ0c1sxXSBpbiBuZXRzZWVuOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgbm90IHBhcnRzWzZdLmlzZGlnaXQoKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNlaXZlICs9IGxvbmcocGFydHNbNl0pCiAgICAgICAgICAgIHRyYW5zbWl0ICs9IGxvbmcocGFydHNbOV0pCiAgICAgICAgICAgIG5ldHNlZW5bcGFydHNbMF1dID0gMQoKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbmknLCByZWNlaXZlIC0gc2VsZi5wcmV2X25ldF9zdGF0c1swXSkKICAgICAgICBzZWxmLnNhdmVfZGF0YShkYXRhLCAnbm8nLCB0cmFuc21pdCAtIHNlbGYucHJldl9uZXRfc3RhdHNbMV0pCiAgICAgICAgc2VsZi5wcmV2X25ldF9zdGF0cyA9IFtyZWNlaXZlLCB0cmFuc21pdF0KCiAgICBkZWYgc3Vub3NfbmV0c3RhdHNfc3RhdHMoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZCBuZXR3b3JrIGJ5dGVzIGluL291dCBmcm9tIHRoZSBvdXRwdXQgb2YgIm5ldHN0YXQgLWkiCiAgICAgICAgTm90IGV4YWN0LCBhcyBvbiBTdW5PUyBpdCBkb2Vzbid0IGRpc3BsYXkgYnl0ZXMgZm9yIGV2ZXJ5IHByb3RvY29sLAogICAgICAgIGJ1dCBtb3JlIGV4YWN0IHRoYW4gdXNpbmcgJ3RvcCcgb3IgJ25ldHN0YXQgPGludGVydmFsPicKICAgICAgICAiIiIKICAgICAgICBuZXQwID0gY2FsbCgna3N0YXQgLW4gbmV0MCB8IGdyZXAgImJ5dGVzNjQiJykKICAgICAgICBuZXQxID0gY2FsbCgna3N0YXQgLW4gbmV0MSB8IGdyZXAgImJ5dGVzNjQiJykKCiAgICAgICAgcmVjZWl2ZSA9IDBMCiAgICAgICAgdHJhbnNtaXQgPSAwTAoKICAgICAgICBmb3IgbmV0d29yayBpbiBbbmV0MCwgbmV0MV06CiAgICAgICAgICAgIGZvciBsaW5lIGluIG5ldHdvcmsuc3BsaXQoIlxuIik6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBub3QgcGFydHNbMV0uaXNkaWdpdCgpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gImlieXRlczY0IjoKICAgICAgICAgICAgICAgICAgICByZWNlaXZlICs9IGxvbmcocGFydHNbMV0pCiAgICAgICAgICAgICAgICBlbGlmIHBhcnRzWzBdID09ICJvYnl0ZXM2NCI6CiAgICAgICAgICAgICAgICAgICAgdHJhbnNtaXQgKz0gbG9uZyhwYXJ0c1sxXSkKCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ25pJywgcmVjZWl2ZSAtIHNlbGYucHJldl9uZXRfc3RhdHNbMF0pCiAgICAgICAgc2VsZi5zYXZlX2RhdGEoZGF0YSwgJ25vJywgdHJhbnNtaXQgLSBzZWxmLnByZXZfbmV0X3N0YXRzWzFdKQogICAgICAgIHNlbGYucHJldl9uZXRfc3RhdHMgPSBbcmVjZWl2ZSwgdHJhbnNtaXRdCgogICAgZGVmIHN0YXRzKHNlbGYpOgogICAgICAgICIiIkNvbGxlY3RzIHN0YXRpc3RpY3MuIiIiCiAgICAgICAgZGF0YSA9IHt9CgogICAgICAgIGlmIHNlbGYucHJvY2ZpbGVzeXN0ZW06CiAgICAgICAgICAgIHNlbGYuY3B1X3N0YXRzKGRhdGEpCiAgICAgICAgICAgIHNlbGYuZGlza19zdGF0cyhkYXRhKQogICAgICAgICAgICBzZWxmLm1lbV9zdGF0cyhkYXRhKQogICAgICAgICAgICBzZWxmLm5ldF9zdGF0cyhkYXRhKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHNlbGYuc3lzID09ICJEYXJ3aW4iOgogICAgICAgICAgICAgICAgc2VsZi5vc3hfdG9wX3N0YXRzKGRhdGEpCiAgICAgICAgICAgICAgICBzZWxmLm5ldHN0YXRzX3N0YXRzKGRhdGEpCiAgICAgICAgICAgIGlmIHNlbGYuc3lzID09ICJTdW5PUyI6CiAgICAgICAgICAgICAgICBzZWxmLnN1bm9zX3RvcF9zdGF0cyhkYXRhKQogICAgICAgICAgICAgICAgc2VsZi5zdW5vc19kaXNrX3N0YXRzKGRhdGEpCiAgICAgICAgICAgICAgICBzZWxmLnN1bm9zX25ldHN0YXRzX3N0YXRzKGRhdGEpCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgbmV3X3JlcXVlc3QocnEpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSBhcGlfcmVxdWVzdCgKICAgICAgICAgICAgICAgIHJxLCBzaWxlbnQ9bm90IGNvbmZpZy5kZWJ1ZywgZGllX29uX2Vycm9yPUZhbHNlKQogICAgICAgICAgICBpZiBjb25maWcuZGVidWdfc3RhdHM6CiAgICAgICAgICAgICAgICBsb2cuaW5mbyhyZXNwb25zZSkKICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIHNjaGVkdWxlKHNlbGYsIG5leHRfc3RlcCk6CiAgICAgICAgaWYgbm90IHNlbGYudG9fcmVtb3ZlOgogICAgICAgICAgICBzZWxmLnRpbWVyID0gdGhyZWFkaW5nLlRpbWVyKG5leHRfc3RlcCwgc2VsZi5zZW5kX3N0YXRzLCAoKSkKICAgICAgICAgICAgc2VsZi50aW1lci5kYWVtb24gPSBUcnVlCiAgICAgICAgICAgIHNlbGYudGltZXIuc3RhcnQoKQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICBzZWxmLnNjaGVkdWxlKDEpCgogICAgZGVmIHNlbmRfc3RhdHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ29sbGVjdHMgYWxsIHN0YXRpc3RpY3MgYW5kIHNlbmRzIHRoZW0gdG8gTG9nZW50cmllcy4KICAgICAgICAiIiIKICAgICAgICBldGhhbG9uID0gdGltZS50aW1lKCkKCiAgICAgICAgcmVzdWx0cyA9IHNlbGYuc3RhdHMoKQogICAgICAgIHJlc3VsdHNbJ3JlcXVlc3QnXSA9IFJRX1dPUktMT0FECiAgICAgICAgcmVzdWx0c1snaG9zdF9rZXknXSA9IGNvbmZpZy5hZ2VudF9rZXkKICAgICAgICBpZiBjb25maWcuZGVidWdfc3RhdHM6CiAgICAgICAgICAgIGxvZy5pbmZvKHJlc3VsdHMpCiAgICAgICAgaWYgbm90IHNlbGYuZmlyc3Q6CiAgICAgICAgICAgICMgU2VuZCBkYXRhCiAgICAgICAgICAgIGlmIG5vdCBjb25maWcuZGF0YWh1YjoKICAgICAgICAgICAgICAgIHNlbGYubmV3X3JlcXVlc3QocmVzdWx0cykKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZpcnN0ID0gRmFsc2UKCiAgICAgICAgZXRoYWxvbiArPSBFUE9DSAogICAgICAgIG5leHRfc3RlcCA9IChldGhhbG9uIC0gdGltZS50aW1lKCkpICUgRVBPQ0gKICAgICAgICBzZWxmLnNjaGVkdWxlKG5leHRfc3RlcCkKCiAgICBkZWYgY2FuY2VsKHNlbGYpOgogICAgICAgIHNlbGYudG9fcmVtb3ZlID0gVHJ1ZQogICAgICAgIGlmIHNlbGYudGltZXI6CiAgICAgICAgICAgIHNlbGYudGltZXIuY2FuY2VsKCkKCmNsYXNzIEZvbGxvd011bHRpbG9nKG9iamVjdCk6CiAgICAiIiIKICAgIFRoZSBGb2xsb3dNdWx0aWxvZyBpcyByZXNwb25zaWJsZSBmb3IgaGFuZGxpbmcgdGhvc2UgbG9ncyB0aGF0IHdlcmUgc2V0LXVwIHVzaW5nIHRoZQogICAgJy0tbXVsdGlsb2cnIG9wdGlvbiBhbmQgdGhhdCBtYXkgaGF2ZSBhIHdpbGRjYXJkIGluIHRoZSBwYXRobmFtZS4KICAgIEluIHdoaWNoIGNhc2UgbXVsdGlwbGUgbG9jYWwgKGxvZykgZmlsZXMgd2lsbCBiZSBmb2xsb3dlZCwgYnV0IHdpdGggYWxsIHRoZSBuZXcgZXZlbnRzCiAgICBmcm9tIGFsbCB0aGUgZmlsZXMgZm9yd2FyZGVkIHRvIHRoZSBzYW1lIHNpbmdsZSBsb2cgaW4gdGhlIGxvZ2VudHJpZXMgaW5mcmFzdHJ1Y3R1cmUuCiAgICAiIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAKICAgICAgICAgICAgICAgICBuYW1lLCAKICAgICAgICAgICAgICAgICBlbnRyeV9maWx0ZXIsIAogICAgICAgICAgICAgICAgIGVudHJ5X2Zvcm1hdHRlciwgCiAgICAgICAgICAgICAgICAgZW50cnlfaWRlbnRpZmllciwgCiAgICAgICAgICAgICAgICAgdHJhbnNwb3J0LCAKICAgICAgICAgICAgICAgICBtYXhfbnVtX2ZvbGxvd2Vycz1NQVhfRklMRVNfRk9MTE9XRUQgKToKICAgICAgICAiIiIgSW5pdGlhbGl6ZXMgdGhlIEZvbGxvd011bHRpbG9nLiAiIiIKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5mbHVzaCA9IFRydWUKICAgICAgICBzZWxmLmVudHJ5X2ZpbHRlciA9IGVudHJ5X2ZpbHRlcgogICAgICAgIHNlbGYuZW50cnlfZm9ybWF0dGVyID0gZW50cnlfZm9ybWF0dGVyCiAgICAgICAgc2VsZi5lbnRyeV9pZGVudGlmaWVyID0gZW50cnlfaWRlbnRpZmllcgogICAgICAgIHNlbGYudHJhbnNwb3J0ID0gdHJhbnNwb3J0CgogICAgICAgIHNlbGYuX3NodXRkb3duID0gRmFsc2UKICAgICAgICBzZWxmLl9tYXhfbnVtX2ZvbGxvd2Vycz1tYXhfbnVtX2ZvbGxvd2VycwogICAgICAgIHNlbGYuX2ZvbGxvd2VycyA9IFtdCiAgICAgICAgc2VsZi5fd29ya2VyID0gdGhyZWFkaW5nLlRocmVhZCgKICAgICAgICAgICAgdGFyZ2V0PXNlbGYuc3VwZXJ2aXNlX2ZvbGxvd2VycywgbmFtZT1zZWxmLm5hbWUpCiAgICAgICAgc2VsZi5fd29ya2VyLmRhZW1vbiA9IFRydWUKICAgICAgICBzZWxmLl93b3JrZXIuc3RhcnQoKQoKICAgIGRlZiBfZmlsZV90ZXN0KHNlbGYsIGNhbmRpZGF0ZSk6CiAgICAgICAgIiIiCiAgICAgICAgT25seSByZWd1bGFyIGZpbGVzIHBhc3NlZAogICAgICAgICIiIgogICAgICAgICMgRmFpbCBpZiBhIHN5bWJvbGljIGxpbmsKICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhjYW5kaWRhdGUpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAjIEZhaWwgaWYgbm90IGEgcmVndWxhciBmaWxlIChwYXNzZXMgbGlua3MhKQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShjYW5kaWRhdGUpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgX2FwcGVuZF9mb2xsb3dlcnMoc2VsZiwgYWRkX2ZpbGVzKTogICAgICAgIAogICAgICAgIGZvciBmaWxlbmFtZSBpbiBhZGRfZmlsZXM6CiAgICAgICAgICAgIGlmIGxlbihzZWxmLl9mb2xsb3dlcnMpIDwgc2VsZi5fbWF4X251bV9mb2xsb3dlcnM6ICAgICAgICAKICAgICAgICAgICAgICAgIGZvbGxvd2VyID0gRm9sbG93ZXIoZmlsZW5hbWUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVudHJ5X2ZpbHRlciwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW50cnlfZm9ybWF0dGVyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lbnRyeV9pZGVudGlmaWVyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc3BvcnQsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUcnVlKQogICAgICAgICAgICAgICAgc2VsZi5fZm9sbG93ZXJzLmFwcGVuZChmb2xsb3dlcikKICAgICAgICAgICAgICAgIGlmIGNvbmZpZy5kZWJ1Z19tdWx0aWxvZzoKICAgICAgICAgICAgICAgICAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAiTnVtYmVyIG9mIGZvbGxvd2VycyBpbmNyZWFzZWQgdG86ICVzICIgJWxlbihzZWxmLl9mb2xsb3dlcnMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2cuZGVidWcoIldhcm5pbmc6IEFsbG93ZWQgbWF4aW11bSBvZiBmaWxlcyB0aGF0IGNhbiBiZSBmb2xsb3dlZCByZWFjaGVkIikKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgZGVmIF9yZW1vdmVfZm9sbG93ZXJzKHNlbGYsIHJlbW92ZWRfZmlsZXMpOgogICAgICAgIGZvciBmb2xsb3dlciBpbiBzZWxmLl9mb2xsb3dlcnM6CiAgICAgICAgICAgIGlmIGZvbGxvd2VyLm5hbWUgaW4gcmVtb3ZlZF9maWxlczogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb2xsb3dlci5jbG9zZSgpCiAgICAgICAgICAgICAgICBzZWxmLl9mb2xsb3dlcnMucmVtb3ZlKGZvbGxvd2VyKQogICAgICAgICAgICAgICAgaWYgY29uZmlnLmRlYnVnX211bHRpbG9nOgogICAgICAgICAgICAgICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsICJOdW1iZXIgb2YgZm9sbG93ZXJzIGRlY3JlYXNlZCB0bzogJXMgIiAlbGVuKHNlbGYuX2ZvbGxvd2VycykKICAgICAgICAgICAgICAgIAogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFN0b3BzIGFsbCBGb2xsb3dNdWx0aWxvZyBhY3Rpdml0eSwgYW5kIHRoZW4gbG9vcHMgdGhyb3VnaCBsaXN0IG9mIGV4aXN0aW5nCiAgICAgICAgZm9sbG93ZXJzIHRvIGNsb3NlIGVhY2ggb25lIC0gdGhlbiB3YWl0cyBmb3IgdGhlIHdvcmtlciB0aHJlYWQgdG8gc3RvcC4KICAgICAgICAiIiIKICAgICAgICBzZWxmLl9zaHV0ZG93biA9IFRydWUKICAgICAgICAjIFJ1biB0aHJvdWdoIGxpc3Qgb2YgZm9sbG93ZXJzIGNsb3NpbmcgZWFjaCBvbmUKICAgICAgICBmb3IgZm9sbG93ZXIgaW4gc2VsZi5fZm9sbG93ZXJzOgogICAgICAgICAgICBmb2xsb3dlci5jbG9zZSgpCiAgICAgICAgc2VsZi5fd29ya2VyLmpvaW4oRk9MTE9XTVVMVElfSk9JTl9JTlRFUlZBTCkKICAgICAgICAKICAgIGRlZiBzdXBlcnZpc2VfZm9sbG93ZXJzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgICBJbnN0YW50aWF0ZXMgYSBGb2xsb3dlciBvYmplY3QgZm9yIGVhY2ggZmlsZSBmb3VuZCAtIGFsbCBsb2cgZXZlbnRzIGZyb20gYWxsCiAgICAgICAgIGZpbGVzIGFyZSBmb3J3YXJkZWQgdG8gdGhlIHNhbWUgbG9nIGluIHRoZSBsRSBpbmZyYXN0cnVjdHVyZQogICAgICAgICIiIiAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3NldCA9IHNldChbZmlsZW5hbWUgZm9yIGZpbGVuYW1lIGluIGdsb2IuZ2xvYihzZWxmLm5hbWUpXSkgICAgICAgICAKICAgICAgICBleGNlcHQgb3MuZXJyb3I6CiAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3I6IEZvbGxvd2VyTXVsdGlwbGUgZ2xvYiBoYXMgZmFpbGVkIikKICAgICAgICBpZiBsZW4oc3RhcnRfc2V0KSA9PSAwOgogICAgICAgICAgICBsb2cuZXJyb3IoIkZvbGxvd011bHRpbG9nOiBubyBmaWxlcyBmb3VuZCBpbiBPUyB0byBiZSBmb2xsb3dlZCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5fYXBwZW5kX2ZvbGxvd2VycyhzdGFydF9zZXQpCiAgICAgICAgd2hpbGUgbm90IHNlbGYuX3NodXRkb3duOgogICAgICAgICAgICB0aW1lLnNsZWVwKFJFVFJZX0dMT0JfSU5URVJWQUwpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGN1cnJlbnRfc2V0ID0gc2V0KFtmaWxlbmFtZSBmb3IgZmlsZW5hbWUgaW4gZ2xvYi5nbG9iKHNlbGYubmFtZSldKSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IG9zLmVycm9yOgogICAgICAgICAgICAgICAgbG9nLmVycm9yKCJFcnJvcjogRm9sbG93ZXJNdWx0aXBsZSBnbG9iIGhhcyBmYWlsZWQiKQogICAgICAgICAgICBmb2xsb3dlZF9maWxlcyA9IFtmb2xsb3dlci5uYW1lIGZvciBmb2xsb3dlciBpbiBzZWxmLl9mb2xsb3dlcnNdCiAgICAgICAgICAgIGFkZGVkX2ZpbGVzID0gW2ZpbGVuYW1lIGZvciBmaWxlbmFtZSBpbiBjdXJyZW50X3NldCBpZiBub3QgZmlsZW5hbWUgaW4gZm9sbG93ZWRfZmlsZXNdICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9mb2xsb3dlcnMoYWRkZWRfZmlsZXMpICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZW1vdmVkX2ZpbGVzID0gW2ZpbGVuYW1lIGZvciBmaWxlbmFtZSBpbiBmb2xsb3dlZF9maWxlcyBpZiBub3QgZmlsZW5hbWUgaW4gY3VycmVudF9zZXRdCiAgICAgICAgICAgIHNlbGYuX3JlbW92ZV9mb2xsb3dlcnMocmVtb3ZlZF9maWxlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgpjbGFzcyBGb2xsb3dlcihvYmplY3QpOgoKICAgICIiIgogICAgVGhlIGZvbGxvd2VyIGtlZXBzIGFuIGV5ZSBvbiB0aGUgZmlsZSBzcGVjaWZpZWQgYW5kIHNlbmRzIG5ldyBldmVudHMgdG8gdGhlCiAgICBsb2dlbnRyaWVzIGluZnJhc3RydWN0dXJlLiAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIAogICAgICAgICAgICAgICAgIG5hbWUsIAogICAgICAgICAgICAgICAgIGVudHJ5X2ZpbHRlciwgCiAgICAgICAgICAgICAgICAgZW50cnlfZm9ybWF0dGVyLCAKICAgICAgICAgICAgICAgICBlbnRyeV9pZGVudGlmaWVyLCAKICAgICAgICAgICAgICAgICB0cmFuc3BvcnQsIAogICAgICAgICAgICAgICAgIGRpc2FibGVfZ2xvYj1GYWxzZSk6CiAgICAgICAgIiIiIEluaXRpYWxpemVzIHRoZSBmb2xsb3dlci4gIiIiCiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQogICAgICAgIHNlbGYuZmx1c2ggPSBUcnVlCiAgICAgICAgc2VsZi5lbnRyeV9maWx0ZXIgPSBlbnRyeV9maWx0ZXIKICAgICAgICBzZWxmLmVudHJ5X2Zvcm1hdHRlciA9IGVudHJ5X2Zvcm1hdHRlcgogICAgICAgIHNlbGYuZW50cnlfaWRlbnRpZmllciA9IGVudHJ5X2lkZW50aWZpZXIKICAgICAgICBzZWxmLnRyYW5zcG9ydCA9IHRyYW5zcG9ydAogICAgICAgICMgRm9sbG93TXVsdGlsb2cgdXNhZ2UKICAgICAgICBzZWxmLl9kaXNhYmxlX2dsb2IgPSBkaXNhYmxlX2dsb2IKCiAgICAgICAgc2VsZi5fZmlsZSA9IE5vbmUKICAgICAgICBzZWxmLl9zaHV0ZG93biA9IEZhbHNlCiAgICAgICAgc2VsZi5fcmVhZF9maWxlX3Jlc3QgPSAnJwogICAgICAgIHNlbGYuX2VudHJ5X3Jlc3QgPSBbXQogICAgICAgIHNlbGYuX3dvcmtlciA9IHRocmVhZGluZy5UaHJlYWQoCiAgICAgICAgICAgIHRhcmdldD1zZWxmLm1vbml0b3Jsb2dzLCBuYW1lPXNlbGYubmFtZSkKICAgICAgICBzZWxmLl93b3JrZXIuZGFlbW9uID0gVHJ1ZQogICAgICAgIHNlbGYuX3dvcmtlci5zdGFydCgpCgogICAgZGVmIF9maWxlX2NhbmRpZGF0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGxpc3Qgb2YgZmlsZSBuYW1lcyB3aGljaCBjb3JyZXNwb25kcyB0byB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY2FuZGlkYXRlcyA9IGdsb2IuZ2xvYihzZWxmLm5hbWUpCgogICAgICAgICAgICBpZiBsZW4oY2FuZGlkYXRlcykgPT0gMDoKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICBjYW5kaWRhdGVfdGltZXMgPSBbW29zLnBhdGguZ2V0bXRpbWUobmFtZSksIG5hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgbmFtZSBpbiBjYW5kaWRhdGVzXQogICAgICAgICAgICBjYW5kaWRhdGVfdGltZXMuc29ydCgpCiAgICAgICAgICAgIGNhbmRpZGF0ZV90aW1lcy5yZXZlcnNlKCkKICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZV90aW1lc1swXVsxXQogICAgICAgIGV4Y2VwdCBvcy5lcnJvcjoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX29wZW5fbG9nKHNlbGYpOgogICAgICAgICIiIktlZXBzIHRyeWluZyB0byByZS1vcGVuIHRoZSBsb2cgZmlsZS4gUmV0dXJucyB3aGVuIHRoZSBmaWxlIGhhcyBiZWVuCiAgICAgICAgb3BlbmVkIG9yIHdoZW4gcmVxdWVzdGVkIHRvIHJlbW92ZS4gICIiIgogICAgICAgIGVycm9yX2luZm8gPSBUcnVlCiAgICAgICAgc2VsZi5yZWFsX25hbWUgPSBOb25lCgogICAgICAgIHdoaWxlIG5vdCBzZWxmLl9zaHV0ZG93bjoKICAgICAgICAgICAgIyBGb2xsb3dNdWx0aWxvZyB1c2FnZQogICAgICAgICAgICBpZiBzZWxmLl9kaXNhYmxlX2dsb2I6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGUgPSBzZWxmLm5hbWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZSA9IHNlbGYuX2ZpbGVfY2FuZGlkYXRlKCkKCiAgICAgICAgICAgIGlmIGNhbmRpZGF0ZToKICAgICAgICAgICAgICAgIHNlbGYucmVhbF9uYW1lID0gY2FuZGlkYXRlCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfbG9nKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9maWxlID0gb3BlbihzZWxmLnJlYWxfbmFtZSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZXhjZXB0IElPRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgaWYgZXJyb3JfaW5mbzoKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCJDYW5ub3Qgb3BlbiBmaWxlICclcycsIHJlLXRyeWluZyBpbiAlc3MgaW50ZXJ2YWxzIiwKICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubmFtZSwgUkVPUEVOX0lOVCkKICAgICAgICAgICAgICAgIGVycm9yX2luZm8gPSBGYWxzZQogICAgICAgICAgICB0aW1lLnNsZWVwKFJFT1BFTl9UUllfSU5URVJWQUwpCgogICAgZGVmIF9jbG9zZV9sb2coc2VsZik6CiAgICAgICAgaWYgc2VsZi5fZmlsZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fZmlsZS5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBzZWxmLl9maWxlID0gTm9uZQoKICAgIGRlZiBfbG9nX3JlbmFtZShzZWxmKToKICAgICAgICAiIiJEZXRlY3RzIGZpbGUgcmVuYW1lLiIiIgoKICAgICAgICAjIEdldCBmaWxlIGNhbmRpZGF0ZXMKICAgICAgICBjYW5kaWRhdGUgPSBzZWxmLl9maWxlX2NhbmRpZGF0ZSgpCiAgICAgICAgaWYgbm90IGNhbmRpZGF0ZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHRyeToKICAgICAgICAgICAgY3RpbWUxID0gb3MuZnN0YXQoc2VsZi5fZmlsZS5maWxlbm8oKSkuc3RfbXRpbWUKICAgICAgICAgICAgY3RpbWVfbmV3ID0gb3MucGF0aC5nZXRtdGltZShjYW5kaWRhdGUpCiAgICAgICAgICAgIGN0aW1lMiA9IG9zLmZzdGF0KHNlbGYuX2ZpbGUuZmlsZW5vKCkpLnN0X210aW1lCiAgICAgICAgZXhjZXB0IG9zLmVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIGN0aW1lMSA9PSBjdGltZTIgYW5kIGN0aW1lMSAhPSBjdGltZV9uZXc6CiAgICAgICAgICAgICMgV2UgaGF2ZSBhIG5hbWUgY2hhbmdlIGFjY29yZGluZyB0byB0aGUgdGltZQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3JlYWRfbG9nX2xpbmVzKHNlbGYpOgogICAgICAgICIiIiBSZWFkcyBhIGJsb2NrIG9mIGxpbmVzIGZyb20gdGhlIGxvZy4gQ2hlY2tzIG1heGltYWwgbGluZSBzaXplLiAiIiIKICAgICAgICBidWZmID0gc2VsZi5fZmlsZS5yZWFkKE1BWF9CTE9DS19TSVpFIC0gbGVuKHNlbGYuX3JlYWRfZmlsZV9yZXN0KSkKICAgICAgICBidWZmX2xpbmVzID0gYnVmZi5zcGxpdCgnXG4nKQogICAgICAgIGlmIGxlbihzZWxmLl9yZWFkX2ZpbGVfcmVzdCkgPiAwOgogICAgICAgICAgICBidWZmX2xpbmVzWzBdID0gc2VsZi5fcmVhZF9maWxlX3Jlc3QgKyBidWZmX2xpbmVzWzBdCgogICAgICAgIHNlbGYuX3JlYWRfZmlsZV9yZXN0ID0gYnVmZl9saW5lc1stMV0KCiAgICAgICAgIyBMaW1pdCBzaXplIG9mIF9yZWFkX2ZpbGVfcmVzdAogICAgICAgIGlmIGxlbihzZWxmLl9yZWFkX2ZpbGVfcmVzdCkgPj0gTUFYX0JMT0NLX1NJWkU6CiAgICAgICAgICAgIGJ1ZmZfbGluZXMuYXBwZW5kKHNlbGYuX3JlYWRfZmlsZV9yZXN0WzpNQVhfQkxPQ0tfU0laRV0pCiAgICAgICAgICAgIHNlbGYuX3JlYWRfZmlsZV9yZXN0ID0gc2VsZi5fcmVhZF9maWxlX3Jlc3RbTUFYX0JMT0NLX1NJWkU6XQoKICAgICAgICByZXR1cm4gW2xpbmUuZGVjb2RlKCd1dGYtOCcsICdpZ25vcmUnKSBmb3IgbGluZSBpbiBidWZmX2xpbmVzWzotMV1dCgogICAgZGVmIF9zZXRfZmlsZV9wb3NpdGlvbihzZWxmLCBvZmZzZXQsIHN0YXJ0PUZJTEVfQkVHSU4pOgogICAgICAgICIiIiBNb3ZlIHRoZSBwb3NpdGlvbiBvZiBmaWxlcG9pbnRlcnMuIiIiCiAgICAgICAgc2VsZi5fZmlsZS5zZWVrKG9mZnNldCwgc3RhcnQpCgogICAgZGVmIF9nZXRfZmlsZV9wb3NpdGlvbihzZWxmKToKICAgICAgICAiIiIgUmV0dXJucyB0aGUgcG9zaXRpb24gZmlsZXBvaW50ZXJzLiIiIgogICAgICAgIHBvcyA9IHNlbGYuX2ZpbGUudGVsbCgpCiAgICAgICAgcmV0dXJuIHBvcwoKICAgIGRlZiBfY29sbGVjdF9saW5lcyhzZWxmLCBsaW5lcyk6CiAgICAgICAgIiIiQWNjZXB0cyBsaW5lcyByZWNlaXZlZCBhbmQgbWVyZ2VzIHRoZW0gdG8gbXVsdGlsaW5lIGV2ZW50cy4KICAgICAgICAiIiIKICAgICAgICAjIEZhc3QgdHJhY2sKICAgICAgICBpZiBub3Qgc2VsZi5lbnRyeV9pZGVudGlmaWVyOgogICAgICAgICAgICByZXR1cm4gbGluZXMKICAgICAgICBpZiBub3QgbGluZXM6CiAgICAgICAgICAgIGlmIHNlbGYuX2VudHJ5X3Jlc3Q6CiAgICAgICAgICAgICAgICB4ID0gW0xJTkVfU0VQQVJBVE9SLmpvaW4oc2VsZi5fZW50cnlfcmVzdCldCiAgICAgICAgICAgICAgICBzZWxmLl9lbnRyeV9yZXN0ID0gW10KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHggPSBbXQogICAgICAgICAgICByZXR1cm4geAogICAgICAgICMgRW50cnkgc2VwYXJhdG9yIGlzIHNwZWNpZmllZAogICAgICAgIG5ld19saW5lcyA9IFtdCiAgICAgICAgbmV3X2VudHJ5ID0gc2VsZi5fZW50cnlfcmVzdAogICAgICAgIHNlbGYuX2VudHJ5X3Jlc3QgPSBbXQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBpZiBzZWxmLmVudHJ5X2lkZW50aWZpZXIuc2VhcmNoKGxpbmUpOgogICAgICAgICAgICAgICAgaWYgbmV3X2VudHJ5OgogICAgICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoTElORV9TRVBBUkFUT1Iuam9pbihuZXdfZW50cnkpKQogICAgICAgICAgICAgICAgICAgIG5ld19lbnRyeSA9IFtdCiAgICAgICAgICAgICAgICBuZXdfZW50cnkuYXBwZW5kKGxpbmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBuZXdfZW50cnkuYXBwZW5kKGxpbmUpCiAgICAgICAgc2VsZi5fZW50cnlfcmVzdCA9IG5ld19lbnRyeQogICAgICAgIHJldHVybiBuZXdfbGluZXMKCiAgICBkZWYgX2dldF9saW5lcyhzZWxmKToKICAgICAgICAiIiJSZXR1cm5zIGEgYmxvY2sgb2YgbmV3bHkgZGV0ZWN0ZWQgbGluZSBmcm9tIHRoZSBsb2cuIFJldHVybnMgTm9uZSBpbgogICAgICAgIGNhc2Ugb2YgdGltZW91dC4KICAgICAgICAiIiIKICAgICAgICAjIE1vdmVzIGF0IHRoZSBlbmQgb2YgdGhlIGxvZyBmaWxlCiAgICAgICAgaWYgc2VsZi5mbHVzaDoKICAgICAgICAgICAgc2VsZi5fc2V0X2ZpbGVfcG9zaXRpb24oMCwgRklMRV9FTkQpCiAgICAgICAgICAgIHNlbGYuZmx1c2ggPSBGYWxzZQoKICAgICAgICAjIFRPRE86IGludmVzdGlnYXRlIHNlbGVjdC1saWtlIGFwcHJvYWNoPwogICAgICAgIGlkbGVfY250ID0gMAogICAgICAgIGlhYV9jbnQgPSAwCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIHdoaWxlIGlhYV9jbnQgIT0gSUFBX0lOVEVSVkFMIGFuZCBub3Qgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgICMgQ29sbGVjdCBsaW5lcwogICAgICAgICAgICBsaW5lcyA9IHNlbGYuX3JlYWRfbG9nX2xpbmVzKCkKICAgICAgICAgICAgbGluZXMgPSBzZWxmLl9jb2xsZWN0X2xpbmVzKGxpbmVzKQogICAgICAgICAgICBpZiBsaW5lczoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAjIE5vIGxpbmUsIHdhaXQKICAgICAgICAgICAgdGltZS5zbGVlcChUQUlMX1JFQ0hFQ0spCgogICAgICAgICAgICBsaW5lcyA9IHNlbGYuX2NvbGxlY3RfbGluZXMoW10pCiAgICAgICAgICAgIGlmIGxpbmVzOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICMgTG9nIHJlbmFtZSBjaGVjawogICAgICAgICAgICBpZGxlX2NudCArPSAxCiAgICAgICAgICAgIGlmIGlkbGVfY250ID09IE5BTUVfQ0hFQ0s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9sb2dfcmVuYW1lKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fb3Blbl9sb2coKQogICAgICAgICAgICAgICAgICAgIGlhYV9jbnQgPSAwCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgUmVjb3ZlciBmcm9tIGV4dGVybmFsIGZpbGUgbW9kaWZpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gPSBzZWxmLl9nZXRfZmlsZV9wb3NpdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2ZpbGVfcG9zaXRpb24oMCwgRklMRV9FTkQpCiAgICAgICAgICAgICAgICAgICAgZmlsZV9zaXplID0gc2VsZi5fZ2V0X2ZpbGVfcG9zaXRpb24oKQoKICAgICAgICAgICAgICAgICAgICBpZiBmaWxlX3NpemUgPCBwb3NpdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBGaWxlIGhhcyBiZWVuIGV4dGVybmFseSBtb2RpZmllZAogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IDAKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfZmlsZV9wb3NpdGlvbihwb3NpdGlvbikKICAgICAgICAgICAgICAgIGlkbGVfY250ID0gMAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUbyByZXNldCBlbmQtb2YtbGluZSBlcnJvcgogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2ZpbGVfcG9zaXRpb24oc2VsZi5fZ2V0X2ZpbGVfcG9zaXRpb24oKSkKICAgICAgICAgICAgaWFhX2NudCArPSAxCgogICAgICAgIHJldHVybiBsaW5lcwoKICAgIGRlZiBfc2VuZF9saW5lcyhzZWxmLCBsaW5lcyk6CiAgICAgICAgIiIiIFNlbmRzIGxpbmVzLiAiIiIKICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBsaW5lID0gc2VsZi5lbnRyeV9maWx0ZXIobGluZSkKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBjb25maWcuZGVidWdfZXZlbnRzOgogICAgICAgICAgICAgICAgcHJpbnQgPj4gc3lzLnN0ZGVyciwgbGluZQogICAgICAgICAgICBsaW5lID0gc2VsZi5lbnRyeV9mb3JtYXR0ZXIobGluZSkKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBzZWxmLnRyYW5zcG9ydC5zZW5kKGxpbmUpCgogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIkNsb3NlcyB0aGUgZm9sbG93ZXIgYnkgc2V0dGluZyB0aGUgc2h1dGRvd24gZmxhZyBhbmQgd2FpdGluZyBmb3IgdGhlCiAgICAgICAgd29ya2VyIHRocmVhZCB0byBzdG9wLiIiIgogICAgICAgIHNlbGYuX3NodXRkb3duID0gVHJ1ZQogICAgICAgIHNlbGYuX3dvcmtlci5qb2luKEZPTExPV0VSX0pPSU5fSU5URVJWQUwpCgogICAgZGVmIG1vbml0b3Jsb2dzKHNlbGYpOgogICAgICAgICIiIiBPcGVucyB0aGUgbG9nIGZpbGUgYW5kIHN0YXJ0cyB0byBjb2xsZWN0IG5ldyBldmVudHMuICIiIgogICAgICAgIHNlbGYuX29wZW5fbG9nKCkKICAgICAgICB3aGlsZSBub3Qgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxpbmVzID0gc2VsZi5fZ2V0X2xpbmVzKCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZW5kX2xpbmVzKGxpbmVzKQogICAgICAgICAgICAgICAgZXhjZXB0IElPRXJyb3IsIGU6CiAgICAgICAgICAgICAgICAgICAgaWYgY29uZmlnLmRlYnVnOgogICAgICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoIklPRXJyb3I6ICVzIiwgZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9vcGVuX2xvZygpCiAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yLCBlOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKCJVbmljb2RlRXJyb3Igc2VuZGluZyBsaW5lcyBgJXMnIiwgbGluZXMsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiQ2F1Z2h0IHVua25vd24gZXJyb3IgYCVzJyB3aGlsZSBzZW5kaW5nIGxpbmVzICVzIiwgZSwgbGluZXMsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkNhdWdodCB1bmtub3duIGVycm9yIGAlcycgd2hpbGUgc2VuZGluZyBsaW5lIiwgZSwgZXhjX2luZm89VHJ1ZSkKICAgICAgICBzZWxmLl9jbG9zZV9sb2coKQoKCmNsYXNzIFRyYW5zcG9ydChvYmplY3QpOgoKICAgICIiIkVuY2Fwc3VsYXRlcyBzaW1wbGUgY29ubmVjdGlvbiB0byBhIHJlbW90ZSBob3N0LiBUaGUgY29ubmVjdGlvbiBtYXkgYmUKICAgIGVuY3J5cHRlZC4gRWFjaCBjb21tdW5pY2F0aW9uIGlzIHN0YXJ0ZWQgd2l0aCB0aGUgcHJlYW1ibGUuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGVuZHBvaW50LCBwb3J0LCB1c2Vfc3NsLCBwcmVhbWJsZSwgZGVidWdfdHJhbnNwb3J0X2V2ZW50cywgcHJveHkpOgogICAgICAgICMgQ29weSB0cmFuc3BvcnQgY29uZmlndXJhdGlvbgogICAgICAgIHNlbGYuZW5kcG9pbnQgPSBlbmRwb2ludAogICAgICAgIHNlbGYucG9ydCA9IHBvcnQKICAgICAgICBzZWxmLnVzZV9zc2wgPSB1c2Vfc3NsCiAgICAgICAgc2VsZi5wcmVhbWJsZSA9IHByZWFtYmxlCiAgICAgICAgc2VsZi5fZW50cmllcyA9IFF1ZXVlLlF1ZXVlKFNFTkRfUVVFVUVfU0laRSkKICAgICAgICBzZWxmLl9zb2NrZXQgPSBOb25lICMgU29ja2V0IHdpdGggb3B0aW9uYWwgVExTIGVuY3lwdGlvbgogICAgICAgIHNlbGYuX2RlYnVnX3RyYW5zcG9ydF9ldmVudHMgPSBkZWJ1Z190cmFuc3BvcnRfZXZlbnRzCgogICAgICAgIHNlbGYuX3NodXRkb3duID0gRmFsc2UKCiAgICAgICAgIyBwcm94eSBzZXR1cAogICAgICAgIHNlbGYuX3VzZV9wcm94eSA9IEZhbHNlCgogICAgICAgIChwcm94eV90eXBlX3N0ciwgc2VsZi5fcHJveHlfdXJsLCBzZWxmLl9wcm94eV9wb3J0KSA9IHByb3h5CgogICAgICAgIGlmIHByb3h5X3R5cGVfc3RyICE9IE5PVF9TRVQgYW5kIHNlbGYuX3Byb3h5X3VybCAhPSBOT1RfU0VUIGFuZCBzZWxmLl9wcm94eV9wb3J0ICE9IE5PVF9TRVQ6CiAgICAgICAgICAgIHNlbGYuX3VzZV9wcm94eSA9IFRydWUKICAgICAgICAgICAgaWYgcHJveHlfdHlwZV9zdHIgPT0gIkhUVFAiOgogICAgICAgICAgICAgICAgc2VsZi5fcHJveHlfdHlwZSA9IHNvY2tzLlBST1hZX1RZUEVfSFRUUAogICAgICAgICAgICBlbGlmIHByb3h5X3R5cGVfc3RyID09ICJTT0NLUzUiOgogICAgICAgICAgICAgICAgc2VsZi5fcHJveHlfdHlwZSA9IHNvY2tzLlBST1hZX1RZUEVfU09DS1M1CiAgICAgICAgICAgIGVsaWYgcHJveHlfdHlwZV9zdHIgPT0gIlNPQ0tTNCI6CiAgICAgICAgICAgICAgICBzZWxmLl9wcm94eV90eXBlID0gc29ja3MuUFJPWFlfVFlQRV9TT0NLUzQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuX3VzZV9wcm94eSA9IEZhbHNlCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkludmFsaWRlIHByb3h5IHR5cGUuIE9ubHkgSFRUUCwgU09DS1M1IGFuZCBTT0NLUzQgYXJlIGFjY2VwdGVkIikKCiAgICAgICAgaWYgc2VsZi5fdXNlX3Byb3h5OgogICAgICAgICAgICBsb2cuaW5mbygiVXNpbmcgcHJveHkgd2l0aCBwcm94eV90eXBlOiAlcywgcHJveHktdXJsOiAlcywgcHJveHktcG9ydDogJXMiLAogICAgICAgICAgICAgICAgICAgICBwcm94eV90eXBlX3N0ciwgc2VsZi5fcHJveHlfdXJsLCBzZWxmLl9wcm94eV9wb3J0KQoKICAgICAgICAjIEdldCBjZXJ0aWZpY2F0ZSBuYW1lCiAgICAgICAgY2VydF9uYW1lID0gTm9uZQogICAgICAgIGlmIG5vdCBjb25maWcudXNlX2NhX3Byb3ZpZGVkOgogICAgICAgICAgICBjZXJ0X25hbWUgPSBzeXN0ZW1fY2VydF9maWxlKCkKICAgICAgICAgICAgaWYgY2VydF9uYW1lIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjZXJ0X25hbWUgPSBkZWZhdWx0X2NlcnRfZmlsZShjb25maWcpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2VydF9uYW1lID0gZGVmYXVsdF9jZXJ0X2ZpbGUoY29uZmlnKQoKICAgICAgICBpZiB1c2Vfc3NsIGFuZCBub3QgY2VydF9uYW1lOgogICAgICAgICAgICBkaWUoJ0Nhbm5vdCBnZXQgZGVmYXVsdCBjZXJ0aWZpY2F0ZSBmaWxlIG5hbWUgdG8gcHJvdmlkZSBjb25uZWN0aW9uIG92ZXIgU1NMIScpCiAgICAgICAgICAgICMgWFhYIERvIHdlIG5lZWQgdG8gZGllIGhlcmU/CiAgICAgICAgc2VsZi5fY2VydHMgPSBjZXJ0X25hbWUKCiAgICAgICAgIyBTdGFydCBhc3luY2hyb25vdXMgd29ya2VyCiAgICAgICAgc2VsZi5fd29ya2VyID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5ydW4pCiAgICAgICAgc2VsZi5fd29ya2VyLmRhZW1vbiA9IFRydWUKICAgICAgICBzZWxmLl93b3JrZXIuc3RhcnQoKQoKICAgIGRlZiBfZ2V0X2FkZHJlc3Moc2VsZiwgdXNlX3Byb3h5KToKICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmVuZHBvaW50CiAgICAgICAgZWxzZToKICAgICAgICAgICAgIiIiUmV0dXJucyBhbiBJUCBhZGRyZXNzIG9mIHRoZSBlbmRwb2ludC4gSWYgdGhlIGVuZHBvaW50IHJlc29sdmVzIHRvCiAgICAgICAgICAgIG11bHRpcGxlIGFkZHJlc3NlcywgYSByYW5kb20gb25lIGlzIHNlbGVjdGVkLiBUaGlzIHdvcmtzIGJldHRlciB0aGFuCiAgICAgICAgICAgIGRlZmF1bHQgc2VsZWN0aW9uLiIiIgogICAgICAgICAgICByZXR1cm4gcmFuZG9tLmNob2ljZSgKICAgICAgICAgICAgICAgIHNvY2tldC5nZXRhZGRyaW5mbyhzZWxmLmVuZHBvaW50LCBzZWxmLnBvcnQpKVs0XVswXQoKICAgIGRlZiBfY29ubmVjdF9zc2woc2VsZiwgcGxhaW5fc29ja2V0KToKICAgICAgICAiIiJDb25uZWN0cyB0aGUgc29ja2V0IGFuZCB3cmFwcyBpbiBTU0wuIFJldHVybnMgdGhlIHdyYXBwZWQgc29ja2V0CiAgICAgICAgb3IgTm9uZSBpbiBjYXNlIG9mIElPIG9yIG90aGVyIGVycm9ycy4iIiIKICAgICAgICAjIEZJWE1FIHRoaXMgY29kZSBpZ25vcmVzIC0tbG9jYWwKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFkZHJlc3MgPSAnLScKICAgICAgICAgICAgYWRkcmVzcyA9IHNlbGYuX2dldF9hZGRyZXNzKHNlbGYuX3VzZV9wcm94eSkKICAgICAgICAgICAgcyA9IHBsYWluX3NvY2tldAogICAgICAgICAgICBzLmNvbm5lY3QoKGFkZHJlc3MsIHNlbGYucG9ydCkpCgogICAgICAgICAgICBpZiBGRUFUX1NTTDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzID0gd3JhcF9zb2NrZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWluX3NvY2tldCwgY2FfY2VydHM9c2VsZi5fY2VydHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwgc3NsX3ZlcnNpb249c3NsLlBST1RPQ09MX1RMU3YxLAogICAgICAgICAgICAgICAgICAgICAgICBjaXBoZXJzPSJISUdIOi1hTlVMTDotZU5VTEw6LVBTSzpSQzQtU0hBOlJDNC1NRDUiKQogICAgICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBzID0gd3JhcF9zb2NrZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWluX3NvY2tldCwgY2FfY2VydHM9c2VsZi5fY2VydHMsIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwKICAgICAgICAgICAgICAgICAgICAgICAgc3NsX3ZlcnNpb249c3NsLlBST1RPQ09MX1RMU3YxKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtYXRjaF9ob3N0bmFtZShzLmdldHBlZXJjZXJ0KCksIHNlbGYuZW5kcG9pbnQpCiAgICAgICAgICAgICAgICBleGNlcHQgQ2VydGlmaWNhdGVFcnJvciwgY2U6CiAgICAgICAgICAgICAgICAgICAgcmVwb3J0KCJDb3VsZCBub3QgdmFsaWRhdGUgU1NMIGNlcnRpZmljYXRlIGZvciAlczogJXMiICUKICAgICAgICAgICAgICAgICAgICAgICAgKHNlbGYuZW5kcG9pbnQsIGNlLm1lc3NhZ2UpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzID0gd3JhcF9zb2NrZXQocGxhaW5fc29ja2V0LCBjYV9jZXJ0cz1zZWxmLl9jZXJ0cykKICAgICAgICAgICAgcmV0dXJuIHMKCiAgICAgICAgZXhjZXB0IElPRXJyb3IsIGU6CiAgICAgICAgICAgIGNhdXNlID0gZS5zdHJlcnJvcgogICAgICAgICAgICBpZiBub3QgY2F1c2U6CiAgICAgICAgICAgICAgICBjYXVzZSA9ICIoTm8gcmVhc29uIGdpdmVuKSIKICAgICAgICAgICAgcmVwb3J0KCJDYW4ndCBjb25uZWN0IHRvICVzLyVzIHZpYSBTU0wgYXQgcG9ydCAlcy4gTWFrZSBzdXJlIHRoYXQgdGhlIGhvc3QgYW5kIHBvcnQgYXJlIHJlYWNoYWJsZSAiCiAgICAgICAgICAgICAgICAgICAiYW5kIHNwZWFrIFNTTDogJXMiICUgKHNlbGYuZW5kcG9pbnQsIGFkZHJlc3MsIHNlbGYucG9ydCwgY2F1c2UpKQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9jb25uZWN0X3BsYWluKHNlbGYsIHBsYWluX3NvY2tldCk6CiAgICAgICAgIiIiQ29ubmVjdHMgdGhlIHNvY2tldCB3aXRoIHRoZSBzb2NrZXQgZ2l2ZW4uIFJldHVybnMgdGhlIHNvY2tldCBvciBOb25lIGluIGNhc2Ugb2YgSU8gZXJyb3JzLiIiIgogICAgICAgIGFkZHJlc3MgPSBzZWxmLl9nZXRfYWRkcmVzcyhzZWxmLl91c2VfcHJveHkpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwbGFpbl9zb2NrZXQuY29ubmVjdCgoYWRkcmVzcywgc2VsZi5wb3J0KSkKICAgICAgICBleGNlcHQgSU9FcnJvciwgZToKICAgICAgICAgICAgY2F1c2UgPSBlLnN0cmVycm9yCiAgICAgICAgICAgIGlmIG5vdCBjYXVzZToKICAgICAgICAgICAgICAgIGNhdXNlID0gIiIKICAgICAgICAgICAgcmVwb3J0KCJDYW4ndCBjb25uZWN0IHRvICVzLyVzIGF0IHBvcnQgJXMuIE1ha2Ugc3VyZSB0aGF0IHRoZSBob3N0IGFuZCBwb3J0IGFyZSByZWFjaGFibGVcbiIKICAgICAgICAgICAgICAgICAgICJFcnJvciBtZXNzYWdlOiAlcyIgJSAoc2VsZi5lbmRwb2ludCwgYWRkcmVzcywgc2VsZi5wb3J0LCBlLnN0cmVycm9yKSkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gcGxhaW5fc29ja2V0CgogICAgZGVmIF9vcGVuX2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIiIiIE9wZW5zIGEgcHVzaCBjb25uZWN0aW9uIHRvIGxvZ2VudHJpZXMuICIiIgogICAgICAgIGxvZy5kZWJ1ZygiT3BlbmluZyBjb25uZWN0aW9uICVzOiVzICVzIiwKICAgICAgICAgICAgICAgICAgc2VsZi5lbmRwb2ludCwgc2VsZi5wb3J0LCBzZWxmLnByZWFtYmxlLnN0cmlwKCkpCiAgICAgICAgcmV0cnkgPSAwCiAgICAgICAgZGVsYXkgPSBTUlZfUkVDT05fVE9fTUlOCiAgICAgICAgIyBLZWVwIHRyeWluZyB0byBvcGVuIHRoZSBjb25uZWN0aW9uCiAgICAgICAgd2hpbGUgbm90IHNlbGYuX3NodXRkb3duOgogICAgICAgICAgICBzZWxmLl9jbG9zZV9jb25uZWN0aW9uKCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcyA9IE5vbmUKICAgICAgICAgICAgICAgIGlmIHNlbGYuX3VzZV9wcm94eToKICAgICAgICAgICAgICAgICAgICBzID0gc29ja3Muc29ja3NvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICAgICAgICAgIHMuc2V0cHJveHkoc2VsZi5fcHJveHlfdHlwZSwgc2VsZi5fcHJveHlfdXJsLCBzZWxmLl9wcm94eV9wb3J0KQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQoKICAgICAgICAgICAgICAgIHMuc2V0dGltZW91dChUQ1BfVElNRU9VVCkKICAgICAgICAgICAgICAgIGlmIHNlbGYudXNlX3NzbDoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzZWxmLl9jb25uZWN0X3NzbChzKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzZWxmLl9jb25uZWN0X3BsYWluKHMpCgogICAgICAgICAgICAgICAgIyBJZiB0aGUgc29ja2V0IGlzIG9wZW4sIHNlbmQgcHJlYW1ibGUgYW5kIGxlYXZlCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9zb2NrZXQ6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcmVhbWJsZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNlbmQoc2VsZi5wcmVhbWJsZSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAjIFhYWAoKICAgICAgICAgICAgIyBXYWl0IGJldHdlZW4gYXR0ZW1wdHMKICAgICAgICAgICAgdGltZS5zbGVlcChkZWxheSkKICAgICAgICAgICAgcmV0cnkgKz0gMQogICAgICAgICAgICBkZWxheSAqPSAyCiAgICAgICAgICAgIGlmIGRlbGF5ID4gU1JWX1JFQ09OX1RPX01BWDoKICAgICAgICAgICAgICAgIGRlbGF5ID0gU1JWX1JFQ09OX1RPX01BWAoKICAgIGRlZiBfY2xvc2VfY29ubmVjdGlvbihzZWxmKToKICAgICAgICBpZiBzZWxmLl9zb2NrZXQ6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgc2VsZi5fc29ja2V0ID0gTm9uZQoKICAgIGRlZiBfc2VuZF9lbnRyeShzZWxmLCBlbnRyeSk6CiAgICAgICAgIiIiU2VuZHMgdGhlIGVudHJ5LiBJZiB0aGUgY29ubmVjdGlvbiBmYWlscyBpdCB3aWxsIHJlLW9wZW4gaXQgYW5kIHRyeQogICAgICAgIGFnYWluLiIiIgogICAgICAgICMgS2VlcCBzZW5kaW5nIGRhdGEgdW50aWwgc3VjY2Vzc2Z1bAogICAgICAgIHdoaWxlIG5vdCBzZWxmLl9zaHV0ZG93bjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNlbmQoZW50cnkuZW5jb2RlKCd1dGY4JykpCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9kZWJ1Z190cmFuc3BvcnRfZXZlbnRzOgogICAgICAgICAgICAgICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsIGVudHJ5LmVuY29kZSgndXRmOCcpLAogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuX29wZW5fY29ubmVjdGlvbigpCgogICAgZGVmIHNlbmQoc2VsZiwgZW50cnkpOgogICAgICAgICIiIlNlbmRzIHRoZSBlbnRyeSBnaXZlbi4gRGVwZW5kaW5nIG9uIHRyYW5zcG9ydCBjb25maWd1cmF0aW9uIGl0IHdpbGwKICAgICAgICBibG9jayB1bnRpbCB0aGUgZW50cnkgaXMgc2VudCBvciBpdCB3aWxsIHF1ZXVlIHRoZSBlbnRyeSBmb3IgYXN5bmMKICAgICAgICBzZW5kLgoKICAgICAgICBOb3RlOiBlbnRyeSBtdXN0IGVuZCB3aXRoIGEgbmV3IGxpbmUKICAgICAgICAiIiIKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9lbnRyaWVzLnB1dF9ub3dhaXQoZW50cnkpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgUXVldWUuRnVsbDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9lbnRyaWVzLmdldF9ub3dhaXQoKQogICAgICAgICAgICAgICAgZXhjZXB0IFF1ZXVlLkVtcHR5OgogICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi5fc2h1dGRvd24gPSBUcnVlCiAgICAgICAgc2VsZi5fd29ya2VyLmpvaW4oVFJBTlNQT1JUX0pPSU5fSU5URVJWQUwpCgogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiJXaGVuIHJ1biB3aXRoIGJhY2tncm91ZCB0aHJlYWQgaXQgY29sbGVjdHMgZW50cmllcyBmcm9tIGludGVybmFsCiAgICAgICAgcXVldWUgYW5kIHNlbmRzIHRoZW0gdG8gZGVzdGluYXRpb24uIiIiCiAgICAgICAgc2VsZi5fb3Blbl9jb25uZWN0aW9uKCkKICAgICAgICB3aGlsZSBub3Qgc2VsZi5fc2h1dGRvd246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGVudHJ5ID0gc2VsZi5fZW50cmllcy5nZXQoVHJ1ZSwgMSkKICAgICAgICAgICAgICAgIHNlbGYuX3NlbmRfZW50cnkoZW50cnkgKyAnXG4nKQogICAgICAgICAgICBleGNlcHQgUXVldWUuRW1wdHk6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkV4Y2VwdGlvbiBpbiBydW46ICVzIiwgdHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICBzZWxmLl9jbG9zZV9jb25uZWN0aW9uKCkKCgpjbGFzcyBEZWZhdWx0VHJhbnNwb3J0KG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHhjb25maWcpOgogICAgICAgIHNlbGYuX3RyYW5zcG9ydCA9IE5vbmUKICAgICAgICBzZWxmLl9jb25maWcgPSB4Y29uZmlnCgogICAgZGVmIGdldChzZWxmKToKICAgICAgICBpZiBub3Qgc2VsZi5fdHJhbnNwb3J0OgogICAgICAgICAgICB1c2Vfc3NsID0gbm90IHNlbGYuX2NvbmZpZy5zdXBwcmVzc19zc2wKICAgICAgICAgICAgaWYgc2VsZi5fY29uZmlnLmRhdGFodWI6CiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IHNlbGYuX2NvbmZpZy5kYXRhaHViX2lwCiAgICAgICAgICAgICAgICBwb3J0ID0gc2VsZi5fY29uZmlnLmRhdGFodWJfcG9ydAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW5kcG9pbnQgPSBEb21haW4uREFUQQogICAgICAgICAgICAgICAgaWYgdXNlX3NzbDoKICAgICAgICAgICAgICAgICAgICBwb3J0ID0gNDQzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MAogICAgICAgICAgICBpZiBjb25maWcuZm9yY2VfZG9tYWluOgogICAgICAgICAgICAgICAgZW5kcG9pbnQgPSBzZWxmLl9jb25maWcuZm9yY2VfZG9tYWluCiAgICAgICAgICAgIGVsaWYgc2VsZi5fY29uZmlnLmZvcmNlX2RhdGFfaG9zdDoKICAgICAgICAgICAgICAgIGVuZHBvaW50ID0gc2VsZi5fY29uZmlnLmZvcmNlX2RhdGFfaG9zdAogICAgICAgICAgICBpZiBzZWxmLl9jb25maWcuZGVidWdfbG9jYWw6CiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IERvbWFpbi5MT0NBTAogICAgICAgICAgICAgICAgcG9ydCA9IDEwMDAwCiAgICAgICAgICAgICAgICB1c2Vfc3NsID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5fdHJhbnNwb3J0ID0gVHJhbnNwb3J0KAogICAgICAgICAgICAgICAgZW5kcG9pbnQsIHBvcnQsIHVzZV9zc2wsICcnLCBzZWxmLl9jb25maWcuZGVidWdfdHJhbnNwb3J0X2V2ZW50cywKICAgICAgICAgICAgICAgIChzZWxmLl9jb25maWcucHJveHlfdHlwZSwgc2VsZi5fY29uZmlnLnByb3h5X3VybCwgc2VsZi5fY29uZmlnLnByb3h5X3BvcnQpKQogICAgICAgIHJldHVybiBzZWxmLl90cmFuc3BvcnQKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgaWYgc2VsZi5fdHJhbnNwb3J0OgogICAgICAgICAgICBzZWxmLl90cmFuc3BvcnQuY2xvc2UoKQoKCmNsYXNzIENvbmZpZ3VyZWRMb2cob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgdG9rZW4sIGRlc3RpbmF0aW9uLCBwYXRoLCBmb3JtYXR0ZXIsIGVudHJ5X2lkZW50aWZpZXIpOgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKICAgICAgICBzZWxmLnRva2VuID0gdG9rZW4KICAgICAgICBzZWxmLmRlc3RpbmF0aW9uID0gZGVzdGluYXRpb24KICAgICAgICBzZWxmLnBhdGggPSBwYXRoCiAgICAgICAgc2VsZi5mb3JtYXR0ZXIgPSBmb3JtYXR0ZXIKICAgICAgICBzZWxmLmVudHJ5X2lkZW50aWZpZXIgPSBlbnRyeV9pZGVudGlmaWVyCiAgICAgICAgc2VsZi5sb2dzZXQgPSBOb25lCiAgICAgICAgc2VsZi5zZXRfa2V5ID0gTm9uZQogICAgICAgIHNlbGYubG9nX2tleSA9IE5vbmUKCiAgICBkZWYgaXNfbG9nc2V0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEZsYWcgb24gd2hldGhlciBpdHMgYSB2YWxpZCBzaGFyZWRsb2cvbG9nc2V0LgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmxvZ3NldAoKCmNsYXNzIEZhdGFsQ29uZmlndXJhdGlvbkVycm9yKEV4Y2VwdGlvbik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1zZyk6CiAgICAgICAgc2VsZi5tc2cgPSBtc2cKCgpjbGFzcyBDb25maWcob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5jb25maWdfZGlyX25hbWUgPSBzZWxmLmdldF9jb25maWdfZGlyKCkKICAgICAgICBzZWxmLmNvbmZpZ19maWxlbmFtZSA9IHNlbGYuY29uZmlnX2Rpcl9uYW1lICsgTEVfQ09ORklHCiAgICAgICAgc2VsZi5jb25maWdfZCA9IG9zLnBhdGguam9pbihzZWxmLmNvbmZpZ19kaXJfbmFtZSwgJ2NvbmYuZCcpCiAgICAgICAgc2VsZi5pbmNsdWRlID0gTk9UX1NFVAoKICAgICAgICAjIENvbmZpZ3VyYXRpb24gdmFyaWFibGVzCiAgICAgICAgc2VsZi5hZ2VudF9rZXkgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5zdXBwcmVzc19zc2wgPSBGYWxzZQogICAgICAgIHNlbGYudXNlX2NhX3Byb3ZpZGVkID0gRmFsc2UKICAgICAgICBzZWxmLnVzZXJfa2V5ID0gREVGQVVMVF9VU0VSX0tFWQogICAgICAgIHNlbGYuZGF0YWh1YiA9IE5PVF9TRVQKICAgICAgICBzZWxmLmRhdGFodWJfaXAgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5kYXRhaHViX3BvcnQgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSBOT1RfU0VUCiAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IE5PVF9TRVQKICAgICAgICBzZWxmLmNvbmZpZ3VyZWRfbG9ncyA9IFtdCiAgICAgICAgc2VsZi5tZXRyaWNzID0gbWV0cmljcy5NZXRyaWNzQ29uZmlnKCkKCiAgICAgICAgIyBTcGVjaWFsIG9wdGlvbnMKICAgICAgICBzZWxmLmRhZW1vbiA9IEZhbHNlCiAgICAgICAgc2VsZi5maWx0ZXJzID0gTk9UX1NFVAogICAgICAgIHNlbGYuZm9ybWF0dGVycyA9IE5PVF9TRVQKICAgICAgICBzZWxmLmZvcm1hdHRlciA9IE5PVF9TRVQKICAgICAgICBzZWxmLmVudHJ5X2lkZW50aWZpZXIgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5mb3JjZSA9IEZhbHNlCiAgICAgICAgc2VsZi5ob3N0bmFtZSA9IE5PVF9TRVQKICAgICAgICBzZWxmLnYxX21ldHJpY3MgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5uYW1lID0gTk9UX1NFVAogICAgICAgIHNlbGYubm9fdGltZXN0YW1wcyA9IEZhbHNlCiAgICAgICAgc2VsZi5waWRfZmlsZSA9IFBJRF9GSUxFCiAgICAgICAgc2VsZi5zdGQgPSBGYWxzZQogICAgICAgIHNlbGYuc3RkX2FsbCA9IEZhbHNlCiAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSBOT1RfU0VUCiAgICAgICAgc2VsZi50eXBlX29wdCA9IE5PVF9TRVQKICAgICAgICBzZWxmLnV1aWQgPSBGYWxzZQogICAgICAgIHNlbGYueGxpc3QgPSBGYWxzZQogICAgICAgIHNlbGYueWVzID0gRmFsc2UKICAgICAgICBzZWxmLm11bHRpbG9nID0gRmFsc2UKICAgICAgICAjIEJlaGF2aW91ciBhc3NvY2lhdGVkIHdpdGggZGFlbW9udG9vbHMvbXVsdGlsb2cKCiAgICAgICAgI3Byb3h5CiAgICAgICAgc2VsZi51c2VfcHJveHkgPSBOT1RfU0VUCiAgICAgICAgc2VsZi5wcm94eV90eXBlID0gTk9UX1NFVAogICAgICAgIHNlbGYucHJveHlfdXJsID0gTk9UX1NFVAogICAgICAgIHNlbGYucHJveHlfcG9ydCA9IE5PVF9TRVQKCiAgICAgICAgIyBEZWJ1ZyBvcHRpb25zCgogICAgICAgICMgRW5hYmxlZCBmaW5lLWdyYWluZWQgbG9nZ2luZwogICAgICAgIHNlbGYuZGVidWcgPSBGYWxzZQogICAgICAgICMgQ29tbWFuZCBsaW5lIGFyZ3MgdG8gc3RkZXJyCiAgICAgICAgc2VsZi5kZWJ1Z19jbWRfbGluZSA9IEZhbHNlCiAgICAgICAgIyBNdWx0aWxvZyBzcGVjaWZpYyBkZWJ1Z2dpbmcgdG8gc3RkZXJyCiAgICAgICAgc2VsZi5kZWJ1Z19tdWx0aWxvZyA9IEZhbHNlCiAgICAgICAgIyBBbGwgcmVjb2duaXplZCBldmVudHMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfZXZlbnRzID0gRmFsc2UKICAgICAgICAjIEFsbCB0cmFuc3BvcnRlZCBldmVudHMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfdHJhbnNwb3J0X2V2ZW50cyA9IEZhbHNlCiAgICAgICAgIyBBbGwgZmlsdGVyaW5nIGFjdGlvbnMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfZmlsdGVycyA9IEZhbHNlCiAgICAgICAgIyBBbGwgZm9ybWF0dGVyaW5nIGFjdGlvbnMgYXJlIGxvZ2dlZAogICAgICAgIHNlbGYuZGVidWdfZm9ybWF0dGVycyA9IEZhbHNlCiAgICAgICAgIyBBbGwgbWV0cmljcyBhY3Rpb25zIGFyZSBsb2dnZWQKICAgICAgICBzZWxmLmRlYnVnX21ldHJpY3MgPSBGYWxzZQogICAgICAgICMgQWRhcHRlciBjb25uZWN0cyB0byBsb2NhaG9zdAogICAgICAgIHNlbGYuZGVidWdfbG9jYWwgPSBGYWxzZQogICAgICAgICMgRG8gbm90IGNvbGxlY3Qgc3RhdGlzdGljcwogICAgICAgIHNlbGYuZGVidWdfbm9zdGF0cyA9IEZhbHNlCiAgICAgICAgIyBDb2xsZWN0ZWQgc3RhdGlzdGljcyBhcmUgbG9nZ2VkCiAgICAgICAgc2VsZi5kZWJ1Z19zdGF0cyA9IEZhbHNlCiAgICAgICAgIyBDb2xsZWN0IHN0YXRpc3RpY3Mgb25seQogICAgICAgIHNlbGYuZGVidWdfc3RhdHNfb25seSA9IEZhbHNlCiAgICAgICAgIyBDb21tYW5kcyBwYXNzZWQgdG8gc2VydmVyIGFyZSBsb2dnZWQKICAgICAgICBzZWxmLmRlYnVnX3JlcXVlc3RzID0gRmFsc2UKICAgICAgICAjIERpc3BsYXkgc3lzdGVtIGluZm9ybWF0aW9uIGFuZCBleGl0CiAgICAgICAgc2VsZi5kZWJ1Z19zeXN0ZW0gPSBGYWxzZQogICAgICAgICMgRGlzcGxheSBsaXN0IG9mIGxvZ3MgaW4gdGhlIHN5c3RlbQogICAgICAgIHNlbGYuZGVidWdfbG9nbGlzdCA9IEZhbHNlCiAgICAgICAgIyBGb3JjZSBob3N0IGZvciBhcGkKICAgICAgICBzZWxmLmZvcmNlX2FwaV9ob3N0ID0gTk9UX1NFVAogICAgICAgICMgRm9yY2UgaG9zdCBmb3IgZGF0YQogICAgICAgIHNlbGYuZm9yY2VfZGF0YV9ob3N0ID0gTk9UX1NFVAogICAgICAgICMgRm9yY2UgaG9zdCBmb3IgdGhpcyBkb21haW4KICAgICAgICBzZWxmLmZvcmNlX2RvbWFpbiA9IE5PVF9TRVQKCiAgICBkZWYgZ2V0X2NvbmZpZ19kaXIoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgSWRlbnRpZmllcyBhIGNvbmZpZ3VyYXRpb24gZGlyZWN0b3J5IGZvciB0aGUgY3VycmVudCB1c2VyLgogICAgICAgIEFsd2F5cyB0ZXJtaW5hdGVkIHdpdGggc2xhc2guCiAgICAgICAgIiIiCiAgICAgICAgaWYgb3MuZ2V0ZXVpZCgpID09IDA6CiAgICAgICAgICAgICMgUnVubmluZyBhcyByb290CiAgICAgICAgICAgIGNfZGlyID0gQ09ORklHX0RJUl9TWVNURU0KICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFJ1bm5pbmcgYXMgYW4gb3JkaW5hcnkgdXNlcgogICAgICAgICAgICBjX2RpciA9IG9zLnBhdGguZXhwYW5kdXNlcignficpICsgJy8nICsgQ09ORklHX0RJUl9VU0VSCgogICAgICAgIHJldHVybiBjX2RpciArICcvJwoKICAgIGRlZiBjbGVhbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBXaXBlcyBvdXQgb2xkIGNvbmZpZ3VyYXRpb24gZmlsZS4gUmV0dXJucyBUcnVlIGlmIHN1Y2Nlc3NmdWwuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcy5yZW1vdmUoc2VsZi5jb25maWdfZmlsZW5hbWUpCiAgICAgICAgZXhjZXB0IE9TRXJyb3IsIGU6CiAgICAgICAgICAgIGlmIGUuZXJybm8gIT0gMjoKICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJFcnJvcjogJXM6ICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY29uZmlnX2ZpbGVuYW1lLCBlLnN0cmVycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgX2xpc3RfY29uZmlncyhzZWxmLCBwYXRoKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgbGlzdCBvZiBjb25maWd1cmF0aW9uIGZpbGVzIGxvY2F0ZWQgaW4gdGhlIHBhdGguCiAgICAgICAgIiIiCiAgICAgICAgY29uZmlncyA9IFtdCiAgICAgICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsocGF0aCk6CiAgICAgICAgICAgIGZvciBmaWxlbmFtZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgIGlmIGZpbGVuYW1lLmVuZHN3aXRoKENPTkZfU1VGRklYKToKICAgICAgICAgICAgICAgICAgICBjb25maWdzLmFwcGVuZChvcy5wYXRoLmpvaW4ocm9vdCwgZmlsZW5hbWUpKQogICAgICAgIHJldHVybiBzb3J0ZWQoY29uZmlncykKCiAgICBkZWYgX2dldF9pZl9kZWYoc2VsZiwgY29uZiwgcGFyYW0sIHBhcmFtX25hbWUpOgogICAgICAgIGlmIHBhcmFtID09IE5PVF9TRVQ6CiAgICAgICAgICAgIG5ld19wYXJhbSA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgcGFyYW1fbmFtZSkKICAgICAgICAgICAgaWYgbmV3X3BhcmFtICE9ICcnOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ld19wYXJhbQogICAgICAgIHJldHVybiBwYXJhbQoKICAgIGRlZiBsb2FkKHNlbGYsIGxvYWRfaW5jbHVkZV9kaXJzPVRydWUpOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemVzIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycyBmcm9tIHRoZSBjb25maWd1cmF0aW9uCiAgICAgICAgZmlsZS4gIFJldHVybnMgVHJ1ZSBpZiBzdWNjZXNzZnVsLCBGYWxzZSBvdGhlcndpc2UuIERvZXMgbm90CiAgICAgICAgdG91Y2ggYWxyZWFkeSBkZWZpbmVkIHBhcmFtZXRlcnMuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICBsb2FkX2luY2x1ZGVfZGlycyAoYm9vbCk6IHNwZWNpZnkgaWYgZmlsZXMgZnJvbSB0aGUgaW5jbHVkZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RvcnkgYXJlIGxvYWRlZAogICAgICAgICIiIgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbmYgPSBDb25maWdQYXJzZXIuU2FmZUNvbmZpZ1BhcnNlcih7CiAgICAgICAgICAgICAgICBVU0VSX0tFWV9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBBR0VOVF9LRVlfUEFSQU06ICcnLAogICAgICAgICAgICAgICAgRklMVEVSU19QQVJBTTogJycsCiAgICAgICAgICAgICAgICBGT1JNQVRURVJTX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIEZPUk1BVFRFUl9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBFTlRSWV9JREVOVElGSUVSX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIFNVUFBSRVNTX1NTTF9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBGT1JDRV9ET01BSU5fUEFSQU06ICcnLAogICAgICAgICAgICAgICAgVVNFX0NBX1BST1ZJREVEX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIERBVEFIVUJfUEFSQU06ICcnLAogICAgICAgICAgICAgICAgU1lTU1RBVF9UT0tFTl9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBIT1NUTkFNRV9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBWMV9NRVRSSUNTX1BBUkFNOiAnVHJ1ZScsCiAgICAgICAgICAgICAgICBQVUxMX1NFUlZFUl9TSURFX0NPTkZJR19QQVJBTTogJ1RydWUnLAogICAgICAgICAgICAgICAgSU5DTFVERV9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBQUk9YWV9UWVBFX1BBUkFNOiAnJywKICAgICAgICAgICAgICAgIFBST1hZX1VSTF9QQVJBTTogJycsCiAgICAgICAgICAgICAgICBQUk9YWV9QT1JUX1BBUkFNOiAnJywKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICMgUmVhZCBjb25maWd1cmF0aW9uIGZpbGVzIGZyb20gZGVmYXVsdCBkaXJlY3RvcmllcwogICAgICAgICAgICBjb25maWdfZmlsZXMgPSBbc2VsZi5jb25maWdfZmlsZW5hbWVdCiAgICAgICAgICAgIGlmIGxvYWRfaW5jbHVkZV9kaXJzOgogICAgICAgICAgICAgICAgY29uZmlnX2ZpbGVzLmV4dGVuZChzZWxmLl9saXN0X2NvbmZpZ3Moc2VsZi5jb25maWdfZCkpCgogICAgICAgICAgICAjIEFkanVzdCBjb25maWd1cmF0aW9uIGZpbGUgcGVybWlzc2lvbnMgdG8gYmUgb25seSByZWFkYWJsZSBieSBvbndlciArIGdyb3VwCiAgICAgICAgICAgIGZvciBfY29uZmlnIGluIGNvbmZpZ19maWxlczoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoX2NvbmZpZyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgICAgIHdvcmxkX3JlYWRhYmxlID0gYm9vbChvcy5zdGF0KF9jb25maWcpLnN0X21vZGUgJiBzdGF0LlNfSVJPVEgpCiAgICAgICAgICAgICAgICAgICAgaWYgd29ybGRfcmVhZGFibGU6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKF9jb25maWcsIDA2NDApCiAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICBsb2cud2FybignQ291bGQgbm90IGFkanVzdCBwZXJtaXNzaW9ucyBmb3IgY29uZmlnIGZpbGUgJXMnLCBfY29uZmlnLCBleGNfaW5mbz1UcnVlKQoKICAgICAgICAgICAgY29uZi5yZWFkKGNvbmZpZ19maWxlcykKCiAgICAgICAgICAgICMgRmFpbCBpZiBubyBjb25maWd1cmF0aW9uIGZpbGUgZXhpc3QKICAgICAgICAgICAgaWYgbm90IGNvbmYuaGFzX3NlY3Rpb24oTUFJTl9TRUNUKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBHZXQgb3B0aW9uYWwgdXNlci1wcm92aWRlZCBjb25maWd1cmF0aW9uIGRpcmVjdG9yeQogICAgICAgICAgICBzZWxmLmluY2x1ZGUgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuaW5jbHVkZSwgSU5DTFVERV9QQVJBTSkKCiAgICAgICAgICAgICMgTG9hZCBjb25maWd1cmF0aW9uIGZpbGVzIGZyb20gdXNlci1wcm92aWRlZCBkaXJlY3RvcnkKICAgICAgICAgICAgaWYgbG9hZF9pbmNsdWRlX2RpcnMgYW5kIHNlbGYuaW5jbHVkZToKICAgICAgICAgICAgICAgIGNvbmZpZ19maWxlcy5leHRlbmQoY29uZi5yZWFkKHNlbGYuX2xpc3RfY29uZmlncyhzZWxmLmluY2x1ZGUpKSkKCiAgICAgICAgICAgIGxvZy5kZWJ1ZygnQ29uZmlndXJhdGlvbiBmaWxlcyBsb2FkZWQ6ICVzJywgJywgJy5qb2luKGNvbmZpZ19maWxlcykpCgogICAgICAgICAgICAjIExvYWQgcGFyYW1ldGVycwogICAgICAgICAgICBzZWxmLnVzZXJfa2V5ID0gc2VsZi5fZ2V0X2lmX2RlZihjb25mLCBzZWxmLnVzZXJfa2V5LCBVU0VSX0tFWV9QQVJBTSkKICAgICAgICAgICAgc2VsZi5hZ2VudF9rZXkgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuYWdlbnRfa2V5LCBBR0VOVF9LRVlfUEFSQU0pCiAgICAgICAgICAgIHNlbGYuZmlsdGVycyA9IHNlbGYuX2dldF9pZl9kZWYoY29uZiwgc2VsZi5maWx0ZXJzLCBGSUxURVJTX1BBUkFNKQogICAgICAgICAgICBzZWxmLmZvcm1hdHRlcnMgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuZm9ybWF0dGVycywgRk9STUFUVEVSU19QQVJBTSkKICAgICAgICAgICAgc2VsZi5mb3JtYXR0ZXIgPSBzZWxmLl9nZXRfaWZfZGVmKGNvbmYsIHNlbGYuZm9ybWF0dGVyLCBGT1JNQVRURVJfUEFSQU0pCiAgICAgICAgICAgIHNlbGYuZW50cnlfaWRlbnRpZmllciA9IHNlbGYuX2dldF9pZl9kZWYoY29uZiwgc2VsZi5lbnRyeV9pZGVudGlmaWVyLCBFTlRSWV9JREVOVElGSUVSX1BBUkFNKQogICAgICAgICAgICBzZWxmLmhvc3RuYW1lID0gc2VsZi5fZ2V0X2lmX2RlZihjb25mLCBzZWxmLmhvc3RuYW1lLCBIT1NUTkFNRV9QQVJBTSkKICAgICAgICAgICAgc2VsZi52MV9tZXRyaWNzID0gc2VsZi5fZ2V0X2lmX2RlZihjb25mLCBzZWxmLnYxX21ldHJpY3MsIFYxX01FVFJJQ1NfUEFSQU0pCiAgICAgICAgICAgIGlmIHNlbGYucHVsbF9zZXJ2ZXJfc2lkZV9jb25maWcgPT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIG5ld19wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgUFVMTF9TRVJWRVJfU0lERV9DT05GSUdfUEFSQU0pCiAgICAgICAgICAgICAgICBzZWxmLnB1bGxfc2VydmVyX3NpZGVfY29uZmlnID0gbmV3X3B1bGxfc2VydmVyX3NpZGVfY29uZmlnID09ICdUcnVlJwogICAgICAgICAgICAgICAgaWYgbmV3X3B1bGxfc2VydmVyX3NpZGVfY29uZmlnIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IFRydWUKCiAgICAgICAgICAgICMgUHJveHkgY29uZmlndXJhdGlvbgogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3R5cGUgPT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfdHlwZSA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgUFJPWFlfVFlQRV9QQVJBTSkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3R5cGU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV90eXBlID0gTk9UX1NFVAogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3VybCA9PSBOT1RfU0VUOgogICAgICAgICAgICAgICAgc2VsZi5wcm94eV91cmwgPSBjb25mLmdldChNQUlOX1NFQ1QsIFBST1hZX1VSTF9QQVJBTSkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3VybDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3VybCA9IE5PVF9TRVQKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9wb3J0ID09IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBwcm94eV9wb3J0ID0gY29uZi5nZXQoTUFJTl9TRUNULCBQUk9YWV9QT1JUX1BBUkFNKQogICAgICAgICAgICAgICAgaWYgbm90IHByb3h5X3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9wb3J0ID0gTk9UX1NFVAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3BvcnQgPSBpbnQocHJveHlfcG9ydCkKCiAgICAgICAgICAgIGlmIHNlbGYucHJveHlfdHlwZSAhPSBOT1RfU0VUIGFuZCBzZWxmLnByb3h5X3VybCAhPSBOT1RfU0VUIGFuZCBzZWxmLnByb3h5X3BvcnQgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIHNlbGYudXNlX3Byb3h5ID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi51c2VfcHJveHkgPSBGYWxzZQoKICAgICAgICAgICAgbmV3X3N1cHByZXNzX3NzbCA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgU1VQUFJFU1NfU1NMX1BBUkFNKQogICAgICAgICAgICBpZiBuZXdfc3VwcHJlc3Nfc3NsID09ICdUcnVlJzoKICAgICAgICAgICAgICAgIHNlbGYuc3VwcHJlc3Nfc3NsID0gbmV3X3N1cHByZXNzX3NzbCA9PSAnVHJ1ZScKICAgICAgICAgICAgbmV3X2ZvcmNlX2RvbWFpbiA9IGNvbmYuZ2V0KE1BSU5fU0VDVCwgRk9SQ0VfRE9NQUlOX1BBUkFNKQogICAgICAgICAgICBpZiBuZXdfZm9yY2VfZG9tYWluOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9kb21haW4gPSBuZXdfZm9yY2VfZG9tYWluCiAgICAgICAgICAgIGlmIHNlbGYuZGF0YWh1YiA9PSBOT1RfU0VUOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfZGF0YWh1Yl9zZXR0aW5ncygKICAgICAgICAgICAgICAgICAgICBjb25mLmdldChNQUlOX1NFQ1QsIERBVEFIVUJfUEFSQU0pLCBzaG91bGRfZGllPUZhbHNlKQogICAgICAgICAgICBpZiBzZWxmLnN5c3RlbV9zdGF0c190b2tlbiA9PSBOT1RfU0VUOgogICAgICAgICAgICAgICAgc3lzdGVtX3N0YXRzX3Rva2VuX3N0ciA9IGNvbmYuZ2V0KAogICAgICAgICAgICAgICAgICAgIE1BSU5fU0VDVCwgU1lTU1RBVF9UT0tFTl9QQVJBTSkKICAgICAgICAgICAgICAgIGlmIHN5c3RlbV9zdGF0c190b2tlbl9zdHIgIT0gJyc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSBzeXN0ZW1fc3RhdHNfdG9rZW5fc3RyCgogICAgICAgICAgICBzZWxmLm1ldHJpY3MubG9hZChjb25mKQoKICAgICAgICAgICAgc2VsZi5sb2FkX2NvbmZpZ3VyZWRfbG9ncyhjb25mKQoKICAgICAgICBleGNlcHQgQ29uZmlnUGFyc2VyLk5vU2VjdGlvbkVycm9yLCBlMDoKICAgICAgICAgICAgcmFpc2UgRmF0YWxDb25maWd1cmF0aW9uRXJyb3IoJyVzJyVlMCkKICAgICAgICBleGNlcHQgQ29uZmlnUGFyc2VyLk5vT3B0aW9uRXJyb3IsIGUxOgogICAgICAgICAgICByYWlzZSBGYXRhbENvbmZpZ3VyYXRpb25FcnJvcignJXMnJWUxKQogICAgICAgIGV4Y2VwdCBDb25maWdQYXJzZXIuTWlzc2luZ1NlY3Rpb25IZWFkZXJFcnJvciwgZTI6CiAgICAgICAgICAgIHJhaXNlIEZhdGFsQ29uZmlndXJhdGlvbkVycm9yKCclcyclZTIpCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgbG9hZF9jb25maWd1cmVkX2xvZ3Moc2VsZiwgY29uZik6CiAgICAgICAgZ2xvYmFsIGxvZwogICAgICAgICIiIgogICAgICAgIExvYWRzIGNvbmZpZ3VyZWQgbG9ncyBmcm9tIHRoZSBjb25maWd1cmF0aW9uIGZpbGUuCiAgICAgICAgVGhlc2UgYXJlIGxvZ3MgdGhhdCB1c2UgdG9rZW5zLgogICAgICAgICIiIgogICAgICAgIHNlbGYuY29uZmlndXJlZF9sb2dzID0gW10KICAgICAgICBhY2NvdW50X2hvc3RzID0gTm9uZQogICAgICAgIGZvciBuYW1lIGluIGNvbmYuc2VjdGlvbnMoKToKICAgICAgICAgICAgaWYgbmFtZSAhPSBNQUlOX1NFQ1Q6CiAgICAgICAgICAgICAgICB0b2tlbiA9ICcnCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgeHRva2VuID0gY29uZi5nZXQobmFtZSwgVE9LRU5fUEFSQU0pCiAgICAgICAgICAgICAgICAgICAgaWYgeHRva2VuOgogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHV1aWRfcGFyc2UoeHRva2VuKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgdG9rZW46CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cud2FybmluZygiSW52YWxpZCBsb2cgdG9rZW4gYCVzJyBpbiBhcHBsaWNhdGlvbiBgJXMnLiIsIHh0b2tlbiwgbmFtZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBDb25maWdQYXJzZXIuTm9PcHRpb25FcnJvcjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHBhdGggPSBjb25mLmdldChuYW1lLCBQQVRIX1BBUkFNKQogICAgICAgICAgICAgICAgZXhjZXB0IENvbmZpZ1BhcnNlci5Ob09wdGlvbkVycm9yOgogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJOb3RlOiBSZXF1aXJlZCBwYXJhbWV0ZXIgYCVzJyBub3QgZm91bmQgaW4gYXBwbGljYXRpb24gYCVzJywgc2tpcHBpbmcgdGhpcyBhcHBsaWNhdGlvbiIsIFBBVEhfUEFSQU0sIG5hbWUpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9ICcnCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb25mLmdldChuYW1lLCBERVNUSU5BVElPTl9QQVJBTSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBDb25maWdQYXJzZXIuTm9PcHRpb25FcnJvcjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAgICAgZm9ybWF0dGVyID0gJycKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXIgPSBjb25mLmdldChuYW1lLCBGT1JNQVRURVJfUEFSQU0pCiAgICAgICAgICAgICAgICBleGNlcHQgQ29uZmlnUGFyc2VyLk5vT3B0aW9uRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgICAgIGVudHJ5X2lkZW50aWZpZXIgPSAnJwogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGVudHJ5X2lkZW50aWZpZXIgPSBjb25mLmdldChuYW1lLCBFTlRSWV9JREVOVElGSUVSX1BBUkFNKQogICAgICAgICAgICAgICAgZXhjZXB0IENvbmZpZ1BhcnNlci5Ob09wdGlvbkVycm9yOgogICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICAgICBjb25maWd1cmVkX2xvZyA9IENvbmZpZ3VyZWRMb2cobmFtZSwgdG9rZW4sIGRlc3RpbmF0aW9uLCBwYXRoLCBmb3JtYXR0ZXIsIGVudHJ5X2lkZW50aWZpZXIpCiAgICAgICAgICAgICAgICBzZWxmLmNvbmZpZ3VyZWRfbG9ncy5hcHBlbmQoY29uZmlndXJlZF9sb2cpCgogICAgZGVmIHNhdmUoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZXMgY29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzIGludG8gdGhlIGNvbmZpZ3VyYXRpb24gZmlsZS4KICAgICAgICBUaGUgZmlsZSB3aXRoIGNlcnRpZmljYXRlcyBpcyBhZGRlZCBhcyB3ZWxsLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY29uZiA9IENvbmZpZ1BhcnNlci5TYWZlQ29uZmlnUGFyc2VyKCkKICAgICAgICAgICAgY3JlYXRlX2NvbmZfZGlyKHNlbGYpCiAgICAgICAgICAgIGNvbmZfZmlsZSA9IG9wZW4oc2VsZi5jb25maWdfZmlsZW5hbWUsICd3YicpCiAgICAgICAgICAgIGNvbmYuYWRkX3NlY3Rpb24oTUFJTl9TRUNUKQogICAgICAgICAgICBpZiBzZWxmLnVzZXJfa2V5ICE9IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIFVTRVJfS0VZX1BBUkFNLCBzZWxmLnVzZXJfa2V5KQogICAgICAgICAgICBpZiBzZWxmLmFnZW50X2tleSAhPSBOT1RfU0VUOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBBR0VOVF9LRVlfUEFSQU0sIHNlbGYuYWdlbnRfa2V5KQogICAgICAgICAgICBpZiBzZWxmLmZpbHRlcnMgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgRklMVEVSU19QQVJBTSwgc2VsZi5maWx0ZXJzKQogICAgICAgICAgICBpZiBzZWxmLmZvcm1hdHRlcnMgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgRk9STUFUVEVSU19QQVJBTSwgc2VsZi5mb3JtYXR0ZXJzKQogICAgICAgICAgICBpZiBzZWxmLmZvcm1hdHRlciAhPSBOT1RfU0VUOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBGT1JNQVRURVJfUEFSQU0sIHNlbGYuZm9ybWF0dGVyKQogICAgICAgICAgICBpZiBzZWxmLnYxX21ldHJpY3MgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgVjFfTUVUUklDU19QQVJBTSwgc2VsZi52MV9tZXRyaWNzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBWMV9NRVRSSUNTX1BBUkFNLCAnRmFsc2UnKQogICAgICAgICAgICBpZiBzZWxmLmhvc3RuYW1lICE9IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIEhPU1ROQU1FX1BBUkFNLCBzZWxmLmhvc3RuYW1lKQogICAgICAgICAgICBpZiBzZWxmLnN1cHByZXNzX3NzbDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgU1VQUFJFU1NfU1NMX1BBUkFNLCAnVHJ1ZScpCiAgICAgICAgICAgIGlmIHNlbGYudXNlX2NhX3Byb3ZpZGVkOgogICAgICAgICAgICAgICAgY29uZi5zZXQoTUFJTl9TRUNULCBVU0VfQ0FfUFJPVklERURfUEFSQU0sICdUcnVlJykKICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9kb21haW46CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIEZPUkNFX0RPTUFJTl9QQVJBTSwgc2VsZi5mb3JjZV9kb21haW4pCiAgICAgICAgICAgIGlmIHNlbGYucHVsbF9zZXJ2ZXJfc2lkZV9jb25maWcgIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KE1BSU5fU0VDVCwgUFVMTF9TRVJWRVJfU0lERV9DT05GSUdfUEFSQU0sICIlcyIgJQogICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZykKICAgICAgICAgICAgaWYgc2VsZi5kYXRhaHViICE9IE5PVF9TRVQ6CiAgICAgICAgICAgICAgICBjb25mLnNldChNQUlOX1NFQ1QsIERBVEFIVUJfUEFSQU0sIHNlbGYuZGF0YWh1YikKICAgICAgICAgICAgaWYgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gIT0gTk9UX1NFVDoKICAgICAgICAgICAgICAgIGNvbmYuc2V0KAogICAgICAgICAgICAgICAgICAgIE1BSU5fU0VDVCwgU1lTU1RBVF9UT0tFTl9QQVJBTSwgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4pCgogICAgICAgICAgICBmb3IgY2xvZyBpbiBzZWxmLmNvbmZpZ3VyZWRfbG9nczoKICAgICAgICAgICAgICAgIGNvbmYuYWRkX3NlY3Rpb24oY2xvZy5uYW1lKQogICAgICAgICAgICAgICAgaWYgY2xvZy50b2tlbjoKICAgICAgICAgICAgICAgICAgICBjb25mLnNldChjbG9nLm5hbWUsIFRPS0VOX1BBUkFNLCBjbG9nLnRva2VuKQogICAgICAgICAgICAgICAgY29uZi5zZXQoY2xvZy5uYW1lLCBQQVRIX1BBUkFNLCBjbG9nLnBhdGgpCiAgICAgICAgICAgICAgICBpZiBjbG9nLmRlc3RpbmF0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbmYuc2V0KGNsb2cubmFtZSwgREVTVElOQVRJT05fUEFSQU0sIGNsb2cuZGVzdGluYXRpb24pCgogICAgICAgICAgICBzZWxmLm1ldHJpY3Muc2F2ZShjb25mKQoKICAgICAgICAgICAgY29uZi53cml0ZShjb25mX2ZpbGUpCiAgICAgICAgZXhjZXB0IElPRXJyb3IsIGU6CiAgICAgICAgICAgIGRpZSgiRXJyb3I6IElPIGVycm9yIHdoZW4gd3JpdGluZyB0byBjb25maWcgZmlsZTogJXMiICUgZSkKCiAgICBkZWYgY2hlY2tfa2V5KHNlbGYsIGtleSk6CiAgICAgICAgIiIiCiAgICAgICAgQ2hlY2tzIGlmIHRoZSBrZXkgbG9va3MgZmluZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBsZW4oa2V5KSA9PSBLRVlfTEVOCgogICAgZGVmIHNldF91c2VyX2tleShzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfa2V5KHZhbHVlKToKICAgICAgICAgICAgZGllKCdFcnJvcjogVXNlciBrZXkgZG9lcyBub3QgbG9vayByaWdodC4nKQogICAgICAgIHNlbGYudXNlcl9rZXkgPSB2YWx1ZQoKICAgIGRlZiB1c2VyX2tleV9yZXF1aXJlZChzZWxmLCBhc2tfZm9yX2l0KToKICAgICAgICAiIiIKICAgICAgICBFeGl0cyB3aXRoIGVycm9yIG1lc3NhZ2UgaWYgdGhlIHVzZXIga2V5IGlzIG5vdCBkZWZpbmVkLgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYudXNlcl9rZXkgPT0gTk9UX1NFVDoKICAgICAgICAgICAgaWYgYXNrX2Zvcl9pdDoKICAgICAgICAgICAgICAgIGxvZy5pbmZvKAogICAgICAgICAgICAgICAgICAgICJBY2NvdW50IGtleSBpcyByZXF1aXJlZC4gRW50ZXIgeW91ciBMb2dlbnRyaWVzIGxvZ2luICIKICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbHMgb3Igc3BlY2lmeSB0aGUgYWNjb3VudCBrZXkgd2l0aCAiCiAgICAgICAgICAgICAgICAgICAgIi0tYWNjb3VudC1rZXkgcGFyYW1ldGVyLiIpCiAgICAgICAgICAgICAgICBzZWxmLnVzZXJfa2V5ID0gcmV0cmlldmVfYWNjb3VudF9rZXkoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZGllKCJBY2NvdW50IGtleSBpcyByZXF1aXJlZC4gRW50ZXIgeW91ciBhY2NvdW50IGtleSB3aXRoIC0tYWNjb3VudC1rZXkgcGFyYW1ldGVyLiIpCiAgICAgICAgICAgIGNvbmZpZy5zYXZlKCkKCiAgICBkZWYgc2V0X3N5c3RlbV9zdGF0X3Rva2VuKHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19rZXkodmFsdWUpOgogICAgICAgICAgICBkaWUoJ0Vycm9yOiBzeXN0ZW0gc3RhdCB0b2tlbiBkb2VzIG5vdCBsb29rIHJpZ2h0LicpCiAgICAgICAgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPSB2YWx1ZQoKICAgIGRlZiBzeXN0ZW1fc3RhdHNfdG9rZW5fcmVxdWlyZWQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5zeXN0ZW1fc3RhdHNfdG9rZW4gPT0gTk9UX1NFVDoKICAgICAgICAgICAgZGllKCJTeXN0ZW0gc3RhdCB0b2tlbiBpcyByZXF1aXJlZC4iKQogICAgICAgIGNvbmZpZy5zYXZlKCkKCiAgICBkZWYgc2V0X2FnZW50X2tleShzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfa2V5KHZhbHVlKToKICAgICAgICAgICAgZGllKCdFcnJvcjogQWdlbnQga2V5IGRvZXMgbm90IGxvb2sgcmlnaHQuJykKICAgICAgICBzZWxmLmFnZW50X2tleSA9IHZhbHVlCgogICAgZGVmIGFnZW50X2tleV9yZXF1aXJlZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBFeGl0cyB3aXRoIGVycm9yIG1lc3NhZ2UgaWYgdGhlIGFnZW50IGtleSBpcyBub3QgZGVmaW5lZC4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmFnZW50X2tleSA9PSBOT1RfU0VUOgogICAgICAgICAgICBkaWUoIkhvc3Qga2V5IGlzIHJlcXVpcmVkLiBSZWdpc3RlciB0aGUgaG9zdCBvciBzcGVjaWZ5IHRoZSBob3N0IGtleSB3aXRoIHRoZSAtLWhvc3Qta2V5IHBhcmFtZXRlci4iKQoKICAgIGRlZiBoYXZlX2FnZW50X2tleShzZWxmKToKICAgICAgICAiIiJUZXN0cyBpZiB0aGUgYWdlbnQga2V5IGhhcyBiZWVuIGFzc2lnbmVkIHRvIHRoaXMgaW5zdGFuY2UuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuYWdlbnRfa2V5ICE9ICcnCgogICAgZGVmIGhvc3RuYW1lX3JlcXVpcmVkKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFNldHMgdGhlIGhvc3RuYW1lIHBhcmFtZXRlciBiYXNlZCBvbiBzZXJ2ZXIgbmV0d29yayBuYW1lLiBJZgogICAgICAgIHRoZSBob3N0bmFtZSBpcyBzZXQgYWxyZWFkeSwgaXQgaXMga2VwdCB1bnRvdWNoZWQuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5ob3N0bmFtZSA9PSBOT1RfU0VUOgogICAgICAgICAgICBzZWxmLmhvc3RuYW1lID0gc29ja2V0LmdldGZxZG4oKQogICAgICAgIHJldHVybiBzZWxmLmhvc3RuYW1lCgogICAgZGVmIG5hbWVfcmVxdWlyZWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgU2V0cyBob3N0IG5hbWUgaWYgbm90IHNldCBhbHJlYWR5LiBUaGUgbmV3IGhvc3QgbmFtZSBpcwogICAgICAgIGRlbGl2ZXJlZCBmcm9tIGl0cyBob3N0bmFtZS4gQXMgYSBzaWRlIGVmZmVjdCB0aGlzCiAgICAgICAgZnVuY3Rpb24gc2V0cyBhIGhvc3RuYW1lIGFzIHdlbGwuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5uYW1lID09IE5PVF9TRVQ6CiAgICAgICAgICAgIHNlbGYubmFtZSA9IHNlbGYuaG9zdG5hbWVfcmVxdWlyZWQoKS5zcGxpdCgnLicpWzBdCiAgICAgICAgcmV0dXJuIHNlbGYubmFtZQoKICAgICMgVGhlIG1ldGhvZCBnZXRzIGFsbCBwYXJhbWV0ZXJzIG9mIGdpdmVuIHR5cGUgZnJvbSBhcmd1bWVudCBsaXN0LAogICAgIyBjaGVja3MgZm9yIHRoZWlyIGZvcm1hdCBhbmQgcmV0dXJucyBsaXN0IG9mIHZhbHVlcyBvZiBwYXJhbWV0ZXJzCiAgICAjIG9mIHNwZWNpZmllZCB0eXBlLiBFLmc6IFdlIGhhdmUgcGFyYW1zID0gWyd0cnVlJywgMTI3LjAuMC4xLCAxMDAwMF0gdGhlIGNhbGwgb2YKICAgICMgY2hlY2tfYW5kX2dldF9wYXJhbV9ieV90eXBlKHBhcmFtcywgdHlwZT0nYm9vbCcpIHlpZWxkcyBbVHJ1ZV0KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2hlY2tfYW5kX2dldF9wYXJhbV9ieV90eXBlKHBhcmFtcywgdHlwZT0nYm9vbCcpOgogICAgICAgIHJldF9wYXJhbSA9IFtdCgogICAgICAgIGZvciBwIGluIHBhcmFtczoKICAgICAgICAgICAgZm91bmQgPSBGYWxzZQogICAgICAgICAgICBwID0gcC5sb3dlcigpCiAgICAgICAgICAgIGlmIHR5cGUgPT0gJ2lwYWRkcic6CiAgICAgICAgICAgICAgICBpZiBwLmZpbmQoJy4nKSAhPSAtMToKICAgICAgICAgICAgICAgICAgICBvY3RldHMgPSBwLnNwbGl0KCcuJywgNCkKICAgICAgICAgICAgICAgICAgICBvY3RldHNfb2sgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG9jdGV0cykgPT0gNDoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG9jdGV0IGluIG9jdGV0czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9jdGV0c19vayAmPSAob2N0ZXQuaXNkaWdpdCgpKSBhbmQgKDAgPD0gaW50KG9jdGV0KSA8PSAyNTUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgb2N0ZXRzX29rID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IG9jdGV0c19vawogICAgICAgICAgICBlbGlmIHR5cGUgPT0gJ2Jvb2wnOgogICAgICAgICAgICAgICAgaWYgKHAuZmluZCgndHJ1ZScpICE9IC0xIGFuZCBsZW4ocCkgPT0gNCkgb3IgKHAuZmluZCgnZmFsc2UnKSAhPSAtMSBhbmQgbGVuKHApID09IDUpOgogICAgICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICBlbGlmIHR5cGUgPT0gJ251bWVyaWMnOgogICAgICAgICAgICAgICAgaWYgcC5pc2RpZ2l0KCk6CiAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBOYW1lRXJyb3IoJ1Vua25vd24gdHlwZSBuYW1lJykKCiAgICAgICAgICAgIGlmIGZvdW5kOgogICAgICAgICAgICAgICAgaWYgdHlwZSA9PSAnbnVtZXJpYyc6CiAgICAgICAgICAgICAgICAgICAgcmV0X3BhcmFtLmFwcGVuZChpbnQocCkpCiAgICAgICAgICAgICAgICBlbGlmIHR5cGUgPT0gJ2Jvb2wnOgogICAgICAgICAgICAgICAgICAgIHJldF9wYXJhbS5hcHBlbmQocCA9PSAndHJ1ZScpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldF9wYXJhbS5hcHBlbmQocCkKCiAgICAgICAgcmV0dXJuIHJldF9wYXJhbQoKICAgIGRlZiBzZXRfZGF0YWh1Yl9zZXR0aW5ncyhzZWxmLCB2YWx1ZSwgc2hvdWxkX2RpZT1UcnVlKToKICAgICAgICBpZiBub3QgdmFsdWUgYW5kIHNob3VsZF9kaWU6CiAgICAgICAgICAgIGRpZSgnLS1kYXRhaHViIHJlcXVpcmVzIGEgcGFyYW1ldGVyJykKICAgICAgICBlbGlmIG5vdCB2YWx1ZSBhbmQgbm90IHNob3VsZF9kaWU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB2YWx1ZXMgPSB2YWx1ZS5zcGxpdCgiOiIpCiAgICAgICAgaWYgbGVuKHZhbHVlcykgPiAyOgogICAgICAgICAgICBkaWUoIkNhbm5vdCBwYXJzZSAlcyBmb3IgLS1kYXRhaHViLiBFeHBlY3RlZCBmb3JtYXQ6IGhvc3RuYW1lOnBvcnQiICUKICAgICAgICAgICAgICAgIHZhbHVlKQoKICAgICAgICBzZWxmLmRhdGFodWJfaXAgPSB2YWx1ZXNbMF0KICAgICAgICBpZiBsZW4odmFsdWVzKSA9PSAyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmRhdGFodWJfcG9ydCA9IGludCh2YWx1ZXNbMV0pCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgZGllKCJDYW5ub3QgcGFyc2UgJXMgYXMgcG9ydC4gU3BlY2lmeSBhIHZhbGlkIC0tZGF0YWh1YiBhZGRyZXNzIiAlCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzWzFdKQogICAgICAgIHNlbGYuZGF0YWh1YiA9IHZhbHVlCgogICAgZGVmIHZhbGlkYXRlX3BhdGhuYW1lKHNlbGYsIGFyZ3M9Tm9uZSwgY21kX2xpbmU9VHJ1ZSwgcGF0aD1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBGb3IgdGhlICctLW11bHRpbG9nJyBvcHRpb24gd2hlcmUgYSB3aWxkY2FyZCBjYW4gYmUgdXNlZCBpbiB0aGUgZGlyZWN0b3J5IG5hbWUuCiAgICAgICAgVmFsaWRhdGVzIHRoZSBzdHJpbmcgdGhhdCBpcyBwYXNzZWQgdG8gdGhlIGFnZW50IGZyb20gY29tbWFuZCBsaW5lLCBjb25maWcgZmlsZSBvciBzZXJ2ZXIuCiAgICAgICAgSWYgZXJyb3IgZnJvbSBjb21tYW5kIGxpbmUsIHRoZW4gZXJyb3IgbWVzc2FnZSB3cml0dGVuIHRvIGNvbW1vbmQgbGluZSBhbmQgYWdlbnQgcXVpdHMuCiAgICAgICAgSWYgZXJyb3IgZnJvbSBjb25maWcgZmlsZSAob3Igc2VydmVyKSB0aGVuIGVycm9yIG1lc3NhZ2Ugd3JpdHRlbiB0byBsb2cgYW5kIEZhbHNlIGlzIHJldHVybmVkLgogICAgICAgIDpwYXJhbSBhcmdzOiB0aGUgcGF0aG5hbWUgZ2l2ZW4gdG8gdGhlIGFnZW50CiAgICAgICAgOnJldHVybjogICAgVHJ1ZSBpZiBva2F5LCB0aGUgYWdlbnQgd2lsbCBkaWUgb3RoZXJ3aXNlCiAgICAgICAgIiIiICAgICAgICAKICAgICAgICBpZiBjbWRfbGluZSBhbmQgcGF0aCBpcyBOb25lOgogICAgICAgICAgICBpZiBhcmdzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcG5hbWVfc2xpY2UgPSBhcmdzWzE6XQogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSB0aGF0IGEgcGF0aG5hbWUgaXMgZGV0ZWN0ZWQgaW4gcGFyYW1ldGVycyB0byBhZ2VudAogICAgICAgICAgICAgICAgaWYgbGVuKHBuYW1lX3NsaWNlKSA9PSAwOgogICAgICAgICAgICAgICAgICAgIGRpZSgiXG5FcnJvcjogTm8gcGF0aG5hbWUgZGV0ZWN0ZWQgLSBTcGVjaWZ5IHRoZSBwYXRoIHRvIHRoZSBmaWxlIHRvIGJlIGZvbGxvd2VkXG4iIAogICAgICAgICAgICAgICAgICAgICAgICArIE1VTFRJTE9HX1VTQUdFLCBFWElUX09LKQogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSB0aGF0IGFnZW50IGlzIG5vdCByZWNlaXZpbmcgYSBsaXN0IG9mIHBhdGhuYW1lcyAocG9zc2libHkgc2hlbGwgaXMgZXhwYW5kaW5nIHdpbGRjYXJkKQogICAgICAgICAgICAgICAgaWYgbGVuKHBuYW1lX3NsaWNlKSA+IDE6CiAgICAgICAgICAgICAgICAgICAgZGllKCJcbkVycm9yOiBUb28gbWFueSBhcmd1bWVudHMgYmVpbmcgcGFzc2VkIHRvIGFnZW50XG4iICsgTVVMVElMT0dfVVNBR0UsIEVYSVRfT0spCiAgICAgICAgICAgICAgICBwbmFtZSA9IHN0cihwbmFtZV9zbGljZVswXSkKICAgICAgICBlbGlmIG5vdCBjbWRfbGluZSBhbmQgcGF0aCBpcyBOb25lOgogICAgICAgICAgICAjIEZvciBhbnl0aGluZyBub3QgY29taW5nIGluIG9uIGNvbW1hbmQgbGluZSBubyBvdXRwdXQgaXMgd3JpdHRlbiB0byBjb21tYW5kIGxpbmUKICAgICAgICAgICAgbG9nLmVycm9yKCJFcnJvcjogUGF0aG5hbWUgYXJndW1lbnQgaXMgZW1wdHkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbGlmIG5vdCBjbWRfbGluZSBhbmQgcGF0aCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcG5hbWU9cGF0aAogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5iYXNlbmFtZShwbmFtZSkKICAgICAgICAjIFZlcmlmeSB0aGVyZSBpcyBhIGZpbGVuYW1lCiAgICAgICAgaWYgbm90IGZpbGVuYW1lOgogICAgICAgICAgICBpZiBub3QgY21kX2xpbmU6CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkVycm9yOiBObyBmaWxlbmFtZSBkZXRlY3RlZCBpbiB0aGUgcGF0aG5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkaWUoIlxuRXJyb3I6IE5vIGZpbGVuYW1lIGRldGVjdGVkIC0gU3BlY2lmeSB0aGUgZmlsZW5hbWUgdG8gYmUgZm9sbG93ZWRcbiIgKyBNVUxUSUxPR19VU0FHRSwgRVhJVF9PSykKICAgICAgICAjIENoZWNrIGlmIGEgd2lsZGNhcmQgZGV0ZWN0ZWQgaW4gcGF0aG5hbWUKICAgICAgICBpZiAnKicgaW4gcG5hbWU6CiAgICAgICAgICAgICMgVmVyaWZ5IHRoYXQgb25seSBvbmUgd2lsZGNhcmQgaXMgaW4gcGF0aG5hbWUKICAgICAgICAgICAgaWYgcG5hbWUuY291bnQoJyonKSA+IDE6CiAgICAgICAgICAgICAgICBpZiBub3QgY21kX2xpbmU6CiAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKCJFcnJvcjogTW9yZSB0aGVuIG9uZSB3aWxkY2FyZCAqIGRldGVjdGVkIGluIHBhdGhuYW1lIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRpZSgiXG5FcnJvcjogT25seSBvbmUgd2lsZGNhcmQgKiBhbGxvd2VkXG4iICsgTVVMVElMT0dfVVNBR0UsIEVYSVRfT0spCiAgICAgICAgICAgICMgVmVyaWZ5IHRoYXQgbm8gd2lsZGNhcmQgaXMgaW4gZmlsZW5hbWUKICAgICAgICAgICAgaWYgJyonIGluIGZpbGVuYW1lOgogICAgICAgICAgICAgICAgaWYgbm90IGNtZF9saW5lOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3I6IFdpbGRjYXJkIGRldGVjdGVkIGluIGZpbGVuYW1lIG9mIHBhdGggYXJndW1lbnQiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkaWUoIlxuRXJyb3I6IE5vIHdpbGRjYXJkICogYWxsb3dlZCBpbiBmaWxlbmFtZVxuIiArIE1VTFRJTE9HX1VTQUdFLCBFWElUX09LKQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHByb2Nlc3NfcGFyYW1zKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgIiIiCiAgICAgICAgUGFyc2VzIGNvbW1hbmQgbGluZSBwYXJhbWV0ZXJzIGFuZCB1cGRhdGVzIGNvbmZpZyBwYXJhbWV0ZXJzIGFjY29yZGluZ2x5CiAgICAgICAgIiIiCiAgICAgICAgcGFyYW1fbGlzdCA9ICIiInVzZXIta2V5PSBhY2NvdW50LWtleT0gYWdlbnQta2V5PSBob3N0LWtleT0gbm8tdGltZXN0YW1wcyBkZWJ1Zy1ldmVudHMKICAgICAgICAgICAgICAgICAgICBkZWJ1Zy10cmFuc3BvcnQtZXZlbnRzIGRlYnVnLW1ldHJpY3MKICAgICAgICAgICAgICAgICAgICBkZWJ1Zy1maWx0ZXJzIGRlYnVnLWZvcm1hdHRlcnMgZGVidWctbG9nbGlzdCBsb2NhbCBkZWJ1Zy1zdGF0cyBkZWJ1Zy1ub3N0YXRzCiAgICAgICAgICAgICAgICAgICAgZGVidWctc3RhdHMtb25seSBkZWJ1Zy1jbWQtbGluZSBkZWJ1Zy1zeXN0ZW0gaGVscCB2ZXJzaW9uIHllcyBmb3JjZSB1dWlkIGxpc3QKICAgICAgICAgICAgICAgICAgICBzdGQgc3RkLWFsbCBuYW1lPSBob3N0bmFtZT0gdHlwZT0gcGlkLWZpbGU9IGRlYnVnIG5vLWRlZmF1bHRzCiAgICAgICAgICAgICAgICAgICAgc3VwcHJlc3Mtc3NsIHVzZS1jYS1wcm92aWRlZCBmb3JjZS1hcGktaG9zdD0gZm9yY2UtZG9tYWluPQogICAgICAgICAgICAgICAgICAgIHN5c3RlbS1zdGF0LXRva2VuPSBkYXRhaHViPSBsZWdhY3lfdjFfbWV0cmljcwogICAgICAgICAgICAgICAgICAgIHB1bGwtc2VydmVyLXNpZGUtY29uZmlnPSBjb25maWc9IGNvbmZpZy5kPSBtdWx0aWxvZyBkZWJ1Zy1tdWx0aWxvZyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgb3B0bGlzdCwgYXJncyA9IGdldG9wdC5nbnVfZ2V0b3B0KHBhcmFtcywgJycsIHBhcmFtX2xpc3Quc3BsaXQoKSkKICAgICAgICBleGNlcHQgZ2V0b3B0LkdldG9wdEVycm9yLCBlcnI6CiAgICAgICAgICAgIGRpZSgiUGFyYW1ldGVyIGVycm9yOiAiICsgc3RyKGVycikpCiAgICAgICAgZm9yIG5hbWUsIHZhbHVlIGluIG9wdGxpc3Q6CiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0taGVscCI6CiAgICAgICAgICAgICAgICBwcmludF91c2FnZSgpCiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0tdmVyc2lvbiI6CiAgICAgICAgICAgICAgICBwcmludF91c2FnZShUcnVlKQogICAgICAgICAgICBpZiBuYW1lID09ICItLWNvbmZpZyI6CiAgICAgICAgICAgICAgICBzZWxmLmNvbmZpZ19maWxlbmFtZSA9IHZhbHVlCiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0tY29uZmlnLmQiOgogICAgICAgICAgICAgICAgc2VsZi5jb25maWdfZCA9IHZhbHVlCiAgICAgICAgICAgIGlmIG5hbWUgPT0gIi0teWVzIjoKICAgICAgICAgICAgICAgIHNlbGYueWVzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tdXNlci1rZXkiOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfdXNlcl9rZXkodmFsdWUpCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1hY2NvdW50LWtleSI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF91c2VyX2tleSh2YWx1ZSkKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWFnZW50LWtleSI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9hZ2VudF9rZXkodmFsdWUpCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1ob3N0LWtleSI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9hZ2VudF9rZXkodmFsdWUpCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1mb3JjZSI6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tbGlzdCI6CiAgICAgICAgICAgICAgICBzZWxmLnhsaXN0ID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tdXVpZCI6CiAgICAgICAgICAgICAgICBzZWxmLnV1aWQgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1uYW1lIjoKICAgICAgICAgICAgICAgIHNlbGYubmFtZSA9IHZhbHVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1ob3N0bmFtZSI6CiAgICAgICAgICAgICAgICBzZWxmLmhvc3RuYW1lID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWxlZ2FjeV92MV9tZXRyaWNzIjoKICAgICAgICAgICAgICAgIHNlbGYudjFfbWV0cmljcyA9ICdUcnVlJwogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tcGlkLWZpbGUiOgogICAgICAgICAgICAgICAgaWYgdmFsdWUgPT0gJyc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5waWRfZmlsZSA9IE5vbmUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5waWRfZmlsZSA9IHZhbHVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1zdGQiOgogICAgICAgICAgICAgICAgc2VsZi5zdGQgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS10eXBlIjoKICAgICAgICAgICAgICAgIHNlbGYudHlwZV9vcHQgPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tc3RkLWFsbCI6CiAgICAgICAgICAgICAgICBzZWxmLnN0ZF9hbGwgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1uby10aW1lc3RhbXBzIjoKICAgICAgICAgICAgICAgIHNlbGYubm9fdGltZXN0YW1wcyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWcgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1jbWQtbGluZSI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2NtZF9saW5lID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctbXVsdGlsb2ciOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19tdWx0aWxvZyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLWV2ZW50cyI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2V2ZW50cyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLXRyYW5zcG9ydC1ldmVudHMiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z190cmFuc3BvcnRfZXZlbnRzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctZmlsdGVycyI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2ZpbHRlcnMgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1mb3JtYXR0ZXJzIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfZm9ybWF0dGVycyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLW1ldHJpY3MiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19tZXRyaWNzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tbG9jYWwiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19sb2NhbCA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLXN0YXRzIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfc3RhdHMgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1ub3N0YXRzIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfbm9zdGF0cyA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLWRlYnVnLXN0YXRzLW9ubHkiOgogICAgICAgICAgICAgICAgc2VsZi5kZWJ1Z19zdGF0c19vbmx5ID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctbG9nbGlzdCI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX2xvZ2xpc3QgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1kZWJ1Zy1yZXF1ZXN0cyI6CiAgICAgICAgICAgICAgICBzZWxmLmRlYnVnX3JlcXVlc3RzID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGVidWctc3lzdGVtIjoKICAgICAgICAgICAgICAgIHNlbGYuZGVidWdfc3lzdGVtID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tc3VwcHJlc3Mtc3NsIjoKICAgICAgICAgICAgICAgIHNlbGYuc3VwcHJlc3Nfc3NsID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZm9yY2UtYXBpLWhvc3QiOgogICAgICAgICAgICAgICAgaWYgdmFsdWUgYW5kIHZhbHVlICE9ICcnOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9yY2VfYXBpX2hvc3QgPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZm9yY2UtZGF0YS1ob3N0IjoKICAgICAgICAgICAgICAgIGlmIHZhbHVlIGFuZCB2YWx1ZSAhPSAnJzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX2RhdGFfaG9zdCA9IHZhbHVlCiAgICAgICAgICAgIGVsaWYgbmFtZSA9PSAiLS1mb3JjZS1kb21haW4iOgogICAgICAgICAgICAgICAgaWYgdmFsdWUgYW5kIHZhbHVlICE9ICcnOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9yY2VfZG9tYWluID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLXVzZS1jYS1wcm92aWRlZCI6CiAgICAgICAgICAgICAgICBzZWxmLnVzZV9jYV9wcm92aWRlZCA9IFRydWUKICAgICAgICAgICAgZWxpZiBuYW1lID09ICItLXN5c3RlbS1zdGF0LXRva2VuIjoKICAgICAgICAgICAgICAgIHNlbGYuc2V0X3N5c3RlbV9zdGF0X3Rva2VuKHZhbHVlKQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tcHVsbC1zZXJ2ZXItc2lkZS1jb25maWciOgogICAgICAgICAgICAgICAgc2VsZi5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZyA9IHZhbHVlID09ICJUcnVlIgogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tZGF0YWh1YiI6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9kYXRhaHViX3NldHRpbmdzKHZhbHVlKQogICAgICAgICAgICBlbGlmIG5hbWUgPT0gIi0tbXVsdGlsb2ciOgogICAgICAgICAgICAgICAgIyBzZWxmLm11bHRpbG9nIGlzIG9ubHkgVHJ1ZSBpZiBwYXRobmFtZSBpcyBnb29kCiAgICAgICAgICAgICAgICBzZWxmLm11bHRpbG9nID0gc2VsZi52YWxpZGF0ZV9wYXRobmFtZShhcmdzLFRydWUsTm9uZSkKCiAgICAgICAgaWYgc2VsZi5kYXRhaHViX2lwIGFuZCBub3Qgc2VsZi5kYXRhaHViX3BvcnQ6CiAgICAgICAgICAgIGlmIHNlbGYuc3VwcHJlc3Nfc3NsOgogICAgICAgICAgICAgICAgc2VsZi5kYXRhaHViX3BvcnQgPSBMRV9ERUZBVUxUX05PTl9TU0xfUE9SVAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5kYXRhaHViX3BvcnQgPSBMRV9ERUZBVUxUX1NTTF9QT1JUCgogICAgICAgIGlmIHNlbGYuZGVidWdfbG9jYWwgYW5kIHNlbGYuZm9yY2VfYXBpX2hvc3Q6CiAgICAgICAgICAgIGRpZSgiRG8gbm90IHNwZWNpZnkgLS1sb2NhbCBhbmQgLS1mb3JjZS1hcGktaG9zdCBhdCB0aGUgc2FtZSB0aW1lLiIpCiAgICAgICAgaWYgc2VsZi5kZWJ1Z19sb2NhbCBhbmQgc2VsZi5mb3JjZV9kYXRhX2hvc3Q6CiAgICAgICAgICAgIGRpZSgiRG8gbm90IHNwZWNpZnkgLS1sb2NhbCBhbmQgLS1mb3JjZS1kYXRhLWhvc3QgYXQgdGhlIHNhbWUgdGltZS4iKQogICAgICAgIGlmIHNlbGYuZGVidWdfbG9jYWwgYW5kIHNlbGYuZm9yY2VfZG9tYWluOgogICAgICAgICAgICBkaWUoIkRvIG5vdCBzcGVjaWZ5IC0tbG9jYWwgYW5kIC0tZm9yY2UtZG9tYWluIGF0IHRoZSBzYW1lIHRpbWUuIikKICAgICAgICByZXR1cm4gYXJncwoKY29uZmlnID0gQ29uZmlnKCkKCgpkZWYgZG9fcmVxdWVzdChjb25uLCBvcGVyYXRpb24sIGFkZHIsIGRhdGE9Tm9uZSwgaGVhZGVycz17fSk6CiAgICBsb2cuZGVidWcoJ0RvbWFpbiByZXF1ZXN0OiAlcyAlcyAlcyAlcycsIG9wZXJhdGlvbiwgYWRkciwgZGF0YSwgaGVhZGVycykKICAgIGlmIGRhdGE6CiAgICAgICAgY29ubi5yZXF1ZXN0KG9wZXJhdGlvbiwgYWRkciwgZGF0YSwgaGVhZGVycz1oZWFkZXJzKQogICAgZWxzZToKICAgICAgICBjb25uLnJlcXVlc3Qob3BlcmF0aW9uLCBhZGRyLCBoZWFkZXJzPWhlYWRlcnMpCgoKZGVmIGdldF9yZXNwb25zZShvcGVyYXRpb24sIGFkZHIsIGRhdGE9Tm9uZSwgaGVhZGVycz17fSwgc2lsZW50PUZhbHNlLCBkaWVfb25fZXJyb3I9VHJ1ZSwgZG9tYWluPURvbWFpbi5BUEkpOgogICAgIiIiCiAgICBSZXR1cm5zIHJlc3BvbnNlIGZyb20gdGhlIGRvbWFpbiBvciBBUEkgc2VydmVyLgogICAgIiIiCiAgICByZXNwb25zZSA9IE5vbmUKICAgIGNvbm4gPSBOb25lCiAgICB0cnk6CiAgICAgICAgY29ubiA9IGRvbWFpbl9jb25uZWN0KGNvbmZpZywgZG9tYWluLCBEb21haW4pCiAgICAgICAgZG9fcmVxdWVzdChjb25uLCBvcGVyYXRpb24sIGFkZHIsIGRhdGEsIGhlYWRlcnMpCiAgICAgICAgcmVzcG9uc2UgPSBjb25uLmdldHJlc3BvbnNlKCkKICAgICAgICByZXR1cm4gcmVzcG9uc2UsIGNvbm4KICAgIGV4Y2VwdCBzb2NrZXQuc3NsZXJyb3IsIG1zZzogICMgTmV0d29yayBlcnJvcgogICAgICAgIGlmIG5vdCBzaWxlbnQ6CiAgICAgICAgICAgIGxvZy5pbmZvKCJTU0wgZXJyb3I6ICVzIiwgbXNnKQogICAgZXhjZXB0IHNvY2tldC5lcnJvciwgbXNnOiAgIyBOZXR3b3JrIGVycm9yCiAgICAgICAgaWYgbm90IHNpbGVudDoKICAgICAgICAgICAgbG9nLmRlYnVnKCJOZXR3b3JrIGVycm9yOiAlcyIsIG1zZykKICAgIGV4Y2VwdCBodHRwbGliLkJhZFN0YXR1c0xpbmU6CiAgICAgICAgZXJyb3IgPSAiSW50ZXJuYWwgZXJyb3IsIGJhZCBzdGF0dXMgbGluZSIKICAgICAgICBpZiBkaWVfb25fZXJyb3I6CiAgICAgICAgICAgIGRpZShlcnJvcikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2cuaW5mbyhlcnJvcikKCiAgICByZXR1cm4gTm9uZSwgTm9uZQoKCmRlZiBhcGlfcmVxdWVzdChyZXF1ZXN0LCByZXF1aXJlZD1GYWxzZSwgY2hlY2tfc3RhdHVzPUZhbHNlLCBzaWxlbnQ9RmFsc2UsIGRpZV9vbl9lcnJvcj1UcnVlKToKICAgICIiIgogICAgUHJvY2Vzc2VzIGEgcmVxdWVzdCBvbiB0aGUgbG9nZW50cmllcyBkb21haW4uCiAgICAiIiIKICAgICMgT2J0YWluIHJlc3BvbnNlCiAgICByZXNwb25zZSwgY29ubiA9IGdldF9yZXNwb25zZSgKICAgICAgICAiUE9TVCIsIExFX1NFUlZFUl9BUEksIHVybGxpYi51cmxlbmNvZGUocmVxdWVzdCksCiAgICAgICAgc2lsZW50PXNpbGVudCwgZGllX29uX2Vycm9yPWRpZV9vbl9lcnJvciwgZG9tYWluPURvbWFpbi5BUEksCiAgICAgICAgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnfSkKCiAgICAjIENoZWNrIHRoZSByZXNwb25zZQogICAgaWYgbm90IHJlc3BvbnNlOgogICAgICAgIGlmIHJlcXVpcmVkOgogICAgICAgICAgICBkaWUoIkVycm9yOiBDYW5ub3QgcHJvY2VzcyBMRSByZXF1ZXN0LCBubyByZXNwb25zZSIpCiAgICAgICAgaWYgY29ubjoKICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGlmIHJlc3BvbnNlLnN0YXR1cyAhPSAyMDA6CiAgICAgICAgaWYgcmVxdWlyZWQ6CiAgICAgICAgICAgIGRpZSgiRXJyb3I6IENhbm5vdCBwcm9jZXNzIExFIHJlcXVlc3Q6ICglcykiICUgcmVzcG9uc2Uuc3RhdHVzKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIHJldHVybiBOb25lCgogICAgeHJlc3BvbnNlID0gcmVzcG9uc2UucmVhZCgpCiAgICBjb25uLmNsb3NlKCkKICAgIGxvZy5kZWJ1ZygnRG9tYWluIHJlc3BvbnNlOiAiJXMiJywgeHJlc3BvbnNlKQogICAgdHJ5OgogICAgICAgIGRfcmVzcG9uc2UgPSBqc29uX2xvYWRzKHhyZXNwb25zZSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIGVycm9yID0gJ0Vycm9yOiBJbnZhbGlkIHJlc3BvbnNlLCBwYXJzZSBlcnJvci4nCiAgICAgICAgaWYgZGllX29uX2Vycm9yOgogICAgICAgICAgICBkaWUoZXJyb3IpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmluZm8oZXJyb3IpCiAgICAgICAgICAgIGRfcmVzcG9uc2UgPSBOb25lCgogICAgaWYgY2hlY2tfc3RhdHVzIGFuZCBkX3Jlc3BvbnNlWydyZXNwb25zZSddICE9ICdvayc6CiAgICAgICAgcmVhc29uID0gZF9yZXNwb25zZVsncmVhc29uJ10KCiAgICAgICAgIyBTcGVjaWFsIGNvbXBhdGliaWxpdHkgY2FzZTogY2hhbmdlIGdyb3VwIHRvIGhvc3QKICAgICAgICByZWFzb24gPSByZWFzb24ucmVwbGFjZSggJ1RoZSBncm91cCB3aXRoIElEJywgJ1RoZSBob3N0IHdpdGggSUQnKQoKICAgICAgICBlcnJvciA9ICJFcnJvcjogJXMiICUgcmVhc29uCiAgICAgICAgaWYgZGllX29uX2Vycm9yOgogICAgICAgICAgICBkaWUoZXJyb3IpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmluZm8oZXJyb3IpCiAgICAgICAgICAgIGRfcmVzcG9uc2UgPSBOb25lCgogICAgcmV0dXJuIGRfcmVzcG9uc2UKCgpkZWYgcHVsbF9yZXF1ZXN0KHdoYXQsIHBhcmFtcyk6CiAgICAiIiIKICAgIFByb2Nlc3NlcyBhIHB1bGwgcmVxdWVzdCBvbiB0aGUgbG9nZW50cmllcyBkb21haW4uCiAgICAiIiIKICAgIHJlc3BvbnNlID0gTm9uZQoKICAgICMgT2J0YWluIHJlc3BvbnNlCiAgICBhZGRyID0gJy8lcy8lcy8/JXMnICUgKAogICAgICAgIGNvbmZpZy51c2VyX2tleSwgdXJsbGliLnF1b3RlKHdoYXQpLCB1cmxsaWIudXJsZW5jb2RlKHBhcmFtcykpCiAgICByZXNwb25zZSwgY29ubiA9IGdldF9yZXNwb25zZSgiR0VUIiwgYWRkciwgZG9tYWluPURvbWFpbi5QVUxMKQoKICAgICMgQ2hlY2sgdGhlIHJlc3BvbnNlCiAgICBpZiBub3QgcmVzcG9uc2U6CiAgICAgICAgZGllKCJFcnJvcjogQ2Fubm90IHByb2Nlc3MgTEUgcmVxdWVzdCwgbm8gcmVzcG9uc2UiKQogICAgaWYgcmVzcG9uc2Uuc3RhdHVzID09IDQwNDoKICAgICAgICBkaWUoIkVycm9yOiBMb2cgbm90IGZvdW5kIikKICAgIGlmIHJlc3BvbnNlLnN0YXR1cyAhPSAyMDA6CiAgICAgICAgZGllKCJFcnJvcjogQ2Fubm90IHByb2Nlc3MgTEUgcmVxdWVzdDogKCVzKSIgJSByZXNwb25zZS5zdGF0dXMpCgogICAgd2hpbGUgVHJ1ZToKICAgICAgICBkYXRhID0gcmVzcG9uc2UucmVhZCg2NTUzNikKICAgICAgICBpZiBsZW4oZGF0YSkgPT0gMDoKICAgICAgICAgICAgYnJlYWsKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKGRhdGEpCiAgICBjb25uLmNsb3NlKCkKCgpkZWYgcmVxdWVzdChyZXF1ZXN0LCByZXF1aXJlZD1GYWxzZSwgY2hlY2tfc3RhdHVzPUZhbHNlLCBydHlwZT0nR0VUJywgcmV0cnk9RmFsc2UpOgogICAgIiIiCiAgICBQcm9jZXNzZXMgYSBsaXN0IHJlcXVlc3Qgb24gdGhlIEFQSSBzZXJ2ZXIuCiAgICAiIiIKICAgIG5vdGljZWQgPSBGYWxzZQogICAgd2hpbGUgVHJ1ZToKICAgICAgICAjIE9idGFpbiByZXNwb25zZQogICAgICAgIHJlc3BvbnNlLCBjb25uID0gZ2V0X3Jlc3BvbnNlKAogICAgICAgICAgICBydHlwZSwgdXJsbGliLnF1b3RlKCcvJyArIGNvbmZpZy51c2VyX2tleSArICcvJyArIHJlcXVlc3QpLAogICAgICAgICAgICBkaWVfb25fZXJyb3I9bm90IHJldHJ5KQoKICAgICAgICAjIENoZWNrIHRoZSByZXNwb25zZQogICAgICAgIGlmIHJlc3BvbnNlOgogICAgICAgICAgICBicmVhawogICAgICAgIGlmIHJlcXVpcmVkOgogICAgICAgICAgICBkaWUoJ0Vycm9yOiBDYW5ub3QgcHJvY2VzcyBMRSByZXF1ZXN0LCBubyByZXNwb25zZScpCiAgICAgICAgaWYgcmV0cnk6CiAgICAgICAgICAgIGlmIG5vdCBub3RpY2VkOgogICAgICAgICAgICAgICAgbG9nLmluZm8oJ0Vycm9yOiBObyByZXNwb25zZSBmcm9tIExFLCByZS10cnlpbmcgaW4gJXNzIGludGVydmFscycsCiAgICAgICAgICAgICAgICAgICAgICAgICBTUlZfUkVDT05fVElNRU9VVCkKICAgICAgICAgICAgICAgIG5vdGljZWQgPSBUcnVlCiAgICAgICAgICAgIHRpbWUuc2xlZXAoU1JWX1JFQ09OX1RJTUVPVVQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICByZXNwb25zZSA9IHJlc3BvbnNlLnJlYWQoKQogICAgY29ubi5jbG9zZSgpCiAgICBsb2cuZGVidWcoJ0xpc3QgcmVzcG9uc2U6ICVzJywgcmVzcG9uc2UpCiAgICB0cnk6CiAgICAgICAgZF9yZXNwb25zZSA9IGpzb25fbG9hZHMocmVzcG9uc2UpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBkaWUoJ0Vycm9yOiBJbnZhbGlkIHJlc3BvbnNlICglcyknICUgcmVzcG9uc2UpCgogICAgaWYgY2hlY2tfc3RhdHVzIGFuZCBkX3Jlc3BvbnNlWydyZXNwb25zZSddICE9ICdvayc6CiAgICAgICAgZGllKCdFcnJvcjogJXMnICUgZF9yZXNwb25zZVsncmVhc29uJ10pCgogICAgcmV0dXJuIGRfcmVzcG9uc2UKCgpkZWYgX3N0YXJ0dXBfaW5mbygpOgogICAgIiIiCiAgICBQcmludHMgY29ycmVjdCBzdGFydHVwIGluZm9ybWF0aW9uIGJhc2VkIG9uIE9TCiAgICAiIiIKICAgIGlmICdkYXJ3aW4nIGluIHN5cy5wbGF0Zm9ybToKICAgICAgICBsb2cuaW5mbygKICAgICAgICAgICAgJyAgc3VkbyBsYXVuY2hjdGwgdW5sb2FkIC9MaWJyYXJ5L0xhdW5jaERhZW1vbnMvY29tLmxvZ2VudHJpZXMuYWdlbnQucGxpc3QnKQogICAgICAgIGxvZy5pbmZvKAogICAgICAgICAgICAnICBzdWRvIGxhdW5jaGN0bCBsb2FkIC9MaWJyYXJ5L0xhdW5jaERhZW1vbnMvY29tLmxvZ2VudHJpZXMuYWdlbnQucGxpc3QnKQogICAgZWxpZiAnbGludXgnIGluIHN5cy5wbGF0Zm9ybToKICAgICAgICBsb2cuaW5mbygnICBzdWRvIHNlcnZpY2UgbG9nZW50cmllcyByZXN0YXJ0JykKICAgIGVsaWYgJ3N1bm9zJyBpbiBzeXMucGxhdGZvcm06CiAgICAgICAgbG9nLmluZm8oJyAgc3VkbyBzdmNhZG0gZGlzYWJsZSBsb2dlbnRyaWVzJykKICAgICAgICBsb2cuaW5mbygnICBzdWRvIHN2Y2FkbSBlbmFibGUgbG9nZW50cmllcycpCiAgICBlbHNlOgogICAgICAgIGxvZy5pbmZvKCcnKQoKCmRlZiBjcmVhdGVfbG9nKGhvc3Rfa2V5LCBuYW1lLCBmaWxlbmFtZSwgdHlwZV9vcHQsIGRvX2ZvbGxvdz1UcnVlLCBzb3VyY2U9Tm9uZSk6CiAgICAiIiIKICAgIENyZWF0ZXMgYSBsb2cgb24gc2VydmVyIHdpdGggZ2l2ZW4gcGFyYW1ldGVycy4KICAgICIiIgogICAgcmVxdWVzdCA9IHsKICAgICAgICAncmVxdWVzdCc6ICduZXdfbG9nJywKICAgICAgICAndXNlcl9rZXknOiBjb25maWcudXNlcl9rZXksCiAgICAgICAgJ2hvc3Rfa2V5JzogaG9zdF9rZXksCiAgICAgICAgJ25hbWUnOiBuYW1lLAogICAgICAgICdmaWxlbmFtZSc6IGZpbGVuYW1lLAogICAgICAgICd0eXBlJzogdHlwZV9vcHQsCiAgICB9CiAgICByZXF1ZXN0Wydmb2xsb3cnXSA9ICd0cnVlJwoKICAgIGlmIG5vdCBkb19mb2xsb3c6CiAgICAgICAgcmVxdWVzdFsnZm9sbG93J10gPSAnZmFsc2UnCgogICAgaWYgc291cmNlOgogICAgICAgIHJlcXVlc3RbJ3NvdXJjZSddID0gc291cmNlCiAgICByZXNwID0gYXBpX3JlcXVlc3QocmVxdWVzdCwgVHJ1ZSwgVHJ1ZSkKCiAgICBpZiByZXNwWydyZXNwb25zZSddID09ICdvayc6CiAgICAgICAgcmV0dXJuIHJlc3BbJ2xvZyddCiAgICByZXR1cm4gTm9uZQoKCmRlZiBjcmVhdGVfaG9zdChuYW1lLCBob3N0bmFtZSwgc3lzdGVtLCBkaXN0bmFtZSwgZGlzdHZlcik6CiAgICAiIiIKICAgIENyZWF0ZXMgYSBuZXcgaG9zdCBvbiBzZXJ2ZXIgd2l0aCBnaXZlbiBwYXJhbWV0ZXJzLgogICAgIiIiCiAgICByZXF1ZXN0ID0gewogICAgICAgICdyZXF1ZXN0JzogJ3JlZ2lzdGVyJywKICAgICAgICAndXNlcl9rZXknOiBjb25maWcudXNlcl9rZXksCiAgICAgICAgJ25hbWUnOiBuYW1lLAogICAgICAgICdob3N0bmFtZSc6IGhvc3RuYW1lLAogICAgICAgICdzeXN0ZW0nOiBzeXN0ZW0sCiAgICAgICAgJ2Rpc3RuYW1lJzogZGlzdG5hbWUsCiAgICAgICAgJ2Rpc3R2ZXInOiBkaXN0dmVyCiAgICB9CiAgICByZXNwID0gYXBpX3JlcXVlc3QocmVxdWVzdCwgVHJ1ZSwgVHJ1ZSkKICAgIGlmIHJlc3BbJ3Jlc3BvbnNlJ10gPT0gJ29rJzoKICAgICAgICByZXR1cm4gcmVzcFsnaG9zdCddCiAgICBlbHNlOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIHJlcXVlc3RfZm9sbG93KGZpbGVuYW1lLCBuYW1lLCB0eXBlX29wdCk6CiAgICAiIiIKICAgIENyZWF0ZXMgYSBuZXcgbG9nIHRvIGZvbGxvdyB0aGUgZmlsZSBnaXZlbi4KICAgICIiIgogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCiAgICBmb2xsb3dlZF9sb2cgPSBjcmVhdGVfbG9nKGNvbmZpZy5hZ2VudF9rZXksIG5hbWUsIGZpbGVuYW1lLCB0eXBlX29wdCkKICAgIHByaW50ICJXaWxsIGZvbGxvdyAlcyBhcyAlcyIgJSAoZmlsZW5hbWUsIG5hbWUpCiAgICBsb2cuaW5mbygiRG9uJ3QgZm9yZ2V0IHRvIHJlc3RhcnQgdGhlIGRhZW1vbiIpCiAgICBfc3RhcnR1cF9pbmZvKCkKICAgIHJldHVybiBmb2xsb3dlZF9sb2cKCgpkZWYgcmVxdWVzdF9ob3N0cyhsb2FkX2xvZ3M9RmFsc2UpOgogICAgIiIiUmV0dXJucyBsaXN0IG9mIHJlZ2lzdGVyZWQgaG9zdHMuCiAgICAiIiIKICAgIGlmIGxvYWRfbG9nczoKICAgICAgICB4bG9hZF9sb2dzID0gJ3RydWUnCiAgICBlbHNlOgogICAgICAgIHhsb2FkX2xvZ3MgPSAnZmFsc2UnCiAgICByZXNwb25zZSA9IGFwaV9yZXF1ZXN0KHsKICAgICAgICAncmVxdWVzdCc6ICdnZXRfdXNlcicsCiAgICAgICAgJ2xvYWRfaG9zdHMnOiAndHJ1ZScsCiAgICAgICAgJ2xvYWRfbG9ncyc6IHhsb2FkX2xvZ3MsCiAgICAgICAgJ3VzZXJfa2V5JzogY29uZmlnLnVzZXJfa2V5fSwgVHJ1ZSwgVHJ1ZSkKCiAgICByZXR1cm4gcmVzcG9uc2VbJ2hvc3RzJ10KCgpkZWYgZ2V0X29yX2NyZWF0ZV9ob3N0KGhvc3RfbmFtZSk6CiAgICAiIiJHZXRzIG9yIGNyZWF0ZXMgYSBuZXcgaG9zdC4KICAgICIiIgogICAgIyBSZXRyaWV2ZSB0aGUgaG9zdCB2aWEgQVBJCiAgICBhY2NvdW50X2hvc3RzID0gcmVxdWVzdF9ob3N0cyhsb2FkX2xvZ3M9VHJ1ZSkKICAgIGhvc3QgPSBmaW5kX2FwaV9vYmpfYnlfbmFtZShhY2NvdW50X2hvc3RzLCBob3N0X25hbWUpCgogICAgaWYgbm90IGhvc3Q6CiAgICAgICAgIyBJZiBpdCBkb2VzIG5vdCBleGlzdCwgY3JlYXRlIGEgbmV3IG9uZQogICAgICAgIGhvc3QgPSBjcmVhdGVfaG9zdChob3N0X25hbWUsICcnLCAnJywgJycsICcnKQoKICAgIHJldHVybiBob3N0WydrZXknXQoKCmRlZiBnZXRfb3JfY3JlYXRlX2xvZyhob3N0X2tleSwgbG9nX25hbWUsIGRlc3RpbmF0aW9uKToKICAgICIiIiBHZXRzIG9yIGNyZWF0ZXMgYSBsb2cgZm9yIHRoZSBob3N0IGdpdmVuLiBJdCByZXR1cm5zIGxvZ3MncyB0b2tlbiBvcgogICAgTm9uZS4KICAgICIiIgogICAgaWYgbm90IGhvc3Rfa2V5OgogICAgICAgIHJldHVybiBOb25lCgogICAgIyBSZXRyaWV2ZSB0aGUgbG9nIHZpYSBBUEkKICAgIGFjY291bnRfaG9zdHMgPSByZXF1ZXN0X2hvc3RzKGxvYWRfbG9ncz1UcnVlKQogICAgaG9zdCA9IGZpbmRfYXBpX29ial9ieV9rZXkoYWNjb3VudF9ob3N0cywgaG9zdF9rZXkpCiAgICBpZiBub3QgaG9zdDoKICAgICAgICByZXR1cm4gTm9uZQogICAgeGxvZyA9IGZpbmRfYXBpX29ial9ieV9uYW1lKGhvc3RbJ2xvZ3MnXSwgbG9nX25hbWUpCiAgICBpZiBub3QgeGxvZzoKICAgICAgICAjIFRyeSB0byBjcmVhdGUgdGhlIGxvZwogICAgICAgIHhsb2cgPSBjcmVhdGVfbG9nKGhvc3RbJ2tleSddLCBsb2dfbmFtZSwgJycsICcnLCBkb19mb2xsb3c9RmFsc2UsIHNvdXJjZT0ndG9rZW4nKQogICAgICAgIGlmIG5vdCB4bG9nOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIHJldHVybiB4bG9nLmdldCgndG9rZW4nLCBOb25lKQoKCiMKIyBDb21tYW5kcwojCgpkZWYgY21kX2luaXQoYXJncyk6CiAgICAiIiIKICAgIFNhdmVzIHZhcmlhYmxlcyBnaXZlbiB0byB0aGUgY29uZmlndXJhdGlvbiBmaWxlLiBWYXJpYWJsZXMgbm90CiAgICBzcGVjaWZpZWQgYXJlIG5vdCBzYXZlZCBhbmQgdGh1cyBhcmUgb3ZlcndyaXR0ZW4gd2l0aCBkZWZhdWx0IHZhbHVlLgogICAgVGhlIGNvbmZpZ3VyYXRpb24gZGlyZWN0b3J5IGlzIGNyZWF0ZWQgaWYgaXQgZG9lcyBub3QgZXhpdC4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBjb25maWcudXNlcl9rZXlfcmVxdWlyZWQoVHJ1ZSkKICAgIGNvbmZpZy5zYXZlKCkKICAgIGxvZy5pbmZvKCJJbml0aWFsaXplZCIpCgoKZGVmIGNtZF9yZWluaXQoYXJncyk6CiAgICAiIiIKICAgIFNhdmVzIHZhcmlhYmxlcyBnaXZlbiB0byB0aGUgY29uZmlndXJhdGlvbiBmaWxlLiBUaGUgY29uZmlndXJhdGlvbgogICAgZGlyZWN0b3J5IGlzIGNyZWF0ZWQgaWYgaXQgZG9lcyBub3QgZXhpdC4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBjb25maWcubG9hZChsb2FkX2luY2x1ZGVfZGlycz1GYWxzZSkKICAgIGNvbmZpZy5zYXZlKCkKICAgIGxvZy5pbmZvKCJSZWluaXRpYWxpemVkIikKCgpkZWYgY21kX3JlZ2lzdGVyKGFyZ3MpOgogICAgIiIiCiAgICBSZWdpc3RlcnMgdGhlIGFnZW50IGluIGxvZ2VudHJpZXMgaW5mcmFzdHJ1Y3R1cmUuIFRoZSBuZXdseSBvYnRhaW5lZAogICAgYWdlbnQga2V5IGlzIHN0b3JlZCBpbiB0aGUgY29uZmlndXJhdGlvbiBmaWxlLgogICAgIiIiCiAgICBub19tb3JlX2FyZ3MoYXJncykKICAgIGNvbmZpZy5sb2FkKCkKCiAgICBpZiBjb25maWcuYWdlbnRfa2V5ICE9IE5PVF9TRVQgYW5kIG5vdCBjb25maWcuZm9yY2U6CiAgICAgICAgcmVwb3J0KCJXYXJuaW5nOiBTZXJ2ZXIgYWxyZWFkeSByZWdpc3RlcmVkLiBVc2UgLS1mb3JjZSB0byBvdmVycmlkZSBjdXJyZW50IHJlZ2lzdHJhdGlvbi4iKQogICAgICAgIHJldHVybgogICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKFRydWUpCiAgICBjb25maWcuaG9zdG5hbWVfcmVxdWlyZWQoKQogICAgY29uZmlnLm5hbWVfcmVxdWlyZWQoKQoKICAgIHNpID0gc3lzdGVtX2RldGVjdChUcnVlKQoKICAgIGhvc3QgPSBjcmVhdGVfaG9zdChjb25maWcubmFtZSwgY29uZmlnLmhvc3RuYW1lLCBzaVsnc3lzdGVtJ10sIHNpWydkaXN0bmFtZSddLCBzaVsnZGlzdHZlciddKQoKICAgIGNvbmZpZy5hZ2VudF9rZXkgPSBob3N0WydrZXknXQogICAgY29uZmlnLnNhdmUoKQoKICAgIGxvZy5pbmZvKCJSZWdpc3RlcmVkICVzICglcykiLCBjb25maWcubmFtZSwgY29uZmlnLmhvc3RuYW1lKQoKICAgICMgUmVnaXN0ZXJpbmcgbG9ncwogICAgbG9ncyA9IFtdCiAgICBpZiBjb25maWcuc3RkIG9yIGNvbmZpZy5zdGRfYWxsOgogICAgICAgIGxvZ3MgPSBjb2xsZWN0X2xvZ19uYW1lcyhzaSkKICAgIGZvciBsb2d4IGluIGxvZ3M6CiAgICAgICAgaWYgY29uZmlnLnN0ZF9hbGwgb3IgbG9neFsnZGVmYXVsdCddID09ICcxJzoKICAgICAgICAgICAgcmVxdWVzdF9mb2xsb3cobG9neFsnZmlsZW5hbWUnXSwgbG9neFsnbmFtZSddLCBsb2d4Wyd0eXBlJ10pCgojIFRoZSBmdW5jdGlvbiBjaGVja3MgZm9yIDIgdGhpbmdzOiAxKSB0aGF0IHRoZSBwYXRoIGlzIG5vdCBlbXB0eTsKIyAyKSB0aGUgcGF0aCBzdGFydHMgd2l0aCAnLycgY2hhcmFjdGVyIHdoaWNoIGluZGljYXRlcyB0aGF0IHRoZSBsb2cgaGFzCiMgYSAicGh5c2ljYWwiIHBhdGggd2hpY2ggc3RhcnRzIGZyb20gZmlsZXN5c3RlbSByb290LgoKCmRlZiBjaGVja19maWxlX25hbWUoZmlsZV9uYW1lKToKICAgIHJldHVybiBmaWxlX25hbWUuc3RhcnRzd2l0aCgnLycpCgoKZGVmIGdldF9maWx0ZXJzKGF2YWlsYWJsZV9maWx0ZXJzLCBmaWx0ZXJfZmlsZW5hbWVzLCBsb2dfbmFtZSwgbG9nX2lkLCBsb2dfZmlsZW5hbWUsIGxvZ190b2tlbik6CiAgICAjIENoZWNrIGZpbHRlcnMKICAgIGlmIG5vdCBmaWx0ZXJfZmlsZW5hbWVzKGxvZ19maWxlbmFtZSk6CiAgICAgICAgZGVidWdfZmlsdGVycygKICAgICAgICAgICAgIiBMb2cgYmxvY2tlZCBieSBmaWx0ZXJfZmlsZW5hbWVzLCBub3QgZm9sbG93aW5nIikKICAgICAgICBsb2cuaW5mbygKICAgICAgICAgICAgJ05vdCBmb2xsb3dpbmcgJXMsIGJsb2NrZWQgYnkgZmlsdGVyX2ZpbGVuYW1lcycsIGxvZ19uYW1lKQogICAgICAgIHJldHVybiBOb25lCiAgICBkZWJ1Z19maWx0ZXJzKAogICAgICAgICIgTG9va2luZyBmb3IgZmlsdGVycyBieSBsb2dfbmFtZT0lcyBsb2dfaWQ9JXMgdG9rZW49JXMiLCBsb2dfbmFtZSwgbG9nX2lkLCBsb2dfdG9rZW4pCgogICAgZW50cnlfZmlsdGVyID0gTm9uZQogICAgaWYgbm90IGVudHJ5X2ZpbHRlciBhbmQgbG9nX25hbWU6CiAgICAgICAgZGVidWdfZmlsdGVycygiIExvb2tpbmcgZm9yIGZpbHRlcnMgYnkgbG9nIG5hbWUiKQogICAgICAgIGVudHJ5X2ZpbHRlciA9IGF2YWlsYWJsZV9maWx0ZXJzLmdldChsb2dfbmFtZSkKICAgICAgICBpZiBub3QgZW50cnlfZmlsdGVyOgogICAgICAgICAgICBkZWJ1Z19maWx0ZXJzKCIgTm8gZmlsdGVyIGZvdW5kIGJ5IGxvZyBuYW1lIikKCiAgICBpZiBub3QgZW50cnlfZmlsdGVyIGFuZCBsb2dfaWQ6CiAgICAgICAgZGVidWdfZmlsdGVycygiIExvb2tpbmcgZm9yIGZpbHRlcnMgYnkgbG9nIElEIikKICAgICAgICBlbnRyeV9maWx0ZXIgPSBhdmFpbGFibGVfZmlsdGVycy5nZXQobG9nX2lkKQogICAgICAgIGlmIG5vdCBlbnRyeV9maWx0ZXI6CiAgICAgICAgICAgIGRlYnVnX2ZpbHRlcnMoIiBObyBmaWx0ZXIgZm91bmQgYnkgbG9nIElEIikKCiAgICBpZiBub3QgZW50cnlfZmlsdGVyIGFuZCBsb2dfdG9rZW46CiAgICAgICAgZGVidWdfZmlsdGVycygiIExvb2tpbmcgZm9yIGZpbHRlcnMgYnkgdG9rZW4iKQogICAgICAgIGVudHJ5X2ZpbHRlciA9IGF2YWlsYWJsZV9maWx0ZXJzLmdldChsb2dfdG9rZW4pCiAgICAgICAgaWYgbm90IGVudHJ5X2ZpbHRlcjoKICAgICAgICAgICAgZGVidWdfZmlsdGVycygiIE5vIGZpbHRlciBmb3VuZCBieSB0b2tlbiIpCgogICAgaWYgZW50cnlfZmlsdGVyIGFuZCBub3QgaGFzYXR0cihlbnRyeV9maWx0ZXIsICdfX2NhbGxfXycpOgogICAgICAgIGRlYnVnX2ZpbHRlcnMoCiAgICAgICAgICAgICIgRmlsdGVyIGZvdW5kLCBidXQgaWdub3JlZCBiZWNhdXNlIGl0J3Mgbm90IGEgZnVuY3Rpb24iKQogICAgICAgIGVudHJ5X2ZpbHRlciA9IE5vbmUKICAgIGlmIG5vdCBlbnRyeV9maWx0ZXI6CiAgICAgICAgZW50cnlfZmlsdGVyID0gZmlsdGVyX2V2ZW50cwogICAgICAgIGRlYnVnX2ZpbHRlcnMoIiBObyBmaWx0ZXIgZm91bmQiKQogICAgZWxzZToKICAgICAgICBkZWJ1Z19maWx0ZXJzKCIgVXNpbmcgZmlsdGVyICVzIiwgZW50cnlfZmlsdGVyKQogICAgcmV0dXJuIGVudHJ5X2ZpbHRlcgoKCmRlZiBnZXRfZm9ybWF0dGVycyhkZWZhdWx0X2Zvcm1hdHRlciwgYXZhaWxhYmxlX2Zvcm1hdHRlcnMsIGxvZ19uYW1lLCBsb2dfaWQsIGxvZ19maWxlbmFtZSwgbG9nX3Rva2VuKToKICAgIGRlYnVnX2Zvcm1hdHRlcnMoCiAgICAgICAgIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IGxvZ19uYW1lPSVzIGlkPSVzIHRva2VuPSVzIiwgbG9nX25hbWUsIGxvZ19pZCwgbG9nX3Rva2VuKQoKICAgIGVudHJ5X2Zvcm1hdHRlciA9IE5vbmUKICAgIGlmIG5vdCBlbnRyeV9mb3JtYXR0ZXIgYW5kIGxvZ19uYW1lOgogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IGxvZyBuYW1lIikKICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBhdmFpbGFibGVfZm9ybWF0dGVycy5nZXQobG9nX25hbWUpCiAgICAgICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlcjoKICAgICAgICAgICAgZGVidWdfZm9ybWF0dGVycygiIE5vIGZvcm1hdHRlciBmb3VuZCBieSBsb2cgbmFtZSIpCgogICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlciBhbmQgbG9nX2lkOgogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IGxvZyBJRCIpCiAgICAgICAgZW50cnlfZm9ybWF0dGVyID0gYXZhaWxhYmxlX2Zvcm1hdHRlcnMuZ2V0KGxvZ19pZCkKICAgICAgICBpZiBub3QgZW50cnlfZm9ybWF0dGVyOgogICAgICAgICAgICBkZWJ1Z19mb3JtYXR0ZXJzKCIgTm8gZm9ybWF0dGVyIGZvdW5kIGJ5IGxvZyBJRCIpCgogICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlciBhbmQgbG9nX3Rva2VuOgogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBMb29raW5nIGZvciBmb3JtYXR0ZXJzIGJ5IHRva2VuIikKICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBhdmFpbGFibGVfZm9ybWF0dGVycy5nZXQobG9nX3Rva2VuKQogICAgICAgIGlmIG5vdCBlbnRyeV9mb3JtYXR0ZXI6CiAgICAgICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBObyBmb3JtYXR0ZXIgZm91bmQgYnkgdG9rZW4iKQoKICAgIGlmIGVudHJ5X2Zvcm1hdHRlciBhbmQgbm90IGhhc2F0dHIoZW50cnlfZm9ybWF0dGVyLCAnX19jYWxsX18nKToKICAgICAgICBkZWJ1Z19mb3JtYXR0ZXJzKAogICAgICAgICAgICAiIEZvcm1hdHRlciBmb3VuZCwgYnV0IGlnbm9yZWQgYmVjYXVzZSBpdCdzIG5vdCBhIGZ1bmN0aW9uIikKICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBOb25lCgogICAgaWYgZW50cnlfZm9ybWF0dGVyOgogICAgICAgIGZvcm0gPSBlbnRyeV9mb3JtYXR0ZXIoY29uZmlnLmhvc3RuYW1lLCBsb2dfbmFtZSwgbG9nX3Rva2VuKQogICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIiBGb3JtYXR0ZXIgZm91bmQiKQogICAgZWxzZToKICAgICAgICBmb3JtID0gZGVmYXVsdF9mb3JtYXR0ZXIKICAgICAgICBkZWJ1Z19mb3JtYXR0ZXJzKCIgTm8gZm9ybWF0dGVyIGZvdW5kIikKCiAgICByZXR1cm4gZm9ybQoKZGVmIF9pbml0X2VudHJ5X2lkZW50aWZpZXIoZW50cnlfaWRlbnRpZmllcik6CiAgICAiIiJDb21waWxlcyBlbnRyeSBzZXBhcmF0b3IgZGVmaW5lZCBieSByZWd1bGFyIGV4cHJlc3Npb24uIElmIHRoZQogICAgY29tcGlsYXRpb24gaXMgbm90IHN1Y2Nlc3NmdWxsLCBpdCByZXR1cm4gTm9uZS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIHJldHVybiByZS5jb21waWxlKGVudHJ5X2lkZW50aWZpZXIpCiAgICBleGNlcHQgcmUuZXJyb3I6CiAgICAgICAgcmV0dXJuIE5vbmUKCmRlZiBzdGFydF9mb2xsb3dlcnMoZGVmYXVsdF90cmFuc3BvcnQpOgogICAgIiIiCiAgICBMb2FkcyBsb2dzIGZyb20gdGhlIHNlcnZlciAob3IgY29uZmlndXJhdGlvbikgYW5kIGluaXRpYWxpemVzIGZvbGxvd2Vycy4KICAgICIiIgogICAgbm90aWNlZCA9IEZhbHNlCiAgICBsb2dzID0gW10KICAgIGZvbGxvd2VycyA9IFtdCiAgICB0cmFuc3BvcnRzID0gW10KICAgIGZvbGxvd19tdWx0aWxvZ3MgPSBbXQoKICAgIGlmIGNvbmZpZy5wdWxsX3NlcnZlcl9zaWRlX2NvbmZpZzoKICAgICAgICAjIFVzZSBMRSBzZXJ2ZXIgYXMgdGhlIHNvdXJjZSBmb3IgbGlzdCBvZiBmb2xsb3dlZCBsb2dzCiAgICAgICAgc2VydmVyX2xvZ3MgPSBbXQogICAgICAgIHdoaWxlIG5vdCBzZXJ2ZXJfbG9nczoKICAgICAgICAgICAgcmVzcCA9IHJlcXVlc3QoJ2hvc3RzLyVzLycgJQogICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuYWdlbnRfa2V5LCBGYWxzZSwgRmFsc2UsIHJldHJ5PVRydWUpCiAgICAgICAgICAgIGlmIHJlc3BbJ3Jlc3BvbnNlJ10gIT0gJ29rJzoKICAgICAgICAgICAgICAgIGlmIG5vdCBub3RpY2VkOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcignRXJyb3IgcmV0cmlldmluZyBsaXN0IG9mIGxvZ3M6ICVzLCByZXRyeWluZyBpbiAlc3MgaW50ZXJ2YWxzJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcFsncmVhc29uJ10sIFNSVl9SRUNPTl9USU1FT1VUKQogICAgICAgICAgICAgICAgICAgIG5vdGljZWQgPSBUcnVlCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKFNSVl9SRUNPTl9USU1FT1VUKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgc2VydmVyX2xvZ3MgPSByZXNwWydsaXN0J10KICAgICAgICAgICAgaWYgbm90IHNlcnZlcl9sb2dzOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChTUlZfUkVDT05fVElNRU9VVCkKICAgICAgICAjIFNlbGVjdCBsb2dzIGZvciB0aGUgYWdlbnQKICAgICAgICBmb3IgbCBpbiBzZXJ2ZXJfbG9nczoKICAgICAgICAgICAgaWYgbC5nZXQoJ2ZvbGxvdycpID09ICd0cnVlJzoKICAgICAgICAgICAgICAgIGxbJ2Zvcm1hdHRlciddID0gJycKICAgICAgICAgICAgICAgIGxbJ2VudHJ5X2lkZW50aWZpZXInXSA9ICcnCiAgICAgICAgICAgICAgICBsb2dzLmFwcGVuZChsKQoKICAgIGZvciBjbCBpbiBjb25maWcuY29uZmlndXJlZF9sb2dzOgogICAgICAgICMgQ29uc3RydWN0IHJlc3BvbnNlLWxpa2UgaXRlbSB3aGljaCBoYXMgdGhlIHNhbWUgc3RydWN0dXJlIGFzIG9uZXMKICAgICAgICAjIHJldHVybmVkIGJ5IExFIFNlcnZlci4KICAgICAgICBsb2dzLmFwcGVuZCgKICAgICAgICAgICAgeyd0eXBlJzogJ3Rva2VuJywgJ25hbWUnOiBjbC5uYW1lLCAnZmlsZW5hbWUnOiBjbC5wYXRoLCAna2V5JzogJycsICd0b2tlbic6IGNsLnRva2VuLAogICAgICAgICAgICAgICAgICAgICAnZm9ybWF0dGVyJzogY2wuZm9ybWF0dGVyLCAnZW50cnlfaWRlbnRpZmllcic6IGNsLmVudHJ5X2lkZW50aWZpZXIsICdmb2xsb3cnOiAndHJ1ZSd9KQoKICAgIGF2YWlsYWJsZV9maWx0ZXJzID0ge30KICAgIGZpbHRlcl9maWxlbmFtZXMgPSBkZWZhdWx0X2ZpbHRlcl9maWxlbmFtZXMKICAgIGlmIGNvbmZpZy5maWx0ZXJzICE9IE5PVF9TRVQ6CiAgICAgICAgc3lzLnBhdGguYXBwZW5kKGNvbmZpZy5maWx0ZXJzKQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGZpbHRlcnMKCiAgICAgICAgICAgIGF2YWlsYWJsZV9maWx0ZXJzID0gZ2V0YXR0cihmaWx0ZXJzLCAnZmlsdGVycycsIHt9KQogICAgICAgICAgICBmaWx0ZXJfZmlsZW5hbWVzID0gZ2V0YXR0cigKICAgICAgICAgICAgICAgIGZpbHRlcnMsICdmaWx0ZXJfZmlsZW5hbWVzJywgZGVmYXVsdF9maWx0ZXJfZmlsZW5hbWVzKQoKICAgICAgICAgICAgZGVidWdfZmlsdGVycygiQXZhaWxhYmxlIGZpbHRlcnM6ICVzIiwgYXZhaWxhYmxlX2ZpbHRlcnMua2V5cygpKQogICAgICAgICAgICBkZWJ1Z19maWx0ZXJzKCJGaWx0ZXIgZmlsZW5hbWVzOiAlcyIsIGZpbHRlcl9maWxlbmFtZXMpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBsb2cuZXJyb3IoJ0Nhbm5vdCBpbXBvcnQgZXZlbnQgZmlsdGVyIG1vZHVsZSAlczogJXMnLAogICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmZpbHRlcnMsIHN5cy5leGNfaW5mbygpWzFdKQogICAgICAgICAgICBsb2cuZXJyb3IoJ0RldGFpbHM6ICVzJywgdHJhY2ViYWNrLnByaW50X2V4YyhzeXMuZXhjX2luZm8oKSkpCgogICAgYXZhaWxhYmxlX2Zvcm1hdHRlcnMgPSB7fQogICAgaWYgY29uZmlnLmZvcm1hdHRlcnMgIT0gTk9UX1NFVDoKICAgICAgICBzeXMucGF0aC5hcHBlbmQoY29uZmlnLmZvcm1hdHRlcnMpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZm9ybWF0dGVycwoKICAgICAgICAgICAgYXZhaWxhYmxlX2Zvcm1hdHRlcnMgPSBnZXRhdHRyKGZvcm1hdHRlcnMsICdmb3JtYXR0ZXJzJywge30pCiAgICAgICAgICAgIGRlYnVnX2Zvcm1hdHRlcnMoIkF2YWlsYWJsZSBmb3JtYXR0ZXJzOiAlcyIsIGF2YWlsYWJsZV9mb3JtYXR0ZXJzLmtleXMoKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIGxvZy5lcnJvcignQ2Fubm90IGltcG9ydCBldmVudCBmb3JtYXR0ZXIgbW9kdWxlICVzOiAlcycsCiAgICAgICAgICAgICAgICAgICAgICBjb25maWcuZm9ybWF0dGVycywgc3lzLmV4Y19pbmZvKClbMV0pCiAgICAgICAgICAgIGxvZy5lcnJvcignRGV0YWlsczogJXMnLCB0cmFjZWJhY2sucHJpbnRfZXhjKHN5cy5leGNfaW5mbygpKSkKCiAgICAjIFN0YXJ0IGZvbGxvd2VycwogICAgZm9yIGwgaW4gbG9nczoKICAgICAgICAjIE5vdGUhIFRva2VuLXR5cGUgbG9ncyBoYXZlIGZvbGxvdyBwYXJhbSA9PSBmYWxzZSBieSBkZWZhdWx0LCBzbyB3ZSBuZWVkIHRvCiAgICAgICAgIyBjaGVjayBhbHNvIHRoZSB0eXBlIG9mIHRoZSBsb2cuCiAgICAgICAgaWYgbFsnZm9sbG93J10gPT0gJ3RydWUnIG9yIGxbJ3R5cGUnXSA9PSAndG9rZW4nOgogICAgICAgICAgICBsb2dfbmFtZSA9IGxbJ25hbWUnXQogICAgICAgICAgICBsb2dfZmlsZW5hbWUgPSBsWydmaWxlbmFtZSddCiAgICAgICAgICAgIGxvZ19rZXkgPSBsWydrZXknXQogICAgICAgICAgICBsb2dfdG9rZW4gPSAnJwogICAgICAgICAgICBpZiBsWyd0eXBlJ10gPT0gJ3Rva2VuJzoKICAgICAgICAgICAgICAgIGxvZ190b2tlbiA9IGxbJ3Rva2VuJ10KICAgICAgICAgICAgbXVsdGlsb2dfZmlsZW5hbWUgPSBGYWxzZQogICAgICAgICAgICBpZiBsb2dfZmlsZW5hbWUuc3RhcnRzd2l0aChQUkVGSVhfTVVMVElMT0dfRklMRU5BTUUpOiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nX2ZpbGVuYW1lID0gbG9nX2ZpbGVuYW1lLnJlcGxhY2UoUFJFRklYX01VTFRJTE9HX0ZJTEVOQU1FLCcnLDEpLmxzdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgY29uZmlnLnZhbGlkYXRlX3BhdGhuYW1lKE5vbmUsRmFsc2UsbG9nX2ZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgbXVsdGlsb2dfZmlsZW5hbWUgPSBUcnVlCgogICAgICAgICAgICAjIERvIG5vdCBzdGFydCBhIGZvbGxvd2VyIGZvciBhIGxvZyB3aXRoIGFic2VudCBmaWxlcGF0aC4KICAgICAgICAgICAgaWYgbm90IGNoZWNrX2ZpbGVfbmFtZShsb2dfZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgI2xvZy5pbmZvKCJBZnRlciBjaGVja19maWxlX25hbWU6bG9nX2ZpbGVuYW1lICVzIixsb2dfZmlsZW5hbWUgKQoKICAgICAgICAgICAgZW50cnlfZmlsdGVyID0gZ2V0X2ZpbHRlcnMoYXZhaWxhYmxlX2ZpbHRlcnMsIGZpbHRlcl9maWxlbmFtZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ19uYW1lLCBsb2dfa2V5LCBsb2dfZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ190b2tlbikKICAgICAgICAgICAgaWYgbm90IGVudHJ5X2ZpbHRlcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIEZvcm1hdHRlciBpcyB0YWtlbiBhY2NvcmRpbmcgdG8gbG9jYWwgc3BlY2lmaWNhdGlvbiwgZ2xvYmFsIHNwZWNpZmljYXRpb24KICAgICAgICAgICAgIyBhbmQgdXNlci1wcm92aWRlZCBmb3JtYXR0ZXIKICAgICAgICAgICAgZW50cnlfZm9ybWF0dGVyID0gZm9ybWF0cy5nZXRfZm9ybWF0dGVyKGxbJ2Zvcm1hdHRlciddLCBjb25maWcuaG9zdG5hbWUsIGxvZ19uYW1lLCBsb2dfdG9rZW4pCiAgICAgICAgICAgIGlmIG5vdCBlbnRyeV9mb3JtYXR0ZXI6CiAgICAgICAgICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBmb3JtYXRzLmdldF9mb3JtYXR0ZXIoY29uZmlnLmZvcm1hdHRlciwgY29uZmlnLmhvc3RuYW1lLCBsb2dfbmFtZSwgbG9nX3Rva2VuKQogICAgICAgICAgICBlbnRyeV9mb3JtYXR0ZXIgPSBnZXRfZm9ybWF0dGVycyhlbnRyeV9mb3JtYXR0ZXIsIGF2YWlsYWJsZV9mb3JtYXR0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dfbmFtZSwgbG9nX2tleSwgbG9nX2ZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dfdG9rZW4pCgogICAgICAgICAgICBzX2VudHJ5X2lkZW50aWZpZXIgPSBsWydlbnRyeV9pZGVudGlmaWVyJ10KICAgICAgICAgICAgaWYgbm90IHNfZW50cnlfaWRlbnRpZmllcjoKICAgICAgICAgICAgICAgIHNfZW50cnlfaWRlbnRpZmllciA9IGNvbmZpZy5lbnRyeV9pZGVudGlmaWVyCiAgICAgICAgICAgIGlmIHNfZW50cnlfaWRlbnRpZmllcjoKICAgICAgICAgICAgICAgIGVudHJ5X2lkZW50aWZpZXIgPSBfaW5pdF9lbnRyeV9pZGVudGlmaWVyKHNfZW50cnlfaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIGlmIG5vdCBlbnRyeV9pZGVudGlmaWVyOgogICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiSW52YWxpZCBlbnRyeSBzZXBhcmF0b3IgYCVzJyBpZ25vcmVkIiwgc19lbnRyeV9pZGVudGlmaWVyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW50cnlfaWRlbnRpZmllciA9IE5vbmUKCiAgICAgICAgICAgIGxvZy5pbmZvKCJGb2xsb3dpbmcgJXMiLCBsb2dfZmlsZW5hbWUpCgogICAgICAgICAgICBpZiBsb2dfdG9rZW4gb3IgY29uZmlnLmRhdGFodWI6CiAgICAgICAgICAgICAgICB0cmFuc3BvcnQgPSBkZWZhdWx0X3RyYW5zcG9ydC5nZXQoKQogICAgICAgICAgICBlbGlmIGxvZ19rZXk6CiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IERvbWFpbi5EQVRBCiAgICAgICAgICAgICAgICBwb3J0ID0gNDQzCiAgICAgICAgICAgICAgICB1c2Vfc3NsID0gbm90IGNvbmZpZy5zdXBwcmVzc19zc2wKICAgICAgICAgICAgICAgIGlmIG5vdCB1c2Vfc3NsOgogICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MAogICAgICAgICAgICAgICAgaWYgY29uZmlnLmZvcmNlX2RvbWFpbjoKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludCA9IGNvbmZpZy5mb3JjZV9kb21haW4KICAgICAgICAgICAgICAgIGlmIGNvbmZpZy5kZWJ1Z19sb2NhbDoKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludCA9IERvbWFpbi5MT0NBTAogICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MDgxCiAgICAgICAgICAgICAgICAgICAgdXNlX3NzbCA9IEZhbHNlCiAgICAgICAgICAgICAgICBwcmVhbWJsZSA9ICdQVVQgLyVzL2hvc3RzLyVzLyVzLz9yZWFsdGltZT0xIEhUVFAvMS4wXHJcblxyXG4nICUgKAogICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VyX2tleSwgY29uZmlnLmFnZW50X2tleSwgbG9nX2tleSkKCiAgICAgICAgICAgICAgICAjIFNwZWNpYWwgY2FzZSBmb3IgSFRUUCBQVVQKICAgICAgICAgICAgICAgICMgVXNlIHBsYWluIGZvcm1hdHRlciBpZiBubyBmb3JtYXR0ZXIgaXMgZGVmaW5lZAogICAgICAgICAgICAgICAgdHJhbnNwb3J0ID0gVHJhbnNwb3J0KGVuZHBvaW50LCBwb3J0LCB1c2Vfc3NsLCBwcmVhbWJsZSwgY29uZmlnLmRlYnVnX3RyYW5zcG9ydF9ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvbmZpZy5wcm94eV90eXBlLCBjb25maWcucHJveHlfdXJsLCBjb25maWcucHJveHlfcG9ydCkpCiAgICAgICAgICAgICAgICB0cmFuc3BvcnRzLmFwcGVuZCh0cmFuc3BvcnQpCiAgICAgICAgICAgICAgICAjIERlZmF1bHQgZm9ybWF0dGVyIGlzIHBsYWluCiAgICAgICAgICAgICAgICBpZiBub3QgZW50cnlfZm9ybWF0dGVyOgogICAgICAgICAgICAgICAgICAgIGVudHJ5X2Zvcm1hdHRlciA9IGZvcm1hdHMuZ2V0X2Zvcm1hdHRlcigncGxhaW4nLCBjb25maWcuaG9zdG5hbWUsIGxvZ19uYW1lLCBsb2dfdG9rZW4pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBEZWZhdWx0IGZvcm1hdHRlciBpcyBzeXNsb2cKICAgICAgICAgICAgaWYgbm90IGVudHJ5X2Zvcm1hdHRlcjoKICAgICAgICAgICAgICAgIGVudHJ5X2Zvcm1hdHRlciA9IGZvcm1hdHMuZ2V0X2Zvcm1hdHRlcignc3lzbG9nJywgY29uZmlnLmhvc3RuYW1lLCBsb2dfbmFtZSwgbG9nX3Rva2VuKQoKICAgICAgICAgICAgIyBJbnN0YW50aWF0ZSB0aGUgZm9sbG93X211bHRpbG9nIGZvciAnbXVsdGlsb2cnIGZpbGVuYW1lLCBvdGhlcndpc2UgdGhlIGluZGl2aWR1YWwgZm9sbG93ZXIKICAgICAgICAgICAgaWYgbXVsdGlsb2dfZmlsZW5hbWU6ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9sbG93X211bHRpbG9nID0gRm9sbG93TXVsdGlsb2cobG9nX2ZpbGVuYW1lLCBlbnRyeV9maWx0ZXIsIGVudHJ5X2Zvcm1hdHRlciwgZW50cnlfaWRlbnRpZmllciwgdHJhbnNwb3J0KQogICAgICAgICAgICAgICAgZm9sbG93X211bHRpbG9ncy5hcHBlbmQoZm9sbG93X211bHRpbG9nKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZm9sbG93ZXIgPSBGb2xsb3dlcihsb2dfZmlsZW5hbWUsIGVudHJ5X2ZpbHRlciwgZW50cnlfZm9ybWF0dGVyLCBlbnRyeV9pZGVudGlmaWVyLCB0cmFuc3BvcnQpCiAgICAgICAgICAgICAgICBmb2xsb3dlcnMuYXBwZW5kKGZvbGxvd2VyKQogICAgcmV0dXJuIChmb2xsb3dlcnMsIHRyYW5zcG9ydHMsIGZvbGxvd19tdWx0aWxvZ3MpCgoKZGVmIGlzX2ZvbGxvd2VkKGZpbGVuYW1lKToKICAgICIiIkNoZWNrcyBpZiB0aGUgZmlsZSBnaXZlbiBpcyBmb2xsb3dlZC4KICAgICIiIgogICAgaG9zdCA9IHJlcXVlc3QoJ2hvc3RzLyVzLycgJSBjb25maWcuYWdlbnRfa2V5LCBUcnVlLCBUcnVlKQogICAgbG9ncyA9IGhvc3RbJ2xpc3QnXQogICAgZm9yIGlsb2cgaW4gbG9nczoKICAgICAgICBpZiBpbG9nWydmb2xsb3cnXSA9PSAndHJ1ZScgYW5kIGZpbGVuYW1lID09IGlsb2dbJ2ZpbGVuYW1lJ106CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCmRlZiBnZXRfbG9nX25hbWVzX2Zvcl9maWxlcyhmaWxlbmFtZXMpOgogICAgIiIiCiAgICBDaGVja3MgaWYgZWFjaCBmaWxlIGluIGEgbGlzdCBvZiBmaWxlcyBpcyBmb2xsb3dlZC4gV2lsbCBvbmx5IG1ha2UgdGhlIG9uZSBjYWxsIG9uIHRoZSBzZXJ2ZXIhCiAgICBJZiBpdCBpcywgZ2V0cyB0aGUgJ25hbWUnIG9mIHRoZSBsb2cgZm9yIHRoaXMgZmlsZS4gSWYgbm90LCB0aGVuIGEgJ05vbmUnIGlzIHVzZWQuCiAgICA6cGFyYW0gZmlsZW5hbWVzOiAgIHRoZSBsaXN0IG9mIGZpbGVuYW1lcyBvZiBpbnRlcmVzdAogICAgOnJldHVybjogICAgcmV0dXJucyBhIHt9IG9mIGZpbGVuYW1lcyB3aXRoIGVpdGhlciB0aGUKICAgICAgICAgICAgICAgIGFzc29jaWF0ZWQgbG9nIG5hbWUgb3IgJ05vbmUnIGZvciBlYWNoIGZpbGUKICAgICIiIgogICAgaWYgbGVuKGZpbGVuYW1lcykgPT0gMDoKICAgICAgICBkaWUoJ1xuV2FybmluZzogTGlzdCBvZiBmaWxlbmFtZXMgaXMgZW1wdHlcbicpCiAgICBob3N0ID0gcmVxdWVzdCgnaG9zdHMvJXMvJyAlIGNvbmZpZy5hZ2VudF9rZXksIFRydWUsIFRydWUpCiAgICBsb2dzID0gaG9zdFsnbGlzdCddCiAgICByZXN1bHQgPSB7fQogICAgZm9yIGZpbGVuYW1lIGluIGZpbGVuYW1lczoKICAgICAgICByZXN1bHRbZmlsZW5hbWVdID0gTk9UX1NFVAogICAgICAgIGZvciBpbG9nIGluIGxvZ3M6CiAgICAgICAgICAgIGlmIGlsb2dbJ2ZvbGxvdyddID09ICd0cnVlJyBhbmQgZmlsZW5hbWUgPT0gaWxvZ1snZmlsZW5hbWUnXToKICAgICAgICAgICAgICAgIHJlc3VsdFtmaWxlbmFtZV0gPSBzdHIoaWxvZ1snbmFtZSddKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZXRfbG9nbGlzdF93aXRoX3BhdGhzKCk6CiAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgbGlzdCBvZiBhbGwgZGVzdGluYXRpb24gbG9ncyBvbiB0aGUgbG9nZW50cmllcyBpbmZyYXN0cnVjdHVyZSBmb3IKICAgICAgICBhIGhvc3Qgd2l0aCB0aGUgcGF0aCB0aGF0IHRoZSBsb2cgaXMgdXNpbmcgZm9yIGZvbGxvd2luZyBhIGZpbGUgb3IgbXV0bGlwbGUgZmlsZXMKICAgIDpyZXR1cm4gOgogICAgIiIiCiAgICBob3N0ID0gcmVxdWVzdCgnaG9zdHMvJXMvJyAlIGNvbmZpZy5hZ2VudF9rZXksIFRydWUsIFRydWUpCiAgICBsb2dzID0gaG9zdFsnbGlzdCddCiAgICByZXN1bHQgPSB7fQogICAgZm9yIGlsb2cgaW4gbG9nczoKICAgICAgICBpZiBpbG9nWydmb2xsb3cnXSA9PSAndHJ1ZSc6CiAgICAgICAgICAgIHJlc3VsdFtzdHIoaWxvZ1snbmFtZSddKV0gPSBzdHIoaWxvZ1snZmlsZW5hbWUnXSkKICAgIHJldHVybiByZXN1bHQKCgpkZWYgY3JlYXRlX2NvbmZpZ3VyZWRfbG9ncyhjb25maWd1cmVkX2xvZ3MpOgogICAgIiIiIEdldCB0b2tlbnMgZm9yIGFsbCBjb25maWd1cmVkIGxvZ3MuIExvZ3Mgd2l0aCBubyB0b2tlbiBzcGVjaWZpZWQgYXJlCiAgICByZXRyaWV2ZWQgdmlhIEFQSSBhbmQgY3JlYXRlZCBpZiBuZWVkZWQuCiAgICAiIiIKICAgIGZvciBjbG9nIGluIGNvbmZpZ3VyZWRfbG9nczoKICAgICAgICBpZiBub3QgY2xvZy5kZXN0aW5hdGlvbiBhbmQgbm90IGNsb2cudG9rZW46CiAgICAgICAgICAgIGxvZy5lcnJvcignSWdub3Jpbmcgc2VjdGlvbiAlcyBhcyBuZWl0aGVyICVzIG5vciAlcyBpcyBzcGVjaWZpZWQnLCBjbG9nLm5hbWUsIFRPS0VOX1BBUkFNLCBERVNUSU5BVElPTl9QQVJBTSkKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgY2xvZy5kZXN0aW5hdGlvbiBhbmQgbm90IGNsb2cudG9rZW46CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIChob3N0bmFtZSwgbG9nbmFtZSkgPSBjbG9nLmRlc3RpbmF0aW9uLnNwbGl0KCcvJywgMSkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJ0lnbm9yaW5nIHNlY3Rpb24gJXMgc2luY2UgYCVzXCcgZG9lcyBub3QgY29udGFpbiBob3N0JywgY2xvZy5uYW1lLCBERVNUSU5BVElPTl9QQVJBTSkKICAgICAgICAgICAgaG9zdF9rZXkgPSBnZXRfb3JfY3JlYXRlX2hvc3QoaG9zdG5hbWUpCiAgICAgICAgICAgIHRva2VuID0gZ2V0X29yX2NyZWF0ZV9sb2coaG9zdF9rZXksIGxvZ25hbWUsIGNsb2cuZGVzdGluYXRpb24pCiAgICAgICAgICAgIGlmIG5vdCB0b2tlbjoKICAgICAgICAgICAgICAgIGxvZy5lcnJvcignSWdub3Jpbmcgc2VjdGlvbiAlcywgY2Fubm90IGNyZWF0ZSBsb2cnICUgY2xvZy5uYW1lKQoKICAgICAgICAgICAgY2xvZy50b2tlbiA9IHRva2VuCgoKZGVmIGNtZF9tb25pdG9yKGFyZ3MpOgogICAgIiIiTW9uaXRvcnMgaG9zdCBhY3Rpdml0eSBhbmQgc2VuZHMgZXZlbnRzIGNvbGxlY3RlZCB0byBsb2dlbnRyaWVzCiAgICBpbmZyYXN0cnVjdHVyZS4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBjb25maWcubG9hZCgpCiAgICBzdGF0cyA9IE5vbmUKICAgIHNtZXRyaWNzID0gTm9uZQoKICAgICMgV2UgbmVlZCBhY2NvdW50IGFuZCBob3N0IElEIHRvIGdldCBzZXJ2ZXIgc2lkZSBjb25maWd1cmF0aW9uCiAgICBpZiBjb25maWcucHVsbF9zZXJ2ZXJfc2lkZV9jb25maWc6CiAgICAgICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKG5vdCBjb25maWcuZGFlbW9uKQogICAgICAgIGNvbmZpZy5hZ2VudF9rZXlfcmVxdWlyZWQoKQoKICAgICMgRW5zdXJlIGFsbCBjb25maWd1cmVkIGxvZ3MgYXJlIGNyZWF0ZWQKICAgIGlmIGNvbmZpZy5jb25maWd1cmVkX2xvZ3MgYW5kIG5vdCBjb25maWcuZGF0YWh1YjoKICAgICAgICBjcmVhdGVfY29uZmlndXJlZF9sb2dzKGNvbmZpZy5jb25maWd1cmVkX2xvZ3MpCgogICAgaWYgY29uZmlnLmRhZW1vbjoKICAgICAgICBkYWVtb25pemUoKQoKICAgICMgU3RhcnQgZGVmYXVsdCB0cmFuc3BvcnQgY2hhbm5lbAogICAgZGVmYXVsdF90cmFuc3BvcnQgPSBEZWZhdWx0VHJhbnNwb3J0KGNvbmZpZykKCiAgICAjIFJlZ2lzdGVyIHJlc291cmNlIG1vbml0b3JpbmcKICAgIGlmIGNvbmZpZy5hZ2VudF9rZXkgIT0gTk9UX1NFVCBhbmQgY29uZmlnLnYxX21ldHJpY3MgIT0gJ0ZhbHNlJzoKICAgICAgICBsb2cuZGVidWcoIkVuYWJsaW5nIFYxIG1ldHJpY3MiKQogICAgICAgIHN0YXRzID0gU3RhdHMoKQogICAgICAgIHN0YXRzLnN0YXJ0KCkKICAgIGVsc2U6CiAgICAgICAgbG9nLmRlYnVnKCJWMSBtZXRyaWNzIGRpc2FibGVkIikKICAgIGZvcm1hdHRlciA9IGZvcm1hdHMuRm9ybWF0U3lzbG9nKGNvbmZpZy5ob3N0bmFtZSwgJ2xlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5tZXRyaWNzLnRva2VuKQogICAgc21ldHJpY3MgPSBtZXRyaWNzLk1ldHJpY3MoY29uZmlnLm1ldHJpY3MsIGRlZmF1bHRfdHJhbnNwb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlciwgY29uZmlnLmRlYnVnX21ldHJpY3MpCiAgICBzbWV0cmljcy5zdGFydCgpCgogICAgZm9sbG93ZXJzID0gW10KICAgIHRyYW5zcG9ydHMgPSBbXQogICAgZm9sbG93X211bHRpbG9ncyA9IFtdCiAgICB0cnk6CiAgICAgICAgIyBMb2FkIGxvZ3MgdG8gZm9sbG93IGFuZCBzdGFydCBmb2xsb3dpbmcgdGhlbQogICAgICAgIGlmIG5vdCBjb25maWcuZGVidWdfc3RhdHNfb25seToKICAgICAgICAgICAgKGZvbGxvd2VycywgdHJhbnNwb3J0cywgZm9sbG93X211bHRpbG9ncykgPSBzdGFydF9mb2xsb3dlcnMoZGVmYXVsdF90cmFuc3BvcnQpCgogICAgICAgICMgUGFyayB0aGlzIHRocmVhZAogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoNjAwKSAgIyBGSVhNRTogaXMgdGhlcmUgYSBiZXR0ZXIgd2F5PwogICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgIHBhc3MKCiAgICBwcmludCA+PiBzeXMuc3RkZXJyLCAiXG5TaHV0dGluZyBkb3duIgogICAgIyBTdG9wIG1ldHJpY3MKICAgIGlmIHN0YXRzOgogICAgICAgIHN0YXRzLmNhbmNlbCgpCiAgICBpZiBzbWV0cmljczoKICAgICAgICBzbWV0cmljcy5jYW5jZWwoKQogICAgIyBDbG9zZSBmb2xsb3dlcnMKICAgIGZvciBmb2xsb3dlciBpbiBmb2xsb3dlcnM6CiAgICAgICAgZm9sbG93ZXIuY2xvc2UoKQogICAgIyBDbG9zZSBlYWNoIGZvbGxvd19tdWx0aWxvZyBhbmQgdGhlIGZvbGxvd2VycyBpdCBob2xkcwogICAgZm9yIGZvbGxvd19tdWx0aWxvZyBpbiBmb2xsb3dfbXVsdGlsb2dzOgogICAgICAgIGZvbGxvd19tdWx0aWxvZy5jbG9zZSgpCiAgICAjIENsb3NlIHRyYW5zcG9ydHMKICAgIGZvciB0cmFuc3BvcnQgaW4gdHJhbnNwb3J0czoKICAgICAgICB0cmFuc3BvcnQuY2xvc2UoKQogICAgZGVmYXVsdF90cmFuc3BvcnQuY2xvc2UoKQoKCmRlZiBjbWRfbW9uaXRvcl9kYWVtb24oYXJncyk6CiAgICAiIiJNb25pdG9ycyBhcyBhIGRhZW1vbiBob3N0IGFjdGl2aXR5IGFuZCBzZW5kcyBldmVudHMgY29sbGVjdGVkIHRvCiAgICBsb2dlbnRyaWVzIGluZnJhc3RydWN0dXJlLgogICAgIiIiCiAgICBjb25maWcuZGFlbW9uID0gVHJ1ZQogICAgY21kX21vbml0b3IoYXJncykKCgpkZWYgY21kX2ZvbGxvdyhhcmdzKToKICAgICIiIgogICAgRm9sbG93IHRoZSBsb2cgZmlsZSBnaXZlbi4KICAgICIiIgogICAgaWYgbGVuKGFyZ3MpID09IDA6CiAgICAgICAgZGllKCJFcnJvcjogU3BlY2lmeSB0aGUgZmlsZSBuYW1lIG9mIHRoZSBsb2cgdG8gZm9sbG93LiIpCiAgICBpZiBsZW4oYXJncykgPiAxOgogICAgICAgIGRpZSgiRXJyb3I6IFRvbyBtYW55IGFyZ3VtZW50cy5cbiIKICAgICAgICAgICAgIkEgY29tbW9uIG1pc3Rha2UgaXMgdG8gdXNlIHdpbGRjYXJkcyBpbiBwYXRoIHRoYXQgaXMgYmVpbmcgIgogICAgICAgICAgICAiZXhwYW5kZWQgYnkgc2hlbGwuIEVuY2xvc2UgdGhlIHBhdGggaW4gc2luZ2xlIHF1b3RlcyB0byBhdm9pZCAiCiAgICAgICAgICAgICJleHBhbnNpb24uIikKCiAgICBjb25maWcubG9hZCgpCiAgICBjb25maWcuYWdlbnRfa2V5X3JlcXVpcmVkKCkKICAgICMgRklYTUU6IGZvbGxvdyB0byBhZGQgbG9ncyBpbnRvIGxvY2FsIGNvbmZpZ3VyYXRpb24KCiAgICBhcmcgPSBhcmdzWzBdCiAgICBmaWxlbmFtZSA9IG9zLnBhdGguYWJzcGF0aChhcmcpCiAgICBuYW1lID0gY29uZmlnLm5hbWUKICAgIGlmIG5hbWUgPT0gTk9UX1NFVDoKICAgICAgICBuYW1lID0gb3MucGF0aC5iYXNlbmFtZShmaWxlbmFtZSkKICAgIHR5cGVfb3B0ID0gY29uZmlnLnR5cGVfb3B0CiAgICBpZiB0eXBlX29wdCA9PSBOT1RfU0VUOgogICAgICAgIHR5cGVfb3B0ID0gIiIKCiAgICAjIENoZWNrIHRoYXQgd2UgZG9uJ3QgZm9sbG93IHRoYXQgZmlsZSBhbHJlYWR5CiAgICBpZiBub3QgY29uZmlnLmZvcmNlIGFuZCBpc19mb2xsb3dlZChmaWxlbmFtZSk6CiAgICAgICAgbG9nLndhcm5pbmcoJ0FscmVhZHkgZm9sbG93aW5nICVzJywgZmlsZW5hbWUpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbGVuKGdsb2IuZ2xvYihmaWxlbmFtZSkpID09IDA6CiAgICAgICAgbG9nLndhcm5pbmcoJ1xuV2FybmluZzogRmlsZSAlcyBkb2VzIG5vdCBleGlzdFxuJywgZmlsZW5hbWUpCgogICAgcmVxdWVzdF9mb2xsb3coZmlsZW5hbWUsIG5hbWUsIHR5cGVfb3B0KQoKCmRlZiBjbWRfZm9sbG93X211bHRpbG9nKGFyZ3MpOgogICAgIiIiCiAgICBGb2xsb3cgdGhlIGxvZyhzKSBhcyBkZWZpbmVkIGluIHN0cmluZyBwYXNzZWQgdG8gYWdlbnQgd2l0aAogICAgdGhlICctLW11bHRpbG9nJyBwYXJhbWV0ZXIgaW5jbHVkZWQgLSBtb2RpZmljYXRpb24gb2YgY21kX2ZvbGxvdwogICAgIiIiCiAgICBpZiBsZW4oYXJncykgPT0gMDoKICAgICAgICBkaWUoIkVycm9yOiBTcGVjaWZ5IHRoZSBmaWxlIG5hbWUgb2YgdGhlIGxvZyB0byBmb2xsb3cuIikKICAgIGlmIGxlbihhcmdzKSA+IDE6CiAgICAgICAgZGllKCJFcnJvcjogVG9vIG1hbnkgYXJndW1lbnRzLlxuIgogICAgICAgICAgICAiQSBjb21tb24gbWlzdGFrZSBpcyB0byB1c2Ugd2lsZGNhcmRzIGluIHBhdGggdGhhdCBpcyBiZWluZyAiCiAgICAgICAgICAgICJleHBhbmRlZCBieSBzaGVsbC4gRW5jbG9zZSB0aGUgcGF0aCBpbiBzaW5nbGUgcXVvdGVzIHRvIGF2b2lkICIKICAgICAgICAgICAgImV4cGFuc2lvbi4iKQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCiAgICBhcmcgPSBhcmdzWzBdCiAgICBwYXRoID0gb3MucGF0aC5hYnNwYXRoKGFyZykKICAgICMgV2hlbiB0ZXN0aW5nIGlnbm9yZSB1c2VyIGlucHV0CiAgICBpZiBjb25maWcuZGVidWdfbXVsdGlsb2c6CiAgICAgICAgZm9sbG93ID0gVHJ1ZQogICAgZWxzZToKICAgICAgICBmb2xsb3cgPSB1c2VyX3Byb21wdChwYXRoKQogICAgaWYgZm9sbG93OgogICAgICAgIG5hbWUgPSBjb25maWcubmFtZQogICAgICAgIGlmIG5hbWUgPT0gTk9UX1NFVDoKICAgICAgICAgICAgbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUocGF0aCkKICAgICAgICB0eXBlX29wdCA9IGNvbmZpZy50eXBlX29wdAogICAgICAgIGlmIHR5cGVfb3B0ID09IE5PVF9TRVQ6CiAgICAgICAgICAgIHR5cGVfb3B0ID0gIiIKICAgICAgICBmaWxlbmFtZSA9IFBSRUZJWF9NVUxUSUxPR19GSUxFTkFNRSArIHBhdGgKICAgICAgICByZXF1ZXN0X2ZvbGxvdyhmaWxlbmFtZSwgbmFtZSwgdHlwZV9vcHQpCgpkZWYgdXNlcl9wcm9tcHQocGF0aCk6CiAgICAiIiIKICAgIERpc3BsYXlzIDIgbGlzdHMgLSBmaWxlcyBhbHJlYWR5IGZvbGxvd2VkIHdpdGggbG9nIG5hbWVzLCBhbmQgdGhvc2Ugbm90LgogICAgUHJvbXB0cyB1c2VyIGlmIHRoZXkgd2lzaCB0byBmb2xsb3cgZmlsZXMgb3Igbm90CiAgICAiIiIKICAgIGZpbGVfY2FuZGlkYXRlcyA9IGdsb2IuZ2xvYihwYXRoKQogICAgbG9nbGlzdF93aXRoX3BhdGhzID0gZ2V0X2xvZ2xpc3Rfd2l0aF9wYXRocygpCiAgICBpZGVudGljYWxfcGF0aCA9IEZhbHNlCiAgICBwcmludCAiXG5FeGlzdGluZyBkZXN0aW5hdGlvbiBMb2dzIGZvciB0aGlzIGhvc3QgYW5kIHRoZSBhc3NvY2lhdGVkIFBhdGhzIGFyZToiCiAgICBwcmludCgnXHR7MDo1MH17MX0nLmZvcm1hdCgnTE9HTkFNRScsICdQQVRIJykpCiAgICBmb3IgbG9nbmFtZSwgZmlsZXBhdGggaW4gbG9nbGlzdF93aXRoX3BhdGhzLml0ZW1zKCk6CiAgICAgICAgIyBUZXN0IGlmIGFuIGlkZW50aWNhbCBwYXRoIGlzIGFscmVhZHkgaW4gdXNlIQogICAgICAgIGlmIHBhdGggPT0gZmlsZXBhdGgucmVwbGFjZShQUkVGSVhfTVVMVElMT0dfRklMRU5BTUUsJycsMSkubHN0cmlwKCk6CiAgICAgICAgICAgIGlkZW50aWNhbF9wYXRoID0gVHJ1ZQogICAgICAgICAgICBwcmludCgnXHR7MDo0MH17MToxMH17Mn0nLmZvcm1hdChsb2duYW1lLCJJREVOVElDQUwiLCBmaWxlcGF0aCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoJ1x0ezA6NTB9ezF9Jy5mb3JtYXQobG9nbmFtZSwgZmlsZXBhdGgpKQogICAgaWYgaWRlbnRpY2FsX3BhdGg6CiAgICAgICAgcHJpbnQgIk5PVEU6IHRoZXJlIGFyZSBkZXN0aW5hdGlvbiBsb2dzIGluIGFib3ZlIGxpc3Qgd2l0aCBpZGVudGljYWwgcGF0aHMuIgogICAgcHJpbnQgIlxuUmVxdWVzdGVkIHBhdGggaXM6ICVzIiAlIHBhdGgKICAgIGlmIGxlbihmaWxlX2NhbmRpZGF0ZXMpID09IDA6CiAgICAgICAgcHJpbnQgIlxuTm8gRmlsZXMgd2VyZSBmb3VuZCBmb3IgdGhpcyBwYXRoIGF0IHRoaXMgdGltZS5cbiIKICAgIGVsc2U6CiAgICAgICAgcHJpbnQgIlxuRmlsZXMgZm91bmQgZm9yIHRoaXMgcGF0aDoiCiAgICAgICAgZmlsZV9jb3VudCA9IDAKICAgICAgICBmb3IgZmlsZW5hbWUgaW4gZmlsZV9jYW5kaWRhdGVzOgogICAgICAgICAgICBpZiBmaWxlX2NvdW50IDwgTUFYX0ZJTEVTX0ZPTExPV0VEOgogICAgICAgICAgICAgICAgcHJpbnQgKCdcdHswfScuZm9ybWF0KGZpbGVuYW1lKSkKICAgICAgICAgICAgICAgIGZpbGVfY291bnQgPSBmaWxlX2NvdW50KzEgICAgICAgIAogICAgd2hpbGUgVHJ1ZToKICAgICAgICBwcmludCAiXG5Vc2UgbmV3IHBhdGggdG8gZm9sbG93IGZpbGVzIFt5XSBvciBxdWl0IFtuXT8iICAgICAgICAKICAgICAgICB1c2VyX3Jlc3AgPSByYXdfaW5wdXQoKS5sb3dlcigpICAgICAgICAKICAgICAgICBpZiB1c2VyX3Jlc3AgPT0gJ24nOgogICAgICAgICAgICBzeXMuZXhpdChFWElUX09LKQogICAgICAgIGVsaWYgdXNlcl9yZXNwID09ICd5JzoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCAiUGxlYXNlIHRyeSBhZ2FpbiIKCmRlZiBjbWRfZm9sbG93ZWQoYXJncyk6CiAgICAiIiIKICAgIENoZWNrIGlmIHRoZSBsb2cgZmlsZSBnaXZlbiBpcyBmb2xsb3dlZC4KICAgICIiIgogICAgaWYgbGVuKGFyZ3MpID09IDA6CiAgICAgICAgZGllKCJFcnJvcjogU3BlY2lmeSB0aGUgZmlsZSBuYW1lIG9mIHRoZSBsb2cgdG8gdGVzdC4iKQogICAgaWYgbGVuKGFyZ3MpICE9IDE6CiAgICAgICAgZGllKCJFcnJvcjogVG9vIG1hbnkgYXJndW1lbnRzLiBPbmx5IG9uZSBmaWxlIG5hbWUgYWxsb3dlZC4iKQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCgogICAgZmlsZW5hbWUgPSBvcy5wYXRoLmFic3BhdGgoYXJnc1swXSkKCiAgICAjIENoZWNrIHRoYXQgd2UgZG9uJ3QgZm9sbG93IHRoYXQgZmlsZSBhbHJlYWR5CiAgICBpZiBpc19mb2xsb3dlZChmaWxlbmFtZSk6CiAgICAgICAgcHJpbnQgJ0ZvbGxvd2luZyAlcycgJSBmaWxlbmFtZQogICAgICAgIHN5cy5leGl0KEVYSVRfT0spCiAgICBlbHNlOgogICAgICAgIHByaW50ICdOT1QgZm9sbG93aW5nICVzJyAlIGZpbGVuYW1lCiAgICAgICAgc3lzLmV4aXQoRVhJVF9OTykKCgpkZWYgY21kX2NsZWFuKGFyZ3MpOgogICAgIiIiCiAgICBXaXBlcyBvdXQgb2xkIGNvbmZpZ3VyYXRpb24gZmlsZS4KICAgICIiIgogICAgbm9fbW9yZV9hcmdzKGFyZ3MpCiAgICBpZiBjb25maWcuY2xlYW4oKToKICAgICAgICBsb2cuaW5mbygnQ29uZmlndXJhdGlvbiBjbGVhbicpCgoKZGVmIGNtZF93aG9hbWkoYXJncyk6CiAgICAiIiIKICAgIERpc3BsYXlzIGluZm9ybWF0aW9uIGFib3V0IHRoaXMgaG9zdC4KICAgICIiIgogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLmFnZW50X2tleV9yZXF1aXJlZCgpCiAgICBub19tb3JlX2FyZ3MoYXJncykKCiAgICBsaXN0X29iamVjdChyZXF1ZXN0KCdob3N0cy8lcycgJSBjb25maWcuYWdlbnRfa2V5LCBUcnVlLCBUcnVlKSkKICAgIHByaW50ICcnCiAgICBsaXN0X29iamVjdChyZXF1ZXN0KCdob3N0cy8lcy8nICUgY29uZmlnLmFnZW50X2tleSwgVHJ1ZSwgVHJ1ZSkpCgoKZGVmIGxvZ3R5cGVfbmFtZShsb2d0eXBlX3V1aWQpOgogICAgIiIiIFByb3ZpZGVzIG5hbWUgZm9yIHRoZSBsb2d0eXBlIGdpdmVuLgogICAgIiIiCiAgICAjIExvb2sgZm9yIGVtYmVkZGVkIHN0cnVjdHVyZXMKICAgIGZvciBzdHJ1Y3R1cmVfbmFtZSwgc3RydWN0dXJlX2lkIGluIEVNQkVEREVEX1NUUlVDVFVSRVMuaXRlcml0ZW1zKCk6CiAgICAgICAgaWYgc3RydWN0dXJlX2lkID09IGxvZ3R5cGVfdXVpZDoKICAgICAgICAgICAgcmV0dXJuIHN0cnVjdHVyZV9uYW1lCgogICAgIyBTZWFyY2ggZm9yIGxvZ3R5cGVzIHByb3ZpZGVkIGJ5IHRoZSBiYWNrZW5kCiAgICByZXNwb25zZSA9IHJlcXVlc3QoJ2xvZ3R5cGVzJywgVHJ1ZSwgVHJ1ZSkKICAgIGFsbF9sb2d0eXBlcyA9IHJlc3BvbnNlWydsaXN0J10KICAgIGZvciBsb2d0eXBlIGluIGFsbF9sb2d0eXBlczoKICAgICAgICBpZiBsb2d0eXBlX3V1aWQgPT0gbG9ndHlwZVsna2V5J106CiAgICAgICAgICAgIHJldHVybiBsb2d0eXBlWydzaG9ydGN1dCddCgogICAgcmV0dXJuICd1bmtub3duJwoKCmRlZiBsaXN0X29iamVjdChyZXF1ZXN0LCBob3N0bmFtZXM9RmFsc2UpOgogICAgIiIiCiAgICBMaXN0cyBvYmplY3QgcmVxdWVzdCBnaXZlbi4KICAgICIiIgogICAgdCA9IHJlcXVlc3RbJ29iamVjdCddCiAgICBpbmRleF9uYW1lID0gJ25hbWUnCiAgICBpdGVtX25hbWUgPSAnJwogICAgaWYgdCA9PSAncm9vdGxpc3QnOgogICAgICAgIGl0ZW1fbmFtZSA9ICdpdGVtJwogICAgZWxpZiB0ID09ICdob3N0JzoKICAgICAgICBwcmludCAnbmFtZSA9JywgcmVxdWVzdFsnbmFtZSddCiAgICAgICAgcHJpbnQgJ2hvc3RuYW1lID0nLCByZXF1ZXN0Wydob3N0bmFtZSddCiAgICAgICAgcHJpbnQgJ2tleSA9JywgcmVxdWVzdFsna2V5J10KICAgICAgICBwcmludCAnZGlzdHJpYnV0aW9uID0nLCByZXF1ZXN0WydkaXN0bmFtZSddCiAgICAgICAgcHJpbnQgJ2Rpc3R2ZXIgPScsIHJlcXVlc3RbJ2Rpc3R2ZXInXQogICAgICAgIHJldHVybgogICAgZWxpZiB0ID09ICdsb2cnOgogICAgICAgIHByaW50ICduYW1lID0nLCByZXF1ZXN0WyduYW1lJ10KICAgICAgICBwcmludCAnZmlsZW5hbWUgPScsIHJlcXVlc3RbJ2ZpbGVuYW1lJ10KICAgICAgICBwcmludCAna2V5ID0nLCByZXF1ZXN0WydrZXknXQogICAgICAgIHByaW50ICd0eXBlID0nLCByZXF1ZXN0Wyd0eXBlJ10KICAgICAgICBwcmludCAnZm9sbG93ID0nLCByZXF1ZXN0Wydmb2xsb3cnXQogICAgICAgIGlmICd0b2tlbicgaW4gcmVxdWVzdDoKICAgICAgICAgICAgcHJpbnQgJ3Rva2VuID0nLCByZXF1ZXN0Wyd0b2tlbiddCiAgICAgICAgaWYgJ2xvZ3R5cGUnIGluIHJlcXVlc3Q6CiAgICAgICAgICAgIHByaW50ICdsb2d0eXBlID0nLCBsb2d0eXBlX25hbWUocmVxdWVzdFsnbG9ndHlwZSddKQogICAgICAgIHJldHVybgogICAgZWxpZiB0ID09ICdsaXN0JzoKICAgICAgICBwcmludCAnbmFtZSA9JywgcmVxdWVzdFsnbmFtZSddCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIHQgPT0gJ2hvc3RsaXN0JzoKICAgICAgICBpdGVtX25hbWUgPSAnaG9zdCcKICAgICAgICBpZiBob3N0bmFtZXM6CiAgICAgICAgICAgIGluZGV4X25hbWUgPSAnaG9zdG5hbWUnCiAgICBlbGlmIHQgPT0gJ2xvZ3R5cGUnOgogICAgICAgIHByaW50ICd0aXRsZSA9JywgcmVxdWVzdFsndGl0bGUnXQogICAgICAgIHByaW50ICdkZXNjcmlwdGlvbiA9JywgcmVxdWVzdFsnZGVzYyddCiAgICAgICAgcHJpbnQgJ3Nob3J0Y3V0ID0nLCByZXF1ZXN0WydzaG9ydGN1dCddCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIHQgPT0gJ2xvZ2xpc3QnOgogICAgICAgIGl0ZW1fbmFtZSA9ICdsb2cnCiAgICBlbGlmIHQgPT0gJ2xvZ3R5cGVsaXN0JzoKICAgICAgICBpdGVtX25hbWUgPSAnbG9ndHlwZScKICAgICAgICBpbmRleF9uYW1lID0gJ3Nob3J0Y3V0JwogICAgZWxzZToKICAgICAgICBkaWUoJ1Vua25vd24gb2JqZWN0IHR5cGUgIiVzIi4gQWdlbnQgdG9vIG9sZD8nICUgdCkKCiAgICAjIFN0YW5kYXJkIGxpc3QsIHByaW50IGl0IHNvcnRlZAogICAgaWxpc3QgPSByZXF1ZXN0WydsaXN0J10KICAgIGlsaXN0ID0gc29ydGVkKGlsaXN0LCBrZXk9bGFtYmRhIGl0ZW06IGl0ZW1baW5kZXhfbmFtZV0pCiAgICBmb3IgaXRlbSBpbiBpbGlzdDoKICAgICAgICBpZiBjb25maWcudXVpZDoKICAgICAgICAgICAgcHJpbnQgaXRlbVsna2V5J10sCiAgICAgICAgcHJpbnQgIiVzIiAlIChpdGVtW2luZGV4X25hbWVdKQogICAgcHJpbnRfdG90YWwoaWxpc3QsIGl0ZW1fbmFtZSkKCgpkZWYgaXNfbG9nX2ZzKGFkZHIpOgogICAgIiIiVGVzdHMgaWYgdGhlIGFkZHJlc3MgcG9pbnRzIGZvciBhIGxvZy4KICAgICIiIgogICAgbG9nX2FkZHJzID0gW3InKGxvZ3N8YXBwcykvLiovJywKICAgICAgICAgICAgICAgICByJ2hvc3QobmFtZSk/cy8uKi8uKi8nXQogICAgZm9yIGxhIGluIGxvZ19hZGRyczoKICAgICAgICBpZiByZS5tYXRjaChsYSwgYWRkcik6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgY21kX2xzX2lwcyhhZ3MpOgogICAgIiIiCiAgICBMaXN0IElQcyB1c2VkIGJ5IHRoZSBhZ2VudC4KICAgICIiIgogICAgbCA9IFtdCiAgICBmb3IgbmFtZSBpbiBbRG9tYWluLk1BSU4sIERvbWFpbi5BUEksIERvbWFpbi5EQVRBLCBEb21haW4uUFVMTF06CiAgICAgICAgZm9yIGluZm8gaW4gc29ja2V0LmdldGFkZHJpbmZvKG5hbWUsIE5vbmUsIDAsIDAsIHNvY2tldC5JUFBST1RPX1RDUCk6CiAgICAgICAgICAgIGlwID0gaW5mb1s0XVswXQogICAgICAgICAgICBwcmludCA+PnN5cy5zdGRlcnIsICclLTE2cyAlcycgJSAoaXAsIG5hbWUpCiAgICAgICAgICAgIGwuYXBwZW5kKGlwKQogICAgcHJpbnQgbAogICAgcHJpbnQgJyAnLmpvaW4obCkKCgpkZWYgY21kX2xzKGFyZ3MpOgogICAgIiIiCiAgICBHZW5lcmFsIGxpc3QgY29tbWFuZAogICAgIiIiCiAgICBpZiBsZW4oYXJncykgPT0gMSBhbmQgYXJnc1swXSA9PSAnaXBzJzoKICAgICAgICBjbWRfbHNfaXBzKGFyZ3MpCiAgICAgICAgcmV0dXJuCiAgICBpZiBsZW4oYXJncykgPT0gMDoKICAgICAgICBhcmdzID0gWycvJ10KICAgIGNvbmZpZy5sb2FkKCkKICAgIGNvbmZpZy51c2VyX2tleV9yZXF1aXJlZChUcnVlKQoKICAgIGFkZHIgPSBhcmdzWzBdCiAgICBpZiBhZGRyLnN0YXJ0c3dpdGgoJy8nKToKICAgICAgICBhZGRyID0gYWRkclsxOl0KICAgICMgTWFrZSBzdXJlIHdlIGFyZSBub3QgZG93bmxvYWRpbmcgbG9nCiAgICBpZiBpc19sb2dfZnMoYWRkcik6CiAgICAgICAgZGllKCdVc2UgcHVsbCB0byBnZXQgbG9nIGNvbnRlbnQuJykKCiAgICAjIGlmIGFkZHIuY291bnQoJy8nKSA+IDI6CiAgICAjIGRpZSggJ1BhdGggbm90IGZvdW5kJykKICAgIGxpc3Rfb2JqZWN0KHJlcXVlc3QoYWRkciwgVHJ1ZSwgVHJ1ZSksCiAgICAgICAgICAgICAgICBob3N0bmFtZXM9YWRkci5zdGFydHN3aXRoKCdob3N0bmFtZXMnKSkKCgpkZWYgY21kX3JtKGFyZ3MpOgogICAgIiIiCiAgICBHZW5lcmFsIHJlbW92ZSBjb21tYW5kCiAgICAiIiIKICAgIGlmIGxlbihhcmdzKSA9PSAwOgogICAgICAgIGFyZ3MgPSBbJy8nXQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKFRydWUpCgogICAgYWRkciA9IGFyZ3NbMF0KICAgIGlmIGFkZHIuc3RhcnRzd2l0aCgnLycpOgogICAgICAgIGFkZHIgPSBhZGRyWzE6XQogICAgaWYgYWRkci5jb3VudCgnLycpID4gMjoKICAgICAgICBkaWUoJ1BhdGggbm90IGZvdW5kJykKICAgIHJlc3BvbnNlID0gcmVxdWVzdChhZGRyLCBUcnVlLCBUcnVlLCBydHlwZT0nREVMRVRFJykKICAgIHJlcG9ydChyZXNwb25zZVsncmVhc29uJ10pCgoKZGVmIGNtZF9wdWxsKGFyZ3MpOgogICAgIiIiCiAgICBMb2cgcHVsbCBjb21tYW5kCiAgICAiIiIKICAgIGlmIGxlbihhcmdzKSA9PSAwOgogICAgICAgIGRpZShQVUxMX1VTQUdFKQogICAgY29uZmlnLmxvYWQoKQogICAgY29uZmlnLnVzZXJfa2V5X3JlcXVpcmVkKFRydWUpCgogICAgcGFyYW1zID0ge30KCiAgICBhZGRyID0gYXJnc1swXQogICAgaWYgYWRkci5zdGFydHN3aXRoKCcvJyk6CiAgICAgICAgYWRkciA9IGFkZHJbMTpdCiAgICBpZiBhZGRyLmVuZHN3aXRoKCcvJyk6CiAgICAgICAgYWRkciA9IGFkZHJbOi0xXQogICAgaWYgbm90IGlzX2xvZ19mcyhhZGRyICsgJy8nKToKICAgICAgICBkaWUoJ0Vycm9yOiBOb3QgYSBsb2cnKQoKICAgIGlmIGxlbihhcmdzKSA+IDE6CiAgICAgICAgdGltZV9yYW5nZSA9IHBhcnNlX3RpbWVzdGFtcF9yYW5nZShhcmdzWzFdKQogICAgICAgIHBhcmFtc1snc3RhcnQnXSA9IHRpbWVfcmFuZ2VbMF0KICAgICAgICBwYXJhbXNbJ2VuZCddID0gdGltZV9yYW5nZVsxXQogICAgaWYgbGVuKGFyZ3MpID4gMjoKICAgICAgICBwYXJhbXNbJ2ZpbHRlciddID0gYXJnc1syXQogICAgaWYgbGVuKGFyZ3MpID4gMzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxpbWl0ID0gaW50KGFyZ3NbM10pCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIGRpZSgnRXJyb3I6IExpbWl0IG11c3QgYmUgaW50ZWdlcicpCiAgICAgICAgaWYgbGltaXQgPCAxOgogICAgICAgICAgICBkaWUoJ0xpbWl0IG11c3QgYmUgYWJvdmUgMCcpCiAgICAgICAgcGFyYW1zWydsaW1pdCddID0gbGltaXQKCiAgICBwdWxsX3JlcXVlc3QoYWRkciwgcGFyYW1zKQoKCiMKIyBNYWluIG1ldGhvZAojCgpkZWYgbWFpbl9yb290KCk6CiAgICAiIiJTZXJpb3VzIGJ1c2luZXNzIHN0YXJ0cyBoZXJlLgogICAgIiIiCiAgICAjIFJlYWQgY29tbWFuZCBsaW5lIHBhcmFtZXRlcnMKICAgIGFyZ3MgPSBjb25maWcucHJvY2Vzc19wYXJhbXMoc3lzLmFyZ3ZbMTpdKQoKICAgIGlmIGNvbmZpZy5kZWJ1ZzoKICAgICAgICBsb2cuc2V0TGV2ZWwobG9nZ2luZy5ERUJVRykKICAgIGlmIGNvbmZpZy5kZWJ1Z19zeXN0ZW06CiAgICAgICAgZGllKHN5c3RlbV9kZXRlY3QoVHJ1ZSkpCiAgICBpZiBjb25maWcuZGVidWdfbG9nbGlzdDoKICAgICAgICBkaWUoY29sbGVjdF9sb2dfbmFtZXMoc3lzdGVtX2RldGVjdChUcnVlKSkpCgogICAgaWYgY29uZmlnLmRlYnVnX2NtZF9saW5lOgogICAgICAgIHByaW50ID4+IHN5cy5zdGRlcnIsICdEZWJ1ZyBjb21tYW5kIGxpbmUgYXJnczogJXMnICUgYXJncwoKICAgIGFyZ3YwID0gc3lzLmFyZ3ZbMF0KICAgIGlmIGFyZ3YwIGFuZCBhcmd2MCAhPSAnJzoKICAgICAgICBwbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoYXJndjApLnNwbGl0KCctJykKICAgICAgICBpZiBsZW4ocG5hbWUpICE9IDE6CiAgICAgICAgICAgIGFyZ3MuaW5zZXJ0KDAsIHBuYW1lWy0xXSkKCiAgICBpZiBsZW4oYXJncykgPT0gMDoKICAgICAgICByZXBvcnQoVVNBR0UpCiAgICAgICAgc3lzLmV4aXQoRVhJVF9IRUxQKQoKICAgIGNvbW1hbmRzID0gewogICAgICAgICdpbml0JzogY21kX2luaXQsCiAgICAgICAgJ3JlaW5pdCc6IGNtZF9yZWluaXQsCiAgICAgICAgJ3JlZ2lzdGVyJzogY21kX3JlZ2lzdGVyLAogICAgICAgICdtb25pdG9yJzogY21kX21vbml0b3IsCiAgICAgICAgJ21vbml0b3JkYWVtb24nOiBjbWRfbW9uaXRvcl9kYWVtb24sCiAgICAgICAgJ2ZvbGxvdyc6IGNtZF9mb2xsb3csCiAgICAgICAgJ2ZvbGxvd2VkJzogY21kX2ZvbGxvd2VkLAogICAgICAgICdjbGVhbic6IGNtZF9jbGVhbiwKICAgICAgICAnd2hvYW1pJzogY21kX3dob2FtaSwKICAgICAgICAjIEZpbGVzeXN0ZW0gb3BlcmF0aW9ucwogICAgICAgICdscyc6IGNtZF9scywKICAgICAgICAncm0nOiBjbWRfcm0sCiAgICAgICAgJ3B1bGwnOiBjbWRfcHVsbCwKICAgIH0KICAgIGZvciBjbWQsIGZ1bmMgaW4gY29tbWFuZHMuaXRlbXMoKToKICAgICAgICBpZiBjbWQgPT0gYXJnc1swXToKICAgICAgICAgICAgaWYgY29uZmlnLm11bHRpbG9nIGFuZCBjbWQgPT0gJ2ZvbGxvdyc6CiAgICAgICAgICAgICAgICByZXR1cm4gY21kX2ZvbGxvd19tdWx0aWxvZyhhcmdzWzE6XSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jKGFyZ3NbMTpdKQogICAgZGllKCdFcnJvcjogVW5rbm93biBjb21tYW5kICIlcyIuJyAlIGFyZ3NbMF0pCgoKZGVmIG1haW4oKToKICAgIHRyeToKICAgICAgICBtYWluX3Jvb3QoKQogICAgZXhjZXB0IEZhdGFsQ29uZmlndXJhdGlvbkVycm9yLCBlOgogICAgICAgIGxvZy5lcnJvcigiRmF0YWw6ICVzIiwgZS5tc2cpCiAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgZGllKCJcblRlcm1pbmF0ZWQiLCBFWElUX1RFUk1JTkFURUQpCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpCg==</text>
      </register>
      <register name="2" type="2">
        <text encoding="base64">YXN5bmMgZGVmIGFzeW5jX2h0dHBfdHJ5KGZ1bmMsIHJldHJpZXM9MywgdGltZW91dD01LCBtZXRob2Q9J2pzb24nLCAqYXJncywgKiprd2FyZ3MpOgogICAgaSA9IDAK</text>
      </register>
      <register name="3" type="2">
        <text encoding="base64">YXN5bmMgZGVmIGFzeW5jX2h0dHBfdHJ5KGZ1bmMsIHJldHJpZXM9MywgdGltZW91dD01LCBtZXRob2Q9J2pzb24nLCAqYXJncywgKiprd2FyZ3MpOgogICAgaSA9IDAK</text>
      </register>
      <register name="4" type="4">
        <text>handle exception</text>
      </register>
      <register name="5" type="4">
        <text>, seems not good</text>
      </register>
      <register name="6" type="2">
        <text encoding="base64">ICAgICAgICAgICAgcnRuID0gYXdhaXQgc2VsZi5mdXR1cmVfdHJhZGUobG9jYWxfc3ltYm9sPWxvY2FsX2Nvbi5sb2NhbF9zeW1ib2wsIHR0eXBlPXR0eXBlLCBwcmljZT1wcmljZSwgYW1vdW50PWFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJhY3RfdHlwZT1sb2NhbF9jb24uZGVsaXZlcnkpCg==</text>
      </register>
      <register name="7" type="2">
        <text encoding="base64">ICAgICAgICAgICAgdHR5cGUK</text>
      </register>
      <register name="8" type="2">
        <text encoding="base64">ICAgICAgICAgICAgICAgIHJ0biA9IGF3YWl0IHNlbGYuZnV0dXJlX3RyYWRlKGxvY2FsX3N5bWJvbD1sb2NhbF9jb24ubG9jYWxfc3ltYm9sLCB0dHlwZT01IC0gdHR5cGUsIHByaWNlPXByaWNlLCBhbW91bnQ9YW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJhY3RfdHlwZT1sb2NhbF9jb24uZGVsaXZlcnkpCg==</text>
      </register>
      <register name="9" type="2">
        <text encoding="base64">ICAgICAgICAgICAgICAgIHJ0biA9IGF3YWl0IHNlbGYuZnV0dXJlX3RyYWRlKGxvY2FsX3N5bWJvbD1sb2NhbF9jb24ubG9jYWxfc3ltYm9sLCB0dHlwZT10dHlwZSwgcHJpY2U9cHJpY2UsIGFtb3VudD1hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cmFjdF90eXBlPWxvY2FsX2Nvbi5kZWxpdmVyeSkK</text>
      </register>
      <register name=":" type="4">
        <text>action FindPrevious</text>
      </register>
    </registers>
    <search>
      <last-search encoding="base64">XDxpcGFkZHJfYWxpaGsyXD4=</last-search>
      <last-offset />
      <last-pattern encoding="base64">XDxpcGFkZHJfYWxpaGsyXD4=</last-pattern>
      <last-dir>1</last-dir>
      <show-last>false</show-last>
    </search>
    <history>
      <history-search>
        <entry encoding="base64">XDxpcGFkZHJfYWxpaGsyXD4=</entry>
      </history-search>
      <history-cmd>
        <entry>action HighlightUsagesInFile</entry>
        <entry>action FindNext</entry>
        <entry>action FindPrevious</entry>
      </history-cmd>
      <history-expr />
      <history-input />
    </history>
    <shortcut-conflicts>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed V</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed A</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed C</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed B</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed F</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed S</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed U</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed W</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed I</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed R</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed G</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed T</text>
      </shortcut-conflict>
    </shortcut-conflicts>
  </component>
</application>